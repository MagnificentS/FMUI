<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Football Manager UI v19</title>
    <style>
        :root {
            /* ============================================
               GRID CONFIGURATION - Change these values to resize the grid
               The entire system will adapt automatically
               ============================================ */
            
            /* v16 Color Palette - Lighter and more readable */
            --neutral-100: #0a0b0d;
            --neutral-200: #12141a;
            --neutral-300: #1a1d24;
            --neutral-400: #22262f;
            
            --primary-100: #003d52;
            --primary-200: #005a7a;
            --primary-300: #0077a3;
            --primary-400: #0094cc;
            
            --accent-100: #ff6b35;
            --accent-200: #00ff88;  /* Green for continue button */
            --accent-300: #ffb800;
            --accent-400: #ff4757;
            
            /* Layout & Typography */
            --border-radius: 2px;
            --shadow-intensity: 8px;
            --font-size-xs: 10px;
            --font-size-sm: 12px;
            --font-size-base: 14px;
            --font-size-md: 16px;
            --font-size-lg: 18px;
            --font-size-xl: 20px;
            
            /* ============================================
               GRID CONTAINER DIMENSIONS
               To change grid size, modify these values:
               Example for 30x15 grid: --grid-columns: 30; --grid-rows: 15;
               Container size will be calculated automatically
               ============================================ */
            --grid-columns: 37;        /* Number of columns in the grid - increased by 2 */
            --grid-rows: 19;           /* Number of rows in the grid - increased by 1 */
            --grid-cell-size: 32px;    /* Size of each grid cell - square cells */
            --grid-gap: 8px;           /* Gap between cells - doubled from 4px */
            --grid-padding-v: 18px;    /* Vertical padding */
            --grid-padding-h: 16px;    /* Horizontal padding - reduced from 32px */
            
            /* Container dimensions (calculated from grid) */
            --container-width: 1504px;  /* (37 * 32) + (36 * 8) + (2 * 16) = 1184 + 288 + 32 */
            --container-height: 788px;  /* (19 * 32) + (18 * 8) + (2 * 18) = 608 + 144 + 36 */
            
            /* Card Size Constraints (in grid cells) */
            --min-card-width: 9;        /* Minimum card width in cells - reduced from 10 */
            --min-card-height: 6;       /* Minimum card height in cells */
            --default-card-width: 14;   /* Default card width in cells */
            --default-card-height: 8;   /* Default card height in cells */
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, 'Inter', 'Segoe UI', sans-serif;
            color: #e4e6eb;
            overflow: hidden;
            height: 100vh;
            position: relative;
            background: #0a0b0d;
        }

        /* Background container with gradient */
        .bg {
            position: fixed;
            inset: 0;
            z-index: 0;
            /* background: linear-gradient(135deg, #0a0b0d 0%, #1a1220 25%, #0d0f1a 50%, #0a0b0d 100%); */
            /* background: linear-gradient(135deg, rgba(10, 11, 13, 0.6) 0%, rgba(26, 18, 32, 0.6) 25%, rgba(13, 15, 26, 0.6) 50%, rgba(10, 11, 13, 0.6) 100%); */
            background: linear-gradient(135deg, #14151d 0%, #241c27 25%, #171934 50%, #141541 100%);
        }
        
        /* Background image with blend mode */
        .bg-overlay {
            position: absolute;
            inset: 0;
            width: 100%;
            height: 100%;
            background: url('assets/images/bg_002.png') center/cover no-repeat;
            /*mix-blend-mode: overlay;*/
            opacity: 0.23;
        }


        /* Header - NO hover effect */
        .header {
            background: var(--primary-200);
            height: 40px;
            display: flex;
            align-items: center;
            width: 100%;
            box-shadow: 0 2px 10px rgba(0,0,0,0.5);
            z-index: 100;
            position: relative;
        }

        .header-content {
            max-width: 1680px;
            margin: 0 auto;
            width: 100%;
            padding: 0 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .team-section {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .team-badge {
            position: absolute;
            left: calc(50% - 42.5vw);
            top: 4px;
            width: 64px;
            height: 80px; /* Span header (40px) + nav (48px) */
            z-index: 95;
            overflow: hidden;
        }
        
        .team-badge::before {
            content: '';
            position: absolute;
            inset: 0;
            background: url('assets/images/shield.png') center/contain no-repeat;
            z-index: 1;
        }
        
        .team-badge::after {
            content: '';
            position: absolute;
            inset: 0;
            background: linear-gradient(180deg, rgba(0, 148, 204, 0.8) 0%, rgba(0, 94, 128, 0.8) 100%);
            z-index: 2;
            -webkit-mask-image: url('assets/images/shield.png');
            -webkit-mask-size: contain;
            -webkit-mask-repeat: no-repeat;
            -webkit-mask-position: center;
            mask-image: url('assets/images/shield.png');
            mask-size: contain;
            mask-repeat: no-repeat;
            mask-position: center;
        }
        
        .badge-rim {
            position: absolute;
            inset: 0;
            background: url('assets/images/rim.png') center/contain no-repeat;
            z-index: 3;
            pointer-events: none;
        }

        .team-info {
            margin-left: 80px; /* Space for the large badge */
            display: flex;
            align-items: center;
        }

        .team-name {
            font-weight: 600;
            font-size: var(--font-size-base);
            color: #ffffff;
        }

        /* Header right buttons container */
        .header-right-buttons {
            position: absolute;
            right: calc(50% - 50vw + 64px);
            display: flex;
            align-items: center;
            gap: 12px;
        }

        /* Date-Time Button (same dimensions as badge) */
        .date-time-btn {
            width: auto;
            height: 30px;
            padding: 0 12px;
            background: rgba(0,0,0,0.2);
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: var(--border-radius);
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: var(--font-size-sm);
            color: rgba(255,255,255,0.9);
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .date-time-btn:hover {
            background: rgba(0,0,0,0.3);
            border-color: rgba(255,255,255,0.2);
        }

        .date-time-btn .date {
            font-weight: 500;
        }

        .date-time-btn .time {
            opacity: 0.8;
        }

        /* Simple navigation buttons */
        .nav-btn {
            width: 30px;
            height: 30px;
            background: rgba(0,0,0,0.2);
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: var(--border-radius);
            display: flex;
            align-items: center;
            justify-content: center;
            color: rgba(255,255,255,0.7);
            cursor: pointer;
            transition: all 0.2s ease;
            margin-right: 8px;
            font-size: 14px;
        }

        .nav-btn:hover {
            background: rgba(0,148,204,0.3);
            border-color: rgba(0,148,204,0.5);
            color: #ffffff;
            transform: translateY(-1px);
        }

        /* Navigation - v16 style */
        .nav-container {
            background: var(--neutral-300);
            width: 100%;
            box-shadow: 0 2px 8px rgba(0,0,0,0.4);
            z-index: 90;
            position: relative;
        }

        .nav-content {
            width: calc(85vw + 8px);
            min-width: 1024px;
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0;
            height: 48px;
            position: relative;
        }

        .nav-tabs {
            display: flex;
            gap: 8px;
            align-items: center;
            margin-left: 80px; /* Space for the badge */
        }

        .nav-tab {
            padding: 8px 16px;
            background: transparent;
            color: rgba(255,255,255,0.7);
            border: none;
            cursor: pointer;
            transition: all 0.2s ease;
            font-size: var(--font-size-sm);
            border-radius: var(--border-radius);
        }

        .nav-tab:hover {
            background: rgba(0, 148, 204, 0.2);
            color: #ffffff;
        }

        .nav-tab.active {
            background: var(--primary-300);
            color: #ffffff;
        }

        /* Navigation Right Section - Aligned buttons */
        .nav-right {
            position: absolute;
            right: calc(10vw - 265px); /*calc(10vw - 350px);*/
            display: flex;
            align-items: center;
            gap: 12px;
        }

        /* Continue Button - GREEN from v16 */
        .continue-btn {
            padding: 7px 16px;
            background: var(--accent-200); /* Green #00ff88 */
            color: var(--neutral-100);
            border: none;
            border-radius: var(--border-radius);
            cursor: pointer;
            font-weight: 600;
            font-size: var(--font-size-sm);
            transition: all 0.2s ease;
            letter-spacing: 0.5px;
        }

        .continue-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(0, 255, 136, 0.4);
        }

        /* Sub-navigation - Increased by 20% */
        .nav-submenu {
            height: 38px; /* Increased from 32px by 20% */
            background: var(--neutral-200);
            display: none;
            align-items: center;
            position: relative;
            z-index: 85;
        }

        .nav-submenu.active {
            display: flex;
        }

        .submenu-content {
            width: 80vw;
            min-width: 1024px;
            margin: 0 auto;
            display: flex;
            gap: 16px;
            align-items: center;
            padding-left: 30px; /* Space for the badge */
        }

        .submenu-item {
            padding: 5px 14px;
            font-size: 12px; /* Increased from 10px */
            color: rgba(255,255,255,0.6);
            cursor: pointer;
            transition: all 0.2s ease;
            border-radius: var(--border-radius);
            font-weight: 500;
        }

        .submenu-item:hover {
            background: rgba(0, 148, 204, 0.15);
            color: #ffffff;
        }

        .submenu-item.active {
            background: var(--primary-100);
            color: #ffffff;
        }

        /* Main Panel - Reduced width and spacing */
        .app-container {
            display: flex;
            justify-content: center;
            align-items: flex-start;
            height: 100vh;
            position: relative;
            width: 100%;
            max-width: 1920px;
            margin: 0 auto;
            padding-top: 20px; /* Increased by 40px to compensate for height reduction */
        }

        .main-panel {
            width: 100%;
            padding: 20px;
            overflow: hidden;
            position: relative;
            margin-top: -100px;  /* Moved up by 60px (was 15px, now -45px) */
            display: flex;
            flex-direction: column;  /* Stack elements vertically */
            align-items: center;     /* Center horizontally */
        }

        /* Card Indicators - v16 style */
        .card-indicators {
            display: none;
            justify-content: center;
            gap: 8px;
            margin-bottom: 12px;
            position: relative;
            height: 30px;
            width: auto;
        }

        .card-indicators.active {
            display: flex;
            width: auto;
        }

        .card-indicator {
            width: 28px;
            height: 28px;
            background: var(--neutral-300);
            border: 1px solid var(--primary-300);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s ease;
            font-size: var(--font-size-xs);
            position: relative;
        }

        .card-indicator:hover {
            background: var(--primary-300);
            transform: scale(1.1);
        }

        .card-indicator.active {
            background: var(--primary-400);
            border-color: var(--primary-400);
        }

        /* Indicator Tooltips */
        .card-indicator-tooltip {
            position: absolute;
            top: -25px;
            left: 50%;
            transform: translateX(-50%);
            background: var(--neutral-400);
            color: #ffffff;
            padding: 4px 8px;
            font-size: var(--font-size-xs);
            border-radius: var(--border-radius);
            white-space: nowrap;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.2s ease;
        }

        .card-indicator:hover .card-indicator-tooltip {
            opacity: 1;
        }

        /* Content Pages */
        .content-page {
            display: none;
            height: 100%;
            position: relative;
            width: 100%;
        }

        .content-page.active {
            display: flex;
            justify-content: center;
            align-items: flex-start;
            width: 100%;
        }

        /* View Containers */
        .view-container {
            display: none;
            height: calc(100% - 50px);
            width: 100%;
            justify-content: center;
            align-items: flex-start;
        }

        .view-container.active {
            display: flex;
        }
        
        /* Override for single view to fill container */
        #overview-single-view.view-container.active,
        #squad-single-view.view-container.active,
        #tactics-single-view.view-container.active,
        #training-single-view.view-container.active,
        #transfers-single-view.view-container.active,
        #finances-single-view.view-container.active,
        #fixtures-single-view.view-container.active {
            display: block;
            width: 100%;
        }

        /* Grid Container - 4 columns, 100px row height */
        .tile-container {
            display: grid;
            /* 44 columns of 33px */
            grid-template-columns: repeat(var(--grid-columns), var(--grid-cell-size));
            /* 19 rows of 33px */
            grid-template-rows: repeat(var(--grid-rows), var(--grid-cell-size));
            gap: var(--grid-gap);
            /* Vertical padding: 18px, Horizontal padding: 32px */
            padding: var(--grid-padding-v) var(--grid-padding-h);
            width: var(--container-width);
            height: var(--container-height);
            overflow: hidden;
            background: rgba(0, 0, 0, 0.12);
            border-radius: var(--border-radius);
            backdrop-filter: blur(13px);
            position: relative;
            margin: 0 auto; /* Center the container horizontally */
        }
        
        /* Grid overlay - shows during drag/resize */
        .grid-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            pointer-events: none;
            z-index: 1000;
            opacity: 0;
            transition: opacity 0.2s ease;
        }
        
        .grid-overlay.active {
            opacity: 1;
        }
        
        .grid-overlay::before {
            content: '';
            position: absolute;
            /* Match the tile-container padding */
            top: var(--grid-padding-v);
            left: var(--grid-padding-h);
            right: var(--grid-padding-h);
            bottom: var(--grid-padding-v);
            background-image: 
                /* Grid lines */
                repeating-linear-gradient(
                    0deg,
                    rgba(0, 255, 136, 0.3) 0px,
                    rgba(0, 255, 136, 0.3) 1px,
                    transparent 1px,
                    transparent calc((var(--grid-cell-size) + var(--grid-gap)))
                ),
                repeating-linear-gradient(
                    90deg,
                    rgba(0, 255, 136, 0.3) 0px,
                    rgba(0, 255, 136, 0.3) 1px,
                    transparent 1px,
                    transparent calc((var(--grid-cell-size) + var(--grid-gap)))
                );
        }
        
        /* Cross markers at center of each grid cell */
        .grid-overlay::after {
            content: '';
            position: absolute;
            /* Match the tile-container padding */
            top: var(--grid-padding-v);
            left: var(--grid-padding-h);
            right: var(--grid-padding-h);
            bottom: var(--grid-padding-v);
            /* SVG pattern for 5px x 5px crosses - 40px spacing (32px cell + 8px gap) */
            background-image: url("data:image/svg+xml,%3Csvg width='40' height='40' xmlns='http://www.w3.org/2000/svg'%3E%3Cg%3E%3Cline x1='20' y1='17.5' x2='20' y2='22.5' stroke='rgba(0,255,136,0.3)' stroke-width='1'/%3E%3Cline x1='17.5' y1='20' x2='22.5' y2='20' stroke='rgba(0,255,136,0.3)' stroke-width='1'/%3E%3C/g%3E%3C/svg%3E");
            background-repeat: repeat;
        }


        .tile-container.layout-single {
            display: block;
            overflow: hidden;
            padding: 0;
            width: 100%;
            max-width: var(--container-width);  /* Constrain to container width */
            height: calc(var(--container-height) - 42px);  /* Account for indicators above */
            max-height: calc(var(--container-height) - 42px);
            margin: 0 auto;  /* Center if narrower */
            background: transparent;
        }

        .tile-container.layout-list {
            grid-template-columns: 1fr;
        }

        /* Cards - Multiple Size Options */
        .card {
            background: var(--neutral-200);
            border-radius: var(--border-radius);
            box-shadow: 0 var(--shadow-intensity) calc(var(--shadow-intensity) * 1.5) rgba(0,0,0,calc(0.4 * 0.95));
            overflow: hidden;
            display: flex;
            flex-direction: column;
            position: relative;
            transition: all 0.3s ease;
            border: 1px solid transparent;
            cursor: default;
            user-select: none;
            box-sizing: border-box;
            /* Default: 1 column wide, 2 rows tall */
            grid-column: span 1;
            grid-row: span 2;
        }
        
        /* Smooth transitions for push/swap animations */
        .card.transitioning {
            transition: all 0.2s cubic-bezier(0.4, 0.0, 0.2, 1);
        }
        
        .card.pushed {
            animation: push-feedback 0.3s ease;
        }
        
        @keyframes push-feedback {
            0% { transform: scale(1); }
            50% { transform: scale(0.98); }
            100% { transform: scale(1); }
        }
        
        
        /* Width and Height classes are now generated dynamically in JavaScript
           based on GRID_CONFIG to adapt to any grid size */

        .card:hover {
            box-shadow: 0 var(--shadow-intensity) calc(var(--shadow-intensity) * 2) rgba(0, 148, 204, 0.3);
            border-color: var(--primary-300);
        }
        
        .card.dragging {
            opacity: 0.5;
            z-index: 1000;
            pointer-events: none;
        }
        
        .card.drag-placeholder {
            background: rgba(0, 148, 204, 0.1);
            border: 2px dashed rgba(0, 148, 204, 0.3);
            box-shadow: none;
        }
        
        /* Drop indicators - simple before/after */
        .card.drop-target-before::before,
        .card.drop-target-after::after {
            content: '';
            position: absolute;
            left: 0;
            right: 0;
            height: 4px;
            background: var(--accent-200);
            box-shadow: 0 0 10px rgba(0, 255, 136, 0.8);
            z-index: 999;
            pointer-events: none;
        }
        
        .card.drop-target-before::before {
            top: -8px;
        }
        
        .card.drop-target-after::after {
            bottom: -8px;
        }
        
        .card.pinned {
            cursor: default;
            position: relative;
        }
        
        /* Pin icon only shows when dragging is active */
        body.dragging .card.pinned::before {
            content: '';
            position: absolute;
            top: 8px;
            right: 40px;
            width: 20px;
            height: 20px;
            background: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="white"><path d="M16,12V4H17V2H7V4H8V12L6,14V16H11.2V22H12.8V16H18V14L16,12Z"/></svg>') no-repeat center;
            background-size: contain;
            filter: drop-shadow(0 2px 4px rgba(0, 0, 0, 0.5));
            z-index: 11;
        }
        
        /* Red glow when attempting to drop on pinned card */
        .card.pinned.drag-over {
            border: 2px solid #ff4757;
            box-shadow: 
                0 0 30px rgba(255, 71, 87, 0.6),
                0 0 60px rgba(255, 71, 87, 0.3),
                inset 0 0 20px rgba(255, 71, 87, 0.1);
        }

        .card.expanded {
            width: 100%;
            height: calc(var(--container-height) - 42px);  /* Container height minus indicators (30px + 12px margin) */
            max-width: var(--container-width);  /* Constrain to container width */
            max-height: calc(var(--container-height) - 42px);  /* Account for indicators */
            margin: 0 auto;  /* Center if narrower than parent */
        }

        /* Card Header - v13 height (35px total) */
        .card-header {
            background: var(--neutral-100);
            padding: 6px 12px; /* Reduced from 10px to achieve 35px total height */
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
            color: var(--primary-400);
            border-bottom: 2px solid var(--primary-300);
            display: flex;
            justify-content: space-between;
            align-items: center;
            height: 35px;
            box-sizing: border-box;
            cursor: default; /* Use default cursor */
        }

        .card-header span {
            font-weight: 600;
            font-size: 11px;
            color: var(--primary-400);
        }

        /* Card Dropdown Menu */
        .card-menu {
            position: relative;
        }

        .card-menu-btn {
            background: transparent;
            border: none;
            color: rgba(255,255,255,0.6);
            cursor: pointer;
            padding: 2px;
            margin-right: -8px;
            transition: all 0.2s ease;
        }

        .card-menu-btn:hover {
            color: var(--primary-400);
        }

        .card-menu-dropdown {
            position: absolute;
            top: 100%;
            right: 0;
            background: var(--neutral-400);
            border: 1px solid var(--neutral-500);
            border-radius: var(--border-radius);
            padding: 4px 0;
            display: none;
            z-index: 10;
            min-width: 120px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
        }

        .card-menu-dropdown.active {
            display: block;
        }

        .card-menu-item {
            padding: 8px 12px;
            color: rgba(255,255,255,0.8);
            cursor: pointer;
            font-size: 11px;
            transition: all 0.2s ease;
            border-bottom: 1px solid var(--neutral-300);
        }

        .card-menu-item:last-child {
            border-bottom: none;
        }

        .card-menu-item:hover {
            background: var(--primary-100);
            color: #ffffff;
        }

        /* Card Body - v16 style */
        .card-body {
            padding: 12px;
            overflow-y: auto;
            flex: 1;
        }

        /* Resize Handle */
        .resize-handle {
            position: absolute;
            bottom: 0;
            right: 0;
            width: 20px;
            height: 20px;
            cursor: nwse-resize;
            opacity: 0;
            transition: opacity 0.2s;
            background: linear-gradient(135deg, transparent 50%, rgba(255,255,255,0.1) 50%);
            z-index: 10;
        }

        .card:hover .resize-handle {
            opacity: 0.5;
            background: linear-gradient(135deg, transparent 50%, var(--primary-400) 50%);
        }

        /* v16 Styled Scrollbars */
        .card-body::-webkit-scrollbar,
        .tile-container::-webkit-scrollbar {
            width: 10px;
            height: 10px;
        }

        .card-body::-webkit-scrollbar-track,
        .tile-container::-webkit-scrollbar-track {
            background: rgba(255,255,255,0.05);
            border-radius: 10px;
            margin: 10px 0;
        }
        
        /* Add padding to horizontal scrollbar track */
        .card-body::-webkit-scrollbar-track:horizontal {
            margin: 0 15px;
        }

        .card-body::-webkit-scrollbar-thumb,
        .tile-container::-webkit-scrollbar-thumb {
            background: var(--primary-300);
            border-radius: 10px;
            border: 2px solid var(--neutral-200);
        }

        .card-body::-webkit-scrollbar-thumb:hover,
        .tile-container::-webkit-scrollbar-thumb:hover {
            background: var(--primary-400);
        }

        .card-body::-webkit-scrollbar-corner,
        .tile-container::-webkit-scrollbar-corner {
            background: transparent;
        }

        .stat-row {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid var(--neutral-300);
            font-size: 11px;
        }

        .stat-label {
            color: rgba(255,255,255,0.6);
            font-size: 11px;
        }

        .stat-value {
            color: rgba(255,255,255,0.9);
            font-weight: 500;
            font-size: 11px;
        }

        /* Data Tables */
        .data-table {
            width: 100%;
            font-size: var(--font-size-sm);
        }

        .data-table th {
            text-align: left;
            padding: 8px 4px;
            border-bottom: 1px solid var(--neutral-400);
            color: rgba(255,255,255,0.6);
            font-size: var(--font-size-xs);
            font-weight: 500;
            text-transform: uppercase;
        }

        .data-table td {
            padding: 6px 4px;
            border-bottom: 1px solid rgba(255,255,255,0.05);
            color: rgba(255,255,255,0.9);
        }

        /* Settings FAB - Subtle and translucent */
        .settings-fab {
            position: fixed;
            bottom: 36px;
            right: calc(50% - 50vw + 64px);
            width: 56px;
            height: 56px;
            background: rgba(40, 44, 52, 0.6); /* Translucent dark grey */
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
            transition: all 0.3s ease;
            z-index: 100;
            backdrop-filter: blur(10px);
        }

        .settings-fab:hover {
            transform: translateY(-2px) rotate(90deg);
            background: rgba(40, 44, 52, 0.8);
            box-shadow: 
                0 4px 12px rgba(0, 0, 0, 0.3),
                0 0 30px rgba(0, 148, 204, 0.5),
                0 0 50px rgba(0, 148, 204, 0.3); /* Stronger glow */
        }

        .settings-fab svg {
            width: 24px;
            height: 24px;
            fill: #808080; /* Grey icon */
            opacity: 0.8;
        }

        .settings-fab:hover svg {
            fill: var(--primary-400);
            opacity: 1;
            filter: drop-shadow(0 0 8px rgba(0, 148, 204, 0.6));
        }
        
        /* Hamburger Menu Dropdown */
        .hamburger-menu {
            position: fixed;
            bottom: 100px;
            right: calc(50% - 50vw + 64px);
            background: var(--neutral-300);
            border: 1px solid var(--neutral-400);
            border-radius: var(--border-radius);
            padding: 8px 0;
            display: none;
            z-index: 101;
            min-width: 200px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
        }
        
        .hamburger-menu.active {
            display: block;
        }
        
        .menu-item {
            padding: 12px 20px;
            color: rgba(255,255,255,0.9);
            cursor: pointer;
            font-size: 14px;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        .menu-item:hover {
            background: rgba(0, 148, 204, 0.15);
            color: var(--primary-400);
        }
        
        .menu-item svg {
            opacity: 0.8;
        }
        
        .menu-item:hover svg {
            opacity: 1;
        }
        
        .menu-divider {
            height: 1px;
            background: var(--neutral-400);
            margin: 8px 0;
        }

        /* Settings Dialog */
        .settings-dialog {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: var(--neutral-200);
            border: 1px solid var(--neutral-400);
            border-radius: var(--border-radius);
            padding: 24px;
            z-index: 1000;
            display: none;
            min-width: 400px;
            box-shadow: 0 16px 48px rgba(0,0,0,0.5);
        }

        .settings-dialog.active {
            display: block;
        }

        .settings-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 12px;
            border-bottom: 1px solid var(--neutral-400);
        }

        .settings-title {
            font-size: var(--font-size-lg);
            font-weight: 600;
            color: #ffffff;
        }

        .settings-close {
            background: transparent;
            border: none;
            color: rgba(255,255,255,0.6);
            cursor: pointer;
            font-size: 24px;
            transition: all 0.2s ease;
        }

        .settings-close:hover {
            color: var(--accent-400);
        }

        .settings-group {
            margin-bottom: 20px;
        }

        .settings-group-title {
            font-size: var(--font-size-sm);
            font-weight: 600;
            color: rgba(255,255,255,0.8);
            margin-bottom: 10px;
            text-transform: uppercase;
        }

        .setting-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 0;
        }

        .setting-label {
            font-size: var(--font-size-sm);
            color: rgba(255,255,255,0.7);
        }

        /* Overlay */
        .overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.7);
            z-index: 999;
            display: none;
        }

        .overlay.active {
            display: block;
        }

        /* Badge styles */
        .badge {
            padding: 2px 6px;
            border-radius: 2px;
            font-size: 10px;
            font-weight: 600;
        }

        .badge-success { background: var(--accent-200); color: var(--neutral-100); }
        .badge-warning { background: var(--accent-300); color: var(--neutral-100); }
        .badge-danger { background: var(--accent-400); color: white; }

        /* ============================================
           AETHELRED DESIGN SYSTEM - newPlan.md Components
           ============================================ */

        /* StatRow Component (newPlan.md Widget 1.1) */
        .aethelred-stat-row {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid rgba(255,255,255,0.1);
            font-size: var(--font-size-sm);
        }

        .aethelred-stat-label {
            color: rgba(255,255,255,0.6);
            font-size: var(--font-size-sm);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            opacity: 0.8;
            text-align: left;
        }

        .aethelred-stat-value {
            color: rgba(255,255,255,0.9);
            font-weight: 600;
            font-size: var(--font-size-sm);
            text-align: right;
            margin-left: auto;
        }

        /* StatRow semantic coloring based on valueType */
        .aethelred-stat-value.positive {
            color: var(--accent-200); /* Green */
        }

        .aethelred-stat-value.negative {
            color: var(--accent-400); /* Red */
        }

        .aethelred-stat-value.warning {
            color: var(--accent-300); /* Amber */
        }

        .aethelred-stat-value.neutral {
            color: rgba(255,255,255,0.9);
        }

        /* Card structure for Aethelred components */
        .aethelred-card-header {
            background: var(--neutral-100);
            padding: 6px 12px;
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
            color: var(--primary-400);
            border-bottom: 2px solid var(--primary-300);
            display: flex;
            justify-content: space-between;
            align-items: center;
            height: 35px;
            box-sizing: border-box;
        }

        .aethelred-card-body {
            padding: 12px;
            overflow-y: auto;
            flex: 1;
        }

        /* MiniTable Component (newPlan.md Widget 2.1) */
        .aethelred-mini-table {
            width: 100%;
            font-size: var(--font-size-sm);
            border-collapse: collapse;
        }

        .aethelred-mini-table thead th {
            text-align: left;
            padding: 8px 4px;
            border-bottom: 1px solid var(--neutral-400);
            color: rgba(255,255,255,0.6);
            font-size: var(--font-size-xs);
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            opacity: 0.8;
        }

        .aethelred-mini-table tbody td {
            padding: 6px 4px;
            border-bottom: 1px solid rgba(255,255,255,0.05);
            color: rgba(255,255,255,0.9);
            font-size: var(--font-size-sm);
        }

        .aethelred-mini-table tbody tr:hover {
            background: rgba(0, 148, 204, 0.1);
        }

        /* Data Table for RosterCard (newPlan.md Card 2.2) - Enhanced version of MiniTable */
        .aethelred-data-table {
            width: 100%;
            font-size: var(--font-size-sm);
            border-collapse: collapse;
            margin: 0;
        }

        .aethelred-data-table thead th {
            text-align: left;
            padding: 10px 6px;
            border-bottom: 2px solid var(--neutral-400);
            color: rgba(255,255,255,0.7);
            font-size: var(--font-size-xs);
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.8px;
            background: rgba(0,0,0,0.2);
            position: sticky;
            top: 0;
            z-index: 1;
        }

        .aethelred-data-table tbody td {
            padding: 8px 6px;
            border-bottom: 1px solid rgba(255,255,255,0.08);
            color: rgba(255,255,255,0.95);
            font-size: var(--font-size-sm);
            vertical-align: middle;
        }

        .aethelred-data-table tbody tr:hover {
            background: rgba(0, 148, 204, 0.15);
            transform: scale(1.002);
            transition: all 0.2s ease;
        }

        .aethelred-data-table tbody tr:nth-child(even) {
            background: rgba(255,255,255,0.02);
        }

        .aethelred-data-table tbody tr:nth-child(even):hover {
            background: rgba(0, 148, 204, 0.15);
        }

        /* StatBar Component (newPlan.md Widget 3.1) */
        .aethelred-stat-bar {
            width: 100%;
            height: 8px;
            background: rgba(255,255,255,0.1);
            border-radius: 4px;
            overflow: hidden;
            position: relative;
            margin: 4px 0;
        }

        .aethelred-stat-bar-fill {
            height: 100%;
            border-radius: 4px;
            transition: width 0.6s ease-in-out;
            position: relative;
            background: linear-gradient(90deg, transparent 0%, rgba(255,255,255,0.1) 100%);
        }

        /* StatBar status-based coloring */
        .aethelred-stat-bar-fill.high {
            background: linear-gradient(90deg, var(--accent-200) 0%, rgba(0, 255, 136, 0.8) 100%);
            box-shadow: 0 0 8px rgba(0, 255, 136, 0.4);
        }

        .aethelred-stat-bar-fill.medium {
            background: linear-gradient(90deg, var(--accent-300) 0%, rgba(255, 184, 0, 0.8) 100%);
            box-shadow: 0 0 8px rgba(255, 184, 0, 0.4);
        }

        .aethelred-stat-bar-fill.low {
            background: linear-gradient(90deg, var(--accent-400) 0%, rgba(255, 71, 87, 0.8) 100%);
            box-shadow: 0 0 8px rgba(255, 71, 87, 0.4);
        }

        /* StatBar with integrated text display */
        .aethelred-stat-bar-row {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }

        .aethelred-stat-bar-row .aethelred-stat-label {
            color: rgba(255,255,255,0.6);
            font-size: var(--font-size-sm);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            opacity: 0.8;
            flex-shrink: 0;
            min-width: 100px;
        }

        .aethelred-stat-bar-row .aethelred-stat-bar {
            flex: 1;
            margin: 0 12px;
            max-width: 120px;
        }

        .aethelred-stat-bar-row .aethelred-stat-value {
            color: rgba(255,255,255,0.9);
            font-weight: 600;
            font-size: var(--font-size-sm);
            text-align: right;
            flex-shrink: 0;
            min-width: 40px;
        }

        /* Formation Display (newPlan.md Card 3.3) - REDESIGNED FOR FULL PITCH */
        .aethelred-formation-display {
            text-align: center;
            padding: 16px;
            min-height: 400px;
        }

        .aethelred-formation-header {
            margin-bottom: 16px;
        }

        .aethelred-formation-tactic {
            font-size: var(--font-size-lg);
            font-weight: 600;
            color: var(--primary-400);
            margin-bottom: 4px;
        }

        .aethelred-formation-name {
            font-size: var(--font-size-md);
            color: rgba(255,255,255,0.7);
            margin-bottom: 12px;
        }

        .aethelred-pitch {
            position: relative;
            width: 100%;
            max-width: 400px;
            height: 280px;
            margin: 0 auto 16px auto;
            background: linear-gradient(to bottom, #0a3d1a 0%, #1a6329 25%, #2a7339 50%, #1a6329 75%, #0a3d1a 100%);
            border-radius: 12px;
            border: 3px solid rgba(255,255,255,0.3);
            overflow: visible;
            box-shadow: 
                inset 0 0 20px rgba(0,0,0,0.3),
                0 4px 20px rgba(0,0,0,0.2);
        }

        /* Full pitch markings */
        .aethelred-pitch::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 0;
            right: 0;
            height: 2px;
            background: rgba(255,255,255,0.4);
            transform: translateY(-50%);
        }

        .aethelred-pitch::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 100px;
            height: 100px;
            border: 2px solid rgba(255,255,255,0.4);
            border-radius: 50%;
            transform: translate(-50%, -50%);
        }

        /* Goal areas */
        .aethelred-pitch-goals {
            position: absolute;
            width: 100%;
            height: 100%;
        }

        .aethelred-pitch-goals::before {
            content: '';
            position: absolute;
            top: 0;
            left: 50%;
            width: 80px;
            height: 25px;
            background: rgba(255,255,255,0.1);
            border: 1px solid rgba(255,255,255,0.3);
            border-top: none;
            border-radius: 0 0 8px 8px;
            transform: translateX(-50%);
        }

        .aethelred-pitch-goals::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 50%;
            width: 80px;
            height: 25px;
            background: rgba(255,255,255,0.1);
            border: 1px solid rgba(255,255,255,0.3);
            border-bottom: none;
            border-radius: 8px 8px 0 0;
            transform: translateX(-50%);
        }

        /* Penalty areas */
        .aethelred-pitch-penalty {
            position: absolute;
            width: 100%;
            height: 100%;
        }

        .aethelred-pitch-penalty::before {
            content: '';
            position: absolute;
            top: 0;
            left: 50%;
            width: 140px;
            height: 50px;
            border: 1px solid rgba(255,255,255,0.25);
            border-top: none;
            transform: translateX(-50%);
        }

        .aethelred-pitch-penalty::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 50%;
            width: 140px;
            height: 50px;
            border: 1px solid rgba(255,255,255,0.25);
            border-bottom: none;
            transform: translateX(-50%);
        }

        .aethelred-player-marker {
            position: absolute;
            width: 24px;
            height: 24px;
            background: var(--primary-400);
            border: 2px solid rgba(255,255,255,0.9);
            border-radius: 50%;
            transform: translate(-50%, -50%);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 9px;
            font-weight: 600;
            color: white;
            text-shadow: 0 1px 2px rgba(0,0,0,0.8);
            box-shadow: 0 2px 4px rgba(0,0,0,0.3);
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .aethelred-player-marker:hover {
            transform: translate(-50%, -50%) scale(1.2);
            background: var(--accent-200);
            box-shadow: 0 4px 8px rgba(0,0,0,0.4);
        }

        .aethelred-player-marker.goalkeeper {
            background: var(--accent-300);
        }

        .aethelred-player-marker.defender {
            background: var(--primary-300);
        }

        .aethelred-player-marker.midfielder {
            background: var(--accent-200);
        }

        .aethelred-player-marker.forward {
            background: var(--accent-400);
        }

        .aethelred-formation-familiarity {
            font-size: var(--font-size-sm);
            color: rgba(255,255,255,0.8);
        }

        .aethelred-formation-familiarity .percentage {
            font-weight: 600;
            color: var(--accent-200);
        }

        /* SetPiece Display - FIXED FOR PROPER GOAL-RELATIVE POSITIONING */
        .aethelred-setpiece-display {
            text-align: center;
            padding: 16px;
            min-height: 300px;
        }

        .aethelred-setpiece-pitch {
            position: relative;
            width: 100%;
            max-width: 350px;
            height: 200px;
            margin: 0 auto 16px auto;
            background: linear-gradient(to bottom, #0a3d1a 0%, #1a6329 25%, #2a7339 50%, #1a6329 75%, #0a3d1a 100%);
            border-radius: 12px;
            border: 3px solid rgba(255,255,255,0.3);
            overflow: visible;
        }

        /* Goal area for set pieces */
        .aethelred-setpiece-goal {
            position: absolute;
            bottom: 0;
            left: 50%;
            width: 100px;
            height: 8px;
            background: rgba(255,255,255,0.8);
            transform: translateX(-50%);
            border-radius: 4px 4px 0 0;
        }

        /* Penalty area outline */
        .aethelred-setpiece-penalty {
            position: absolute;
            bottom: 0;
            left: 50%;
            width: 160px;
            height: 60px;
            border: 2px solid rgba(255,255,255,0.4);
            border-bottom: none;
            transform: translateX(-50%);
        }

        /* Goal area outline */
        .aethelred-setpiece-goal-area {
            position: absolute;
            bottom: 0;
            left: 50%;
            width: 80px;
            height: 20px;
            border: 1px solid rgba(255,255,255,0.3);
            border-bottom: none;
            transform: translateX(-50%);
        }

        /* Set piece markers */
        .aethelred-setpiece-marker {
            position: absolute;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            transform: translate(-50%, -50%);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 8px;
            font-weight: 600;
            color: white;
            text-shadow: 0 1px 2px rgba(0,0,0,0.8);
            box-shadow: 0 2px 4px rgba(0,0,0,0.3);
            transition: all 0.2s ease;
        }

        .aethelred-setpiece-marker.corner {
            background: var(--accent-300);
            border: 2px solid rgba(255,255,255,0.9);
        }

        .aethelred-setpiece-marker.freekick {
            background: var(--accent-400);
            border: 2px solid rgba(255,255,255,0.9);
        }

        .aethelred-setpiece-marker.penalty {
            background: var(--primary-400);
            border: 2px solid rgba(255,255,255,0.9);
        }
    </style>
</head>
<body>
    <div class="bg">
        <div class="bg-overlay"></div>
    </div>
    
    <!-- Header with Date-Time Button -->
    <div class="header" ondblclick="toggleSingleView()">
        <div class="header-content">
            <div class="team-badge">
                <div class="badge-rim"></div>
            </div>
            <div class="team-section">
                <div class="team-info">
                    <div class="team-name">Manchester United</div>
                </div>
            </div>
            <div class="header-right-buttons">
                <button class="date-time-btn" onclick="advanceTime()">
                    <span class="date">15 August 2024</span>
                    <span class="time">14:30</span>
                </button>
            </div>
        </div>
    </div>

    <!-- Navigation with Continue Button -->
    <nav class="nav-container">
        <div class="nav-content">
            <div class="nav-tabs">
                <button class="nav-tab active" onclick="switchTab('overview', this)">Overview</button>
                <button class="nav-tab" onclick="switchTab('squad', this)">Squad</button>
                <button class="nav-tab" onclick="switchTab('tactics', this)">Tactics</button>
                <button class="nav-tab" onclick="switchTab('training', this)">Training</button>
                <button class="nav-tab" onclick="switchTab('transfers', this)">Transfers</button>
                <button class="nav-tab" onclick="switchTab('finances', this)">Finances</button>
                <button class="nav-tab" onclick="switchTab('fixtures', this)">Fixtures</button>
            </div>
            <div class="nav-right">
                <button class="continue-btn" onclick="continueSim()">CONTINUE</button>
            </div>
        </div>
    </nav>

    <!-- Submenus for all navigation items -->
    <div class="nav-submenu" id="overview-submenu">
        <div class="submenu-content">
            <span class="submenu-item active">Dashboard</span>
            <span class="submenu-item">Reports</span>
            <span class="submenu-item">Statistics</span>
            <span class="submenu-item">News</span>
            <span class="submenu-item">Inbox</span>
        </div>
    </div>

    <div class="nav-submenu" id="squad-submenu">
        <div class="submenu-content">
            <span class="submenu-item active">First Team</span>
            <span class="submenu-item">Reserves</span>
            <span class="submenu-item">Youth</span>
            <span class="submenu-item">Staff</span>
            <span class="submenu-item">Reports</span>
            <span class="submenu-item">Dynamics</span>
        </div>
    </div>

    <div class="nav-submenu" id="tactics-submenu">
        <div class="submenu-content">
            <span class="submenu-item active">Formation</span>
            <span class="submenu-item">Instructions</span>
            <span class="submenu-item">Set Pieces</span>
            <span class="submenu-item">Opposition</span>
            <span class="submenu-item">Analysis</span>
        </div>
    </div>

    <div class="nav-submenu" id="training-submenu">
        <div class="submenu-content">
            <span class="submenu-item active">Schedule</span>
            <span class="submenu-item">Individual</span>
            <span class="submenu-item">Coaches</span>
            <span class="submenu-item">Facilities</span>
            <span class="submenu-item">Reports</span>
        </div>
    </div>

    <div class="nav-submenu" id="transfers-submenu">
        <div class="submenu-content">
            <span class="submenu-item active">Transfer Hub</span>
            <span class="submenu-item">Scout Reports</span>
            <span class="submenu-item">Shortlist</span>
            <span class="submenu-item">Loans</span>
            <span class="submenu-item">Contract Offers</span>
            <span class="submenu-item">Director</span>
        </div>
    </div>

    <div class="nav-submenu" id="finances-submenu">
        <div class="submenu-content">
            <span class="submenu-item active">Overview</span>
            <span class="submenu-item">Income</span>
            <span class="submenu-item">Expenditure</span>
            <span class="submenu-item">FFP</span>
            <span class="submenu-item">Projections</span>
            <span class="submenu-item">Sponsors</span>
        </div>
    </div>

    <div class="nav-submenu" id="fixtures-submenu">
        <div class="submenu-content">
            <span class="submenu-item active">Calendar</span>
            <span class="submenu-item">Results</span>
            <span class="submenu-item">Schedule</span>
            <span class="submenu-item">Rules</span>
            <span class="submenu-item">History</span>
        </div>
    </div>

    <!-- Main Container -->
    <div class="app-container">
        <div class="main-panel">
            <!-- Card Indicators -->
            <div class="card-indicators" id="cardIndicators">
                <!-- Populated dynamically -->
            </div>

            <!-- Overview Page -->
            <div class="content-page active" id="overview-page" data-current-view="grid">
                <!-- Grid View -->
                <div class="view-container active" id="overview-grid-view">
                    <div class="tile-container">
                        <!-- Cards will be loaded here -->
                    </div>
                </div>
                
                <!-- Single View -->
                <div class="view-container" id="overview-single-view">
                    <div class="tile-container layout-single">
                        <!-- Single card displayed here -->
                    </div>
                </div>
            </div>

            <!-- Squad Page -->
            <div class="content-page" id="squad-page" data-current-view="grid">
                <div class="view-container active" id="squad-grid-view">
                    <div class="tile-container">
                        <!-- Squad cards -->
                    </div>
                </div>
                <div class="view-container" id="squad-single-view">
                    <div class="tile-container layout-single"></div>
                </div>
            </div>

            <!-- Tactics Page -->
            <div class="content-page" id="tactics-page" data-current-view="grid">
                <div class="view-container active" id="tactics-grid-view">
                    <div class="tile-container">
                        <!-- Tactics cards -->
                    </div>
                </div>
                <div class="view-container" id="tactics-single-view">
                    <div class="tile-container layout-single"></div>
                </div>
            </div>

            <!-- Training Page -->
            <div class="content-page" id="training-page" data-current-view="grid">
                <div class="view-container active" id="training-grid-view">
                    <div class="tile-container">
                        <!-- Training cards -->
                    </div>
                </div>
                <div class="view-container" id="training-single-view">
                    <div class="tile-container layout-single"></div>
                </div>
            </div>

            <!-- Transfers Page -->
            <div class="content-page" id="transfers-page" data-current-view="grid">
                <div class="view-container active" id="transfers-grid-view">
                    <div class="tile-container">
                        <!-- Transfer cards -->
                    </div>
                </div>
                <div class="view-container" id="transfers-single-view">
                    <div class="tile-container layout-single"></div>
                </div>
            </div>

            <!-- Finances Page -->
            <div class="content-page" id="finances-page" data-current-view="grid">
                <div class="view-container active" id="finances-grid-view">
                    <div class="tile-container">
                        <!-- Finance cards -->
                    </div>
                </div>
                <div class="view-container" id="finances-single-view">
                    <div class="tile-container layout-single"></div>
                </div>
            </div>

            <!-- Fixtures Page -->
            <div class="content-page" id="fixtures-page" data-current-view="grid">
                <div class="view-container active" id="fixtures-grid-view">
                    <div class="tile-container">
                        <!-- Fixture cards -->
                    </div>
                </div>
                <div class="view-container" id="fixtures-single-view">
                    <div class="tile-container layout-single"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Hamburger Menu FAB -->
    <div class="settings-fab" onclick="toggleMenu()">
        <svg viewBox="0 0 24 24">
            <path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2"/>
        </svg>
    </div>
    
    <!-- Hamburger Menu Dropdown -->
    <div class="hamburger-menu" id="hamburgerMenu">
        <div class="menu-item" onclick="goToMainMenu()">
            <svg viewBox="0 0 24 24" width="20" height="20">
                <path fill="currentColor" d="M10,20V14H14V20H19V12H22L12,3L2,12H5V20H10Z"/>
            </svg>
            <span>Main Menu</span>
        </div>
        <div class="menu-divider"></div>
        <div class="menu-item" onclick="loadLayout()">
            <svg viewBox="0 0 24 24" width="20" height="20">
                <path fill="currentColor" d="M14,2H6A2,2 0 0,0 4,4V20A2,2 0 0,0 6,22H18A2,2 0 0,0 20,20V8L14,2M18,20H6V4H13V9H18V20M12,11L8,15H10.5V19H13.5V15H16L12,11Z"/>
            </svg>
            <span>Load</span>
        </div>
        <div class="menu-item" onclick="saveLayout()">
            <svg viewBox="0 0 24 24" width="20" height="20">
                <path fill="currentColor" d="M15,9H5V5H15M12,19A3,3 0 0,1 9,16A3,3 0 0,1 12,13A3,3 0 0,1 15,16A3,3 0 0,1 12,19M17,3H5C3.89,3 3,3.9 3,5V19A2,2 0 0,0 5,21H19A2,2 0 0,0 21,19V7L17,3Z"/>
            </svg>
            <span>Save</span>
        </div>
        <div class="menu-item" onclick="saveAsLayout()">
            <svg viewBox="0 0 24 24" width="20" height="20">
                <path fill="currentColor" d="M15,9H5V5H15M12,19A3,3 0 0,1 9,16A3,3 0 0,1 12,13A3,3 0 0,1 15,16A3,3 0 0,1 12,19M17,3H5C3.89,3 3,3.9 3,5V19A2,2 0 0,0 5,21H19A2,2 0 0,0 21,19V7L17,3M19,19H5V5H16.17L19,7.83V19Z"/>
            </svg>
            <span>Save As</span>
        </div>
        <div class="menu-divider"></div>
        <div class="menu-item" onclick="openSettings()">
            <svg viewBox="0 0 24 24" width="20" height="20">
                <path fill="currentColor" d="M12,15.5A3.5,3.5 0 0,1 8.5,12A3.5,3.5 0 0,1 12,8.5A3.5,3.5 0 0,1 15.5,12A3.5,3.5 0 0,1 12,15.5M19.43,12.97C19.47,12.65 19.5,12.33 19.5,12C19.5,11.67 19.47,11.34 19.43,11L21.54,9.37C21.73,9.22 21.78,8.95 21.66,8.73L19.66,5.27C19.54,5.05 19.27,4.96 19.05,5.05L16.56,6.05C16.04,5.66 15.5,5.32 14.87,5.07L14.5,2.42C14.46,2.18 14.25,2 14,2H10C9.75,2 9.54,2.18 9.5,2.42L9.13,5.07C8.5,5.32 7.96,5.66 7.44,6.05L4.95,5.05C4.73,4.96 4.46,5.05 4.34,5.27L2.34,8.73C2.21,8.95 2.27,9.22 2.46,9.37L4.57,11C4.53,11.34 4.5,11.67 4.5,12C4.5,12.33 4.53,12.65 4.57,12.97L2.46,14.63C2.27,14.78 2.21,15.05 2.34,15.27L4.34,18.73C4.46,18.95 4.73,19.03 4.95,18.95L7.44,17.94C7.96,18.34 8.5,18.68 9.13,18.93L9.5,21.58C9.54,21.82 9.75,22 10,22H14C14.25,22 14.46,21.82 14.5,21.58L14.87,18.93C15.5,18.67 16.04,18.34 16.56,17.94L19.05,18.95C19.27,19.03 19.54,18.95 19.66,18.73L21.66,15.27C21.78,15.05 21.73,14.78 21.54,14.63L19.43,12.97Z"/>
            </svg>
            <span>Settings</span>
        </div>
        <div class="menu-divider"></div>
        <div class="menu-item" onclick="exitApp()">
            <svg viewBox="0 0 24 24" width="20" height="20">
                <path fill="currentColor" d="M19,3H5C3.89,3 3,3.89 3,5V9H5V5H19V19H5V15H3V19A2,2 0 0,0 5,21H19A2,2 0 0,0 21,19V5C21,3.89 20.1,3 19,3M10.08,15.58L11.5,17L16.5,12L11.5,7L10.08,8.41L12.67,11H3V13H12.67L10.08,15.58Z"/>
            </svg>
            <span>Exit</span>
        </div>
    </div>

    <!-- Settings Dialog -->
    <div class="overlay" onclick="closeSettings()"></div>
    <div class="settings-dialog">
        <div class="settings-header">
            <span class="settings-title">Settings</span>
            <button class="settings-close" onclick="closeSettings()">×</button>
        </div>
        <div class="settings-content">
            <div class="settings-group">
                <div class="settings-group-title">Display</div>
                <div class="setting-item">
                    <span class="setting-label">Dark Mode</span>
                    <input type="checkbox" checked>
                </div>
                <div class="setting-item">
                    <span class="setting-label">Animations</span>
                    <input type="checkbox" checked>
                </div>
            </div>
            <div class="settings-group">
                <div class="settings-group-title">Style Theme</div>
                <div class="setting-item">
                    <span class="setting-label">Classic (v16)</span>
                    <input type="radio" name="theme" checked>
                </div>
                <div class="setting-item">
                    <span class="setting-label">Dark Experimental</span>
                    <input type="radio" name="theme">
                </div>
            </div>
        </div>
    </div>

    <script>
        // ========================================
        // AETHELRED DESIGN SYSTEM - newPlan.md Components
        // ========================================
        
        /**
         * StatRow Component (newPlan.md Widget 1.1)
         * Purpose: To display a single key-value pair of information with consistent styling
         * Data Contract: {label: string, value: string | number, valueType: 'positive' | 'negative' | 'warning' | 'neutral'}
         */
        class AethelredStatRow {
            constructor(data) {
                this.validateData(data);
                this.label = data.label;
                this.value = data.value;
                this.valueType = data.valueType || 'neutral';
            }
            
            validateData(data) {
                if (!data || typeof data.label !== 'string' || (data.value === undefined || data.value === null)) {
                    throw new Error('StatRow requires label (string) and value (string|number)');
                }
                if (data.valueType && !['positive', 'negative', 'warning', 'neutral'].includes(data.valueType)) {
                    throw new Error('StatRow valueType must be one of: positive, negative, warning, neutral');
                }
            }
            
            render() {
                const valueClass = this.valueType ? this.valueType : 'neutral';
                return `
                    <div class="aethelred-stat-row">
                        <span class="aethelred-stat-label">${this.label}</span>
                        <span class="aethelred-stat-value ${valueClass}">${this.value}</span>
                    </div>
                `;
            }
            
            static renderMultiple(dataArray) {
                if (!Array.isArray(dataArray)) {
                    throw new Error('StatRow.renderMultiple requires an array of data objects');
                }
                return dataArray.map(data => new AethelredStatRow(data).render()).join('');
            }
        }

        /**
         * SummaryStatCard Component (newPlan.md Card 1.2)
         * Purpose: To display a collection of primary KPIs for a specific game area
         * Data Contract: {header: {title: string}, body: {contentType: 'StatRowList', contentData: [StatRow data contracts]}}
         */
        class AethelredSummaryStatCard {
            constructor(data) {
                this.validateData(data);
                this.header = data.header;
                this.body = data.body;
            }
            
            validateData(data) {
                if (!data || !data.header || typeof data.header.title !== 'string') {
                    throw new Error('SummaryStatCard requires header.title (string)');
                }
                if (!data.body || data.body.contentType !== 'StatRowList' || !Array.isArray(data.body.contentData)) {
                    throw new Error('SummaryStatCard requires body.contentType="StatRowList" and body.contentData (array)');
                }
                
                // Validate each StatRow data contract
                data.body.contentData.forEach((statData, index) => {
                    try {
                        new AethelredStatRow(statData);
                    } catch (error) {
                        throw new Error(`SummaryStatCard StatRow at index ${index}: ${error.message}`);
                    }
                });
            }
            
            render() {
                const statRowsHtml = AethelredStatRow.renderMultiple(this.body.contentData);
                
                return `
                    <div class="aethelred-card-header">
                        <span>${this.header.title}</span>
                    </div>
                    <div class="aethelred-card-body">
                        ${statRowsHtml}
                    </div>
                `;
            }
            
            static createFinancialOverview() {
                // Example implementation as specified in newPlan.md
                return new AethelredSummaryStatCard({
                    header: { title: 'Financial Overview' },
                    body: {
                        contentType: 'StatRowList',
                        contentData: [
                            { label: 'Transfer Budget', value: '£45M', valueType: 'neutral' },
                            { label: 'Wage Budget', value: '£2.3M/week', valueType: 'neutral' },
                            { label: 'FFP Status', value: 'Compliant', valueType: 'positive' }
                        ]
                    }
                });
            }
        }

        /**
         * MiniTable Component (newPlan.md Widget 2.1)
         * Purpose: To display structured, tabular data within a card. Used for simple lists where columns are important.
         * Data Contract: {headers: [string, string, ...], rows: [[string | number, string | number, ...], ...]}
         */
        class AethelredMiniTable {
            constructor(data) {
                this.validateData(data);
                this.headers = data.headers;
                this.rows = data.rows;
            }
            
            validateData(data) {
                if (!data || !Array.isArray(data.headers) || data.headers.length === 0) {
                    throw new Error('MiniTable requires headers (non-empty array of strings)');
                }
                if (!Array.isArray(data.rows)) {
                    throw new Error('MiniTable requires rows (array of arrays)');
                }
                
                // Validate that all headers are strings
                data.headers.forEach((header, index) => {
                    if (typeof header !== 'string') {
                        throw new Error(`MiniTable header at index ${index} must be a string`);
                    }
                });
                
                // Validate that all rows have the correct number of columns
                const expectedColumns = data.headers.length;
                data.rows.forEach((row, rowIndex) => {
                    if (!Array.isArray(row) || row.length !== expectedColumns) {
                        throw new Error(`MiniTable row at index ${rowIndex} must have ${expectedColumns} columns`);
                    }
                });
            }
            
            render() {
                const headerHtml = this.headers.map(header => `<th>${header}</th>`).join('');
                const rowsHtml = this.rows.map(row => {
                    const cellsHtml = row.map(cell => `<td>${cell}</td>`).join('');
                    return `<tr>${cellsHtml}</tr>`;
                }).join('');
                
                return `
                    <table class="aethelred-mini-table">
                        <thead>
                            <tr>${headerHtml}</tr>
                        </thead>
                        <tbody>
                            ${rowsHtml}
                        </tbody>
                    </table>
                `;
            }
        }

        /**
         * RosterCard Component (newPlan.md Card 2.2)
         * Purpose: To display a list of players or staff with key summary stats. This is one of the most critical components.
         * Data Contract: {header: {title: string}, body: {contentType: 'DataTable', contentData: {headers: [...], rows: [...]}}}
         */
        class AethelredRosterCard {
            constructor(data) {
                this.validateData(data);
                this.header = data.header;
                this.body = data.body;
            }
            
            validateData(data) {
                if (!data || !data.header || typeof data.header.title !== 'string') {
                    throw new Error('RosterCard requires header.title (string)');
                }
                if (!data.body || data.body.contentType !== 'DataTable') {
                    throw new Error('RosterCard requires body.contentType="DataTable"');
                }
                if (!data.body.contentData || !data.body.contentData.headers || !data.body.contentData.rows) {
                    throw new Error('RosterCard requires body.contentData.headers and body.contentData.rows');
                }
                
                // Validate the nested MiniTable data structure
                try {
                    new AethelredMiniTable(data.body.contentData);
                } catch (error) {
                    throw new Error(`RosterCard DataTable validation failed: ${error.message}`);
                }
            }
            
            render() {
                const { headers, rows } = this.body.contentData;
                
                const headerHtml = headers.map(header => `<th>${header}</th>`).join('');
                const rowsHtml = rows.map(row => {
                    const cellsHtml = row.map(cell => `<td>${cell}</td>`).join('');
                    return `<tr>${cellsHtml}</tr>`;
                }).join('');
                
                return `
                    <div class="aethelred-card-header">
                        <span>${this.header.title}</span>
                    </div>
                    <div class="aethelred-card-body">
                        <table class="aethelred-data-table">
                            <thead>
                                <tr>${headerHtml}</tr>
                            </thead>
                            <tbody>
                                ${rowsHtml}
                            </tbody>
                        </table>
                    </div>
                `;
            }
            
            static createFirstTeamSquad() {
                // Example implementation as specified in newPlan.md
                return new AethelredRosterCard({
                    header: { title: 'First Team Squad' },
                    body: {
                        contentType: 'DataTable',
                        contentData: {
                            headers: ['Name', 'Pos', 'Age', 'Nat', 'Avg', 'Value'],
                            rows: [
                                ['Andre Onana', 'GK', 28, 'CMR', 7.4, '£40M'],
                                ['Diogo Dalot', 'RB', 25, 'POR', 7.2, '£35M'],
                                ['Raphael Varane', 'CB', 31, 'FRA', 7.5, '£35M'],
                                ['Lisandro Martinez', 'CB', 26, 'ARG', 7.6, '£55M'],
                                ['Luke Shaw', 'LB', 29, 'ENG', 7.3, '£28M'],
                                ['Casemiro', 'DM', 32, 'BRA', 7.5, '£45M'],
                                ['Kobbie Mainoo', 'CM', 19, 'ENG', 7.3, '£40M'],
                                ['Bruno Fernandes', 'AM', 29, 'POR', 8.2, '£75M'],
                                ['Marcus Rashford', 'LW', 26, 'ENG', 7.8, '£85M'],
                                ['Alejandro Garnacho', 'RW', 20, 'ARG', 7.4, '£50M'],
                                ['Rasmus Hojlund', 'ST', 21, 'DEN', 7.2, '£65M']
                            ]
                        }
                    }
                });
            }
        }

        /**
         * StatBar Component (newPlan.md Widget 3.1)
         * Purpose: To visually represent a value as a percentage of a whole.
         * Data Contract: {value: number, maxValue: number, status: 'high' | 'medium' | 'low'}
         */
        class AethelredStatBar {
            constructor(data) {
                this.validateData(data);
                this.value = data.value;
                this.maxValue = data.maxValue;
                this.status = data.status;
            }
            
            validateData(data) {
                if (!data || typeof data.value !== 'number' || typeof data.maxValue !== 'number') {
                    throw new Error('StatBar requires value (number) and maxValue (number)');
                }
                if (data.maxValue <= 0) {
                    throw new Error('StatBar maxValue must be greater than 0');
                }
                if (data.value < 0) {
                    throw new Error('StatBar value cannot be negative');
                }
                if (data.status && !['high', 'medium', 'low'].includes(data.status)) {
                    throw new Error('StatBar status must be one of: high, medium, low');
                }
            }
            
            render() {
                const percentage = Math.min(100, (this.value / this.maxValue) * 100);
                const statusClass = this.status ? this.status : 'medium';
                
                return `
                    <div class="aethelred-stat-bar">
                        <div class="aethelred-stat-bar-fill ${statusClass}" style="width: ${percentage}%"></div>
                    </div>
                `;
            }
            
            renderWithLabel(label, valueText) {
                const percentage = Math.min(100, (this.value / this.maxValue) * 100);
                const statusClass = this.status ? this.status : 'medium';
                
                return `
                    <div class="aethelred-stat-bar-row">
                        <span class="aethelred-stat-label">${label}</span>
                        <div class="aethelred-stat-bar">
                            <div class="aethelred-stat-bar-fill ${statusClass}" style="width: ${percentage}%"></div>
                        </div>
                        <span class="aethelred-stat-value">${valueText || this.value + '%'}</span>
                    </div>
                `;
            }
        }

        /**
         * TeamCohesionCard Component (newPlan.md Card 3.2)
         * Purpose: To provide a visual summary of team dynamics using mixed StatRow and StatBar components.
         * Data Contract: {header: {title: string}, body: {contentType: 'MixedStatList', contentData: [{type: 'StatBarRow'|'StatRow', data: {...}}]}}
         */
        class AethelredTeamCohesionCard {
            constructor(data) {
                this.validateData(data);
                this.header = data.header;
                this.body = data.body;
            }
            
            validateData(data) {
                if (!data || !data.header || typeof data.header.title !== 'string') {
                    throw new Error('TeamCohesionCard requires header.title (string)');
                }
                if (!data.body || data.body.contentType !== 'MixedStatList' || !Array.isArray(data.body.contentData)) {
                    throw new Error('TeamCohesionCard requires body.contentType="MixedStatList" and body.contentData (array)');
                }
                
                // Validate each mixed content item
                data.body.contentData.forEach((item, index) => {
                    if (!item || !item.type || !item.data) {
                        throw new Error(`TeamCohesionCard item at index ${index} requires type and data properties`);
                    }
                    
                    if (item.type === 'StatRow') {
                        try {
                            new AethelredStatRow(item.data);
                        } catch (error) {
                            throw new Error(`TeamCohesionCard StatRow at index ${index}: ${error.message}`);
                        }
                    } else if (item.type === 'StatBarRow') {
                        if (!item.data.label || !item.data.bar) {
                            throw new Error(`TeamCohesionCard StatBarRow at index ${index} requires label and bar properties`);
                        }
                        try {
                            new AethelredStatBar(item.data.bar);
                        } catch (error) {
                            throw new Error(`TeamCohesionCard StatBarRow at index ${index}: ${error.message}`);
                        }
                    } else {
                        throw new Error(`TeamCohesionCard item at index ${index} has invalid type: ${item.type}. Must be 'StatRow' or 'StatBarRow'`);
                    }
                });
            }
            
            render() {
                const contentHtml = this.body.contentData.map(item => {
                    if (item.type === 'StatRow') {
                        const statRow = new AethelredStatRow(item.data);
                        return statRow.render();
                    } else if (item.type === 'StatBarRow') {
                        const statBar = new AethelredStatBar(item.data.bar);
                        return statBar.renderWithLabel(item.data.label, item.data.valueText);
                    }
                    return '';
                }).join('');
                
                return `
                    <div class="aethelred-card-header">
                        <span>${this.header.title}</span>
                    </div>
                    <div class="aethelred-card-body">
                        ${contentHtml}
                    </div>
                `;
            }
            
            static createExample() {
                // Example implementation as specified in newPlan.md
                return new AethelredTeamCohesionCard({
                    header: { title: 'Team Cohesion' },
                    body: {
                        contentType: 'MixedStatList',
                        contentData: [
                            { 
                                type: 'StatBarRow', 
                                data: { 
                                    label: 'Unity',
                                    bar: { value: 85, maxValue: 100, status: 'high' },
                                    valueText: '85%'
                                }
                            },
                            { 
                                type: 'StatRow', 
                                data: { label: 'Social Groups', value: 4 }
                            },
                            { 
                                type: 'StatRow', 
                                data: { label: 'Happy Players', value: '22/28', valueType: 'positive' }
                            }
                        ]
                    }
                });
            }
        }

        /**
         * FormationCard Component (newPlan.md Card 3.3)
         * Purpose: To visually represent the team's current tactical formation. This is a highly specialized component.
         * Data Contract: {header: {title: string}, body: {contentType: 'FormationDisplay', contentData: {formationName, tacticName, familiarity, players: [...]}}}
         */
        class AethelredFormationCard {
            constructor(data) {
                this.validateData(data);
                this.header = data.header;
                this.body = data.body;
            }
            
            validateData(data) {
                if (!data || !data.header || typeof data.header.title !== 'string') {
                    throw new Error('FormationCard requires header.title (string)');
                }
                if (!data.body || data.body.contentType !== 'FormationDisplay') {
                    throw new Error('FormationCard requires body.contentType="FormationDisplay"');
                }
                
                const contentData = data.body.contentData;
                if (!contentData || 
                    typeof contentData.formationName !== 'string' ||
                    typeof contentData.tacticName !== 'string' ||
                    typeof contentData.familiarity !== 'number' ||
                    !Array.isArray(contentData.players)) {
                    throw new Error('FormationCard requires formationName, tacticName (strings), familiarity (number), and players (array)');
                }
                
                // Validate each player
                contentData.players.forEach((player, index) => {
                    if (!player || 
                        typeof player.name !== 'string' ||
                        typeof player.position !== 'string' ||
                        !player.coords ||
                        typeof player.coords.x !== 'number' ||
                        typeof player.coords.y !== 'number') {
                        throw new Error(`FormationCard player at index ${index} requires name, position (strings) and coords {x, y} (numbers)`);
                    }
                    
                    if (player.coords.x < 0 || player.coords.x > 1 || player.coords.y < 0 || player.coords.y > 1) {
                        throw new Error(`FormationCard player at index ${index} coords must be between 0 and 1`);
                    }
                });
            }
            
            getPositionClass(position) {
                const pos = position.toUpperCase();
                if (pos === 'GK') return 'goalkeeper';
                if (['CB', 'LB', 'RB', 'WB', 'LWB', 'RWB'].includes(pos)) return 'defender';
                if (['CM', 'DM', 'AM', 'LM', 'RM'].includes(pos)) return 'midfielder';
                if (['ST', 'CF', 'LW', 'RW', 'LF', 'RF'].includes(pos)) return 'forward';
                return 'midfielder'; // Default
            }
            
            getPlayerInitials(name) {
                return name.split(' ')
                    .map(n => n.charAt(0).toUpperCase())
                    .slice(0, 2)
                    .join('');
            }
            
            render() {
                const { formationName, tacticName, familiarity, players } = this.body.contentData;
                
                const playersHtml = players.map(player => {
                    const positionClass = this.getPositionClass(player.position);
                    const initials = this.getPlayerInitials(player.name);
                    const leftPercent = player.coords.x * 100;
                    // Invert Y coordinate so 0 = top (goalkeeper area), 1 = bottom (attacking area)
                    const topPercent = (1 - player.coords.y) * 100;
                    
                    return `
                        <div class="aethelred-player-marker ${positionClass}" 
                             style="left: ${leftPercent}%; top: ${topPercent}%;"
                             title="${player.name} (${player.position})">
                            ${initials}
                        </div>
                    `;
                }).join('');
                
                return `
                    <div class="aethelred-card-header">
                        <span>${this.header.title}</span>
                    </div>
                    <div class="aethelred-card-body">
                        <div class="aethelred-formation-display">
                            <div class="aethelred-formation-header">
                                <div class="aethelred-formation-tactic">${tacticName}</div>
                                <div class="aethelred-formation-name">${formationName}</div>
                            </div>
                            <div class="aethelred-pitch">
                                <div class="aethelred-pitch-goals"></div>
                                <div class="aethelred-pitch-penalty"></div>
                                ${playersHtml}
                            </div>
                            <div class="aethelred-formation-familiarity">
                                Familiarity: <span class="percentage">${familiarity}%</span>
                            </div>
                        </div>
                    </div>
                `;
            }
            
            static createExample() {
                // Fixed positioning - goalkeeper at top, strikers at bottom
                return new AethelredFormationCard({
                    header: { title: 'Formation' },
                    body: {
                        contentType: 'FormationDisplay',
                        contentData: {
                            formationName: '4-2-3-1 Wide',
                            tacticName: 'Fluid Counter-Attack',
                            familiarity: 95,
                            players: [
                                { name: 'Onana', position: 'GK', coords: {x: 0.5, y: 0.95} },
                                { name: 'Dalot', position: 'RB', coords: {x: 0.85, y: 0.75} },
                                { name: 'Varane', position: 'CB', coords: {x: 0.65, y: 0.75} },
                                { name: 'Martinez', position: 'CB', coords: {x: 0.35, y: 0.75} },
                                { name: 'Shaw', position: 'LB', coords: {x: 0.15, y: 0.75} },
                                { name: 'Casemiro', position: 'DM', coords: {x: 0.4, y: 0.55} },
                                { name: 'Mainoo', position: 'DM', coords: {x: 0.6, y: 0.55} },
                                { name: 'Garnacho', position: 'LW', coords: {x: 0.2, y: 0.35} },
                                { name: 'Bruno', position: 'AM', coords: {x: 0.5, y: 0.35} },
                                { name: 'Antony', position: 'RW', coords: {x: 0.8, y: 0.35} },
                                { name: 'Hojlund', position: 'ST', coords: {x: 0.5, y: 0.15} }
                            ]
                        }
                    }
                });
            }
        }

        /**
         * PrimaryNav Component (newPlan.md Widget 4.1)
         * Purpose: The main navigation bar for switching between top-level game screens.
         * Data Contract: {tabs: [string...], activeTab: string}
         */
        class AethelredPrimaryNav {
            constructor(data, container) {
                this.validateData(data);
                this.tabs = data.tabs;
                this.activeTab = data.activeTab;
                this.container = container;
                this.eventListeners = {};
            }
            
            validateData(data) {
                if (!data || !Array.isArray(data.tabs) || data.tabs.length === 0) {
                    throw new Error('PrimaryNav requires tabs (non-empty array of strings)');
                }
                if (!data.activeTab || typeof data.activeTab !== 'string') {
                    throw new Error('PrimaryNav requires activeTab (string)');
                }
                if (!data.tabs.includes(data.activeTab)) {
                    throw new Error('PrimaryNav activeTab must be one of the tabs');
                }
                
                // Validate all tabs are strings
                data.tabs.forEach((tab, index) => {
                    if (typeof tab !== 'string') {
                        throw new Error(`PrimaryNav tab at index ${index} must be a string`);
                    }
                });
            }
            
            on(eventType, callback) {
                if (!this.eventListeners[eventType]) {
                    this.eventListeners[eventType] = [];
                }
                this.eventListeners[eventType].push(callback);
            }
            
            emit(eventType, data) {
                if (this.eventListeners[eventType]) {
                    this.eventListeners[eventType].forEach(callback => callback(data));
                }
            }
            
            handleTabClick(tabName) {
                if (tabName !== this.activeTab) {
                    this.activeTab = tabName;
                    this.emit('TabSelected', tabName);
                    this.render(); // Re-render to update active state
                }
            }
            
            render() {
                if (!this.container) return '';
                
                const tabsHtml = this.tabs.map(tab => {
                    const activeClass = tab === this.activeTab ? ' active' : '';
                    return `<button class="nav-tab${activeClass}" onclick="primaryNavInstance.handleTabClick('${tab}')">${tab}</button>`;
                }).join('');
                
                this.container.innerHTML = tabsHtml;
                return tabsHtml;
            }
        }

        /**
         * SubMenuNav Component (newPlan.md Widget 4.2)
         * Purpose: A secondary navigation bar that appears contextually based on the primary selection.
         * Data Contract: {menus: {[primaryTab]: [string...]}, activePrimaryTab: string, activeSubMenu: string}
         */
        class AethelredSubMenuNav {
            constructor(data, container) {
                this.validateData(data);
                this.menus = data.menus;
                this.activePrimaryTab = data.activePrimaryTab;
                this.activeSubMenu = data.activeSubMenu;
                this.container = container;
                this.eventListeners = {};
            }
            
            validateData(data) {
                if (!data || typeof data.menus !== 'object' || data.menus === null) {
                    throw new Error('SubMenuNav requires menus (object)');
                }
                if (!data.activePrimaryTab || typeof data.activePrimaryTab !== 'string') {
                    throw new Error('SubMenuNav requires activePrimaryTab (string)');
                }
                if (!data.activeSubMenu || typeof data.activeSubMenu !== 'string') {
                    throw new Error('SubMenuNav requires activeSubMenu (string)');
                }
                
                // Validate menu structure
                Object.keys(data.menus).forEach(key => {
                    if (!Array.isArray(data.menus[key])) {
                        throw new Error(`SubMenuNav menu for '${key}' must be an array`);
                    }
                    data.menus[key].forEach((item, index) => {
                        if (typeof item !== 'string') {
                            throw new Error(`SubMenuNav menu item at ${key}[${index}] must be a string`);
                        }
                    });
                });
                
                // Validate that activeSubMenu exists in the current primary tab's menu (if menu exists)
                const currentMenu = data.menus[data.activePrimaryTab];
                if (currentMenu && !currentMenu.includes(data.activeSubMenu)) {
                    throw new Error(`SubMenuNav activeSubMenu '${data.activeSubMenu}' not found in menu for '${data.activePrimaryTab}'`);
                }
            }
            
            on(eventType, callback) {
                if (!this.eventListeners[eventType]) {
                    this.eventListeners[eventType] = [];
                }
                this.eventListeners[eventType].push(callback);
            }
            
            emit(eventType, data) {
                if (this.eventListeners[eventType]) {
                    this.eventListeners[eventType].forEach(callback => callback(data));
                }
            }
            
            handleSubMenuClick(subMenuName) {
                if (subMenuName !== this.activeSubMenu) {
                    this.activeSubMenu = subMenuName;
                    this.emit('SubMenuSelected', subMenuName);
                    this.render(); // Re-render to update active state
                }
            }
            
            updatePrimaryTab(primaryTab) {
                this.activePrimaryTab = primaryTab;
                // Reset to first submenu item if menu exists
                const currentMenu = this.menus[primaryTab];
                if (currentMenu && currentMenu.length > 0) {
                    this.activeSubMenu = currentMenu[0];
                }
                this.render();
            }
            
            render() {
                if (!this.container) return '';
                
                // Critical: render nothing if menus[activePrimaryTab] is undefined (newPlan.md specification)
                const currentMenu = this.menus[this.activePrimaryTab];
                if (!currentMenu) {
                    this.container.innerHTML = '';
                    this.container.style.display = 'none';
                    return '';
                }
                
                const itemsHtml = currentMenu.map(item => {
                    const activeClass = item === this.activeSubMenu ? ' active' : '';
                    return `<span class="submenu-item${activeClass}" onclick="subMenuNavInstance.handleSubMenuClick('${item}')">${item}</span>`;
                }).join('');
                
                this.container.innerHTML = `<div class="submenu-content">${itemsHtml}</div>`;
                this.container.style.display = 'flex';
                return itemsHtml;
            }
        }

        /**
         * SetPieceCard Component - FIXED FOR PROPER GOAL-RELATIVE POSITIONING
         * Purpose: To display set piece arrangements with proper goal positioning
         * Data Contract: {header: {title: string}, body: {contentType: 'SetPieceDisplay', contentData: {setPieceType, players: [...]}}}
         */
        class AethelredSetPieceCard {
            constructor(data) {
                this.validateData(data);
                this.header = data.header;
                this.body = data.body;
            }
            
            validateData(data) {
                if (!data || !data.header || typeof data.header.title !== 'string') {
                    throw new Error('SetPieceCard requires header.title (string)');
                }
                if (!data.body || data.body.contentType !== 'SetPieceDisplay') {
                    throw new Error('SetPieceCard requires body.contentType="SetPieceDisplay"');
                }
                
                const contentData = data.body.contentData;
                if (!contentData || !contentData.setPieceType || !Array.isArray(contentData.players)) {
                    throw new Error('SetPieceCard requires setPieceType (string) and players (array)');
                }
            }
            
            getSetPieceClass(setPieceType) {
                const type = setPieceType.toLowerCase();
                if (type.includes('corner')) return 'corner';
                if (type.includes('freekick') || type.includes('free kick')) return 'freekick';
                if (type.includes('penalty')) return 'penalty';
                return 'freekick';
            }
            
            render() {
                const { setPieceType, players } = this.body.contentData;
                const setPieceClass = this.getSetPieceClass(setPieceType);
                
                const playersHtml = players.map(player => {
                    const leftPercent = player.coords.x * 100;
                    const topPercent = player.coords.y * 100;
                    const initials = player.name.split(' ').map(n => n.charAt(0)).join('').toUpperCase();
                    
                    return `
                        <div class="aethelred-setpiece-marker ${setPieceClass}" 
                             style="left: ${leftPercent}%; top: ${topPercent}%;"
                             title="${player.name} (${player.role || player.position})">
                            ${initials}
                        </div>
                    `;
                }).join('');
                
                return `
                    <div class="aethelred-card-header">
                        <span>${this.header.title}</span>
                    </div>
                    <div class="aethelred-card-body">
                        <div class="aethelred-setpiece-display">
                            <div style="margin-bottom: 16px;">
                                <div style="font-size: var(--font-size-md); font-weight: 600; color: var(--primary-400);">${setPieceType}</div>
                            </div>
                            <div class="aethelred-setpiece-pitch">
                                <div class="aethelred-setpiece-goal"></div>
                                <div class="aethelred-setpiece-penalty"></div>
                                <div class="aethelred-setpiece-goal-area"></div>
                                ${playersHtml}
                            </div>
                        </div>
                    </div>
                `;
            }
            
            static createCornerExample() {
                return new AethelredSetPieceCard({
                    header: { title: 'Corner Kicks' },
                    body: {
                        contentType: 'SetPieceDisplay',
                        contentData: {
                            setPieceType: 'Corner Kick',
                            players: [
                                { name: 'Bruno', position: 'Taker', coords: {x: 0.9, y: 0.95} },
                                { name: 'Maguire', position: 'Near Post', coords: {x: 0.45, y: 0.15} },
                                { name: 'Varane', position: 'Far Post', coords: {x: 0.55, y: 0.15} },
                                { name: 'Casemiro', position: 'Penalty Spot', coords: {x: 0.5, y: 0.35} },
                                { name: 'Rashford', position: 'Edge of Box', coords: {x: 0.3, y: 0.5} },
                                { name: 'Antony', position: 'Edge of Box', coords: {x: 0.7, y: 0.5} }
                            ]
                        }
                    }
                });
            }
        }

        /**
         * Aethelred Component Factory System
         * Centralized system for creating components from data contracts
         * Supports all newPlan.md component types with validation and error handling
         */
        class AethelredComponentFactory {
            constructor() {
                this.componentTypes = {
                    'StatRow': AethelredStatRow,
                    'SummaryStatCard': AethelredSummaryStatCard,
                    'MiniTable': AethelredMiniTable,
                    'RosterCard': AethelredRosterCard,
                    'StatBar': AethelredStatBar,
                    'TeamCohesionCard': AethelredTeamCohesionCard,
                    'FormationCard': AethelredFormationCard,
                    'SetPieceCard': AethelredSetPieceCard,
                    'PrimaryNav': AethelredPrimaryNav,
                    'SubMenuNav': AethelredSubMenuNav
                };
            }
            
            /**
             * Create a component from its type and data contract
             * @param {string} componentType - The type of component to create
             * @param {object} data - The data contract for the component
             * @param {HTMLElement} container - Container element (for navigation components)
             * @returns {object} The created component instance
             */
            createComponent(componentType, data, container = null) {
                if (!this.componentTypes[componentType]) {
                    throw new Error(`Unknown component type: ${componentType}. Available types: ${Object.keys(this.componentTypes).join(', ')}`);
                }
                
                try {
                    const ComponentClass = this.componentTypes[componentType];
                    
                    // Navigation components require container
                    if (['PrimaryNav', 'SubMenuNav'].includes(componentType)) {
                        if (!container) {
                            throw new Error(`${componentType} requires a container element`);
                        }
                        return new ComponentClass(data, container);
                    } else {
                        return new ComponentClass(data);
                    }
                } catch (error) {
                    throw new Error(`Failed to create ${componentType}: ${error.message}`);
                }
            }
            
            /**
             * Create and render a component in one step
             * @param {string} componentType - The type of component to create
             * @param {object} data - The data contract for the component
             * @param {HTMLElement} container - Container element (for navigation components)
             * @returns {string} The rendered HTML
             */
            createAndRender(componentType, data, container = null) {
                const component = this.createComponent(componentType, data, container);
                return component.render();
            }
            
            /**
             * Validate a data contract for a specific component type
             * @param {string} componentType - The type of component to validate for
             * @param {object} data - The data contract to validate
             * @returns {boolean} True if valid, throws error if invalid
             */
            validateDataContract(componentType, data) {
                try {
                    this.createComponent(componentType, data);
                    return true;
                } catch (error) {
                    throw new Error(`Data contract validation failed for ${componentType}: ${error.message}`);
                }
            }
            
            /**
             * Get available component types
             * @returns {string[]} Array of available component type names
             */
            getAvailableTypes() {
                return Object.keys(this.componentTypes);
            }
            
            /**
             * Create example instances of all components (for testing/demonstration)
             * @returns {object} Object containing rendered examples of all components
             */
            createExamples() {
                const examples = {};
                
                try {
                    // StatRow example
                    examples.StatRow = new AethelredStatRow({
                        label: 'Transfer Budget',
                        value: '£45M',
                        valueType: 'positive'
                    }).render();
                    
                    // SummaryStatCard example (using newPlan.md Financial Overview)
                    examples.SummaryStatCard = AethelredSummaryStatCard.createFinancialOverview().render();
                    
                    // MiniTable example
                    examples.MiniTable = new AethelredMiniTable({
                        headers: ['Name', 'Position', 'Age'],
                        rows: [
                            ['Bruno Fernandes', 'AM', 29],
                            ['Marcus Rashford', 'LW', 26]
                        ]
                    }).render();
                    
                    // RosterCard example (using newPlan.md First Team Squad)
                    examples.RosterCard = AethelredRosterCard.createFirstTeamSquad().render();
                    
                    // StatBar example
                    examples.StatBar = new AethelredStatBar({
                        value: 85,
                        maxValue: 100,
                        status: 'high'
                    }).renderWithLabel('Unity', '85%');
                    
                    // TeamCohesionCard example (using exact newPlan.md example)
                    examples.TeamCohesionCard = AethelredTeamCohesionCard.createExample().render();
                    
                    // FormationCard example (using exact newPlan.md example)
                    examples.FormationCard = AethelredFormationCard.createExample().render();
                    
                } catch (error) {
                    console.error('Error creating component examples:', error);
                }
                
                return examples;
            }
        }

        // Global factory instance
        const AethelredFactory = new AethelredComponentFactory();

        // ========================================
        // GLOBAL GRID CONFIGURATION SYSTEM
        // ========================================
        
        // Read CSS variables and create a centralized configuration
        const GRID_CONFIG = (() => {
            const root = document.documentElement;
            const style = getComputedStyle(root);
            
            // Parse CSS variables
            const config = {
                // Grid dimensions
                columns: parseInt(style.getPropertyValue('--grid-columns')) || 37,
                rows: parseInt(style.getPropertyValue('--grid-rows')) || 19,
                cellSize: parseInt(style.getPropertyValue('--grid-cell-size')) || 32,
                gap: parseInt(style.getPropertyValue('--grid-gap')) || 8,
                paddingV: parseInt(style.getPropertyValue('--grid-padding-v')) || 18,
                paddingH: parseInt(style.getPropertyValue('--grid-padding-h')) || 16,
                
                // Container dimensions
                containerWidth: parseInt(style.getPropertyValue('--container-width')) || 1688,
                containerHeight: parseInt(style.getPropertyValue('--container-height')) || 735,
                
                // Card constraints (can be overridden via CSS variables)
                minCardWidth: parseInt(style.getPropertyValue('--min-card-width')) || 5,
                minCardHeight: parseInt(style.getPropertyValue('--min-card-height')) || 3,
                defaultCardWidth: parseInt(style.getPropertyValue('--default-card-width')) || 14,
                defaultCardHeight: parseInt(style.getPropertyValue('--default-card-height')) || 8,
                
                // Calculated values
                get cellSizeWithGap() {
                    return this.cellSize + this.gap;
                },
                get maxCSSClasses() {
                    // Determine how many CSS classes we need to generate
                    return {
                        width: Math.min(this.columns, 30), // Practical limit
                        height: Math.min(this.rows, 20)     // Practical limit
                    };
                },
                get gridPixelWidth() {
                    return this.columns * this.cellSizeWithGap - this.gap;
                },
                get gridPixelHeight() {
                    return this.rows * this.cellSizeWithGap - this.gap;
                }
            };
            
            // Log configuration for debugging
            console.log('Grid Configuration Loaded:', config);
            
            return config;
        })();
        
        // Page state management - isolated per page
        const pageStates = new Map();
        
        // Initialize page states
        ['overview', 'squad', 'tactics', 'training', 'transfers', 'finances', 'fixtures'].forEach(page => {
            pageStates.set(page, {
                currentView: 'grid',
                selectedCardIndex: 0,
                cards: []
            });
        });

        // Switch tabs
        function switchTab(tab, element) {
            // Update active nav
            document.querySelectorAll('.nav-tab').forEach(t => t.classList.remove('active'));
            element.classList.add('active');
            
            // Hide all pages
            document.querySelectorAll('.content-page').forEach(p => p.classList.remove('active'));
            
            // Show selected page
            const page = document.getElementById(tab + '-page');
            if (page) {
                page.classList.add('active');
                
                // Reset to that page's saved state
                const state = pageStates.get(tab);
                if (state.currentView === 'single') {
                    showSingleView(tab, state.selectedCardIndex);
                } else {
                    showGridView(tab);
                }
            }
            
            // Update submenu
            document.querySelectorAll('.nav-submenu').forEach(s => s.classList.remove('active'));
            const submenu = document.getElementById(tab + '-submenu');
            if (submenu) submenu.classList.add('active');
            
            // Load cards for this page
            loadPageCards(tab);
        }

        // Load cards for a specific page
        function loadPageCards(pageName) {
            const page = document.getElementById(pageName + '-page');
            const gridView = page.querySelector(`#${pageName}-grid-view .tile-container`);
            
            if (!gridView) return;
            
            // Clear existing cards
            gridView.innerHTML = '';
            
            // Get cards for this page
            const cards = getCardsForPage(pageName);
            pageStates.get(pageName).cards = cards;
            
            cards.forEach(cardData => {
                const card = createCardFromData(cardData, pageName);
                gridView.appendChild(card);
            });
        }

        // Define card size presets based on configuration
        function getCardSizePresets() {
            return {
                // Small cards for quick info
                small: { 
                    width: GRID_CONFIG.minCardWidth, 
                    height: GRID_CONFIG.minCardHeight 
                },
                // Standard cards for basic content - use minimum size
                standard: { 
                    width: GRID_CONFIG.minCardWidth, 
                    height: GRID_CONFIG.minCardHeight 
                },
                // Medium cards for more detailed info (10x6)
                medium: { 
                    width: 10, 
                    height: 6 
                },
                // Wide cards for tables and lists (12x6)
                wide: { 
                    width: 12, 
                    height: 6 
                },
                // Large cards for main content (12x8)
                large: { 
                    width: 12, 
                    height: 8 
                },
                // Tall cards for vertical lists (8x8)
                tall: { 
                    width: 8, 
                    height: 8 
                }
            };
        }

        // Get cards for a specific page
        function getCardsForPage(pageName) {
            const sizes = getCardSizePresets();
            
            const cardTemplates = {
                overview: [
                    { title: 'Match Preview', ...sizes.medium, content: generateMatchPreview() },
                    { title: 'Squad Summary', ...sizes.wide, content: generateSquadSummary() },
                    { title: 'League Table', ...sizes.tall, content: generateLeagueTable() },
                    { title: 'Financial Overview', ...sizes.standard, content: generateFinancialOverview() },
                    { title: 'Training Schedule', ...sizes.medium, content: generateTrainingSchedule() },
                    { title: 'Recent Form', ...sizes.standard, content: generateRecentForm() }
                ],
                squad: [
                    { title: 'First Team Squad', ...sizes.large, content: generateSquadList() },
                    { title: 'Player Stats', ...sizes.standard, content: generatePlayerStats() },
                    { title: 'Injury Report', ...sizes.standard, content: generateInjuryReport() },
                    { title: 'Morale', ...sizes.standard, content: generateMorale() }
                ],
                tactics: [
                    { title: 'Formation', ...sizes.wide, content: generateFormation() },
                    { title: 'Team Instructions', ...sizes.standard, content: generateInstructions() },
                    { title: 'Set Pieces', ...sizes.standard, content: generateSetPieces() },
                    { title: 'Opposition Instructions', ...sizes.standard, content: generateOpposition() }
                ],
                training: [
                    { title: 'Training Schedule', ...sizes.wide, content: generateTrainingSchedule() },
                    { title: 'Fitness Levels', ...sizes.standard, content: generateFitnessLevels() },
                    { title: 'Individual Focus', ...sizes.standard, content: generateIndividualTraining() }
                ],
                transfers: [
                    { title: 'Transfer Targets', ...sizes.wide, content: generateTransferTargets() },
                    { title: 'Transfer Budget', ...sizes.standard, content: generateTransferBudget() },
                    { title: 'Scout Reports', ...sizes.standard, content: generateScoutReports() }
                ],
                finances: [
                    { title: 'Revenue Streams', ...sizes.standard, content: generateRevenue() },
                    { title: 'Expenses', ...sizes.standard, content: generateExpenses() },
                    { title: 'Financial Forecast', ...sizes.wide, content: generateForecast() },
                    { title: 'FFP Status', ...sizes.standard, content: generateFFPStatus() }
                ],
                fixtures: [
                    { title: 'Upcoming Fixtures', ...sizes.wide, content: generateFixtures() },
                    { title: 'Recent Results', ...sizes.standard, content: generateResults() },
                    { title: 'Competition Progress', ...sizes.standard, content: generateCompetitions() }
                ]
            };
            
            return cardTemplates[pageName] || [];
        }

        // Create a card element - handles both object data and direct params
        function createCardFromData(cardData, pageName) {
            const card = document.createElement('div');
            // Apply width and height classes with configuration defaults
            const width = cardData.width || GRID_CONFIG.defaultCardWidth;
            const height = cardData.height || GRID_CONFIG.defaultCardHeight;
            card.className = `card w${width} h${height}`;
            card.setAttribute('data-grid-w', width);
            card.setAttribute('data-grid-h', height);
            card.draggable = false; // We use header dragging
            
            // Check if we're in single view to hide/show correct menu items
            const state = pageStates.get(pageName);
            const isExpanded = state && state.currentView === 'single';
            
            card.innerHTML = `
                <div class="card-header" ondblclick="expandCardFromHeader(this)">
                    <span>${cardData.title}</span>
                    <div class="card-menu">
                        <button class="card-menu-btn" onclick="toggleCardMenu(this, event)">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <circle cx="12" cy="12" r="1"/>
                                <circle cx="12" cy="12" r="5"/>
                            </svg>
                        </button>
                        <div class="card-menu-dropdown">
                            ${!isExpanded ? '<div class="card-menu-item" onclick="expandCard(this)">Expand</div>' : ''}
                            ${isExpanded ? '<div class="card-menu-item" onclick="restoreView(this)">Restore</div>' : ''}
                            <div class="card-menu-item" onclick="pinCard(this)">Pin</div>
                            <div class="card-menu-item" onclick="removeCard(this)">Remove</div>
                            <div class="card-menu-item" onclick="replaceCard(this)">Replace</div>
                            <div class="card-menu-item" onclick="bookmarkCard(this)">Bookmark</div>
                        </div>
                    </div>
                </div>
                <div class="card-body">
                    ${cardData.content}
                </div>
                <div class="resize-handle"></div>
            `;
            
            return card;
        }

        // Toggle card dropdown menu
        function toggleCardMenu(button, event) {
            event.stopPropagation();
            console.log('Card menu toggled');
            const dropdown = button.nextElementSibling;
            const allDropdowns = document.querySelectorAll('.card-menu-dropdown');
            
            allDropdowns.forEach(d => {
                if (d !== dropdown) d.classList.remove('active');
            });
            
            dropdown.classList.toggle('active');
            
            // Close on outside click
            setTimeout(() => {
                document.addEventListener('click', function closeDropdown(e) {
                    if (!button.contains(e.target) && !dropdown.contains(e.target)) {
                        dropdown.classList.remove('active');
                        document.removeEventListener('click', closeDropdown);
                    }
                });
            }, 0);
        }

        // Expand card to single view
        function expandCard(menuItem) {
            const card = menuItem.closest('.card');
            const cardTitle = card.querySelector('.card-header span')?.textContent || 'Unknown';
            console.log(`Expanding card: ${cardTitle}`);
            
            const page = card.closest('.content-page');
            const pageName = page.id.replace('-page', '');
            const gridView = page.querySelector(`#${pageName}-grid-view`);
            const cards = Array.from(gridView.querySelectorAll('.card'));
            const cardIndex = cards.indexOf(card);
            
            // Close dropdown
            const dropdown = menuItem.closest('.card-menu-dropdown');
            if (dropdown) dropdown.classList.remove('active');
            
            showSingleView(pageName, cardIndex);
        }

        // Expand from header double-click (or restore if already in single view)
        function expandCardFromHeader(header) {
            const card = header.closest('.card');
            const cardTitle = card.querySelector('.card-header span')?.textContent || 'Unknown';
            const page = card.closest('.content-page');
            const pageName = page.id.replace('-page', '');
            const state = pageStates.get(pageName);
            
            console.log(`Double-click on card: ${cardTitle}`);
            
            // If already in single view, restore to grid
            if (state.currentView === 'single') {
                console.log('Restoring to grid view');
                showGridView(pageName);
            } else {
                console.log('Expanding to single view');
                // Otherwise expand to single view
                const gridView = page.querySelector(`#${pageName}-grid-view`);
                const cards = Array.from(gridView.querySelectorAll('.card'));
                const cardIndex = cards.indexOf(card);
                showSingleView(pageName, cardIndex);
            }
        }

        // Restore view from carousel
        function restoreView(menuItem) {
            const page = menuItem.closest('.content-page');
            const pageName = page.id.replace('-page', '');
            
            // Close dropdown
            const dropdown = menuItem.closest('.card-menu-dropdown');
            if (dropdown) dropdown.classList.remove('active');
            
            showGridView(pageName);
        }

        // Show single view for a page
        function showSingleView(pageName, cardIndex) {
            const page = document.getElementById(pageName + '-page');
            const gridView = page.querySelector(`#${pageName}-grid-view`);
            const singleView = page.querySelector(`#${pageName}-single-view`);
            const state = pageStates.get(pageName);
            
            // Update state
            state.currentView = 'single';
            state.selectedCardIndex = cardIndex;
            
            // Hide grid, show single
            gridView.classList.remove('active');
            singleView.classList.add('active');
            
            // Create indicators
            const indicators = document.getElementById('cardIndicators');
            indicators.innerHTML = '';
            
            const cards = gridView.querySelectorAll('.card');
            cards.forEach((card, i) => {
                const indicator = document.createElement('div');
                indicator.className = 'card-indicator' + (i === cardIndex ? ' active' : '');
                indicator.textContent = i + 1;
                indicator.onclick = () => selectCard(pageName, i);
                
                // Add tooltip
                const tooltip = document.createElement('div');
                tooltip.className = 'card-indicator-tooltip';
                tooltip.textContent = card.querySelector('.card-header span').textContent;
                indicator.appendChild(tooltip);
                
                indicators.appendChild(indicator);
            });
            
            indicators.classList.add('active');
            
            // Clone card to single view
            const singleContainer = singleView.querySelector('.tile-container');
            singleContainer.innerHTML = '';
            const selectedCard = cards[cardIndex];
            if (selectedCard) {
                const clonedCard = selectedCard.cloneNode(true);
                clonedCard.classList.add('expanded');
                
                // Update menu for expanded state
                const expandItem = clonedCard.querySelector('.card-menu-item');
                if (expandItem && expandItem.textContent === 'Expand') {
                    expandItem.textContent = 'Restore';
                    expandItem.onclick = () => restoreView(expandItem);
                }
                
                singleContainer.appendChild(clonedCard);
            }
        }

        // Show grid view for a page
        function showGridView(pageName) {
            const page = document.getElementById(pageName + '-page');
            const gridView = page.querySelector(`#${pageName}-grid-view`);
            const singleView = page.querySelector(`#${pageName}-single-view`);
            const state = pageStates.get(pageName);
            
            // Update state
            state.currentView = 'grid';
            
            // Show grid, hide single
            gridView.classList.add('active');
            singleView.classList.remove('active');
            
            // Hide indicators
            document.getElementById('cardIndicators').classList.remove('active');
        }

        // Select card in single view
        function selectCard(pageName, index) {
            const page = document.getElementById(pageName + '-page');
            const gridView = page.querySelector(`#${pageName}-grid-view`);
            const singleView = page.querySelector(`#${pageName}-single-view`);
            const state = pageStates.get(pageName);
            
            // Update state
            state.selectedCardIndex = index;
            
            // Update indicators
            document.querySelectorAll('.card-indicator').forEach((ind, i) => {
                ind.classList.toggle('active', i === index);
            });
            
            // Update single view
            const cards = gridView.querySelectorAll('.card');
            const selectedCard = cards[index];
            if (selectedCard) {
                const singleContainer = singleView.querySelector('.tile-container');
                singleContainer.innerHTML = '';
                const clonedCard = selectedCard.cloneNode(true);
                clonedCard.classList.add('expanded');
                
                // Update menu for expanded state
                const expandItem = clonedCard.querySelector('.card-menu-item');
                if (expandItem && expandItem.textContent === 'Expand') {
                    expandItem.textContent = 'Restore';
                    expandItem.onclick = () => restoreView(expandItem);
                }
                
                singleContainer.appendChild(clonedCard);
            }
        }

        // Toggle single view (double-click header)
        function toggleSingleView() {
            const activePage = document.querySelector('.content-page.active');
            if (!activePage) return;
            
            const pageName = activePage.id.replace('-page', '');
            const state = pageStates.get(pageName);
            
            if (state.currentView === 'grid') {
                showSingleView(pageName, 0);
            } else {
                showGridView(pageName);
            }
        }

        // Additional generator functions for all pages
        // Overview page content generators
        function generateMatchPreview() {
            return `
                <div class="stat-row">
                    <span>Next Match:</span>
                    <strong>vs Liverpool (H)</strong>
                </div>
                <div class="stat-row">
                    <span>Date:</span>
                    <strong>Saturday, 15:00</strong>
                </div>
                <div class="stat-row">
                    <span>Competition:</span>
                    <strong>Premier League</strong>
                </div>
                <div class="stat-row">
                    <span>Form:</span>
                    <strong>WWDWL</strong>
                </div>
            `;
        }
        
        function generateSquadSummary() {
            return `
                <div class="stat-row">
                    <span>Squad Size:</span>
                    <strong>25 Players</strong>
                </div>
                <div class="stat-row">
                    <span>Average Age:</span>
                    <strong>26.3 years</strong>
                </div>
                <div class="stat-row">
                    <span>Injuries:</span>
                    <strong style="color: var(--accent-400);">3 players</strong>
                </div>
                <div class="stat-row">
                    <span>Morale:</span>
                    <strong style="color: var(--accent-200);">Excellent</strong>
                </div>
            `;
        }
        
        function generateFinancialOverview() {
            return `
                <div class="stat-row">
                    <span>Transfer Budget:</span>
                    <strong>£45M</strong>
                </div>
                <div class="stat-row">
                    <span>Wage Budget:</span>
                    <strong>£2.3M/week</strong>
                </div>
                <div class="stat-row">
                    <span>FFP Status:</span>
                    <strong style="color: var(--accent-200);">Compliant</strong>
                </div>
            `;
        }
        
        function generateTrainingSchedule() {
            return `
                <div class="stat-row">
                    <span>Monday:</span>
                    <strong>Recovery</strong>
                </div>
                <div class="stat-row">
                    <span>Tuesday:</span>
                    <strong>Tactical</strong>
                </div>
                <div class="stat-row">
                    <span>Wednesday:</span>
                    <strong>Physical</strong>
                </div>
                <div class="stat-row">
                    <span>Thursday:</span>
                    <strong>Technical</strong>
                </div>
                <div class="stat-row">
                    <span>Friday:</span>
                    <strong>Match Prep</strong>
                </div>
            `;
        }
        
        function generateRecentForm() {
            return `
                <div class="stat-row">
                    <span>Last 5:</span>
                    <strong>WWDWL</strong>
                </div>
                <div class="stat-row">
                    <span>Goals For:</span>
                    <strong>12</strong>
                </div>
                <div class="stat-row">
                    <span>Goals Against:</span>
                    <strong>7</strong>
                </div>
                <div class="stat-row">
                    <span>Points:</span>
                    <strong>10/15</strong>
                </div>
            `;
        }
        
        function generateStartingXI() {
            return `
                <div style="position: relative; background: linear-gradient(135deg, #0a4020 0%, #0f5132 100%); height: 300px; border-radius: 8px; padding: 20px;">
                    <div style="color: white; font-size: 14px; text-align: center;">
                        <div>GK: Onana</div>
                        <div style="margin-top: 20px;">Dalot - Varane - Martinez - Shaw</div>
                        <div style="margin-top: 20px;">Casemiro - Mainoo</div>
                        <div style="margin-top: 20px;">Garnacho - Bruno - Rashford</div>
                        <div style="margin-top: 20px;">Hojlund</div>
                    </div>
                </div>
            `;
        }
        
        function generatePlayerForm() {
            return `
                <div class="stat-row">
                    <span class="stat-label">Bruno Fernandes</span>
                    <span class="stat-value">⬆️ 8.2</span>
                </div>
                <div class="stat-row">
                    <span class="stat-label">Marcus Rashford</span>
                    <span class="stat-value">⬆️ 7.8</span>
                </div>
                <div class="stat-row">
                    <span class="stat-label">Kobbie Mainoo</span>
                    <span class="stat-value">➡️ 7.3</span>
                </div>
                <div class="stat-row">
                    <span class="stat-label">Antony</span>
                    <span class="stat-value">⬇️ 6.4</span>
                </div>
            `;
        }
        
        function generateSquadDepth() {
            return `
                <div class="stat-row">
                    <span class="stat-label">Goalkeepers</span>
                    <span class="stat-value">3</span>
                </div>
                <div class="stat-row">
                    <span class="stat-label">Defenders</span>
                    <span class="stat-value">9</span>
                </div>
                <div class="stat-row">
                    <span class="stat-label">Midfielders</span>
                    <span class="stat-value">7</span>
                </div>
                <div class="stat-row">
                    <span class="stat-label">Forwards</span>
                    <span class="stat-value">7</span>
                </div>
            `;
        }
        
        function generateContractExpiries() {
            return `
                <div class="stat-row">
                    <span class="stat-label">Varane</span>
                    <span class="stat-value"><span class="badge badge-danger">6 months</span></span>
                </div>
                <div class="stat-row">
                    <span class="stat-label">Martial</span>
                    <span class="stat-value"><span class="badge badge-danger">6 months</span></span>
                </div>
                <div class="stat-row">
                    <span class="stat-label">Evans</span>
                    <span class="stat-value"><span class="badge badge-warning">1 year</span></span>
                </div>
            `;
        }
        
        function generateYouthProspects() {
            return `
                <div class="stat-row">
                    <span class="stat-label">Kobbie Mainoo</span>
                    <span class="stat-value">⭐⭐⭐⭐⭐</span>
                </div>
                <div class="stat-row">
                    <span class="stat-label">Alejandro Garnacho</span>
                    <span class="stat-value">⭐⭐⭐⭐</span>
                </div>
                <div class="stat-row">
                    <span class="stat-label">Omari Forson</span>
                    <span class="stat-value">⭐⭐⭐</span>
                </div>
            `;
        }
        
        // Tactics page generators
        function generateCurrentTactic() {
            return `
                <div style="text-align: center; padding: 20px;">
                    <div style="font-size: 24px; font-weight: bold;">Fluid Counter-Attack</div>
                    <div style="margin-top: 10px; color: rgba(255,255,255,0.6);">4-2-3-1 Wide</div>
                    <div style="margin-top: 20px;">
                        <div class="badge badge-success">95% Familiarity</div>
                    </div>
                </div>
            `;
        }
        
        function generateAlternativeTactics() {
            return `
                <div class="stat-row">
                    <span class="stat-label">Gegenpress</span>
                    <span class="stat-value">4-3-3</span>
                </div>
                <div class="stat-row">
                    <span class="stat-label">Tiki-Taka</span>
                    <span class="stat-value">4-3-3 DM</span>
                </div>
                <div class="stat-row">
                    <span class="stat-label">Route One</span>
                    <span class="stat-value">4-4-2</span>
                </div>
            `;
        }
        
        function generateTeamInstructions() {
            return `
                <div class="stat-row">
                    <span class="stat-label">Build Up</span>
                    <span class="stat-value">Play Out of Defence</span>
                </div>
                <div class="stat-row">
                    <span class="stat-label">Chance Creation</span>
                    <span class="stat-value">Mixed Passes</span>
                </div>
                <div class="stat-row">
                    <span class="stat-label">Defence</span>
                    <span class="stat-value">Higher Line</span>
                </div>
            `;
        }
        
        function generatePlayerRoles() {
            return `
                <table class="data-table">
                    <thead>
                        <tr><th>Position</th><th>Player</th><th>Role</th></tr>
                    </thead>
                    <tbody>
                        <tr><td>GK</td><td>Onana</td><td>Sweeper Keeper</td></tr>
                        <tr><td>RB</td><td>Dalot</td><td>Complete Wing Back</td></tr>
                        <tr><td>CB</td><td>Varane</td><td>Ball Playing Defender</td></tr>
                        <tr><td>CB</td><td>Martinez</td><td>Ball Playing Defender</td></tr>
                        <tr><td>LB</td><td>Shaw</td><td>Inverted Wing Back</td></tr>
                        <tr><td>DM</td><td>Casemiro</td><td>Deep Lying Playmaker</td></tr>
                        <tr><td>CM</td><td>Mainoo</td><td>Box to Box</td></tr>
                        <tr><td>RW</td><td>Garnacho</td><td>Inside Forward</td></tr>
                        <tr><td>AM</td><td>Bruno</td><td>Advanced Playmaker</td></tr>
                        <tr><td>LW</td><td>Rashford</td><td>Inside Forward</td></tr>
                        <tr><td>ST</td><td>Hojlund</td><td>Complete Forward</td></tr>
                    </tbody>
                </table>
            `;
        }
        
        function generateSetPieces() {
            return `
                <div class="stat-row">
                    <span class="stat-label">Corners</span>
                    <span class="stat-value">Bruno</span>
                </div>
                <div class="stat-row">
                    <span class="stat-label">Free Kicks</span>
                    <span class="stat-value">Bruno/Rashford</span>
                </div>
                <div class="stat-row">
                    <span class="stat-label">Penalties</span>
                    <span class="stat-value">Bruno</span>
                </div>
            `;
        }
        
        function generateOppositionAnalysis() {
            return `
                <div class="stat-row">
                    <span class="stat-label">Next: Liverpool</span>
                    <span class="stat-value">4-3-3</span>
                </div>
                <div class="stat-row">
                    <span class="stat-label">Strength</span>
                    <span class="stat-value">High Press</span>
                </div>
                <div class="stat-row">
                    <span class="stat-label">Weakness</span>
                    <span class="stat-value">High Line</span>
                </div>
            `;
        }
        
        function generateMatchPrep() {
            return `
                <div class="stat-row">
                    <span class="stat-label">Focus</span>
                    <span class="stat-value">Defensive Shape</span>
                </div>
                <div class="stat-row">
                    <span class="stat-label">Match Practice</span>
                    <span class="stat-value">Scheduled</span>
                </div>
                <div class="stat-row">
                    <span class="stat-label">Team Talk</span>
                    <span class="stat-value">Passionate</span>
                </div>
            `;
        }
        
        function generateTacticalFamiliarity() {
            return `
                <div class="stat-row">
                    <span class="stat-label">Current Tactic</span>
                    <span class="stat-value">95%</span>
                </div>
                <div class="stat-row">
                    <span class="stat-label">Alternative 1</span>
                    <span class="stat-value">72%</span>
                </div>
                <div class="stat-row">
                    <span class="stat-label">Alternative 2</span>
                    <span class="stat-value">68%</span>
                </div>
            `;
        }
        
        // Training page generators
        function generateIndividualTraining() {
            return `
                <table class="data-table">
                    <thead>
                        <tr><th>Player</th><th>Focus</th><th>Progress</th></tr>
                    </thead>
                    <tbody>
                        <tr><td>Hojlund</td><td>Finishing</td><td>75%</td></tr>
                        <tr><td>Mainoo</td><td>Passing</td><td>82%</td></tr>
                        <tr><td>Garnacho</td><td>Decision Making</td><td>68%</td></tr>
                        <tr><td>Antony</td><td>Weak Foot</td><td>45%</td></tr>
                        <tr><td>Mount</td><td>Fitness</td><td>60%</td></tr>
                    </tbody>
                </table>
            `;
        }
        
        function generateTrainingIntensity() {
            return `
                <div class="stat-row">
                    <span class="stat-label">Overall</span>
                    <span class="stat-value">Medium</span>
                </div>
                <div class="stat-row">
                    <span class="stat-label">Match Prep</span>
                    <span class="stat-value">High</span>
                </div>
                <div class="stat-row">
                    <span class="stat-label">Recovery</span>
                    <span class="stat-value">Low</span>
                </div>
            `;
        }
        
        function generateCoachesReport() {
            return `
                <div class="stat-row">
                    <span class="stat-label">Best Trainer</span>
                    <span class="stat-value">Bruno Fernandes</span>
                </div>
                <div class="stat-row">
                    <span class="stat-label">Most Improved</span>
                    <span class="stat-value">Kobbie Mainoo</span>
                </div>
                <div class="stat-row">
                    <span class="stat-label">Needs Attention</span>
                    <span class="stat-value">Sancho</span>
                </div>
            `;
        }
        
        function generateYouthDevelopment() {
            return `
                <div class="stat-row">
                    <span class="stat-label">U23 Position</span>
                    <span class="stat-value">2nd</span>
                </div>
                <div class="stat-row">
                    <span class="stat-label">U18 Position</span>
                    <span class="stat-value">1st</span>
                </div>
                <div class="stat-row">
                    <span class="stat-label">Academy Rating</span>
                    <span class="stat-value">⭐⭐⭐⭐⭐</span>
                </div>
            `;
        }
        
        function generateTrainingFacilities() {
            return `
                <div class="stat-row">
                    <span class="stat-label">Carrington</span>
                    <span class="stat-value">World Class</span>
                </div>
                <div class="stat-row">
                    <span class="stat-label">Youth Facilities</span>
                    <span class="stat-value">Excellent</span>
                </div>
                <div class="stat-row">
                    <span class="stat-label">Medical Centre</span>
                    <span class="stat-value">State of the Art</span>
                </div>
            `;
        }
        
        function generateFitnessLevels() {
            return `
                <div class="stat-row">
                    <span class="stat-label">Squad Average</span>
                    <span class="stat-value">87%</span>
                </div>
                <div class="stat-row">
                    <span class="stat-label">Match Fitness</span>
                    <span class="stat-value">92%</span>
                </div>
                <div class="stat-row">
                    <span class="stat-label">Injury Risk</span>
                    <span class="stat-value"><span class="badge badge-warning">Medium</span></span>
                </div>
            `;
        }
        
        function generateTrainingFocus() {
            return `
                <div class="stat-row">
                    <span class="stat-label">This Week</span>
                    <span class="stat-value">Defensive Shape</span>
                </div>
                <div class="stat-row">
                    <span class="stat-label">Next Week</span>
                    <span class="stat-value">Set Pieces</span>
                </div>
                <div class="stat-row">
                    <span class="stat-label">Monthly</span>
                    <span class="stat-value">Possession</span>
                </div>
            `;
        }
        
        // Transfer page generators
        function generateTransferTargets() {
            return `
                <table class="data-table">
                    <thead>
                        <tr><th>Player</th><th>Club</th><th>Position</th><th>Value</th></tr>
                    </thead>
                    <tbody>
                        <tr><td>J. Frimpong</td><td>Leverkusen</td><td>RB</td><td>£40M</td></tr>
                        <tr><td>J. Branthwaite</td><td>Everton</td><td>CB</td><td>£60M</td></tr>
                        <tr><td>A. Onana</td><td>Everton</td><td>CM</td><td>£50M</td></tr>
                        <tr><td>M. Gusto</td><td>Chelsea</td><td>RB</td><td>£35M</td></tr>
                        <tr><td>I. Toney</td><td>Brentford</td><td>ST</td><td>£70M</td></tr>
                    </tbody>
                </table>
            `;
        }
        
        function generateTransferBudget() {
            return `
                <div class="stat-row">
                    <span class="stat-label">Available</span>
                    <span class="stat-value">£55M</span>
                </div>
                <div class="stat-row">
                    <span class="stat-label">Spent</span>
                    <span class="stat-value">£65M</span>
                </div>
                <div class="stat-row">
                    <span class="stat-label">Sales</span>
                    <span class="stat-value">£32M</span>
                </div>
            `;
        }
        
        function generateScoutingReport() {
            return `
                <div class="stat-row">
                    <span class="stat-label">Top Target</span>
                    <span class="stat-value">J. Frimpong</span>
                </div>
                <div class="stat-row">
                    <span class="stat-label">Scout Rating</span>
                    <span class="stat-value">⭐⭐⭐⭐</span>
                </div>
                <div class="stat-row">
                    <span class="stat-label">Recommendation</span>
                    <span class="stat-value"><span class="badge badge-success">Sign</span></span>
                </div>
            `;
        }
        
        function generateTransferHistory() {
            return `
                <div class="stat-row">
                    <span class="stat-label">In: Hojlund</span>
                    <span class="stat-value">£72M</span>
                </div>
                <div class="stat-row">
                    <span class="stat-label">In: Mount</span>
                    <span class="stat-value">£60M</span>
                </div>
                <div class="stat-row">
                    <span class="stat-label">Out: Fred</span>
                    <span class="stat-value">£15M</span>
                </div>
            `;
        }
        
        function generateContractNegotiations() {
            return `
                <div class="stat-row">
                    <span class="stat-label">Rashford</span>
                    <span class="stat-value">Extension talks</span>
                </div>
                <div class="stat-row">
                    <span class="stat-label">Mainoo</span>
                    <span class="stat-value">New deal offered</span>
                </div>
                <div class="stat-row">
                    <span class="stat-label">Varane</span>
                    <span class="stat-value">Considering options</span>
                </div>
            `;
        }
        
        function generateLoanWatch() {
            return `
                <div class="stat-row">
                    <span class="stat-label">Greenwood</span>
                    <span class="stat-value">Getafe - 8 goals</span>
                </div>
                <div class="stat-row">
                    <span class="stat-label">Amrabat</span>
                    <span class="stat-value">Option to buy</span>
                </div>
            `;
        }
        
        function generateShortlist() {
            return `
                <div class="stat-row">
                    <span class="stat-label">Defenders</span>
                    <span class="stat-value">3 targets</span>
                </div>
                <div class="stat-row">
                    <span class="stat-label">Midfielders</span>
                    <span class="stat-value">2 targets</span>
                </div>
                <div class="stat-row">
                    <span class="stat-label">Forwards</span>
                    <span class="stat-value">1 target</span>
                </div>
            `;
        }
        
        function generateAgentOffers() {
            return `
                <div class="stat-row">
                    <span class="stat-label">K. Benzema</span>
                    <span class="stat-value">Free transfer</span>
                </div>
                <div class="stat-row">
                    <span class="stat-label">S. Ramos</span>
                    <span class="stat-value">6 month deal</span>
                </div>
            `;
        }
        
        // Finance page generators
        function generateRevenueStreams() {
            return `
                <div class="stat-row">
                    <span class="stat-label">Matchday</span>
                    <span class="stat-value">£110M/year</span>
                </div>
                <div class="stat-row">
                    <span class="stat-label">Broadcasting</span>
                    <span class="stat-value">£215M/year</span>
                </div>
                <div class="stat-row">
                    <span class="stat-label">Commercial</span>
                    <span class="stat-value">£275M/year</span>
                </div>
            `;
        }
        
        function generateWageStructure() {
            return `
                <table class="data-table">
                    <thead>
                        <tr><th>Player</th><th>Weekly Wage</th></tr>
                    </thead>
                    <tbody>
                        <tr><td>Casemiro</td><td>£350K</td></tr>
                        <tr><td>Varane</td><td>£340K</td></tr>
                        <tr><td>Bruno</td><td>£300K</td></tr>
                        <tr><td>Rashford</td><td>£300K</td></tr>
                        <tr><td>Mount</td><td>£250K</td></tr>
                    </tbody>
                </table>
            `;
        }
        
        function generateFFPCompliance() {
            return `
                <div class="stat-row">
                    <span class="stat-label">Status</span>
                    <span class="stat-value"><span class="badge badge-success">Compliant</span></span>
                </div>
                <div class="stat-row">
                    <span class="stat-label">Margin</span>
                    <span class="stat-value">£48M</span>
                </div>
                <div class="stat-row">
                    <span class="stat-label">Next Review</span>
                    <span class="stat-value">June 2024</span>
                </div>
            `;
        }
        
        function generateSponsorshipDeals() {
            return `
                <div class="stat-row">
                    <span class="stat-label">Kit Sponsor</span>
                    <span class="stat-value">TeamViewer £47M</span>
                </div>
                <div class="stat-row">
                    <span class="stat-label">Kit Manufacturer</span>
                    <span class="stat-value">Adidas £90M</span>
                </div>
                <div class="stat-row">
                    <span class="stat-label">Stadium Rights</span>
                    <span class="stat-value">Available</span>
                </div>
            `;
        }
        
        function generateStadiumRevenue() {
            return `
                <div class="stat-row">
                    <span class="stat-label">Capacity</span>
                    <span class="stat-value">74,310</span>
                </div>
                <div class="stat-row">
                    <span class="stat-label">Avg Attendance</span>
                    <span class="stat-value">73,881</span>
                </div>
                <div class="stat-row">
                    <span class="stat-label">Revenue/Match</span>
                    <span class="stat-value">£3.8M</span>
                </div>
            `;
        }
        
        function generateTransferBalance() {
            return `
                <div class="stat-row">
                    <span class="stat-label">Incoming</span>
                    <span class="stat-value">+£132M</span>
                </div>
                <div class="stat-row">
                    <span class="stat-label">Outgoing</span>
                    <span class="stat-value">-£48M</span>
                </div>
                <div class="stat-row">
                    <span class="stat-label">Net Spend</span>
                    <span class="stat-value">-£84M</span>
                </div>
            `;
        }
        
        function generateSeasonProjection() {
            return `
                <div class="stat-row">
                    <span class="stat-label">Revenue</span>
                    <span class="stat-value">£590M</span>
                </div>
                <div class="stat-row">
                    <span class="stat-label">Profit</span>
                    <span class="stat-value">£45M</span>
                </div>
                <div class="stat-row">
                    <span class="stat-label">Growth</span>
                    <span class="stat-value">+8%</span>
                </div>
            `;
        }
        
        // Fixtures page generators
        function generateNextMatch() {
            return `
                <div style="text-align: center; padding: 20px;">
                    <div style="font-size: 18px; font-weight: bold;">Manchester United vs Liverpool</div>
                    <div style="margin-top: 10px;">Old Trafford</div>
                    <div style="margin-top: 10px;">Sunday, 15:00</div>
                    <div style="margin-top: 20px;">
                        <span class="badge badge-info">Premier League</span>
                    </div>
                </div>
            `;
        }
        
        function generateRecentResults() {
            return `
                <div class="stat-row">
                    <span class="stat-label">vs Arsenal</span>
                    <span class="stat-value"><span class="badge badge-success">W 2-1</span></span>
                </div>
                <div class="stat-row">
                    <span class="stat-label">@ Chelsea</span>
                    <span class="stat-value"><span class="badge badge-warning">D 1-1</span></span>
                </div>
                <div class="stat-row">
                    <span class="stat-label">vs City</span>
                    <span class="stat-value"><span class="badge badge-danger">L 0-2</span></span>
                </div>
            `;
        }
        
        function generateUpcomingFixtures() {
            return `
                <table class="data-table">
                    <thead>
                        <tr><th>Date</th><th>Opponent</th><th>Comp</th></tr>
                    </thead>
                    <tbody>
                        <tr><td>Sun</td><td>Liverpool (H)</td><td>PL</td></tr>
                        <tr><td>Wed</td><td>Fulham (A)</td><td>PL</td></tr>
                        <tr><td>Sat</td><td>Brighton (H)</td><td>PL</td></tr>
                        <tr><td>Tue</td><td>Bayern (A)</td><td>UCL</td></tr>
                        <tr><td>Sat</td><td>Bournemouth (A)</td><td>PL</td></tr>
                    </tbody>
                </table>
            `;
        }
        
        function generateCompetitionProgress() {
            return `
                <div class="stat-row">
                    <span class="stat-label">Premier League</span>
                    <span class="stat-value">6th</span>
                </div>
                <div class="stat-row">
                    <span class="stat-label">Champions League</span>
                    <span class="stat-value">Group Stage</span>
                </div>
                <div class="stat-row">
                    <span class="stat-label">FA Cup</span>
                    <span class="stat-value">4th Round</span>
                </div>
            `;
        }
        
        function generateHeadToHead() {
            return `
                <div class="stat-row">
                    <span class="stat-label">vs Liverpool</span>
                    <span class="stat-value">W2 D1 L2</span>
                </div>
                <div class="stat-row">
                    <span class="stat-label">Goals For</span>
                    <span class="stat-value">8</span>
                </div>
                <div class="stat-row">
                    <span class="stat-label">Goals Against</span>
                    <span class="stat-value">7</span>
                </div>
            `;
        }
        
        function generateSeasonStats() {
            return `
                <div class="stat-row">
                    <span class="stat-label">Played</span>
                    <span class="stat-value">20</span>
                </div>
                <div class="stat-row">
                    <span class="stat-label">Won</span>
                    <span class="stat-value">12</span>
                </div>
                <div class="stat-row">
                    <span class="stat-label">Drawn</span>
                    <span class="stat-value">3</span>
                </div>
                <div class="stat-row">
                    <span class="stat-label">Lost</span>
                    <span class="stat-value">5</span>
                </div>
            `;
        }
        
        function generateFixtureCongestion() {
            return `
                <div class="stat-row">
                    <span class="stat-label">Next 7 days</span>
                    <span class="stat-value">3 matches</span>
                </div>
                <div class="stat-row">
                    <span class="stat-label">Next 14 days</span>
                    <span class="stat-value">5 matches</span>
                </div>
                <div class="stat-row">
                    <span class="stat-label">Rotation</span>
                    <span class="stat-value"><span class="badge badge-warning">Recommended</span></span>
                </div>
            `;
        }
        
        // Card actions (v16 menu items)
        function pinCard(menuItem) {
            const card = menuItem.closest('.card');
            const wasPinned = card.classList.contains('pinned');
            card.classList.toggle('pinned');
            console.log(`Card ${wasPinned ? 'unpinned' : 'pinned'}`);
            
            // Update draggable state
            if (card.classList.contains('pinned')) {
                card.draggable = false;
                menuItem.textContent = 'Unpin';
            } else {
                card.draggable = true;
                menuItem.textContent = 'Pin';
            }
            
            // Close dropdown
            const dropdown = menuItem.closest('.card-menu-dropdown');
            dropdown.classList.remove('active');
        }

        function removeCard(menuItem) {
            const card = menuItem.closest('.card');
            const cardTitle = card.querySelector('.card-header span')?.textContent || 'Unknown';
            console.log(`Removing card: ${cardTitle}`);
            card.remove();
        }

        function replaceCard(menuItem) {
            const card = menuItem.closest('.card');
            const cardTitle = card.querySelector('.card-header span')?.textContent || 'Unknown';
            console.log(`Replace card requested for: ${cardTitle}`);
            // Add replace functionality
        }

        function bookmarkCard(menuItem) {
            console.log('Bookmark card functionality');
            // Add bookmark functionality
        }

        // Continue simulation
        function continueSim() {
            console.log('Continuing simulation...');
            // Add simulation logic here
        }

        // Advance time
        function advanceTime() {
            console.log('Advancing time...');
            // Add time advancement logic
        }

        // Settings
        // Hamburger menu functions
        function toggleMenu() {
            const menu = document.getElementById('hamburgerMenu');
            menu.classList.toggle('active');
            
            // Close menu when clicking outside
            if (menu.classList.contains('active')) {
                document.addEventListener('click', closeMenuOnClickOutside);
            }
        }
        
        function closeMenuOnClickOutside(e) {
            const menu = document.getElementById('hamburgerMenu');
            const fab = document.querySelector('.settings-fab');
            
            if (!menu.contains(e.target) && !fab.contains(e.target)) {
                menu.classList.remove('active');
                document.removeEventListener('click', closeMenuOnClickOutside);
            }
        }
        
        function loadLayout() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.json';
            input.onchange = e => {
                const file = e.target.files[0];
                const reader = new FileReader();
                reader.onload = event => {
                    try {
                        const layout = JSON.parse(event.target.result);
                        // Apply loaded layout
                        const cards = document.querySelectorAll('.card');
                        layout.cards.forEach((cardData, index) => {
                            if (cards[index]) {
                                const card = cards[index];
                                // Apply width
                                if (cardData.width && cardData.width > 1) {
                                    card.className = card.className.replace(/wide-\d/, '');
                                    card.classList.add(`wide-${cardData.width}`);
                                }
                                // Apply height
                                if (cardData.height && cardData.height !== 'auto') {
                                    card.style.height = cardData.height;
                                }
                                // Apply pinned state
                                if (cardData.pinned) {
                                    card.classList.add('pinned');
                                    card.draggable = false;
                                }
                            }
                        });
                        alert('Layout loaded successfully!');
                    } catch (error) {
                        alert('Error loading layout: ' + error.message);
                    }
                };
                reader.readAsText(file);
            };
            input.click();
            document.getElementById('hamburgerMenu').classList.remove('active');
        }
        
        function saveLayout() {
            const layout = {
                cards: [],
                timestamp: new Date().toISOString()
            };
            
            // Collect current card positions and sizes
            document.querySelectorAll('.card').forEach(card => {
                layout.cards.push({
                    title: card.querySelector('.card-header span').textContent,
                    width: card.className.match(/wide-(\d)/)?.[1] || 1,
                    height: card.style.height || 'auto',
                    pinned: card.classList.contains('pinned')
                });
            });
            
            const dataStr = JSON.stringify(layout, null, 2);
            const dataUri = 'data:application/json;charset=utf-8,'+ encodeURIComponent(dataStr);
            
            const link = document.createElement('a');
            link.setAttribute('href', dataUri);
            link.setAttribute('download', 'fm-layout.json');
            link.click();
            
            document.getElementById('hamburgerMenu').classList.remove('active');
        }
        
        function saveAsLayout() {
            const filename = prompt('Enter layout name:', 'my-layout');
            if (filename) {
                const layout = {
                    cards: [],
                    timestamp: new Date().toISOString()
                };
                
                document.querySelectorAll('.card').forEach(card => {
                    layout.cards.push({
                        title: card.querySelector('.card-header span').textContent,
                        width: card.className.match(/wide-(\d)/)?.[1] || 1,
                        height: card.style.height || 'auto'
                    });
                });
                
                const dataStr = JSON.stringify(layout, null, 2);
                const dataUri = 'data:application/json;charset=utf-8,'+ encodeURIComponent(dataStr);
                
                const link = document.createElement('a');
                link.setAttribute('href', dataUri);
                link.setAttribute('download', filename + '.json');
                link.click();
            }
            document.getElementById('hamburgerMenu').classList.remove('active');
        }
        
        function goToMainMenu() {
            // Navigate to main menu or home page
            if (confirm('Return to Main Menu? Any unsaved changes will be lost.')) {
                window.location.href = 'index.html'; // or wherever the main menu is
            }
            document.getElementById('hamburgerMenu').classList.remove('active');
        }
        
        function exitApp() {
            if (confirm('Are you sure you want to exit?')) {
                window.close();
            }
            document.getElementById('hamburgerMenu').classList.remove('active');
        }
        
        function openSettings() {
            document.getElementById('hamburgerMenu').classList.remove('active');
            document.querySelector('.overlay').classList.add('active');
            document.querySelector('.settings-dialog').classList.add('active');
        }

        function closeSettings() {
            document.querySelector('.overlay').classList.remove('active');
            document.querySelector('.settings-dialog').classList.remove('active');
        }

        // Keyboard navigation
        document.addEventListener('keydown', (e) => {
            const activePage = document.querySelector('.content-page.active');
            if (!activePage) return;
            
            const pageName = activePage.id.replace('-page', '');
            const state = pageStates.get(pageName);
            
            if (state.currentView === 'single') {
                if (e.key === 'ArrowLeft') {
                    selectCard(pageName, Math.max(0, state.selectedCardIndex - 1));
                } else if (e.key === 'ArrowRight') {
                    const cardCount = state.cards.length;
                    selectCard(pageName, Math.min(cardCount - 1, state.selectedCardIndex + 1));
                } else if (e.key === 'Escape') {
                    showGridView(pageName);
                }
            }
        });

        // Content generation functions - Updated for Aethelred Design System
        function generateMatchPreview() {
            // Updated to use Aethelred SummaryStatCard (newPlan.md Card 1.2)
            const matchCard = new AethelredSummaryStatCard({
                header: { title: 'Match Preview' },
                body: {
                    contentType: 'StatRowList',
                    contentData: [
                        { label: 'Next Match', value: 'vs Liverpool', valueType: 'neutral' },
                        { label: 'Competition', value: 'Premier League', valueType: 'neutral' },
                        { label: 'Date', value: '20 Aug 2024', valueType: 'neutral' },
                        { label: 'Venue', value: 'Old Trafford', valueType: 'positive' },
                        { label: 'Form', value: 'WWDLW', valueType: 'positive' }
                    ]
                }
            });
            
            return matchCard.render();
        }

        function generateSquadSummary() {
            // Updated to use Aethelred SummaryStatCard (newPlan.md Card 1.2)
            const squadCard = new AethelredSummaryStatCard({
                header: { title: 'Squad Summary' },
                body: {
                    contentType: 'StatRowList',
                    contentData: [
                        { label: 'Total Players', value: '28', valueType: 'neutral' },
                        { label: 'First Team', value: '23', valueType: 'neutral' },
                        { label: 'Reserves', value: '5', valueType: 'neutral' },
                        { label: 'Average Age', value: '26.3 years', valueType: 'neutral' },
                        { label: 'Youngest Player', value: 'Mainoo (19)', valueType: 'positive' },
                        { label: 'Oldest Player', value: 'Heaton (38)', valueType: 'neutral' },
                        { label: 'Foreign Players', value: '18/25', valueType: 'neutral' },
                        { label: 'Home Grown', value: '7/8 required', valueType: 'warning' },
                        { label: 'EU Players', value: '8', valueType: 'neutral' },
                        { label: 'Non-EU Players', value: '10', valueType: 'neutral' },
                        { label: 'Team Value', value: '£842M', valueType: 'positive' },
                        { label: 'Avg Player Value', value: '£30M', valueType: 'neutral' },
                        { label: 'Highest Value', value: 'Rashford (£85M)', valueType: 'positive' },
                        { label: 'Total Wages', value: '£3.2M/week', valueType: 'neutral' },
                        { label: 'Highest Earner', value: 'Casemiro (£350K/w)', valueType: 'warning' },
                        { label: 'Average Wage', value: '£114K/week', valueType: 'neutral' },
                        { label: 'Squad Morale', value: 'Excellent', valueType: 'positive' },
                        { label: 'Team Cohesion', value: '82%', valueType: 'positive' },
                        { label: 'Dressing Room', value: 'United', valueType: 'positive' },
                        { label: 'Captain', value: 'Bruno Fernandes', valueType: 'neutral' },
                        { label: 'Vice Captain', value: 'Casemiro', valueType: 'neutral' }
                    ]
                }
            });
            
            return squadCard.render();
        }

        function generateLeagueTable() {
            // Updated to use Aethelred RosterCard (newPlan.md Card 2.2)
            const leagueCard = new AethelredRosterCard({
                header: { title: 'League Table' },
                body: {
                    contentType: 'DataTable',
                    contentData: {
                        headers: ['#', 'Team', 'P', 'W', 'D', 'L', 'GF', 'GA', 'GD', 'Pts'],
                        rows: [
                            [1, 'Man City', 3, 3, 0, 0, 10, 2, '+8', 9],
                            [2, 'Arsenal', 3, 2, 1, 0, 8, 3, '+5', 7],
                            [3, 'Liverpool', 3, 2, 1, 0, 7, 3, '+4', 7],
                            [4, 'Man United', 3, 2, 0, 1, 5, 3, '+2', 6],
                            [5, 'Brighton', 3, 2, 0, 1, 6, 5, '+1', 6],
                            [6, 'Chelsea', 3, 1, 2, 0, 5, 4, '+1', 5],
                            [7, 'Newcastle', 3, 1, 2, 0, 4, 3, '+1', 5],
                            [8, 'Tottenham', 3, 1, 1, 1, 4, 4, '0', 4],
                            [9, 'West Ham', 3, 1, 1, 1, 3, 4, '-1', 4],
                            [10, 'Aston Villa', 3, 1, 1, 1, 3, 5, '-2', 4],
                            [11, 'Fulham', 3, 1, 0, 2, 3, 5, '-2', 3],
                            [12, 'Brentford', 3, 1, 0, 2, 3, 6, '-3', 3],
                            [13, 'Crystal Palace', 3, 0, 2, 1, 2, 4, '-2', 2],
                            [14, 'Leicester', 3, 0, 2, 1, 2, 5, '-3', 2],
                            [15, 'Wolves', 3, 0, 2, 1, 1, 3, '-2', 2],
                            [16, 'Ipswich', 3, 0, 1, 2, 2, 5, '-3', 1],
                            [17, 'Southampton', 3, 0, 1, 2, 1, 4, '-3', 1],
                            [18, 'Everton', 3, 0, 1, 2, 1, 5, '-4', 1],
                            [19, 'Bournemouth', 3, 0, 0, 3, 2, 7, '-5', 0],
                            [20, 'Nottm Forest', 3, 0, 0, 3, 1, 6, '-5', 0]
                        ]
                    }
                }
            });
            
            return leagueCard.render();
        }

        function generateFinancialOverview() {
            // Updated to use Aethelred SummaryStatCard (newPlan.md Card 1.2)
            const financialCard = new AethelredSummaryStatCard({
                header: { title: 'Financial Overview' },
                body: {
                    contentType: 'StatRowList',
                    contentData: [
                        { label: 'Current Balance', value: '£45.2M', valueType: 'positive' },
                        { label: 'Transfer Budget', value: '£120M', valueType: 'neutral' },
                        { label: 'Remaining Budget', value: '£55M', valueType: 'neutral' },
                        { label: 'Wage Budget', value: '£3.8M/w', valueType: 'neutral' },
                        { label: 'Used Wages', value: '£2.96M/w (78%)', valueType: 'warning' },
                        { label: 'Available Wages', value: '£840K/w', valueType: 'neutral' },
                        { label: 'FFP Status', value: 'Compliant', valueType: 'positive' },
                        { label: 'FFP Room', value: '£48M', valueType: 'positive' },
                        { label: 'Revenue YTD', value: '£285M', valueType: 'positive' },
                        { label: 'Expenses YTD', value: '£242M', valueType: 'neutral' },
                        { label: 'Profit/Loss', value: '+£43M', valueType: 'positive' },
                        { label: 'Projected Annual', value: '£580M revenue', valueType: 'positive' },
                        { label: 'Stadium Income', value: '£3.8M/match', valueType: 'neutral' },
                        { label: 'Merchandise', value: '£125M/year', valueType: 'neutral' },
                        { label: 'TV Revenue', value: '£215M/year', valueType: 'neutral' },
                        { label: 'Sponsorship', value: '£150M/year', valueType: 'neutral' }
                    ]
                }
            });
            
            return financialCard.render();
        }

        function generateTrainingSchedule() {
            // Updated to use Aethelred RosterCard (newPlan.md Card 2.2)
            const scheduleCard = new AethelredRosterCard({
                header: { title: 'Training Schedule' },
                body: {
                    contentType: 'DataTable',
                    contentData: {
                        headers: ['Day', 'Focus', 'Intensity'],
                        rows: [
                            ['Monday', 'Recovery', 'Light'],
                            ['Tuesday', 'Tactical', 'Medium'],
                            ['Wednesday', 'Physical', 'High'],
                            ['Thursday', 'Technical', 'Medium'],
                            ['Friday', 'Set Pieces', 'Light'],
                            ['Saturday', 'Match', '-'],
                            ['Sunday', 'Rest', '-']
                        ]
                    }
                }
            });
            
            return scheduleCard.render();
        }

        function generateSquadList() {
            // Updated to use Aethelred RosterCard (newPlan.md Card 2.2)
            const rosterCard = new AethelredRosterCard({
                header: { title: 'First Team Squad' },
                body: {
                    contentType: 'DataTable',
                    contentData: {
                        headers: ['Name', 'Pos', 'Age', 'Nat', 'Apps', 'Gls', 'Ast', 'Avg', 'Value'],
                        rows: [
                            ['Andre Onana', 'GK', 28, 'CMR', 3, 0, 0, 7.4, '£40M'],
                            ['Tom Heaton', 'GK', 38, 'ENG', 0, 0, 0, '-', '£500K'],
                            ['Altay Bayindir', 'GK', 26, 'TUR', 0, 0, 0, '-', '£12M'],
                            ['Diogo Dalot', 'RB', 25, 'POR', 3, 0, 1, 7.2, '£35M'],
                            ['Aaron Wan-Bissaka', 'RB', 26, 'ENG', 1, 0, 0, 6.8, '£20M'],
                            ['Luke Shaw', 'LB', 29, 'ENG', 2, 0, 1, 7.3, '£28M'],
                            ['Tyrell Malacia', 'LB', 25, 'NED', 0, 0, 0, '-', '£15M'],
                            ['Sergio Reguilon', 'LB', 27, 'ESP', 0, 0, 0, '-', '£12M'],
                            ['Raphael Varane', 'CB', 31, 'FRA', 2, 0, 0, 7.5, '£35M'],
                            ['Lisandro Martinez', 'CB', 26, 'ARG', 3, 0, 0, 7.6, '£55M'],
                            ['Harry Maguire', 'CB', 31, 'ENG', 1, 0, 0, 6.9, '£20M'],
                            ['Victor Lindelof', 'CB', 30, 'SWE', 1, 0, 0, 6.7, '£18M'],
                            ['Jonny Evans', 'CB', 36, 'NIR', 0, 0, 0, '-', '£2M'],
                            ['Casemiro', 'DM', 32, 'BRA', 3, 1, 0, 7.5, '£45M'],
                            ['Sofyan Amrabat', 'DM', 28, 'MAR', 1, 0, 0, 6.5, '£18M'],
                            ['Christian Eriksen', 'CM', 32, 'DEN', 2, 0, 1, 7.1, '£15M'],
                            ['Mason Mount', 'CM', 25, 'ENG', 1, 0, 0, 6.6, '£55M'],
                            ['Scott McTominay', 'CM', 27, 'SCO', 2, 0, 0, 6.8, '£25M'],
                            ['Kobbie Mainoo', 'CM', 19, 'ENG', 3, 0, 1, 7.3, '£40M'],
                            ['Bruno Fernandes (C)', 'AM', 29, 'POR', 3, 1, 2, 8.2, '£75M'],
                            ['Marcus Rashford', 'LW', 26, 'ENG', 3, 2, 0, 7.8, '£85M'],
                            ['Alejandro Garnacho', 'LW', 20, 'ARG', 3, 1, 1, 7.4, '£50M'],
                            ['Jadon Sancho', 'RW', 24, 'ENG', 0, 0, 0, '-', '£40M'],
                            ['Antony', 'RW', 24, 'BRA', 2, 0, 0, 6.4, '£35M'],
                            ['Amad Diallo', 'RW', 22, 'CIV', 1, 0, 0, 6.7, '£25M'],
                            ['Facundo Pellistri', 'RW', 22, 'URU', 0, 0, 0, '-', '£8M'],
                            ['Rasmus Hojlund', 'ST', 21, 'DEN', 3, 1, 0, 7.2, '£65M'],
                            ['Anthony Martial', 'ST', 28, 'FRA', 0, 0, 0, '-', '£15M']
                        ]
                    }
                }
            });
            
            return rosterCard.render();
        }

        function generatePlayerStats() {
            // Updated to use Aethelred SummaryStatCard (newPlan.md Card 1.2)
            const statsCard = new AethelredSummaryStatCard({
                header: { title: 'Player Stats' },
                body: {
                    contentType: 'StatRowList',
                    contentData: [
                        { label: 'Top Scorer', value: 'Rashford (3)', valueType: 'positive' },
                        { label: 'Top Assists', value: 'Bruno (2)', valueType: 'positive' },
                        { label: 'Avg Rating', value: '7.12', valueType: 'positive' },
                        { label: 'Clean Sheets', value: '1', valueType: 'neutral' }
                    ]
                }
            });
            
            return statsCard.render();
        }

        function generateInjuryReport() {
            // Updated to use Aethelred SummaryStatCard (newPlan.md Card 1.2)
            const injuryCard = new AethelredSummaryStatCard({
                header: { title: 'Injury Report' },
                body: {
                    contentType: 'StatRowList',
                    contentData: [
                        { label: 'L. Shaw (LB)', value: '2 weeks', valueType: 'warning' },
                        { label: 'A. Martial (ST)', value: '4 weeks', valueType: 'negative' },
                        { label: 'T. Malacia (LB)', value: '1 week', valueType: 'warning' }
                    ]
                }
            });
            
            return injuryCard.render();
        }

        function generateMorale() {
            // Updated to use Aethelred SummaryStatCard (newPlan.md Card 1.2)
            const moraleCard = new AethelredSummaryStatCard({
                header: { title: 'Morale' },
                body: {
                    contentType: 'StatRowList',
                    contentData: [
                        { label: 'Squad Morale', value: 'Excellent', valueType: 'positive' },
                        { label: 'Dressing Room', value: 'United', valueType: 'positive' },
                        { label: 'Team Leaders', value: 'Bruno, Casemiro', valueType: 'neutral' }
                    ]
                }
            });
            
            return moraleCard.render();
        }

        function generateFormation() {
            // Updated to use Aethelred FormationCard - FIXED POSITIONING
            const formationCard = new AethelredFormationCard({
                header: { title: 'Formation' },
                body: {
                    contentType: 'FormationDisplay',
                    contentData: {
                        formationName: '4-2-3-1 Wide',
                        tacticName: 'Balanced Attack',
                        familiarity: 92,
                        players: [
                            { name: 'Onana', position: 'GK', coords: {x: 0.5, y: 0.95} },
                            { name: 'Dalot', position: 'RB', coords: {x: 0.85, y: 0.75} },
                            { name: 'Varane', position: 'CB', coords: {x: 0.65, y: 0.75} },
                            { name: 'Martinez', position: 'CB', coords: {x: 0.35, y: 0.75} },
                            { name: 'Shaw', position: 'LB', coords: {x: 0.15, y: 0.75} },
                            { name: 'Casemiro', position: 'DM', coords: {x: 0.4, y: 0.55} },
                            { name: 'Eriksen', position: 'CM', coords: {x: 0.6, y: 0.55} },
                            { name: 'Antony', position: 'RW', coords: {x: 0.8, y: 0.35} },
                            { name: 'Bruno', position: 'AM', coords: {x: 0.5, y: 0.35} },
                            { name: 'Rashford', position: 'LW', coords: {x: 0.2, y: 0.35} },
                            { name: 'Hojlund', position: 'ST', coords: {x: 0.5, y: 0.15} }
                        ]
                    }
                }
            });
            
            return formationCard.render();
        }

        function generateInstructions() {
            // Updated to use Aethelred SummaryStatCard (newPlan.md Card 1.2)
            const instructionsCard = new AethelredSummaryStatCard({
                header: { title: 'Team Instructions' },
                body: {
                    contentType: 'StatRowList',
                    contentData: [
                        { label: 'Mentality', value: 'Positive', valueType: 'positive' },
                        { label: 'Width', value: 'Fairly Wide', valueType: 'neutral' },
                        { label: 'Tempo', value: 'Higher', valueType: 'positive' },
                        { label: 'Defensive Line', value: 'Standard', valueType: 'neutral' },
                        { label: 'Pressing', value: 'More Often', valueType: 'positive' }
                    ]
                }
            });
            
            return instructionsCard.render();
        }

        function generateSetPieces() {
            // Updated to use Aethelred SetPieceCard - FIXED POSITIONING
            const setPieceCard = new AethelredSetPieceCard({
                header: { title: 'Set Pieces' },
                body: {
                    contentType: 'SetPieceDisplay',
                    contentData: {
                        setPieceType: 'Corner Kick Setup',
                        players: [
                            { name: 'Bruno', role: 'Corner Taker', coords: {x: 0.95, y: 0.9} },
                            { name: 'Maguire', role: 'Near Post', coords: {x: 0.45, y: 0.1} },
                            { name: 'Varane', role: 'Far Post', coords: {x: 0.55, y: 0.1} },
                            { name: 'Casemiro', role: 'Penalty Spot', coords: {x: 0.5, y: 0.3} },
                            { name: 'Rashford', role: 'Short Option', coords: {x: 0.8, y: 0.7} },
                            { name: 'Martinez', role: 'Back Post', coords: {x: 0.6, y: 0.05} }
                        ]
                    }
                }
            });
            
            return setPieceCard.render();
        }

        function generateOpposition() {
            // Updated to use Aethelred SummaryStatCard (newPlan.md Card 1.2)
            const oppositionCard = new AethelredSummaryStatCard({
                header: { title: 'Opposition Instructions' },
                body: {
                    contentType: 'StatRowList',
                    contentData: [
                        { label: 'Liverpool', value: 'Press Salah', valueType: 'neutral' },
                        { label: 'Man City', value: 'Tight Marking', valueType: 'neutral' },
                        { label: 'Arsenal', value: 'Show Weaker Foot', valueType: 'neutral' }
                    ]
                }
            });
            
            return oppositionCard.render();
        }

        function generateFitnessLevels() {
            return `
                <div class="stat-row">
                    <span class="stat-label">Squad Fitness</span>
                    <span class="stat-value">85%</span>
                </div>
                <div class="stat-row">
                    <span class="stat-label">Match Sharpness</span>
                    <span class="stat-value">78%</span>
                </div>
                <div class="stat-row">
                    <span class="stat-label">Injury Risk</span>
                    <span class="stat-value"><span class="badge badge-warning">Medium</span></span>
                </div>
            `;
        }

        function generateIndividualTraining() {
            return `
                <div class="stat-row">
                    <span class="stat-label">Hojlund</span>
                    <span class="stat-value">Finishing</span>
                </div>
                <div class="stat-row">
                    <span class="stat-label">Garnacho</span>
                    <span class="stat-value">Crossing</span>
                </div>
                <div class="stat-row">
                    <span class="stat-label">Mainoo</span>
                    <span class="stat-value">Passing</span>
                </div>
            `;
        }

        function generateTransferTargets() {
            return `
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>Name</th>
                            <th>Club</th>
                            <th>Pos</th>
                            <th>Age</th>
                            <th>Scout</th>
                            <th>Value</th>
                            <th>Status</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr><td>Jude Bellingham</td><td>Real Madrid</td><td>CM</td><td>21</td><td>95</td><td>£150M</td><td>Unlikely</td></tr>
                        <tr><td>Victor Osimhen</td><td>Napoli</td><td>ST</td><td>25</td><td>92</td><td>£120M</td><td>Interested</td></tr>
                        <tr><td>Jeremie Frimpong</td><td>Leverkusen</td><td>RB</td><td>23</td><td>88</td><td>£35M</td><td>Possible</td></tr>
                        <tr><td>Florian Wirtz</td><td>Leverkusen</td><td>AM</td><td>21</td><td>91</td><td>£85M</td><td>Monitoring</td></tr>
                        <tr><td>Josko Gvardiol</td><td>Man City</td><td>CB</td><td>22</td><td>90</td><td>£75M</td><td>Unlikely</td></tr>
                        <tr><td>Michael Olise</td><td>Crystal Palace</td><td>RW</td><td>22</td><td>85</td><td>£45M</td><td>Interested</td></tr>
                        <tr><td>Evan Ferguson</td><td>Brighton</td><td>ST</td><td>19</td><td>83</td><td>£50M</td><td>Monitoring</td></tr>
                        <tr><td>Enzo Fernandez</td><td>Chelsea</td><td>CM</td><td>23</td><td>89</td><td>£65M</td><td>Unlikely</td></tr>
                        <tr><td>Amadou Onana</td><td>Everton</td><td>DM</td><td>22</td><td>84</td><td>£40M</td><td>Possible</td></tr>
                        <tr><td>Pedro Neto</td><td>Wolves</td><td>LW</td><td>24</td><td>86</td><td>£50M</td><td>Interested</td></tr>
                        <tr><td>Jarrod Bowen</td><td>West Ham</td><td>RW</td><td>27</td><td>82</td><td>£35M</td><td>Backup</td></tr>
                        <tr><td>Ivan Toney</td><td>Brentford</td><td>ST</td><td>28</td><td>81</td><td>£30M</td><td>Backup</td></tr>
                        <tr><td>Moussa Diaby</td><td>Aston Villa</td><td>RW</td><td>25</td><td>83</td><td>£38M</td><td>Monitoring</td></tr>
                        <tr><td>Jean-Clair Todibo</td><td>Nice</td><td>CB</td><td>24</td><td>84</td><td>£32M</td><td>Possible</td></tr>
                        <tr><td>Benjamin Sesko</td><td>RB Leipzig</td><td>ST</td><td>21</td><td>85</td><td>£45M</td><td>Interested</td></tr>
                    </tbody>
                </table>
            `;
        }

        function generateTransferBudget() {
            return `
                <div class="stat-row">
                    <span class="stat-label">Available</span>
                    <span class="stat-value" style="color: var(--accent-200);">£120M</span>
                </div>
                <div class="stat-row">
                    <span class="stat-label">Spent</span>
                    <span class="stat-value">£65M</span>
                </div>
                <div class="stat-row">
                    <span class="stat-label">Wage Room</span>
                    <span class="stat-value">£450k/w</span>
                </div>
            `;
        }

        function generateScoutReports() {
            return `
                <div class="stat-row">
                    <span class="stat-label">New Reports</span>
                    <span class="stat-value">12</span>
                </div>
                <div class="stat-row">
                    <span class="stat-label">Priority Targets</span>
                    <span class="stat-value">3</span>
                </div>
                <div class="stat-row">
                    <span class="stat-label">Scouts Active</span>
                    <span class="stat-value">8</span>
                </div>
            `;
        }

        function generateRevenue() {
            return `
                <div class="stat-row">
                    <span class="stat-label">Matchday</span>
                    <span class="stat-value">£110M</span>
                </div>
                <div class="stat-row">
                    <span class="stat-label">Commercial</span>
                    <span class="stat-value">£275M</span>
                </div>
                <div class="stat-row">
                    <span class="stat-label">Broadcasting</span>
                    <span class="stat-value">£215M</span>
                </div>
            `;
        }

        function generateExpenses() {
            return `
                <div class="stat-row">
                    <span class="stat-label">Wages</span>
                    <span class="stat-value">£198M</span>
                </div>
                <div class="stat-row">
                    <span class="stat-label">Operations</span>
                    <span class="stat-value">£87M</span>
                </div>
                <div class="stat-row">
                    <span class="stat-label">Transfers</span>
                    <span class="stat-value">£125M</span>
                </div>
            `;
        }

        function generateForecast() {
            return `
                <div class="stat-row">
                    <span class="stat-label">Projected Profit</span>
                    <span class="stat-value" style="color: var(--accent-200);">£45M</span>
                </div>
                <div class="stat-row">
                    <span class="stat-label">FFP Status</span>
                    <span class="stat-value"><span class="badge badge-success">Compliant</span></span>
                </div>
                <div class="stat-row">
                    <span class="stat-label">Next Season Budget</span>
                    <span class="stat-value">£180M</span>
                </div>
            `;
        }

        function generateFFPStatus() {
            return `
                <div class="stat-row">
                    <span class="stat-label">Current Status</span>
                    <span class="stat-value"><span class="badge badge-success">Compliant</span></span>
                </div>
                <div class="stat-row">
                    <span class="stat-label">Squad Cost</span>
                    <span class="stat-value">82%</span>
                </div>
                <div class="stat-row">
                    <span class="stat-label">Margin</span>
                    <span class="stat-value">£48M</span>
                </div>
            `;
        }

        function generateFixtures() {
            return `
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>Date</th>
                            <th>Opponent</th>
                            <th>Venue</th>
                            <th>Comp</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr><td>20 Aug</td><td>Liverpool</td><td>H</td><td>PL</td></tr>
                        <tr><td>24 Aug</td><td>Galatasaray</td><td>A</td><td>UCL</td></tr>
                        <tr><td>27 Aug</td><td>Brighton</td><td>A</td><td>PL</td></tr>
                        <tr><td>02 Sep</td><td>Arsenal</td><td>H</td><td>PL</td></tr>
                    </tbody>
                </table>
            `;
        }

        function generateRecentForm() {
            // Updated to use Aethelred SummaryStatCard (newPlan.md Card 1.2)
            const formCard = new AethelredSummaryStatCard({
                header: { title: 'Recent Form' },
                body: {
                    contentType: 'StatRowList',
                    contentData: [
                        { label: 'Last 5 Matches', value: 'W W D L W', valueType: 'positive' },
                        { label: 'Goals Scored', value: '12', valueType: 'positive' },
                        { label: 'Goals Conceded', value: '7', valueType: 'warning' },
                        { label: 'Points', value: '10/15', valueType: 'positive' }
                    ]
                }
            });
            
            return formCard.render();
        }
        
        function generateResults() {
            return `
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>Date</th>
                            <th>Result</th>
                            <th>Comp</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr><td>13 Aug</td><td>W 2-1 vs Wolves</td><td>PL</td></tr>
                        <tr><td>06 Aug</td><td>L 0-2 vs Spurs</td><td>PL</td></tr>
                        <tr><td>01 Aug</td><td>W 3-0 vs Fulham</td><td>PL</td></tr>
                    </tbody>
                </table>
            `;
        }

        function generateCompetitions() {
            return `
                <div class="stat-row">
                    <span class="stat-label">Premier League</span>
                    <span class="stat-value">4th</span>
                </div>
                <div class="stat-row">
                    <span class="stat-label">Champions League</span>
                    <span class="stat-value">Group Stage</span>
                </div>
                <div class="stat-row">
                    <span class="stat-label">FA Cup</span>
                    <span class="stat-value">R3</span>
                </div>
                <div class="stat-row">
                    <span class="stat-label">Carabao Cup</span>
                    <span class="stat-value">R4</span>
                </div>
            `;
        }

        // REMOVED OLD RESIZE FUNCTION - See initResize below for the correct implementation

        // Grid Layout with explicit positioning support
        function layoutCards(container) {
            if (!container) return;
            
            console.log('layoutCards called on container:', container.id || container.className);
            const cards = Array.from(container.querySelectorAll('.card')).filter(card => !card.classList.contains('drag-placeholder'));
            
            // Build grid occupation map using configuration
            const grid = [];
            const maxRows = Math.max(30, GRID_CONFIG.rows * 2); // Allow for overflow
            for (let i = 0; i < maxRows; i++) {
                grid[i] = new Array(GRID_CONFIG.columns).fill(false);
            }
            
            // First pass: place cards with explicit positions
            const cardsToAutoPlace = [];
            
            cards.forEach((card, index) => {
                // Get dimensions from classes - check up to max configured
                let width = 1, height = 2;
                for (let w = 1; w <= GRID_CONFIG.maxCSSClasses.width; w++) {
                    if (card.classList.contains(`w${w}`)) width = w;
                }
                for (let h = 1; h <= GRID_CONFIG.maxCSSClasses.height; h++) {
                    if (card.classList.contains(`h${h}`)) height = h;
                }
                console.log(`Card ${index}: detected w${width} h${height}, classes:`, card.className);
                
                // Check if card has explicit positioning
                const gridColumn = card.style.gridColumn;
                const gridRow = card.style.gridRow;
                
                if (gridColumn && gridRow) {
                    // Extract position from CSS grid values
                    const colMatch = gridColumn.match(/(\d+)\s*\/\s*span\s*(\d+)/);
                    const rowMatch = gridRow.match(/(\d+)\s*\/\s*span\s*(\d+)/);
                    
                    if (colMatch && rowMatch) {
                        const col = parseInt(colMatch[1]) - 1; // Convert to 0-indexed
                        const row = parseInt(rowMatch[1]) - 1;
                        
                        // Mark space as occupied
                        for (let r = 0; r < height && row + r < maxRows; r++) {
                            for (let c = 0; c < width && col + c < GRID_CONFIG.columns; c++) {
                                grid[row + r][col + c] = true;
                            }
                        }
                    }
                } else {
                    cardsToAutoPlace.push(card);
                }
            });
            
            // Second pass: auto-place remaining cards
            cardsToAutoPlace.forEach((card, index) => {
                // Get dimensions from classes using configuration
                let width = 1, height = 2;
                for (let w = 1; w <= GRID_CONFIG.maxCSSClasses.width; w++) {
                    if (card.classList.contains(`w${w}`)) width = w;
                }
                for (let h = 1; h <= GRID_CONFIG.maxCSSClasses.height; h++) {
                    if (card.classList.contains(`h${h}`)) height = h;
                }
                console.log(`Auto-placing card ${index}: w${width} h${height}`);
                
                // Find first available spot
                let placed = false;
                for (let row = 0; row < maxRows - height + 1 && !placed; row++) {
                    for (let col = 0; col <= GRID_CONFIG.columns - width && !placed; col++) {
                        // Check if space is free
                        let canPlace = true;
                        for (let r = 0; r < height; r++) {
                            for (let c = 0; c < width; c++) {
                                if (grid[row + r][col + c]) {
                                    canPlace = false;
                                    break;
                                }
                            }
                            if (!canPlace) break;
                        }
                        
                        if (canPlace) {
                            // Mark space as occupied
                            for (let r = 0; r < height; r++) {
                                for (let c = 0; c < width; c++) {
                                    grid[row + r][col + c] = true;
                                }
                            }
                            // Place card (grid is 1-indexed in CSS)
                            card.style.gridColumn = `${col + 1} / span ${width}`;
                            card.style.gridRow = `${row + 1} / span ${height}`;
                            placed = true;
                        }
                    }
                }
            });
        }
        
        // Resize functionality for grid sizes
        function initResize() {
            document.querySelectorAll('.resize-handle').forEach(handle => {
                handle.addEventListener('mousedown', initResizing);
            });
        }

        // Helper function to get all cards and their positions
        function getCardPositions(container, excludeCard = null) {
            const cards = Array.from(container.querySelectorAll('.card')).filter(c => 
                c !== excludeCard && !c.classList.contains('drag-placeholder')
            );
            
            return cards.map(card => {
                const gridCol = card.style.gridColumn;
                const gridRow = card.style.gridRow;
                let col = 1, row = 1, width = 1, height = 1;
                
                // Extract position
                if (gridCol) {
                    const match = gridCol.match(/(\d+)\s*\/\s*span\s*(\d+)/);
                    if (match) {
                        col = parseInt(match[1]);
                        width = parseInt(match[2]);
                    } else if (gridCol.includes('span')) {
                        width = parseInt(gridCol.match(/span\s*(\d+)/)[1]);
                    }
                }
                
                if (gridRow) {
                    const match = gridRow.match(/(\d+)\s*\/\s*span\s*(\d+)/);
                    if (match) {
                        row = parseInt(match[1]);
                        height = parseInt(match[2]);
                    } else if (gridRow.includes('span')) {
                        height = parseInt(gridRow.match(/span\s*(\d+)/)[1]);
                    }
                }
                
                // Fallback to data attributes
                width = parseInt(card.getAttribute('data-grid-w')) || width;
                height = parseInt(card.getAttribute('data-grid-h')) || height;
                
                return {
                    card,
                    col,
                    row,
                    width,
                    height,
                    endCol: col + width - 1,
                    endRow: row + height - 1
                };
            });
        }
        
        // Check if two rectangles overlap
        function rectanglesOverlap(r1, r2) {
            return !(r1.endCol < r2.col || r2.endCol < r1.col ||
                     r1.endRow < r2.row || r2.endRow < r1.row);
        }
        
        // Push cards in a specific direction
        function pushCard(card, direction, distance, allCards) {
            const cardPos = allCards.find(c => c.card === card);
            if (!cardPos) return false;
            
            let newCol = cardPos.col;
            let newRow = cardPos.row;
            
            switch(direction) {
                case 'right': newCol += distance; break;
                case 'left': newCol -= distance; break;
                case 'down': newRow += distance; break;
                case 'up': newRow -= distance; break;
            }
            
            // Check boundaries
            if (newCol < 1 || newCol + cardPos.width - 1 > GRID_CONFIG.columns ||
                newRow < 1 || newRow + cardPos.height - 1 > GRID_CONFIG.rows) {
                return false;
            }
            
            // Check for collisions with other cards
            const testPos = {
                col: newCol,
                row: newRow,
                width: cardPos.width,
                height: cardPos.height,
                endCol: newCol + cardPos.width - 1,
                endRow: newRow + cardPos.height - 1
            };
            
            const hasCollision = allCards.some(other => 
                other.card !== card && rectanglesOverlap(testPos, other)
            );
            
            if (!hasCollision) {
                // Add animation class
                card.classList.add('transitioning', 'pushed');
                
                // Update position
                card.style.gridColumn = `${newCol} / span ${cardPos.width}`;
                card.style.gridRow = `${newRow} / span ${cardPos.height}`;
                cardPos.col = newCol;
                cardPos.row = newRow;
                cardPos.endCol = testPos.endCol;
                cardPos.endRow = testPos.endRow;
                
                // Remove animation classes after transition
                setTimeout(() => {
                    card.classList.remove('transitioning', 'pushed');
                }, 300);
                
                return true;
            }
            
            return false;
        }
        
        function initResizing(e) {
            e.preventDefault();
            e.stopPropagation();
            
            const card = e.target.closest('.card');
            if (!card) return;
            
            console.log('=== RESIZE START ===');
            
            const container = card.closest('.tile-container');
            const gridOverlay = container?.querySelector('.grid-overlay');
            
            // Show grid overlay
            if (gridOverlay) gridOverlay.classList.add('active');
            
            // Get STARTING dimensions at the beginning of resize
            let startWidth = parseInt(card.getAttribute('data-grid-w'));
            let startHeight = parseInt(card.getAttribute('data-grid-h'));
            
            // Fallback to reading from classes if no data attributes
            if (!startWidth) {
                for (let w = 1; w <= GRID_CONFIG.maxCSSClasses.width; w++) {
                    if (card.classList.contains(`w${w}`)) {
                        startWidth = w;
                        break;
                    }
                }
                startWidth = startWidth || GRID_CONFIG.defaultCardWidth;
            }
            if (!startHeight) {
                for (let h = 1; h <= GRID_CONFIG.maxCSSClasses.height; h++) {
                    if (card.classList.contains(`h${h}`)) {
                        startHeight = h;
                        break;
                    }
                }
                startHeight = startHeight || GRID_CONFIG.defaultCardHeight;
            }
            
            console.log(`Starting dimensions: w${startWidth} h${startHeight}`);
            
            const startX = e.clientX;
            const startY = e.clientY;
            
            // Get current position from grid styles
            const gridColumn = card.style.gridColumn;
            const gridRow = card.style.gridRow;
            let colStart = 1, rowStart = 1;
            
            // Extract starting position if explicitly set
            if (gridColumn && gridColumn.includes('/')) {
                const match = gridColumn.match(/(\d+)\s*\/\s*span/);
                if (match) colStart = parseInt(match[1]);
            }
            if (gridRow && gridRow.includes('/')) {
                const match = gridRow.match(/(\d+)\s*\/\s*span/);
                if (match) rowStart = parseInt(match[1]);
            }
            
            console.log(`Starting position: col ${colStart}, row ${rowStart}`);
            
            // Use configuration for constraints
            const MIN_WIDTH = GRID_CONFIG.minCardWidth;
            const MIN_HEIGHT = GRID_CONFIG.minCardHeight;
            const CELL_SIZE = GRID_CONFIG.cellSizeWithGap;
            
            // Store original positions of all cards for undo
            const originalPositions = getCardPositions(container);
            let lastValidWidth = startWidth;
            let lastValidHeight = startHeight;
            
            function doResize(e) {
                const deltaX = e.clientX - startX;
                const deltaY = e.clientY - startY;
                
                // Calculate new size based on STARTING size + mouse delta
                const cellsDeltaX = Math.round(deltaX / CELL_SIZE);
                const cellsDeltaY = Math.round(deltaY / CELL_SIZE);
                
                // Apply minimum and maximum constraints
                const desiredWidth = Math.max(MIN_WIDTH, Math.min(GRID_CONFIG.columns - colStart + 1, startWidth + cellsDeltaX));
                const desiredHeight = Math.max(MIN_HEIGHT, Math.min(GRID_CONFIG.rows - rowStart + 1, startHeight + cellsDeltaY));
                
                // Only process if size actually changed
                if (desiredWidth === lastValidWidth && desiredHeight === lastValidHeight) {
                    return;
                }
                
                console.log(`Attempting resize to: w${desiredWidth} h${desiredHeight}`);
                
                // Get current positions of all cards
                const allCards = getCardPositions(container, card);
                
                // Calculate the new bounds for the resizing card
                const newBounds = {
                    col: colStart,
                    row: rowStart,
                    width: desiredWidth,
                    height: desiredHeight,
                    endCol: colStart + desiredWidth - 1,
                    endRow: rowStart + desiredHeight - 1
                };
                
                // Find overlapping cards
                const overlappingCards = allCards.filter(other => 
                    rectanglesOverlap(newBounds, other)
                );
                
                if (overlappingCards.length > 0) {
                    console.log(`Found ${overlappingCards.length} overlapping cards`);
                    
                    // Determine push direction based on resize direction
                    const isExpandingRight = desiredWidth > lastValidWidth;
                    const isExpandingDown = desiredHeight > lastValidHeight;
                    
                    let canPush = true;
                    let swapOccurred = false;
                    const pushOperations = [];
                    
                    // Try to push overlapping cards
                    for (const overlap of overlappingCards) {
                        let pushed = false;
                        
                        // Determine optimal push direction
                        if (isExpandingRight && overlap.col >= colStart + lastValidWidth) {
                            // Push right
                            const pushDistance = newBounds.endCol - overlap.col + 1;
                            if (overlap.col + overlap.width - 1 + pushDistance <= GRID_CONFIG.columns) {
                                pushOperations.push({ card: overlap.card, direction: 'right', distance: pushDistance });
                                pushed = true;
                            }
                        }
                        
                        if (!pushed && isExpandingDown && overlap.row >= rowStart + lastValidHeight) {
                            // Push down
                            const pushDistance = newBounds.endRow - overlap.row + 1;
                            if (overlap.row + overlap.height - 1 + pushDistance <= GRID_CONFIG.rows) {
                                pushOperations.push({ card: overlap.card, direction: 'down', distance: pushDistance });
                                pushed = true;
                            }
                        }
                        
                        if (!pushed) {
                            // Can't push this card - try swapping if it's a single overlap
                            if (overlappingCards.length === 1 && 
                                overlap.width >= desiredWidth && 
                                overlap.height >= desiredHeight) {
                                console.log('Cannot push - attempting swap');
                                console.log(`Swapping: Card at (${colStart},${rowStart}) size ${lastValidWidth}x${lastValidHeight} with card at (${overlap.col},${overlap.row}) size ${overlap.width}x${overlap.height}`);
                                
                                // Add animation classes for smooth swap
                                const otherCard = overlap.card;
                                otherCard.classList.add('transitioning');
                                card.classList.add('transitioning');
                                
                                // Store the other card's original position
                                const otherOrigCol = overlap.col;
                                const otherOrigRow = overlap.row;
                                
                                // Move other card to resizing card's position
                                otherCard.style.gridColumn = `${colStart} / span ${overlap.width}`;
                                otherCard.style.gridRow = `${rowStart} / span ${overlap.height}`;
                                
                                // Update data attributes on the other card
                                otherCard.setAttribute('data-grid-w', overlap.width);
                                otherCard.setAttribute('data-grid-h', overlap.height);
                                
                                // Update the resizing card to the other card's position
                                // But don't update colStart/rowStart here - do it after confirming the resize
                                
                                // Mark that a swap occurred
                                swapOccurred = true;
                                
                                // Store new position for resizing card
                                colStart = otherOrigCol;
                                rowStart = otherOrigRow;
                                
                                // Remove animation classes after transition
                                setTimeout(() => {
                                    otherCard.classList.remove('transitioning');
                                    card.classList.remove('transitioning');
                                }, 300);
                                
                                break; // Exit the loop since we handled the overlap
                            } else {
                                canPush = false;
                                break;
                            }
                        }
                    }
                    
                    if (!swapOccurred) {
                        if (canPush && pushOperations.length > 0) {
                            // Execute all push operations
                            for (const op of pushOperations) {
                                pushCard(op.card, op.direction, op.distance, allCards);
                            }
                        } else if (!canPush) {
                            console.log('Cannot expand - blocked by other cards');
                            return; // Don't resize if we can't push
                        }
                    }
                }
                
                // Update the resizing card
                lastValidWidth = desiredWidth;
                lastValidHeight = desiredHeight;
                
                card.setAttribute('data-grid-w', desiredWidth);
                card.setAttribute('data-grid-h', desiredHeight);
                
                if (colStart > 1 || rowStart > 1) {
                    card.style.gridColumn = `${colStart} / span ${desiredWidth}`;
                    card.style.gridRow = `${rowStart} / span ${desiredHeight}`;
                } else {
                    card.style.gridColumn = `span ${desiredWidth}`;
                    card.style.gridRow = `span ${desiredHeight}`;
                }
                
                // Update CSS classes for compatibility
                for (let w = 1; w <= GRID_CONFIG.maxCSSClasses.width; w++) card.classList.remove(`w${w}`);
                for (let h = 1; h <= GRID_CONFIG.maxCSSClasses.height; h++) card.classList.remove(`h${h}`);
                if (desiredWidth <= GRID_CONFIG.maxCSSClasses.width) card.classList.add(`w${desiredWidth}`);
                if (desiredHeight <= GRID_CONFIG.maxCSSClasses.height) card.classList.add(`h${desiredHeight}`);
            }
            
            function stopResize() {
                console.log('=== RESIZE END ===');
                console.log(`Final size: w${card.getAttribute('data-grid-w')} h${card.getAttribute('data-grid-h')}`);
                
                document.removeEventListener('mousemove', doResize);
                document.removeEventListener('mouseup', stopResize);
                
                // Hide grid overlay
                if (gridOverlay) gridOverlay.classList.remove('active');
            }
            
            document.addEventListener('mousemove', doResize);
            document.addEventListener('mouseup', stopResize);
        }
        
        // Sortable Grid with Edge Snapping
        let draggedCard = null;
        let placeholder = null;
        let dropIndicator = null;
        
        function initDragAndDrop() {
            document.querySelectorAll('.card').forEach(card => {
                // Only make header draggable
                const header = card.querySelector('.card-header');
                if (header) {
                    header.addEventListener('mousedown', initHeaderDrag);
                }
            });
            
            // Create drop indicator element
            dropIndicator = document.createElement('div');
            dropIndicator.className = 'drop-indicator horizontal';
            document.body.appendChild(dropIndicator);
        }
        
        function initHeaderDrag(e) {
            // Don't prevent default immediately - let double-click work
            // e.preventDefault(); // REMOVED to allow double-click
            
            // Ignore if clicking on buttons or menu items
            if (e.target.closest('.card-menu-btn') || 
                e.target.closest('.card-menu-dropdown') || 
                e.target.closest('.resize-handle')) {
                return;
            }
            
            const card = this.closest('.card');
            
            // Don't allow dragging pinned cards
            if (card.classList.contains('pinned')) {
                return;
            }
            
            // Add a small delay to distinguish from double-click
            let dragTimeout;
            let startX = e.clientX;
            let startY = e.clientY;
            let isDragging = false;
            
            const container = card.parentNode;
            const gridOverlay = container?.querySelector('.grid-overlay');
            
            // Start drag only after mouse moves a minimum distance
            function checkForDrag(moveEvent) {
                const deltaX = Math.abs(moveEvent.clientX - startX);
                const deltaY = Math.abs(moveEvent.clientY - startY);
                
                // If mouse moved more than 5 pixels, start dragging
                if (deltaX > 5 || deltaY > 5) {
                    clearTimeout(dragTimeout);
                    document.removeEventListener('mousemove', checkForDrag);
                    document.removeEventListener('mouseup', cancelDrag);
                    
                    // Now prevent default and start actual drag
                    moveEvent.preventDefault();
                    isDragging = true;
                    
                    // Show grid overlay during drag
                    if (gridOverlay) gridOverlay.classList.add('active');
                    
                    // Continue with original drag logic
                    startDragging(card, container, gridOverlay, e);
                }
            }
            
            function cancelDrag() {
                clearTimeout(dragTimeout);
                document.removeEventListener('mousemove', checkForDrag);
                document.removeEventListener('mouseup', cancelDrag);
            }
            
            // Listen for mouse movement to detect drag intent
            document.addEventListener('mousemove', checkForDrag);
            document.addEventListener('mouseup', cancelDrag);
            
            // Cancel drag detection after 200ms (double-click window)
            dragTimeout = setTimeout(cancelDrag, 200);
        }
        
        function startDragging(card, container, gridOverlay, e) {
            // This is the actual drag logic, moved from initHeaderDrag
            console.log('=== DRAG START ===');
            
            // Create a placeholder
            placeholder = document.createElement('div');
            placeholder.className = 'card drag-placeholder';
            
            // Get card dimensions - try data attributes first, then CSS classes
            let cardWidth = card.getAttribute('data-grid-w');
            let cardHeight = card.getAttribute('data-grid-h');
            
            // If no data attributes, read from CSS classes
            if (!cardWidth) {
                for (let w = 1; w <= GRID_CONFIG.maxCSSClasses.width; w++) {
                    if (card.classList.contains(`w${w}`)) {
                        cardWidth = w;
                        break;
                    }
                }
                cardWidth = cardWidth || GRID_CONFIG.defaultCardWidth;
            }
            if (!cardHeight) {
                for (let h = 1; h <= GRID_CONFIG.maxCSSClasses.height; h++) {
                    if (card.classList.contains(`h${h}`)) {
                        cardHeight = h;
                        break;
                    }
                }
                cardHeight = cardHeight || GRID_CONFIG.defaultCardHeight;
            }
            
            console.log(`Dragging card with dimensions: w${cardWidth} h${cardHeight}`);
            
            placeholder.setAttribute('data-grid-w', cardWidth);
            placeholder.setAttribute('data-grid-h', cardHeight);
            placeholder.style.gridColumn = `span ${cardWidth}`;
            placeholder.style.gridRow = `span ${cardHeight}`;
            
            // Insert placeholder at card's position
            container.insertBefore(placeholder, card);
            
            // Remove card from flow temporarily
            container.removeChild(card);
            
            // Make card follow mouse (floating above)
            card.classList.add('dragging');
            card.style.position = 'fixed';
            card.style.zIndex = '9999';
            card.style.pointerEvents = 'none';
            card.style.opacity = '0.8';
            document.body.appendChild(card);
            
            // Position card at mouse
            const rect = card.getBoundingClientRect();
            const offsetX = e.clientX - rect.left;
            const offsetY = e.clientY - rect.top;
            
            function updateCardPosition(e) {
                card.style.left = (e.clientX - offsetX) + 'px';
                card.style.top = (e.clientY - offsetY) + 'px';
            }
            
            updateCardPosition(e);
            document.body.classList.add('dragging');
            
            function handleMouseMove(e) {
                updateCardPosition(e);
                
                // Calculate grid position from mouse coordinates
                const containerRect = container.getBoundingClientRect();
                const relativeX = e.clientX - containerRect.left - GRID_CONFIG.paddingH;
                const relativeY = e.clientY - containerRect.top - GRID_CONFIG.paddingV;
                
                // Calculate grid cell using configuration
                const cellSize = GRID_CONFIG.cellSizeWithGap;
                
                const gridCol = Math.max(1, Math.min(GRID_CONFIG.columns, Math.floor(relativeX / cellSize) + 1));
                const gridRow = Math.max(1, Math.min(GRID_CONFIG.rows, Math.floor(relativeY / cellSize) + 1));
                
                // Get card dimensions
                const cardWidth = parseInt(placeholder.getAttribute('data-grid-w')) || 1;
                const cardHeight = parseInt(placeholder.getAttribute('data-grid-h')) || 2;
                
                // Ensure card fits within grid bounds
                const finalCol = Math.min(gridCol, GRID_CONFIG.columns - cardWidth + 1);
                const finalRow = Math.min(gridRow, GRID_CONFIG.rows - cardHeight + 1);
                
                // Position placeholder at calculated grid position
                placeholder.style.gridColumn = `${finalCol} / span ${cardWidth}`;
                placeholder.style.gridRow = `${finalRow} / span ${cardHeight}`;
                
                // Store grid position for final placement
                placeholder.setAttribute('data-target-col', finalCol);
                placeholder.setAttribute('data-target-row', finalRow);
            }
            
            function handleMouseUp() {
                document.removeEventListener('mousemove', handleMouseMove);
                document.removeEventListener('mouseup', handleMouseUp);
                
                // Put card back in container
                card.style.position = '';
                card.style.left = '';
                card.style.top = '';
                card.style.zIndex = '';
                card.style.pointerEvents = '';
                card.style.opacity = '';
                card.classList.remove('dragging');
                
                // Set card position explicitly from placeholder
                const targetCol = placeholder.getAttribute('data-target-col');
                const targetRow = placeholder.getAttribute('data-target-row');
                const cardWidth = placeholder.getAttribute('data-grid-w');
                const cardHeight = placeholder.getAttribute('data-grid-h');
                
                if (targetCol && targetRow) {
                    card.style.gridColumn = `${targetCol} / span ${cardWidth}`;
                    card.style.gridRow = `${targetRow} / span ${cardHeight}`;
                    // Ensure data attributes are set on the card
                    card.setAttribute('data-grid-w', cardWidth);
                    card.setAttribute('data-grid-h', cardHeight);
                }
                
                // Replace placeholder with card
                container.insertBefore(card, placeholder);
                container.removeChild(placeholder);
                
                document.body.classList.remove('dragging');
                
                // Hide grid overlay
                if (gridOverlay) gridOverlay.classList.remove('active');
                
                placeholder = null;
            }
            
            document.addEventListener('mousemove', handleMouseMove);
            document.addEventListener('mouseup', handleMouseUp);
        }
        
        // Removed unused HTML5 drag handlers - using mouse events instead

        // Add grid overlays to containers
        function addGridOverlays() {
            document.querySelectorAll('.tile-container').forEach(container => {
                if (!container.querySelector('.grid-overlay')) {
                    const overlay = document.createElement('div');
                    overlay.className = 'grid-overlay';
                    container.appendChild(overlay);
                }
            });
        }
        
        // Initialize card features when cards are loaded
        function initializeCardFeatures() {
            setTimeout(() => {
                // Add grid overlays
                addGridOverlays();
                
                // Layout all cards first
                document.querySelectorAll('.tile-container').forEach(container => {
                    layoutCards(container);
                });
                
                initResize();
                initDragAndDrop();
                
                // Re-initialize after tab switches
                document.querySelectorAll('.card').forEach(card => {
                    const header = card.querySelector('.card-header');
                    if (header && !header.hasAttribute('data-drag-init')) {
                        header.setAttribute('data-drag-init', 'true');
                        header.addEventListener('mousedown', initHeaderDrag);
                    }
                });
            }, 100);
        }

        // Define loadAllPages first
        function loadAllPages() {
            loadSquadPage();
            loadTacticsPage();
            loadTrainingPage();
            loadTransfersPage();
            loadFinancesPage();
            loadFixturesPage();
        }
        
        // Universal card creation function with proper sizing
        function createCard(title, content, sizeClass = '') {
            const sizes = getCardSizePresets();
            let w = GRID_CONFIG.defaultCardWidth, h = GRID_CONFIG.defaultCardHeight;
            
            // Map size classes to presets
            if (sizeClass.includes('small')) {
                ({ width: w, height: h } = sizes.small);
            } else if (sizeClass.includes('standard')) {
                ({ width: w, height: h } = sizes.standard);
            } else if (sizeClass.includes('medium')) {
                ({ width: w, height: h } = sizes.medium);
            } else if (sizeClass.includes('wide')) {
                ({ width: w, height: h } = sizes.wide);
                // Support wide-2 for extra wide
                if (sizeClass.includes('wide-2')) {
                    w = Math.min(w + 4, Math.floor(GRID_CONFIG.columns * 0.6));
                }
            } else if (sizeClass.includes('large')) {
                ({ width: w, height: h } = sizes.large);
            } else if (sizeClass.includes('tall')) {
                ({ width: w, height: h } = sizes.tall);
                // Support tall-2 for extra tall
                if (sizeClass.includes('tall-2')) {
                    h = Math.min(h + 2, Math.floor(GRID_CONFIG.rows * 0.7));
                }
            }
            
            // Always include data attributes for drag/drop
            return `<div class="card" data-grid-w="${w}" data-grid-h="${h}" style="grid-column: span ${w}; grid-row: span ${h};">
                <div class="card-header">
                    <span>${title}</span>
                    ${getCardMenuHTML()}
                </div>
                <div class="card-content" style="padding: 20px; overflow: auto;">${content || '<p>Loading...</p>'}</div>
                <div class="resize-handle"></div>
            </div>`;
        }
        
        function loadSquadPage() {
            const container = document.querySelector('#squad-grid-view .tile-container');
            container.innerHTML = `
                ${createCard('Starting XI', generateStartingXI(), 'standard')}
                ${createCard('Squad List', generateSquadList(), 'tall')}
                ${createCard('Formation', generateFormation(), 'small')}
                ${createCard('Player Form', generatePlayerForm(), 'small')}
                ${createCard('Squad Depth', generateSquadDepth(), 'small')}
                ${createCard('Injury Report', generateInjuryReport(), 'small')}
            `;
            setTimeout(() => initializeCardFeatures(), 100);
        }
        
        function getCardMenuHTML() {
            return `
                <button class="card-menu-btn" onclick="toggleCardMenu(this, event)">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="12" cy="12" r="1"/>
                        <circle cx="12" cy="12" r="5"/>
                    </svg>
                </button>
                <div class="card-menu-dropdown">
                    <div class="card-menu-item" onclick="pinCard(this)">Pin</div>
                    <div class="card-menu-item" onclick="removeCard(this)">Remove</div>
                    <div class="card-menu-item" onclick="replaceCard(this)">Replace</div>
                    <div class="card-menu-item" onclick="bookmarkCard(this)">Bookmark</div>
                </div>
            `;
        }
        
        function loadTacticsPage() {
            const container = document.querySelector('#tactics-grid-view .tile-container');
            container.innerHTML = `
                ${createCard('Current Tactic', generateCurrentTactic(), 'wide-2')}
                ${createCard('Alternative Tactics', generateAlternativeTactics())}
                ${createCard('Team Instructions', generateTeamInstructions(), 'wide-2')}
                ${createCard('Player Roles', generatePlayerRoles(), 'wide-2 tall-2')}
                ${createCard('Set Pieces', generateSetPieces())}
                ${createCard('Opposition Analysis', generateOppositionAnalysis())}
                ${createCard('Match Preparation', generateMatchPrep())}
                ${createCard('Tactical Familiarity', generateTacticalFamiliarity())}
            `;
            setTimeout(() => initializeCardFeatures(), 100);
        }
        
        function loadTrainingPage() {
            const container = document.querySelector('#training-grid-view .tile-container');
            container.innerHTML = `
                ${createCard('Training Schedule', generateTrainingSchedule(), 'wide-2')}
                ${createCard('Individual Training', generateIndividualTraining(), 'wide-2 tall-2')}
                ${createCard('Training Intensity', generateTrainingIntensity())}
                ${createCard('Coaches Report', generateCoachesReport())}
                ${createCard('Youth Development', generateYouthDevelopment())}
                ${createCard('Training Facilities', generateTrainingFacilities())}
                ${createCard('Fitness Levels', generateFitnessLevels())}
                ${createCard('Training Focus', generateTrainingFocus())}
            `;
            setTimeout(() => initializeCardFeatures(), 100);
        }
        
        function loadTransfersPage() {
            const container = document.querySelector('#transfers-grid-view .tile-container');
            container.innerHTML = `
                ${createCard('Transfer Targets', generateTransferTargets(), 'wide-2 tall-2')}
                ${createCard('Transfer Budget', generateTransferBudget())}
                ${createCard('Scouting Report', generateScoutingReport(), 'wide-2')}
                ${createCard('Transfer History', generateTransferHistory())}
                ${createCard('Contract Negotiations', generateContractNegotiations())}
                ${createCard('Loan Watch', generateLoanWatch())}
                ${createCard('Shortlist', generateShortlist())}
                ${createCard('Agent Offers', generateAgentOffers())}
            `;
            setTimeout(() => initializeCardFeatures(), 100);
        }
        
        function loadFinancesPage() {
            const container = document.querySelector('#finances-grid-view .tile-container');
            container.innerHTML = `
                ${createCard('Financial Overview', generateFinancialOverview(), 'wide-2')}
                ${createCard('Revenue Streams', generateRevenueStreams(), 'wide-2')}
                ${createCard('Wage Structure', generateWageStructure(), 'tall-2')}
                ${createCard('FFP Compliance', generateFFPCompliance())}
                ${createCard('Sponsorship Deals', generateSponsorshipDeals())}
                ${createCard('Stadium Revenue', generateStadiumRevenue())}
                ${createCard('Transfer Balance', generateTransferBalance())}
                ${createCard('Season Projection', generateSeasonProjection())}
            `;
            setTimeout(() => initializeCardFeatures(), 100);
        }
        
        function loadFixturesPage() {
            const container = document.querySelector('#fixtures-grid-view .tile-container');
            container.innerHTML = `
                ${createCard('Next Match', generateNextMatch(), 'wide-2')}
                ${createCard('Recent Results', generateRecentResults())}
                ${createCard('Upcoming Fixtures', generateUpcomingFixtures(), 'tall-2')}
                ${createCard('League Table', generateLeagueTable(), 'wide-2 tall-2')}
                ${createCard('Competition Progress', generateCompetitionProgress())}
                ${createCard('Head to Head', generateHeadToHead())}
                ${createCard('Season Stats', generateSeasonStats())}
                ${createCard('Fixture Congestion', generateFixtureCongestion())}
            `;
            setTimeout(() => initializeCardFeatures(), 100);
        }
        
        // Reinitialize when switching tabs
        const originalSwitchTab = switchTab;
        window.switchTab = function(tab, element) {
            originalSwitchTab(tab, element);
            setTimeout(() => {
                initializeCardFeatures();
            }, 100);
        };
        
        // Generate dynamic CSS classes based on configuration
        function generateDynamicGridClasses() {
            const style = document.createElement('style');
            let css = '/* Dynamically generated grid classes */\n';
            
            // Generate width classes
            for (let w = 1; w <= GRID_CONFIG.maxCSSClasses.width; w++) {
                css += `.card.w${w} { grid-column: span ${w}; }\n`;
            }
            
            // Generate height classes
            for (let h = 1; h <= GRID_CONFIG.maxCSSClasses.height; h++) {
                css += `.card.h${h} { grid-row: span ${h}; }\n`;
            }
            
            style.textContent = css;
            document.head.appendChild(style);
            console.log(`Generated CSS classes: w1-w${GRID_CONFIG.maxCSSClasses.width}, h1-h${GRID_CONFIG.maxCSSClasses.height}`);
        }
        
        // CLEAN UX IMPLEMENTATION - Load before initialization
    </script>
    
    <!-- ENHANCED UI COMPONENTS -->
    <script src="NAVIGATION-ENHANCEMENTS.js"></script>
    <script src="MINIMAL-SUBSCREEN-FIX.js"></script>
    <script src="RICH-VISUAL-ENHANCEMENT.js"></script>
    <script src="PROFESSIONAL-DNA-VISUALIZATION.js"></script>
    <script src="PROFESSIONAL-PIZZA-CHARTS.js"></script>
    <script src="ENHANCED-FORMATION-PHYSICS.js"></script>
    <script src="ENHANCED-SETPIECE-PHYSICS.js"></script>
    <script src="TACTICAL-FORMATION-WIDGET.js"></script>
    <script src="SETPIECE-DESIGNER-WIDGET.js"></script>
    
    <!-- COMPREHENSIVE VALIDATION SYSTEM -->
    <script src="COMPREHENSIVE-VALIDATION-SYSTEM.js"></script>
    
    <script>
        // Initialize everything after clean UX implementation
        generateDynamicGridClasses(); // Generate CSS classes first
        
        // ========================================
        // AETHELRED DESIGN SYSTEM VALIDATION & TESTING
        // ========================================
        
        /**
         * Comprehensive validation system to ensure all components match newPlan.md specifications
         */
        function validateAethelredImplementation() {
            console.log('🔍 Starting Aethelred Design System Validation...');
            const results = {
                passed: 0,
                failed: 0,
                errors: []
            };
            
            // Test all component examples from factory
            try {
                const examples = AethelredFactory.createExamples();
                console.log('✅ Component Factory Examples Generated Successfully');
                results.passed++;
                
                // Validate each component type exists and works
                AethelredFactory.getAvailableTypes().forEach(type => {
                    try {
                        console.log(`Testing ${type} component...`);
                        if (examples[type]) {
                            console.log(`✅ ${type} example created successfully`);
                            results.passed++;
                        } else {
                            console.log(`⚠️ ${type} example not available`);
                        }
                    } catch (error) {
                        console.error(`❌ ${type} failed:`, error.message);
                        results.failed++;
                        results.errors.push(`${type}: ${error.message}`);
                    }
                });
                
                // Test newPlan.md exact examples
                console.log('🧪 Testing newPlan.md Exact Examples...');
                
                // Test Financial Overview (newPlan.md Card 1.2 example)
                const financialTest = AethelredSummaryStatCard.createFinancialOverview();
                if (financialTest.header.title === 'Financial Overview' && 
                    financialTest.body.contentData.length === 3) {
                    console.log('✅ Financial Overview matches newPlan.md example');
                    results.passed++;
                } else {
                    console.log('❌ Financial Overview does not match newPlan.md');
                    results.failed++;
                }
                
                // Test Team Cohesion (newPlan.md Card 3.2 example)
                const cohesionTest = AethelredTeamCohesionCard.createExample();
                if (cohesionTest.header.title === 'Team Cohesion' && 
                    cohesionTest.body.contentData[0].type === 'StatBarRow' &&
                    cohesionTest.body.contentData[0].data.bar.value === 85) {
                    console.log('✅ Team Cohesion matches newPlan.md example');
                    results.passed++;
                } else {
                    console.log('❌ Team Cohesion does not match newPlan.md');
                    results.failed++;
                }
                
                // Test Formation Card (newPlan.md Card 3.3 example)
                const formationTest = AethelredFormationCard.createExample();
                if (formationTest.header.title === 'Formation' && 
                    formationTest.body.contentData.formationName === '4-2-3-1 Wide' &&
                    formationTest.body.contentData.players.length === 11) {
                    console.log('✅ Formation Card matches newPlan.md example');
                    results.passed++;
                } else {
                    console.log('❌ Formation Card does not match newPlan.md');
                    results.failed++;
                }
                
            } catch (error) {
                console.error('❌ Validation failed:', error);
                results.failed++;
                results.errors.push(error.message);
            }
            
            // Final report
            console.log(`\n🏆 AETHELRED VALIDATION COMPLETE`);
            console.log(`✅ Passed: ${results.passed}`);
            console.log(`❌ Failed: ${results.failed}`);
            if (results.errors.length > 0) {
                console.log(`\n🚨 Errors:`, results.errors);
            }
            
            return results;
        }
        
        // Run validation on page load
        window.addEventListener('load', () => {
            setTimeout(validateAethelredImplementation, 1000);
        });

        // Clean implementation will handle overview, skip original
        // loadPageCards('overview'); // DISABLED - handled by clean implementation
        loadAllPages();
        initializeCardFeatures();
        
        // Show initial submenu for Overview tab
        document.getElementById('overview-submenu').classList.add('active');
</body>
</html>