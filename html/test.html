<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Football Manager UI v19</title>
    <style>
        :root {
            /* ============================================
               GRID CONFIGURATION - Change these values to resize the grid
               The entire system will adapt automatically
               ============================================ */
            
            /* v16 Color Palette - Lighter and more readable */
            --neutral-100: #0a0b0d;
            --neutral-200: #12141a;
            --neutral-300: #1a1d24;
            --neutral-400: #22262f;
            
            --primary-100: #003d52;
            --primary-200: #005a7a;
            --primary-300: #0077a3;
            --primary-400: #0094cc;
            
            --accent-100: #ff6b35;
            --accent-200: #00ff88;  /* Green for continue button */
            --accent-300: #ffb800;
            --accent-400: #ff4757;
            
            /* Layout & Typography */
            --border-radius: 2px;
            --shadow-intensity: 8px;
            --font-size-xs: 10px;
            --font-size-sm: 12px;
            --font-size-base: 14px;
            --font-size-md: 16px;
            --font-size-lg: 18px;
            --font-size-xl: 20px;
            
            /* ============================================
               GRID CONTAINER DIMENSIONS
               To change grid size, modify these values:
               Example for 30x15 grid: --grid-columns: 30; --grid-rows: 15;
               Container size will be calculated automatically
               ============================================ */
            --grid-columns: 41;        /* Calculated: max columns for 1628px = 41 */
            --grid-rows: 22;           /* Reduced to 22 rows (removed 1 grid = 37px) */
            --grid-cell-size: 37px;    /* Updated to 37px square cells */
            --grid-gap: 2.4px;         /* Calculated for perfect even distribution: 95px ÷ 40 gaps = 2.375px */
            --grid-padding-v: 8px;    /* Vertical padding - Universal 8px */
            --grid-padding-h: 8px;    /* Horizontal padding - Universal 8px */
            
            /* Container dimensions (calculated from grid) */
            --container-width: 1628px;  /* Target width - fits 41 columns perfectly */
            --container-height: 881px;  /* Calculated: 22×37 + 21×2.4 + 16 = 814+50.4+16 = 880.4px rounded to 881px */
            
            /* Card Size Constraints (in grid cells) */
            --min-card-width: 6;        /* Minimum card width in cells - matches stat card size */
            --min-card-height: 3;       /* Minimum card height in cells - matches stat card size */
            --default-card-width: 18;   /* Default card width in cells - updated for 44 columns */
            --default-card-height: 10;   /* Default card height in cells - updated for 23 rows */
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, 'Inter', 'Segoe UI', sans-serif;
            color: #e4e6eb;
            overflow: hidden;
            height: 100vh;
            position: relative;
            background: #0a0b0d;
            padding-top: 126px; /* Header (40px) + Nav (48px) + Submenu (38px) = 126px */
        }

        /* Background container with gradient */
        .bg {
            position: fixed;
            inset: 0;
            z-index: 0;
            /* background: linear-gradient(135deg, #0a0b0d 0%, #1a1220 25%, #0d0f1a 50%, #0a0b0d 100%); */
            /* background: linear-gradient(135deg, rgba(10, 11, 13, 0.6) 0%, rgba(26, 18, 32, 0.6) 25%, rgba(13, 15, 26, 0.6) 50%, rgba(10, 11, 13, 0.6) 100%); */
            background: linear-gradient(135deg, #14151d 0%, #241c27 25%, #171934 50%, #141541 100%);
        }
        
        /* Background image with blend mode */
        .bg-overlay {
            position: absolute;
            inset: 0;
            width: 100%;
            height: 100%;
            background: url('assets/images/bg_002.png') center/cover no-repeat;
            /*mix-blend-mode: overlay;*/
            opacity: 0.23;
        }


        /* Header - NO hover effect */
        .header {
            background: var(--neutral-200);
            height: 40px;
            display: flex !important;
            align-items: center;
            width: 100%;
            box-shadow: 0 2px 10px rgba(0,0,0,0.5);
            z-index: 100;
            position: fixed;
            top: 0;
            left: 0;
            border-bottom: 1px solid rgba(255,255,255,0.1);
            visibility: visible !important;
            opacity: 1 !important;
        }

        .header-content {
            max-width: 1680px;
            margin: 0 auto;
            width: 100%;
            padding: 0 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .team-section {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .team-badge {
            position: absolute;
            left: calc(50% - 42.5vw);
            top: 4px;
            width: 64px;
            height: 80px; /* Span header (40px) + nav (48px) */
            z-index: 95;
            overflow: hidden;
        }
        
        .team-badge::before {
            content: '';
            position: absolute;
            inset: 0;
            background: url('assets/images/shield.png') center/contain no-repeat;
            z-index: 1;
        }
        
        .team-badge::after {
            content: '';
            position: absolute;
            inset: 0;
            background: linear-gradient(180deg, rgba(0, 148, 204, 0.8) 0%, rgba(0, 94, 128, 0.8) 100%);
            z-index: 2;
            -webkit-mask-image: url('assets/images/shield.png');
            -webkit-mask-size: contain;
            -webkit-mask-repeat: no-repeat;
            -webkit-mask-position: center;
            mask-image: url('assets/images/shield.png');
            mask-size: contain;
            mask-repeat: no-repeat;
            mask-position: center;
        }
        
        .badge-rim {
            position: absolute;
            inset: 0;
            background: url('assets/images/rim.png') center/contain no-repeat;
            z-index: 3;
            pointer-events: none;
        }

        .team-info {
            margin-left: 80px; /* Space for the large badge */
            display: flex;
            align-items: center;
        }

        .team-name {
            font-weight: 600;
            font-size: var(--font-size-base);
            color: #ffffff;
        }

        /* Header right buttons container */
        .header-right-buttons {
            position: absolute;
            right: calc(50% - 50vw + 64px);
            display: flex;
            align-items: center;
            gap: 12px;
        }

        /* Date-Time Button (same dimensions as badge) */
        .date-time-btn {
            width: auto;
            height: 30px;
            padding: 0 12px;
            background: rgba(0,0,0,0.2);
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: var(--border-radius);
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: var(--font-size-sm);
            color: rgba(255,255,255,0.9);
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .date-time-btn:hover {
            background: rgba(0,0,0,0.3);
            border-color: rgba(255,255,255,0.2);
        }

        .date-time-btn .date {
            font-weight: 500;
        }

        .date-time-btn .time {
            opacity: 0.8;
        }

        /* Navigation - v16 style */
        .nav-container {
            background: var(--neutral-200);
            width: 100%;
            box-shadow: 0 2px 8px rgba(0,0,0,0.4);
            z-index: 90;
            position: fixed;
            top: 40px;
            left: 0;
            border-bottom: 1px solid rgba(255,255,255,0.1);
            visibility: visible !important;
        }

        .nav-content {
            width: calc(85vw + 8px);
            min-width: 1024px;
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0;
            height: 48px;
            position: relative;
        }

        .nav-tabs {
            display: flex;
            gap: 8px;
            align-items: center;
            margin-left: 80px; /* Space for the badge */
        }

        .nav-tab {
            padding: 8px 16px;
            background: transparent;
            color: rgba(255,255,255,0.7);
            border: none;
            cursor: pointer;
            transition: all 0.2s ease;
            font-size: var(--font-size-sm);
            border-radius: var(--border-radius);
        }

        .nav-tab:hover {
            background: rgba(0, 148, 204, 0.2);
            color: #ffffff;
        }

        .nav-tab.active {
            background: var(--neutral-400);
            color: rgba(255,255,255,0.95);
            border-bottom: 2px solid rgba(255,255,255,0.3);
        }

        /* Navigation Right Section - Aligned buttons */
        .nav-right {
            position: absolute;
            right: calc(10vw - 265px); /*calc(10vw - 350px);*/
            display: flex;
            align-items: center;
            gap: 12px;
        }

        /* Continue Button - GREEN from v16 */
        .continue-btn {
            padding: 7px 16px;
            background: var(--neutral-400);
            color: rgba(255,255,255,0.95);
            border: 1px solid rgba(255,255,255,0.2);
            border-radius: var(--border-radius);
            cursor: pointer;
            font-weight: 600;
            font-size: var(--font-size-sm);
            transition: all 0.2s ease;
            letter-spacing: 0.5px;
        }

        .continue-btn:hover {
            transform: translateY(-1px);
            background: rgba(255,255,255,0.1);
            border-color: rgba(255,255,255,0.3);
        }

        /* Sub-navigation - Increased by 20% */
        .nav-submenu {
            height: 38px; /* Increased from 32px by 20% */
            background: var(--neutral-100);
            display: none;
            align-items: center;
            position: fixed;
            top: 88px; /* Header (40px) + Nav (48px) = 88px */
            left: 0;
            width: 100%;
            z-index: 85;
            border-bottom: 1px solid rgba(255,255,255,0.05);
        }

        .nav-submenu.active {
            display: flex;
        }

        .submenu-content {
            width: 80vw;
            min-width: 1024px;
            margin: 0 auto;
            display: flex;
            gap: 16px;
            align-items: center;
            padding-left: 30px; /* Space for the badge */
        }

        .submenu-item {
            padding: 5px 14px;
            font-size: 12px; /* Increased from 10px */
            color: rgba(255,255,255,0.6);
            cursor: pointer;
            transition: all 0.2s ease;
            border-radius: var(--border-radius);
            font-weight: 500;
        }

        .submenu-item:hover {
            background: rgba(0, 148, 204, 0.15);
            color: #ffffff;
        }

        .submenu-item.active {
            background: var(--primary-100);
            color: #ffffff;
        }

        /* Main Panel - Reduced width and spacing */
        .app-container {
            display: flex;
            justify-content: center;
            align-items: flex-start;
            height: 100vh;
            position: relative;
            width: 100%;
            max-width: 1920px;
            margin: 0 auto;
            padding-top: 20px; /* Increased by 40px to compensate for height reduction */
        }

        .main-panel {
            width: 100%;
            padding: 20px;
            overflow: hidden;
            position: relative;
            margin-top: -10px;  /* Moved up by 60px (was 15px, now -45px) */
            display: flex;
            flex-direction: column;  /* Stack elements vertically */
            align-items: center;     /* Center horizontally */
        }

        /* Card Indicators - v16 style */
        .card-indicators {
            display: none;
            justify-content: center;
            gap: 8px;
            margin-bottom: 12px;
            position: relative;
            height: 30px;
            width: auto;
        }

        .card-indicators.active {
            display: flex;
            width: auto;
        }

        .card-indicator {
            width: 28px;
            height: 28px;
            background: var(--neutral-300);
            border: 1px solid var(--primary-300);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s ease;
            font-size: var(--font-size-xs);
            position: relative;
        }

        .card-indicator:hover {
            background: var(--primary-300);
            transform: scale(1.1);
        }

        .card-indicator.active {
            background: var(--primary-400);
            border-color: var(--primary-400);
        }

        /* Indicator Tooltips */
        .card-indicator-tooltip {
            position: absolute;
            top: -25px;
            left: 50%;
            transform: translateX(-50%);
            background: var(--neutral-400);
            color: #ffffff;
            padding: 4px 8px;
            font-size: var(--font-size-xs);
            border-radius: var(--border-radius);
            white-space: nowrap;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.2s ease;
        }

        .card-indicator:hover .card-indicator-tooltip {
            opacity: 1;
        }

        /* Content Pages */
        .content-page {
            display: none;
            height: 100%;
            position: relative;
            width: 100%;
        }

        .content-page.active {
            display: flex;
            justify-content: center;
            align-items: flex-start;
            width: 100%;
        }

        /* View Containers - Reverted to working state */
        .view-container {
            display: none;
            height: calc(100% - 50px);
            width: 100%;
            justify-content: center;
            align-items: flex-start;
        }

        .view-container.active {
            display: flex;
        }
        
        /* Override for single view to fill container */
        #overview-single-view.view-container.active,
        #squad-single-view.view-container.active,
        #tactics-single-view.view-container.active,
        #training-single-view.view-container.active,
        #transfers-single-view.view-container.active,
        #finances-single-view.view-container.active,
        #fixtures-single-view.view-container.active {
            display: block;
            width: 100%;
        }

        /* Grid Container - 4 columns, 100px row height */
        .tile-container {
            display: grid;
            /* 44 columns of 37px */
            grid-template-columns: repeat(var(--grid-columns), var(--grid-cell-size));
            /* 23 rows of 37px */
            grid-template-rows: repeat(var(--grid-rows), var(--grid-cell-size));
            gap: var(--grid-gap);
            padding: var(--grid-padding-v) var(--grid-padding-h);
            width: var(--container-width);
            height: var(--container-height);
            overflow: hidden;
            background: rgba(0, 0, 0, 0.12);
            border-radius: var(--border-radius);
            backdrop-filter: blur(13px);
            position: relative;
            margin: 0 auto; /* Center the container horizontally */
        }
        
        /* Grid overlay - shows during drag/resize */
        .grid-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            pointer-events: none;
            z-index: 1000;
            opacity: 0;
            transition: opacity 0.2s ease;
        }
        
        .grid-overlay.active {
            opacity: 1;
        }
        
        .grid-overlay::before {
            content: '';
            position: absolute;
            /* Match the tile-container padding */
            top: var(--grid-padding-v);
            left: var(--grid-padding-h);
            right: var(--grid-padding-h);
            bottom: var(--grid-padding-v);
            background-image: 
                /* Grid lines */
                repeating-linear-gradient(
                    0deg,
                    rgba(0, 255, 136, 0.3) 0px,
                    rgba(0, 255, 136, 0.3) 1px,
                    transparent 1px,
                    transparent calc((var(--grid-cell-size) + var(--grid-gap)))
                ),
                repeating-linear-gradient(
                    90deg,
                    rgba(0, 255, 136, 0.3) 0px,
                    rgba(0, 255, 136, 0.3) 1px,
                    transparent 1px,
                    transparent calc((var(--grid-cell-size) + var(--grid-gap)))
                );
        }
        
        /* Cross markers at center of each grid cell */
        .grid-overlay::after {
            content: '';
            position: absolute;
            /* Match the tile-container padding */
            top: var(--grid-padding-v);
            left: var(--grid-padding-h);
            right: var(--grid-padding-h);
            bottom: var(--grid-padding-v);
            /* SVG pattern for 5px x 5px crosses - 40px spacing (32px cell + 8px gap) */
            background-image: url("data:image/svg+xml,%3Csvg width='40' height='40' xmlns='http://www.w3.org/2000/svg'%3E%3Cg%3E%3Cline x1='20' y1='17.5' x2='20' y2='22.5' stroke='rgba(0,255,136,0.3)' stroke-width='1'/%3E%3Cline x1='17.5' y1='20' x2='22.5' y2='20' stroke='rgba(0,255,136,0.3)' stroke-width='1'/%3E%3C/g%3E%3C/svg%3E");
            background-repeat: repeat;
        }


        .tile-container.layout-single {
            display: block;
            overflow: hidden;
            padding: 0;
            width: 100%;
            max-width: var(--container-width);  /* Constrain to container width */
            height: calc(var(--container-height) - 42px);  /* Account for indicators above */
            max-height: calc(var(--container-height) - 42px);
            margin: 0 auto;  /* Center if narrower */
            background: transparent;
        }

        .tile-container.layout-list {
            grid-template-columns: 1fr;
        }

        /* Cards - Multiple Size Options */
        .card {
            background: var(--neutral-200);
            border-radius: var(--border-radius);
            box-shadow: 0 var(--shadow-intensity) calc(var(--shadow-intensity) * 1.5) rgba(0,0,0,calc(0.4 * 0.95));
            overflow: hidden;
            display: flex;
            flex-direction: column;
            position: relative;
            transition: all 0.3s ease;
            border: 1px solid transparent;
            cursor: default;
        }

        /* CLEAN PROFESSIONAL STYLING - Like Squad Screen */
        
        /* All overview cards use clean, consistent styling */
        .card.tier-match-predictor,
        .card.tier-squad-health-matrix,
        .card.tier-tactical-momentum,
        .card.tier-financial-flow,
        .card.tier-intelligence-hub,
        .card.tier-training-optimizer,
        .card.tier-form-pattern,
        .card.tier-league-table,
        .card.tier-pressure-points,
        .card.tier-live-feed {
            /* Clean borders like Squad screen */
            border: 1px solid rgba(255,255,255,0.1);
            background: var(--neutral-200);
            /* Remove all excessive styling */
        }
        
        /* League Table - Clean professional styling based on Example.html */
        
        .card.tier-league-table {
            background: var(--neutral-200);
            border: 1px solid rgba(255,255,255,0.1);
        }
        
        .card.tier-league-table .data-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 11px;
        }
        
        .card.tier-league-table .data-table th {
            background: var(--neutral-300);
            padding: 8px 2px;
            text-align: left;
            font-weight: 600;
            color: rgba(255,255,255,0.9);
            border-bottom: 1px solid rgba(255,255,255,0.1);
            font-size: 10px;
        }
        
        .card.tier-league-table .data-table th:first-child { padding-left: 8px; }
        .card.tier-league-table .data-table th:last-child { padding-right: 8px; }
        
        .card.tier-league-table .data-table td {
            padding: 6px 2px;
            border-bottom: 1px solid rgba(255,255,255,0.05);
            vertical-align: middle;
            color: rgba(255,255,255,0.85);
        }
        
        .card.tier-league-table .data-table td:first-child { 
            padding-left: 8px;
            font-weight: 600;
            color: rgba(255,255,255,0.7);
        }
        
        .card.tier-league-table .data-table td:last-child { padding-right: 8px; }
        
        /* Specific column width controls for compact layout */
        .card.tier-league-table .data-table th:nth-child(1), 
        .card.tier-league-table .data-table td:nth-child(1) { width: 25px; max-width: 25px; } /* # */
        
        .card.tier-league-table .data-table th:nth-child(2), 
        .card.tier-league-table .data-table td:nth-child(2) { width: 120px; max-width: 120px; } /* Team */
        
        .card.tier-league-table .data-table th:nth-child(3), 
        .card.tier-league-table .data-table td:nth-child(3) { width: 25px; max-width: 25px; } /* P */
        
        .card.tier-league-table .data-table th:nth-child(4), 
        .card.tier-league-table .data-table td:nth-child(4) { width: 25px; max-width: 25px; } /* W */
        
        .card.tier-league-table .data-table th:nth-child(5), 
        .card.tier-league-table .data-table td:nth-child(5) { width: 25px; max-width: 25px; } /* D */
        
        .card.tier-league-table .data-table th:nth-child(6), 
        .card.tier-league-table .data-table td:nth-child(6) { width: 25px; max-width: 25px; } /* L */
        
        .card.tier-league-table .data-table th:nth-child(7), 
        .card.tier-league-table .data-table td:nth-child(7) { width: 30px; max-width: 30px; } /* GF */
        
        .card.tier-league-table .data-table th:nth-child(8), 
        .card.tier-league-table .data-table td:nth-child(8) { width: 30px; max-width: 30px; } /* GA */
        
        .card.tier-league-table .data-table th:nth-child(9), 
        .card.tier-league-table .data-table td:nth-child(9) { width: 35px; max-width: 35px; } /* GD */
        
        .card.tier-league-table .data-table th:nth-child(10), 
        .card.tier-league-table .data-table td:nth-child(10) { width: 30px; max-width: 30px; } /* Pts */
        
        .card.tier-league-table .data-table th:nth-child(11), 
        .card.tier-league-table .data-table td:nth-child(11) { width: 65px; max-width: 65px; } /* Form - extra space for 5 indicators */
        
        .card.tier-league-table .data-table tr {
            transition: background-color 0.2s;
            position: relative;
        }
        
        .card.tier-league-table .data-table tr:hover {
            background-color: rgba(255,255,255,0.05);
        }
        
        /* Team name styling */
        .card.tier-league-table .team-name {
            font-weight: 600;
            color: rgba(255,255,255,0.95);
        }
        
        /* Goal difference styling */
        .card.tier-league-table .goal-difference {
            font-weight: 600;
        }
        
        .card.tier-league-table .goal-difference.positive { color: var(--accent-200); }
        .card.tier-league-table .goal-difference.neutral { color: rgba(255,255,255,0.6); }
        .card.tier-league-table .goal-difference.negative { color: var(--accent-400); }
        
        /* Points column styling */
        .card.tier-league-table .points {
            font-weight: 700;
            font-size: 12px;
            color: rgba(255,255,255,0.95);
        }
        
        /* Form indicators - Clean CSS approach from Example.html */
        .card.tier-league-table .form-indicators {
            display: flex;
            gap: 2px;
            justify-content: flex-start;
            width: 62px; /* 5 × 10px + 4 × 2px gaps + 3px buffer = 61px */
        }
        
        .card.tier-league-table .form-indicator {
            width: 10px;
            height: 10px;
            border-radius: 2px;
            font-size: 7px;
            font-weight: bold;
            text-align: center;
            line-height: 10px;
            color: white;
            font-family: monospace;
            flex-shrink: 0;
        }
        
        .card.tier-league-table .form-w { background: var(--accent-200); }
        .card.tier-league-table .form-d { background: var(--accent-300); }
        .card.tier-league-table .form-l { background: var(--accent-400); }
        
        /* Remove old form column width - now handled by nth-child selectors */
        
        /* User team highlight */
        .card.tier-league-table .current-position {
            background: rgba(0, 148, 204, 0.15) !important;
            font-weight: bold;
        }
        
        /* Competition Zone Highlighting - Solid borders only (no gradients for dark theme) */
        .card.tier-league-table .zone-champions-league {
            border-left: 4px solid var(--accent-200);
        }
        
        .card.tier-league-table .zone-europa-league {
            border-left: 4px solid var(--accent-300);
        }
        
        .card.tier-league-table .zone-conference-league {
            border-left: 4px solid #8b5cf6;
        }
        
        .card.tier-league-table .zone-relegation {
            border-left: 4px solid var(--accent-400);
        }
        
        /* Responsive adjustments for smaller screens */
        @media (max-width: 768px) {
            .card.tier-league-table .data-table {
                font-size: 10px;
            }
            
            .card.tier-league-table .data-table th,
            .card.tier-league-table .data-table td {
                padding: 4px 2px;
            }

            .card.tier-league-table .form-indicators {
                width: 50px; /* 5 × 8px + 4 × 2px gaps + 2px buffer = 50px on mobile */
            }

            .card.tier-league-table .form-indicator {
                width: 8px;
                height: 8px;
                font-size: 6px;
                line-height: 8px;
            }
            
            /* Mobile column adjustments */
            .card.tier-league-table .data-table th:nth-child(2), 
            .card.tier-league-table .data-table td:nth-child(2) { width: 100px; max-width: 100px; } /* Team - smaller on mobile */
            
            .card.tier-league-table .data-table th:nth-child(11), 
            .card.tier-league-table .data-table td:nth-child(11) { width: 52px; max-width: 52px; } /* Form - smaller on mobile */
        }

        /* ========================================================================
           TRAINING OVERVIEW CARD - Complete redesign with calendar interface
           Based on Example.html but adapted to project styling conventions
           ======================================================================== */

        .aethelred-training-overview-card {
            background: var(--neutral-200);
            border: 1px solid rgba(255,255,255,0.1);
            overflow: hidden;
        }


        .aethelred-training-calendar-container {
            padding: 16px;
            background: var(--neutral-200);
        }

        .aethelred-training-week-summary {
            display: grid;
            grid-template-columns: 1fr auto auto auto;
            gap: 16px;
            margin-bottom: 16px;
            padding: 12px;
            background: var(--neutral-300);
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: var(--border-radius);
        }

        .aethelred-week-overview {
            display: flex;
            flex-direction: column;
        }

        .aethelred-week-overview-label {
            font-size: var(--font-size-xs);
            color: rgba(255,255,255,0.6);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 4px;
        }

        .aethelred-week-overview-value {
            font-size: var(--font-size-md);
            font-weight: 700;
            color: rgba(255,255,255,0.9);
        }

        .aethelred-week-risk-indicator {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 12px;
            background: var(--neutral-400);
            border: 1px solid var(--accent-400);
            border-radius: var(--border-radius);
        }

        .aethelred-risk-icon {
            color: var(--accent-400);
            font-size: var(--font-size-sm);
        }

        .aethelred-risk-text {
            font-size: var(--font-size-xs);
            color: var(--accent-400);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .aethelred-week-load-total {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 12px;
            background: var(--neutral-400);
            border: 1px solid var(--accent-200);
            border-radius: var(--border-radius);
        }

        .aethelred-load-total-value {
            font-size: var(--font-size-sm);
            font-weight: 700;
            color: var(--accent-200);
        }

        .aethelred-load-total-label {
            font-size: var(--font-size-xs);
            color: var(--accent-200);
            text-transform: uppercase;
        }

        .aethelred-training-calendar-week {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 0;
            border: 1px solid rgba(255,255,255,0.1);
            margin-bottom: 16px;
            border-radius: var(--border-radius);
            overflow: hidden;
        }

        .aethelred-training-day-slot {
            background: var(--neutral-300);
            border-right: 1px solid rgba(255,255,255,0.1);
            min-height: 120px;
            display: grid;
            grid-template-rows: auto auto 1fr auto;
            position: relative;
        }

        .aethelred-training-day-slot:last-child {
            border-right: none;
        }

        .aethelred-training-day-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 6px 8px;
            border-bottom: 1px solid rgba(255,255,255,0.1);
            background: var(--neutral-400);
        }

        .aethelred-training-day-name {
            font-size: var(--font-size-xs);
            font-weight: 700;
            color: rgba(255,255,255,0.9);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .aethelred-training-day-flags {
            display: flex;
            gap: 4px;
        }

        .aethelred-training-day-flag {
            font-size: var(--font-size-xs);
            padding: 2px 4px;
            border: 1px solid rgba(255,255,255,0.2);
            background: var(--neutral-200);
            color: rgba(255,255,255,0.7);
            border-radius: var(--border-radius);
        }

        .aethelred-training-day-flag.flag-risk {
            border-color: var(--accent-400);
            background: var(--neutral-400);
            color: var(--accent-400);
        }

        .aethelred-training-day-flag.flag-match {
            border-color: var(--accent-300);
            background: var(--neutral-400);
            color: var(--accent-300);
        }

        .aethelred-training-day-status {
            padding: 8px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            text-align: center;
        }

        .aethelred-training-intensity-label {
            font-size: var(--font-size-xs);
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            padding: 4px 8px;
            border: 1px solid rgba(255,255,255,0.2);
            border-radius: var(--border-radius);
        }

        /* Intensity States with Subtle Patterns */
        .aethelred-training-day-slot.intensity-high {
            background: 
                repeating-linear-gradient(
                    45deg,
                    rgba(255, 102, 102, 0.03) 0px,
                    rgba(255, 102, 102, 0.03) 1px,
                    transparent 1px,
                    transparent 12px
                ),
                var(--neutral-300);
            border-color: var(--accent-400);
        }

        .aethelred-training-day-slot.intensity-high .aethelred-training-intensity-value {
            color: var(--accent-400);
        }

        .aethelred-training-day-slot.intensity-high .aethelred-training-intensity-label {
            background: var(--accent-400);
            border-color: var(--accent-400);
            color: white;
        }

        .aethelred-training-day-slot.intensity-rest {
            background: 
                repeating-linear-gradient(
                    90deg,
                    rgba(102, 204, 102, 0.02) 0px,
                    rgba(102, 204, 102, 0.02) 1px,
                    transparent 1px,
                    transparent 16px
                ),
                var(--neutral-300);
            border-color: var(--accent-200);
        }

        .aethelred-training-day-slot.intensity-rest .aethelred-training-intensity-value {
            color: var(--accent-200);
        }

        .aethelred-training-day-slot.intensity-rest .aethelred-training-intensity-label {
            background: var(--accent-200);
            border-color: var(--accent-200);
            color: var(--neutral-100);
        }

        .aethelred-training-day-slot.day-type-match {
            background: 
                repeating-linear-gradient(
                    0deg,
                    rgba(255, 204, 102, 0.04) 0px,
                    rgba(255, 204, 102, 0.04) 1px,
                    transparent 1px,
                    transparent 10px
                ),
                var(--neutral-300);
            border-color: var(--accent-300);
        }

        .aethelred-training-day-slot.day-type-match .aethelred-training-intensity-value {
            color: var(--accent-300);
        }

        .aethelred-training-day-slot.day-type-match .aethelred-training-intensity-label {
            background: var(--accent-300);
            border-color: var(--accent-300);
            color: var(--neutral-100);
        }

        .aethelred-training-day-slot.day-off {
            background: var(--neutral-200);
            border-color: rgba(255,255,255,0.1);
        }

        .aethelred-training-day-slot.day-off .aethelred-training-intensity-label {
            background: var(--neutral-400);
            border-color: rgba(255,255,255,0.2);
            color: rgba(255,255,255,0.7);
        }

        .aethelred-training-day-notes {
            padding: 6px 8px;
            font-size: var(--font-size-xs);
            color: rgba(255,255,255,0.6);
            line-height: 1.2;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }

        .aethelred-training-load-meter {
            height: 12px;
            background: var(--neutral-400);
            border-top: 1px solid rgba(255,255,255,0.1);
            position: relative;
            overflow: hidden;
        }

        .aethelred-training-load-bar {
            position: absolute;
            left: 0;
            top: 0;
            height: 100%;
            transition: width 0.8s ease;
            background: rgba(255,255,255,0.3);
        }

        .aethelred-training-load-bar.load-high {
            background: linear-gradient(90deg, var(--accent-400), #cc3333);
        }

        .aethelred-training-load-bar.load-medium {
            background: linear-gradient(90deg, var(--accent-300), #cc9933);
        }

        .aethelred-training-load-bar.load-low {
            background: linear-gradient(90deg, var(--accent-200), #339933);
        }

        .aethelred-training-load-value {
            position: absolute;
            right: 4px;
            top: 50%;
            transform: translateY(-50%);
            font-size: var(--font-size-xs);
            font-weight: 700;
            color: rgba(255,255,255,0.9);
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.8);
        }

        /* Current Day Marker */
        .aethelred-training-day-slot.current-day {
            border: 2px solid var(--accent-300);
            box-shadow: 0 0 8px rgba(255, 204, 102, 0.3);
        }

        .aethelred-training-day-slot.current-day .aethelred-training-day-name {
            color: var(--accent-300);
            background: var(--neutral-400);
            padding: 2px 4px;
            border: 1px solid var(--accent-300);
            border-radius: var(--border-radius);
        }

        /* Risk Warning Overlay */
        .aethelred-training-day-slot.risk-high::before {
            content: '⚠';
            position: absolute;
            top: 4px;
            right: 4px;
            font-size: 12px;
            color: var(--accent-400);
            z-index: 10;
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.8);
        }

        /* At-Risk Players and Trend Analysis */
        .aethelred-training-analytics-section {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 16px;
        }

        .aethelred-at-risk-players-section {
            background: var(--neutral-300);
            border: 1px solid rgba(255,255,255,0.1);
            padding: 12px;
            border-radius: var(--border-radius);
        }

        .aethelred-at-risk-title {
            font-size: var(--font-size-xs);
            color: rgba(255,255,255,0.6);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 8px;
        }

        .aethelred-at-risk-list {
            display: grid;
            gap: 6px;
        }

        .aethelred-at-risk-player {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 6px 8px;
            background: var(--neutral-400);
            border: 1px solid var(--accent-400);
            border-radius: var(--border-radius);
        }

        .aethelred-at-risk-player-name {
            font-size: var(--font-size-sm);
            font-weight: 600;
            color: var(--accent-400);
        }

        .aethelred-at-risk-reason {
            font-size: var(--font-size-xs);
            color: var(--accent-400);
            background: var(--neutral-200);
            padding: 2px 6px;
            border-radius: var(--border-radius);
        }

        .aethelred-trend-analysis-section {
            background: var(--neutral-300);
            border: 1px solid rgba(255,255,255,0.1);
            padding: 12px;
            border-radius: var(--border-radius);
        }

        .aethelred-trend-analysis-title {
            font-size: var(--font-size-xs);
            color: rgba(255,255,255,0.6);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 8px;
        }

        .aethelred-trend-chart {
            display: flex;
            align-items: end;
            gap: 4px;
            height: 40px;
            margin-bottom: 8px;
        }

        .aethelred-trend-week {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 2px;
        }

        .aethelred-trend-bar {
            background: rgba(255,255,255,0.3);
            border: 1px solid rgba(255,255,255,0.2);
            min-height: 4px;
            width: 100%;
            border-radius: var(--border-radius);
        }

        .aethelred-trend-bar.current-week {
            background: var(--accent-300);
            border-color: var(--accent-300);
        }

        .aethelred-trend-bar.next-week {
            background: rgba(255,255,255,0.4);
            border-color: rgba(255,255,255,0.3);
        }

        .aethelred-trend-label {
            font-size: var(--font-size-xs);
            color: rgba(255,255,255,0.6);
            text-transform: uppercase;
        }

        .aethelred-trend-stats {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px;
            font-size: var(--font-size-xs);
            color: rgba(255,255,255,0.7);
        }

        /* Responsive Design */
        @media (max-width: 1024px) {
            .aethelred-training-calendar-week {
                grid-template-columns: repeat(4, 1fr);
            }
            
            .aethelred-training-analytics-section {
                grid-template-columns: 1fr;
            }
        }

        @media (max-width: 768px) {
            .aethelred-training-calendar-week {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .aethelred-training-day-slot {
                min-height: 100px;
            }
            
            .aethelred-training-week-summary {
                grid-template-columns: 1fr;
            }
        }
        
        /* ===== SQUAD HEALTH MATRIX CARD STYLING ===== */
        
        /* Squad Health Matrix Card - Enhanced dashboard styling */
        .squad-health-matrix-card {
            background: var(--neutral-200);
            border: 1px solid rgba(255,255,255,0.1);
        }
        
        /* Squad Health Matrix Container */
        .squad-health-matrix-container {
            padding: var(--grid-padding-v);
            display: grid;
            gap: 12px;
        }
        
        /* Health Metrics Row - 4-column grid for key indicators */
        .health-metrics-row {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 8px;
        }
        
        /* Health Metric Cards */
        .health-metric-card {
            background: var(--neutral-300);
            border: 1px solid rgba(255,255,255,0.05);
            border-radius: var(--border-radius);
            padding: 10px;
            display: grid;
            gap: 6px;
            transition: background 0.2s ease;
        }
        
        .health-metric-card:hover,
        .health-metric-card:focus {
            background: var(--neutral-400);
            cursor: pointer;
            outline: 2px solid var(--accent-200);
            outline-offset: 2px;
        }
        
        .health-metric-label {
            font-size: var(--font-size-xs);
            color: rgba(255,255,255,0.6);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            font-weight: 600;
        }
        
        .health-metric-value {
            font-size: var(--font-size-md);
            font-weight: 700;
            color: rgba(255,255,255,0.9);
        }
        
        /* Status-based coloring for metric values */
        .health-metric-value.status-good {
            color: var(--accent-200);
        }
        
        .health-metric-value.status-warning {
            color: var(--accent-300);
        }
        
        .health-metric-value.status-critical {
            color: var(--accent-400);
            animation: pulse-warning 2s infinite;
        }
        
        .health-metric-indicator {
            height: 6px;
            background: var(--neutral-400);
            border-radius: var(--border-radius);
            position: relative;
            overflow: hidden;
        }
        
        .health-metric-fill {
            position: absolute;
            left: 0;
            top: 0;
            height: 100%;
            border-radius: var(--border-radius);
            transition: width 0.8s ease;
        }
        
        /* Metric-specific fill colors */
        .metric-fitness .health-metric-fill {
            background: linear-gradient(90deg, var(--accent-200), #339933);
        }
        
        .metric-injuries .health-metric-fill {
            background: linear-gradient(90deg, var(--accent-400), #cc3333);
        }
        
        .metric-morale .health-metric-fill {
            background: linear-gradient(90deg, var(--accent-300), #cc9900);
        }
        
        .metric-risk .health-metric-fill {
            background: linear-gradient(90deg, var(--accent-300), var(--accent-400));
        }
        
        /* Health Details Grid - 3-column layout for detailed information */
        .health-details-grid {
            display: grid;
            grid-template-columns: 1.5fr 1fr 1fr;
            gap: 12px;
        }
        
        /* Health Detail Blocks */
        .health-detail-block {
            background: var(--neutral-300);
            border: 1px solid rgba(255,255,255,0.05);
            border-radius: var(--border-radius);
            padding: 10px;
            display: grid;
            gap: 10px;
            transition: background 0.2s ease;
        }
        
        .health-detail-block:hover {
            background: var(--neutral-400);
            cursor: pointer;
        }
        
        .health-detail-title {
            font-size: var(--font-size-xs);
            color: rgba(255,255,255,0.6);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            font-weight: 600;
        }
        
        /* Injuries List */
        .injuries-list {
            display: grid;
            gap: 6px;
        }
        
        .injury-item {
            display: grid;
            grid-template-columns: 1fr auto;
            gap: 8px;
            padding: 6px 8px;
            background: var(--neutral-200);
            border: 1px solid rgba(255,255,255,0.05);
            border-radius: var(--border-radius);
            border-left: 3px solid var(--accent-400);
            transition: background 0.2s ease;
        }
        
        .injury-item:hover {
            background: var(--neutral-300);
            cursor: pointer;
        }
        
        .injury-item.short-term {
            border-left-color: var(--accent-300);
        }
        
        .injury-item.long-term {
            border-left-color: var(--accent-400);
        }
        
        .injury-player-name {
            font-size: var(--font-size-sm);
            font-weight: 600;
            color: rgba(255,255,255,0.9);
        }
        
        .injury-eta {
            font-size: var(--font-size-xs);
            color: rgba(255,255,255,0.6);
            background: var(--neutral-400);
            padding: 2px 6px;
            border-radius: var(--border-radius);
        }
        
        /* Timeline */
        .returns-timeline {
            position: relative;
            height: 32px;
            background: var(--neutral-200);
            border: 1px solid rgba(255,255,255,0.05);
            border-radius: var(--border-radius);
            margin-top: 6px;
        }
        
        .timeline-track {
            position: absolute;
            left: 8px;
            right: 8px;
            top: 50%;
            height: 1px;
            background: rgba(255,255,255,0.2);
            transform: translateY(-50%);
        }
        
        .timeline-ticks {
            position: absolute;
            left: 8px;
            right: 8px;
            top: 4px;
            bottom: 4px;
            display: grid;
            grid-template-columns: repeat(14, 1fr);
        }
        
        .timeline-tick {
            border-left: 1px solid rgba(255,255,255,0.1);
            opacity: 0.3;
        }
        
        .timeline-tick:nth-child(7) {
            border-left-color: rgba(255,255,255,0.3);
            opacity: 1;
        }
        
        .timeline-marker {
            position: absolute;
            top: 2px;
            transform: translateX(-50%);
            z-index: 2;
        }
        
        .timeline-marker:hover .timeline-marker-label {
            opacity: 1;
            visibility: visible;
        }
        
        .timeline-marker-pin {
            width: 2px;
            height: 28px;
            background: var(--accent-300);
            border-radius: 1px;
        }
        
        .timeline-marker-label {
            position: absolute;
            bottom: 32px;
            left: 50%;
            transform: translateX(-50%);
            white-space: nowrap;
            font-size: var(--font-size-xs);
            color: rgba(255,255,255,0.9);
            background: var(--neutral-400);
            padding: 4px 6px;
            border-radius: var(--border-radius);
            border: 1px solid rgba(255,255,255,0.1);
            opacity: 0;
            visibility: hidden;
            transition: all 0.2s ease;
            z-index: 10;
        }
        
        /* Morale Distribution */
        .morale-distribution {
            display: grid;
            gap: 6px;
        }
        
        .morale-scale {
            display: grid;
            grid-template-columns: repeat(10, 1fr);
            gap: 2px;
            height: 20px;
        }
        
        .morale-cell {
            background: var(--neutral-400);
            border: 1px solid rgba(255,255,255,0.05);
            border-radius: var(--border-radius);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 10px;
        }
        
        .morale-cell.mood-excellent {
            background: rgba(0, 255, 136, 0.2);
            border-color: var(--accent-200);
            color: var(--accent-200);
        }
        
        .morale-cell.mood-good {
            background: rgba(0, 255, 136, 0.1);
            border-color: rgba(0, 255, 136, 0.5);
            color: rgba(0, 255, 136, 0.8);
        }
        
        .morale-cell.mood-neutral {
            background: rgba(255, 184, 0, 0.1);
            border-color: rgba(255, 184, 0, 0.3);
            color: rgba(255, 184, 0, 0.8);
        }
        
        .morale-cell.mood-poor {
            background: rgba(255, 71, 87, 0.1);
            border-color: rgba(255, 71, 87, 0.3);
            color: rgba(255, 71, 87, 0.8);
        }
        
        .morale-cell.mood-terrible {
            background: rgba(255, 71, 87, 0.2);
            border-color: var(--accent-400);
            color: var(--accent-400);
        }
        
        .morale-summary {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 4px;
            font-size: var(--font-size-xs);
            color: rgba(255,255,255,0.6);
        }
        
        /* Risk Areas */
        .risk-areas-list {
            display: grid;
            gap: 4px;
        }
        
        .risk-area-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 6px 8px;
            background: rgba(255, 71, 87, 0.1);
            border: 1px solid rgba(255, 71, 87, 0.2);
            border-radius: var(--border-radius);
            transition: background 0.2s ease;
        }
        
        .risk-area-item:hover {
            background: rgba(255, 71, 87, 0.15);
            cursor: pointer;
        }
        
        .risk-area-position {
            font-size: var(--font-size-sm);
            font-weight: 600;
            color: rgba(255, 153, 153, 1);
        }
        
        .risk-area-level {
            font-size: var(--font-size-xs);
            color: rgba(204, 102, 102, 1);
            background: rgba(42, 17, 17, 0.8);
            padding: 2px 6px;
            border-radius: var(--border-radius);
        }
        
        /* Availability Indicator */
        .health-availability-indicator {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 6px;
            margin-top: 6px;
        }
        
        .availability-stat {
            text-align: center;
            padding: 6px;
            background: var(--neutral-200);
            border: 1px solid rgba(255,255,255,0.05);
            border-radius: var(--border-radius);
        }
        
        .availability-value {
            font-size: var(--font-size-md);
            font-weight: 700;
            margin-bottom: 2px;
        }
        
        .availability-label {
            font-size: var(--font-size-xs);
            color: rgba(255,255,255,0.6);
            text-transform: uppercase;
        }
        
        .stat-available .availability-value {
            color: var(--accent-200);
        }
        
        .stat-injured .availability-value {
            color: var(--accent-400);
        }
        
        .stat-risk .availability-value {
            color: var(--accent-300);
        }
        
        /* Health Matrix Legend */
        .health-matrix-legend {
            font-size: var(--font-size-xs);
            color: rgba(255,255,255,0.5);
            padding: 6px 0;
            text-align: center;
        }
        
        /* Animation for critical values */
        @keyframes pulse-warning {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.6; }
        }
        
        /* Responsive adjustments */
        @media (max-width: 1024px) {
            .health-details-grid {
                grid-template-columns: 1fr;
            }
            
            .health-metrics-row {
                grid-template-columns: repeat(2, 1fr);
            }
        }
        
        @media (max-width: 768px) {
            .health-metrics-row {
                grid-template-columns: 1fr;
            }
            
            .squad-health-matrix-container {
                padding: 6px;
                gap: 8px;
            }
            
            .health-metric-card,
            .health-detail-block {
                padding: 8px;
            }
        }
        
        /* ===== END SQUAD HEALTH MATRIX STYLING ===== */
        
        /* Submenu divider */
        .submenu-divider {
            color: var(--neutral-600);
            margin: 0 8px;
            opacity: 0.6;
        }
        
        .card {
            user-select: none;
            box-sizing: border-box;
            /* Default: 1 column wide, 2 rows tall */
            grid-column: span 1;
            grid-row: span 2;
        }
        
        /* Smooth transitions for push/swap animations */
        .card.transitioning {
            transition: all 0.2s cubic-bezier(0.4, 0.0, 0.2, 1);
        }
        
        .card.pushed {
            animation: push-feedback 0.3s ease;
        }
        
        @keyframes push-feedback {
            0% { transform: scale(1); }
            50% { transform: scale(0.98); }
            100% { transform: scale(1); }
        }
        
        /* Swap indicator pulse animation */
        @keyframes pulse {
            from { opacity: 0.3; }
            to { opacity: 0.7; }
        }
        
        
        /* Width and Height classes are now generated dynamically in JavaScript
           based on GRID_CONFIG to adapt to any grid size */

        .card:hover {
            box-shadow: 0 var(--shadow-intensity) calc(var(--shadow-intensity) * 2) rgba(0, 148, 204, 0.3);
            border-color: var(--primary-300);
        }
        
        .card.dragging {
            opacity: 0.5;
            z-index: 1000;
            pointer-events: none;
        }
        
        .card.drag-placeholder {
            background: rgba(0, 148, 204, 0.1);
            border: 2px dashed rgba(0, 148, 204, 0.3);
            box-shadow: none;
        }
        
        /* Drop indicators - simple before/after */
        .card.drop-target-before::before,
        .card.drop-target-after::after {
            content: '';
            position: absolute;
            left: 0;
            right: 0;
            height: 4px;
            background: var(--accent-200);
            box-shadow: 0 0 10px rgba(0, 255, 136, 0.8);
            z-index: 999;
            pointer-events: none;
        }
        
        .card.drop-target-before::before {
            top: -8px;
        }
        
        .card.drop-target-after::after {
            bottom: -8px;
        }
        
        .card.pinned {
            cursor: default;
            position: relative;
        }
        
        /* Pin icon only shows when dragging is active */
        body.dragging .card.pinned::before {
            content: '';
            position: absolute;
            top: 8px;
            right: 40px;
            width: 20px;
            height: 20px;
            background: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="white"><path d="M16,12V4H17V2H7V4H8V12L6,14V16H11.2V22H12.8V16H18V14L16,12Z"/></svg>') no-repeat center;
            background-size: contain;
            filter: drop-shadow(0 2px 4px rgba(0, 0, 0, 0.5));
            z-index: 11;
        }
        
        /* Red glow when attempting to drop on pinned card */
        .card.pinned.drag-over {
            border: 2px solid #ff4757;
            box-shadow: 
                0 0 30px rgba(255, 71, 87, 0.6),
                0 0 60px rgba(255, 71, 87, 0.3),
                inset 0 0 20px rgba(255, 71, 87, 0.1);
        }

        .card.expanded {
            width: 100%;
            height: calc(var(--container-height) - 42px);  /* Container height minus indicators (30px + 12px margin) */
            max-width: var(--container-width);  /* Constrain to container width */
            max-height: calc(var(--container-height) - 42px);  /* Account for indicators */
            margin: 0 auto;  /* Center if narrower than parent */
        }

        /* Card Header - v13 height (35px total) */
        .card-header {
            background: var(--neutral-100);
            padding: 6px 12px; /* Reduced from 10px to achieve 35px total height */
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
            color: var(--primary-400);
            border-bottom: 2px solid var(--primary-300);
            display: flex;
            justify-content: space-between;
            align-items: center;
            height: 35px;
            box-sizing: border-box;
            cursor: default; /* Use default cursor */
        }

        .card-header span {
            font-weight: 600;
            font-size: 11px;
            color: var(--primary-400);
        }

        /* Card Dropdown Menu */
        .card-menu {
            position: relative;
        }

        .card-menu-btn {
            background: transparent;
            border: none;
            color: rgba(255,255,255,0.6);
            cursor: pointer;
            padding: 2px;
            margin-right: -8px;
            transition: all 0.2s ease;
        }

        .card-menu-btn:hover {
            color: var(--primary-400);
        }

        .card-menu-dropdown {
            position: absolute;
            top: 100%;
            right: 0;
            background: var(--neutral-400);
            border: 1px solid var(--neutral-500);
            border-radius: var(--border-radius);
            padding: 4px 0;
            display: none;
            z-index: 10;
            min-width: 120px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
        }

        .card-menu-dropdown.active {
            display: block;
        }

        .card-menu-item {
            padding: 8px 12px;
            color: rgba(255,255,255,0.8);
            cursor: pointer;
            font-size: 11px;
            transition: all 0.2s ease;
            border-bottom: 1px solid var(--neutral-300);
        }

        .card-menu-item:last-child {
            border-bottom: none;
        }

        .card-menu-item:hover {
            background: var(--primary-100);
            color: #ffffff;
        }

        /* Card Body - v16 style */
        .card-body {
            padding: 8px;
            overflow-y: auto;
            flex: 1;
        }

        /* Resize Handles - RESTORED from main.html functionality */
        .resize-handle {
            position: absolute;
            bottom: 0;
            right: 0;
            width: 20px;
            height: 20px;
            cursor: nwse-resize;
            opacity: 0;
            transition: opacity 0.2s;
            background: linear-gradient(135deg, transparent 50%, rgba(255,255,255,0.1) 50%);
            z-index: 10;
        }
        
        .resize-handle-bl {
            position: absolute;
            bottom: 0;
            left: 0;
            width: 20px;
            height: 20px;
            cursor: nesw-resize;
            opacity: 0;
            transition: opacity 0.2s;
            background: linear-gradient(225deg, transparent 50%, rgba(255,255,255,0.1) 50%);
            z-index: 10;
        }

        .card:hover .resize-handle,
        .card:hover .resize-handle-bl {
            opacity: 0.5;
        }
        
        .card:hover .resize-handle {
            background: linear-gradient(135deg, transparent 50%, var(--primary-400) 50%);
        }
        
        .card:hover .resize-handle-bl {
            background: linear-gradient(225deg, transparent 50%, var(--primary-400) 50%);
        }

        /* v16 Styled Scrollbars */
        .card-body::-webkit-scrollbar,
        .aethelred-card-body::-webkit-scrollbar,
        .tile-container::-webkit-scrollbar {
            width: 10px;
            height: 10px;
        }

        .card-body::-webkit-scrollbar-track,
        .aethelred-card-body::-webkit-scrollbar-track,
        .tile-container::-webkit-scrollbar-track {
            background: rgba(255,255,255,0.05);
            border-radius: 10px;
            margin: 10px 0;
        }
        
        /* Add padding to horizontal scrollbar track */
        .card-body::-webkit-scrollbar-track:horizontal,
        .aethelred-card-body::-webkit-scrollbar-track:horizontal {
            margin: 0 15px;
        }

        .card-body::-webkit-scrollbar-thumb,
        .aethelred-card-body::-webkit-scrollbar-thumb,
        .tile-container::-webkit-scrollbar-thumb {
            background: var(--primary-300);
            border-radius: 10px;
            border: 2px solid var(--neutral-200);
        }

        .card-body::-webkit-scrollbar-thumb:hover,
        .aethelred-card-body::-webkit-scrollbar-thumb:hover,
        .tile-container::-webkit-scrollbar-thumb:hover {
            background: var(--primary-400);
        }

        .card-body::-webkit-scrollbar-corner,
        .aethelred-card-body::-webkit-scrollbar-corner,
        .tile-container::-webkit-scrollbar-corner {
            background: transparent;
        }

        /* Consistent Card Content Design System */
        .stat-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 6px 0;
            border-bottom: 1px solid rgba(255,255,255,0.05);
            font-size: 11px;
        }
        .stat-row:last-child {
            border-bottom: none;
        }

        .stat-label {
            color: rgba(255,255,255,0.5);
            font-size: 10px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .stat-value {
            color: rgba(255,255,255,0.9);
            font-weight: 600;
            font-size: 11px;
        }
        .stat-value.positive { color: var(--accent-200); }
        .stat-value.negative { color: var(--accent-400); }
        .stat-value.warning { color: var(--accent-300); }
        
        /* Mini tables for card content */
        .mini-table {
            width: 100%;
            font-size: 10px;
            border-collapse: collapse;
        }
        .mini-table th {
            text-align: left;
            padding: 4px;
            color: rgba(255,255,255,0.5);
            font-weight: 500;
            border-bottom: 1px solid rgba(255,255,255,0.1);
            text-transform: uppercase;
            font-size: 9px;
        }
        .mini-table td {
            padding: 4px;
            color: rgba(255,255,255,0.8);
        }
        .mini-table tr:hover {
            background: rgba(0,148,204,0.1);
        }
        
        /* Enhanced Progress bars with professional gradients from main.html */
        .stat-bar {
            width: 100%;
            height: 8px;
            background: rgba(255,255,255,0.1);
            border-radius: 4px;
            margin: 4px 0;
            overflow: hidden;
            position: relative;
        }
        .stat-bar-fill {
            height: 100%;
            border-radius: 4px;
            transition: width 0.6s ease-in-out;
            position: relative;
        }
        .stat-bar-fill.high { 
            background: linear-gradient(90deg, var(--accent-200) 0%, rgba(0, 255, 136, 0.8) 100%);
            box-shadow: 0 0 8px rgba(0, 255, 136, 0.4);
        }
        .stat-bar-fill.medium { 
            background: linear-gradient(90deg, var(--accent-300) 0%, rgba(255, 184, 0, 0.8) 100%);
            box-shadow: 0 0 8px rgba(255, 184, 0, 0.4);
        }
        .stat-bar-fill.low { 
            background: linear-gradient(90deg, var(--accent-400) 0%, rgba(255, 71, 87, 0.8) 100%);
            box-shadow: 0 0 8px rgba(255, 71, 87, 0.4);
        }

        /* Data Tables */
        .data-table {
            width: 100%;
            font-size: var(--font-size-sm);
        }

        .data-table th {
            text-align: left;
            padding: 8px 4px;
            border-bottom: 1px solid var(--neutral-400);
            color: rgba(255,255,255,0.6);
            font-size: var(--font-size-xs);
            font-weight: 500;
            text-transform: uppercase;
        }

        .data-table td {
            padding: 6px 4px;
            border-bottom: 1px solid rgba(255,255,255,0.05);
            color: rgba(255,255,255,0.9);
        }

        /* Settings FAB - Subtle and translucent */
        .settings-fab {
            position: fixed;
            bottom: 36px;
            right: calc(50% - 50vw + 64px);
            width: 56px;
            height: 56px;
            background: rgba(40, 44, 52, 0.6); /* Translucent dark grey */
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
            transition: all 0.3s ease;
            z-index: 100;
            backdrop-filter: blur(10px);
        }

        .settings-fab:hover {
            transform: translateY(-2px) rotate(90deg);
            background: rgba(40, 44, 52, 0.8);
            box-shadow: 
                0 4px 12px rgba(0, 0, 0, 0.3),
                0 0 30px rgba(0, 148, 204, 0.5),
                0 0 50px rgba(0, 148, 204, 0.3); /* Stronger glow */
        }

        .settings-fab svg {
            width: 24px;
            height: 24px;
            fill: #808080; /* Grey icon */
            opacity: 0.8;
        }

        .settings-fab:hover svg {
            fill: var(--primary-400);
            opacity: 1;
            filter: drop-shadow(0 0 8px rgba(0, 148, 204, 0.6));
        }
        
        /* Hamburger Menu Dropdown */
        .hamburger-menu {
            position: fixed;
            bottom: 100px;
            right: calc(50% - 50vw + 64px);
            background: var(--neutral-300);
            border: 1px solid var(--neutral-400);
            border-radius: var(--border-radius);
            padding: 8px 0;
            display: none;
            z-index: 101;
            min-width: 200px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
        }
        
        .hamburger-menu.active {
            display: block;
        }
        
        .menu-item {
            padding: 12px 20px;
            color: rgba(255,255,255,0.9);
            cursor: pointer;
            font-size: 14px;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        .menu-item:hover {
            background: rgba(0, 148, 204, 0.15);
            color: var(--primary-400);
        }
        
        .menu-item svg {
            opacity: 0.8;
        }
        
        .menu-item:hover svg {
            opacity: 1;
        }
        
        .menu-divider {
            height: 1px;
            background: var(--neutral-400);
            margin: 8px 0;
        }

        /* Settings Dialog */
        .settings-dialog {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: var(--neutral-200);
            border: 1px solid var(--neutral-400);
            border-radius: var(--border-radius);
            padding: 24px;
            z-index: 1000;
            display: none;
            min-width: 400px;
            box-shadow: 0 16px 48px rgba(0,0,0,0.5);
        }

        .settings-dialog.active {
            display: block;
        }

        .settings-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 12px;
            border-bottom: 1px solid var(--neutral-400);
        }

        .settings-title {
            font-size: var(--font-size-lg);
            font-weight: 600;
            color: #ffffff;
        }

        .settings-close {
            background: transparent;
            border: none;
            color: rgba(255,255,255,0.6);
            cursor: pointer;
            font-size: 24px;
            transition: all 0.2s ease;
        }

        .settings-close:hover {
            color: var(--accent-400);
        }

        .settings-group {
            margin-bottom: 20px;
        }

        .settings-group-title {
            font-size: var(--font-size-sm);
            font-weight: 600;
            color: rgba(255,255,255,0.8);
            margin-bottom: 10px;
            text-transform: uppercase;
        }

        .setting-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 0;
        }

        .setting-label {
            font-size: var(--font-size-sm);
            color: rgba(255,255,255,0.7);
        }

        /* Overlay */
        .overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.7);
            z-index: 999;
            display: none;
        }

        .overlay.active {
            display: block;
        }

        /* Badge styles */
        .badge {
            padding: 2px 6px;
            border-radius: 2px;
            font-size: 10px;
            font-weight: 600;
        }

        .badge-success { background: var(--accent-200); color: var(--neutral-100); }
        .badge-warning { background: var(--accent-300); color: var(--neutral-100); }
        .badge-danger { background: var(--accent-400); color: white; }

        /* ============================================
           PROFESSIONAL FORMATION INTERFACE
           FIFA-standard proportions and styling
           ============================================ */
        
        .formation-interface {
            width: var(--container-width);
            height: var(--container-height);
            background: var(--neutral-200);
            border-radius: var(--border-radius);
            display: flex;
            flex-direction: column;
            overflow: hidden;
            box-shadow: 0 var(--shadow-intensity) calc(var(--shadow-intensity) * 1.5) rgba(0,0,0,0.4);
            margin: 0 auto;
        }
        
        .formation-header {
            background: var(--neutral-100);
            padding: 8px 20px;
            border-bottom: 2px solid var(--primary-300);
            display: flex;
            justify-content: space-between;
            align-items: center;
            height: 40px;
        }
        
        .formation-title {
            color: var(--primary-400);
            font-size: var(--font-size-sm);
            font-weight: 600;
            text-transform: uppercase;
        }
        
        .formation-icon-controls {
            display: flex;
            gap: 8px;
            align-items: center;
        }
        
        .formation-icon-btn {
            width: 24px;
            height: 24px;
            background: var(--neutral-300);
            border: 1px solid var(--neutral-400);
            border-radius: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            color: rgba(255,255,255,0.8);
            font-size: 12px;
            transition: all 0.2s ease;
        }
        
        .formation-icon-btn:hover {
            background: var(--primary-300);
            border-color: var(--primary-400);
            color: white;
        }
        
        .phase-selector {
            display: flex;
            gap: 8px;
        }
        
        .phase-btn {
            padding: 8px 16px;
            background: var(--neutral-300);
            color: rgba(255,255,255,0.7);
            border: 1px solid var(--neutral-400);
            border-radius: var(--border-radius);
            cursor: pointer;
            transition: all 0.2s ease;
            font-size: var(--font-size-sm);
            font-weight: 500;
        }
        
        .phase-btn:hover {
            background: var(--primary-200);
            color: white;
            border-color: var(--primary-300);
        }
        
        .phase-btn.active {
            background: var(--primary-400);
            color: white;
            border-color: var(--primary-400);
        }
        
        .formation-content {
            flex: 1;
            display: flex;
            gap: 8px;
            padding: 8px 8px 8px 8px;
            height: 100%;
        }
        
        .tactical-column {
            flex: 0 0 30%;
            display: flex;
            flex-direction: column;
            gap: 0px;
            height: 100%;
        }
        
        .soccer-field {
            flex: 0 0 100%;
            background: linear-gradient(135deg, #1a5c1a 0%, #2d7a2d 50%, #1a5c1a 100%);
            padding: 0px;
            display: flex;
            justify-content: center;
            align-items: center;
            cursor: default;
            border-radius: var(--border-radius);
            max-height: 100%;
            overflow: hidden;
        }
        
        .soccer-field svg {
            width: 100%;
            height: 100%;
            max-height: 100%;
            max-width: 100%;
        }
        
        .formation-details {
            flex: 0 0 30%;
            background: var(--neutral-400);
            border-radius: var(--border-radius);
            padding: 0px;
            display: flex;
            flex-direction: column;
            gap: 0px;
            overflow-y: auto;
        }
        
        .player-selection {
            flex: 0 0 40%;
            background: var(--neutral-300);
            border-radius: var(--border-radius);
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }
        
        .player-selection h3 {
            margin: 0 0 15px 0;
            font-size: var(--font-size-sm);
            color: var(--primary-400);
        }
        
        #formation-all-players {
            overflow-y: auto;
            flex: 1;
            max-height: 786px;
            padding-right: 0px;
        }
        
        /* Formation player list scrollbar - Match card styling */
        #formation-all-players::-webkit-scrollbar {
            width: 10px;
        }
        
        #formation-all-players::-webkit-scrollbar-track {
            background: rgba(255,255,255,0.05);
            border-radius: 10px;
            margin: 10px 0;
        }
        
        #formation-all-players::-webkit-scrollbar-thumb {
            background: var(--primary-300);
            border-radius: 10px;
            border: 2px solid var(--neutral-200);
        }
        
        #formation-all-players::-webkit-scrollbar-thumb:hover {
            background: var(--primary-400);
        }
        
        #formation-all-players::-webkit-scrollbar-corner {
            background: transparent;
        }
        
        .formation-info {
            background: var(--neutral-200);
            padding: 8px;
            border-radius: var(--border-radius);
            border: 1px solid var(--neutral-400);
            flex: 1;
            display: flex;
            flex-direction: column;
        }
        
        .formation-info h3 {
            color: var(--primary-400);
            font-size: var(--font-size-md);
            font-weight: 600;
            margin-bottom: 12px;
        }
        
        .formation-stat {
            display: flex;
            justify-content: space-between;
            padding: 6px 0;
            border-bottom: 1px solid rgba(255,255,255,0.1);
            font-size: var(--font-size-xs);
        }
        
        .formation-stat:last-child {
            border-bottom: none;
        }
        
        .formation-stat .label {
            color: rgba(255,255,255,0.6);
        }
        
        .formation-stat .value {
            color: rgba(255,255,255,0.9);
            font-weight: 500;
        }
        
        .formation-controls-btn {
            padding: 10px 16px;
            background: var(--neutral-400);
            color: rgba(255,255,255,0.9);
            border: 1px solid var(--neutral-500);
            border-radius: var(--border-radius);
            cursor: pointer;
            transition: all 0.2s ease;
            font-size: var(--font-size-sm);
            font-weight: 500;
        }
        
        .formation-controls-btn:hover {
            background: var(--primary-300);
            border-color: var(--primary-400);
            color: white;
        }
    </style>
</head>
<body>
    <div class="bg">
        <div class="bg-overlay"></div>
    </div>
    
    <!-- Header with Date-Time Button -->
    <div class="header" ondblclick="toggleSingleView()">
        <div class="header-content">
            <div class="team-badge">
                <div class="badge-rim"></div>
            </div>
            <div class="team-section">
                <div class="team-info">
                    <div class="team-name">Manchester United</div>
                </div>
            </div>
            <div class="header-right-buttons">
                <button class="date-time-btn" onclick="advanceTime()">
                    <span class="date">15 August 2024</span>
                    <span class="time">14:30</span>
                </button>
            </div>
        </div>
    </div>

    <!-- Navigation with Continue Button -->
    <nav class="nav-container">
        <div class="nav-content">
            <div class="nav-tabs">
                <button class="nav-tab active" onclick="switchTab('overview', this)">Overview</button>
                <button class="nav-tab" onclick="switchTab('squad', this)">Squad</button>
                <button class="nav-tab" onclick="switchTab('tactics', this)">Tactics</button>
                <button class="nav-tab" onclick="switchTab('training', this)">Training</button>
                <button class="nav-tab" onclick="switchTab('transfers', this)">Transfers</button>
                <button class="nav-tab" onclick="switchTab('finances', this)">Finances</button>
                <button class="nav-tab" onclick="switchTab('fixtures', this)">Fixtures</button>
            </div>
            <div class="nav-right">
                <button class="continue-btn" onclick="continueSim()">CONTINUE</button>
            </div>
        </div>
    </nav>

    <!-- Submenus for all navigation items -->
    <div class="nav-submenu" id="overview-submenu">
        <div class="submenu-content">
            <span class="submenu-item active" onclick="switchSubmenu('overview', 'dashboard', this)">Dashboard</span>
            <span class="submenu-item" onclick="switchSubmenu('overview', 'reports', this)">Reports</span>
            <span class="submenu-item" onclick="switchSubmenu('overview', 'statistics', this)">Statistics</span>
            <span class="submenu-item" onclick="switchSubmenu('overview', 'news', this)">News</span>
            <span class="submenu-item" onclick="switchSubmenu('overview', 'inbox', this)">Inbox</span>
            <span class="submenu-divider">|</span>
            <span class="submenu-item" onclick="saveCurrentLayout()" title="Save current layout to JSON">
                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"></path>
                    <polyline points="17,21 17,13 7,13 7,21"></polyline>
                    <polyline points="7,3 7,8 15,8"></polyline>
                </svg>
                Save Layout
            </span>
            <span class="submenu-item" onclick="loadLayoutFromFile()" title="Load layout from JSON file">
                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                    <polyline points="14,2 14,8 20,8"></polyline>
                    <line x1="16" y1="13" x2="8" y2="13"></line>
                    <line x1="16" y1="17" x2="8" y2="17"></line>
                    <polyline points="10,9 9,9 8,9"></polyline>
                </svg>
                Load Layout
            </span>
        </div>
    </div>

    <div class="nav-submenu" id="squad-submenu">
        <div class="submenu-content">
            <span class="submenu-item active" onclick="switchSubmenu('squad', 'first-team', this)">First Team</span>
            <span class="submenu-item" onclick="switchSubmenu('squad', 'reserves', this)">Reserves</span>
            <span class="submenu-item" onclick="switchSubmenu('squad', 'youth', this)">Youth</span>
            <span class="submenu-item" onclick="switchSubmenu('squad', 'staff', this)">Staff</span>
            <span class="submenu-item" onclick="switchSubmenu('squad', 'reports', this)">Reports</span>
            <span class="submenu-item" onclick="switchSubmenu('squad', 'dynamics', this)">Dynamics</span>
        </div>
    </div>

    <div class="nav-submenu" id="tactics-submenu">
        <div class="submenu-content">
            <span class="submenu-item active" onclick="showTacticsFormation(this)">Formation</span>
            <span class="submenu-item" onclick="switchSubmenu('tactics', 'instructions', this)">Instructions</span>
            <span class="submenu-item" onclick="switchSubmenu('tactics', 'set-pieces', this)">Set Pieces</span>
            <span class="submenu-item" onclick="switchSubmenu('tactics', 'opposition', this)">Opposition</span>
            <span class="submenu-item" onclick="switchSubmenu('tactics', 'analysis', this)">Analysis</span>
        </div>
    </div>

    <div class="nav-submenu" id="training-submenu">
        <div class="submenu-content">
            <span class="submenu-item active" onclick="switchSubmenu('training', 'schedule', this)">Schedule</span>
            <span class="submenu-item" onclick="switchSubmenu('training', 'individual', this)">Individual</span>
            <span class="submenu-item" onclick="switchSubmenu('training', 'coaches', this)">Coaches</span>
            <span class="submenu-item" onclick="switchSubmenu('training', 'facilities', this)">Facilities</span>
            <span class="submenu-item" onclick="switchSubmenu('training', 'reports', this)">Reports</span>
        </div>
    </div>

    <div class="nav-submenu" id="transfers-submenu">
        <div class="submenu-content">
            <span class="submenu-item active" onclick="switchSubmenu('transfers', 'transfer-hub', this)">Transfer Hub</span>
            <span class="submenu-item" onclick="switchSubmenu('transfers', 'scout-reports', this)">Scout Reports</span>
            <span class="submenu-item" onclick="switchSubmenu('transfers', 'shortlist', this)">Shortlist</span>
            <span class="submenu-item" onclick="switchSubmenu('transfers', 'loans', this)">Loans</span>
            <span class="submenu-item" onclick="switchSubmenu('transfers', 'contract-offers', this)">Contract Offers</span>
            <span class="submenu-item" onclick="switchSubmenu('transfers', 'director', this)">Director</span>
        </div>
    </div>

    <div class="nav-submenu" id="finances-submenu">
        <div class="submenu-content">
            <span class="submenu-item active" onclick="switchSubmenu('finances', 'overview', this)">Overview</span>
            <span class="submenu-item" onclick="switchSubmenu('finances', 'income', this)">Income</span>
            <span class="submenu-item" onclick="switchSubmenu('finances', 'expenditure', this)">Expenditure</span>
            <span class="submenu-item" onclick="switchSubmenu('finances', 'ffp', this)">FFP</span>
            <span class="submenu-item" onclick="switchSubmenu('finances', 'projections', this)">Projections</span>
            <span class="submenu-item" onclick="switchSubmenu('finances', 'sponsors', this)">Sponsors</span>
        </div>
    </div>

    <div class="nav-submenu" id="fixtures-submenu">
        <div class="submenu-content">
            <span class="submenu-item active" onclick="switchSubmenu('fixtures', 'calendar', this)">Calendar</span>
            <span class="submenu-item" onclick="switchSubmenu('fixtures', 'results', this)">Results</span>
            <span class="submenu-item" onclick="switchSubmenu('fixtures', 'schedule', this)">Schedule</span>
            <span class="submenu-item" onclick="switchSubmenu('fixtures', 'rules', this)">Rules</span>
            <span class="submenu-item" onclick="switchSubmenu('fixtures', 'history', this)">History</span>
        </div>
    </div>

    <!-- Main Container -->
    <div class="app-container">
        <div class="main-panel">
            <!-- Card Indicators -->
            <div class="card-indicators" id="cardIndicators">
                <!-- Populated dynamically -->
            </div>

            <!-- Overview Page -->
            <div class="content-page active" id="overview-page" data-current-view="grid">
                <!-- Grid View -->
                <div class="view-container active" id="overview-grid-view">
                    <div class="tile-container">
                        <!-- Cards will be loaded here -->
                    </div>
                </div>
                
                <!-- Single View -->
                <div class="view-container" id="overview-single-view">
                    <div class="tile-container layout-single">
                        <!-- Single card displayed here -->
                    </div>
                </div>
            </div>

            <!-- Squad Page -->
            <div class="content-page" id="squad-page" data-current-view="grid">
                <div class="view-container active" id="squad-grid-view">
                    <div class="tile-container">
                        <!-- Squad cards -->
                    </div>
                </div>
                <div class="view-container" id="squad-single-view">
                    <div class="tile-container layout-single"></div>
                </div>
            </div>

            <!-- Tactics Page -->
            <div class="content-page" id="tactics-page" data-current-view="formation">
                <!-- Formation View (DEFAULT - Formation is first child submenu) -->
                <div class="view-container active" id="tactics-formation-view">
                    <div class="formation-interface">
                        
                        <!-- Main Formation Content -->
                        <div class="formation-content">
                            <!-- LEFT COLUMN (30%) - Formation Details -->
                            <div class="formation-details">       
                                <!-- Formation Information -->
                                <div class="formation-info">
                                    <!-- Tactics Control Icons - First Item -->
                                    <div style="display: flex; justify-content: center; gap: 6px; margin-bottom: 0px; 
                                               padding: 0px; background: rgba(255,255,255,0.05); border-radius: 0px;">
                                    <!--
                                    <div style="display: flex; justify-content: center; gap: 6px; margin-bottom: 8px; 
                                               padding: 4px; background: rgba(255,255,255,0.05); border-radius: 4px;">
                                    -->
                                        <button class="formation-icon-btn" onclick="saveFormation()" title="Save Formation">
                                            <svg width="12" height="12" viewBox="0 0 24 24" fill="currentColor">
                                                <path d="M17 3H5c-1.11 0-2 .9-2 2v14c0 1.1.89 2 2 2h14c1.1 0 2-.9 2-2V7l-4-4zm-5 16c-1.66 0-3-1.34-3-3s1.34-3 3-3 3 1.34 3 3-1.34 3-3 3zm3-10H5V5h10v4z"/>
                                            </svg>
                                        </button>
                                        <button class="formation-icon-btn" onclick="loadFormation()" title="Load Formation">
                                            <svg width="12" height="12" viewBox="0 0 24 24" fill="currentColor">
                                                <path d="M14,2H6A2,2 0 0,0 4,4V20A2,2 0 0,0 6,22H18A2,2 0 0,0 20,20V8L14,2M18,20H6V4H13V9H18V20Z"/>
                                            </svg>
                                        </button>
                                        <button class="formation-icon-btn" onclick="exportFormation()" title="Export as JSON">
                                            <svg width="12" height="12" viewBox="0 0 24 24" fill="currentColor">
                                                <path d="M19 9h-4V3H9v6H5l7 7 7-7zM5 18v2h14v-2H5z"/>
                                            </svg>
                                        </button>
                                    </div>
                                    
                                    <div class="formation-stat">
                                        <span class="label">Formation</span>
                                        <select onchange="changeFormation(this.value)" 
                                                style="background: var(--neutral-400); color: white; border: 1px solid var(--neutral-500); 
                                                       border-radius: 4px; padding: 2px 6px; font-size: 10px; cursor: pointer;">
                                            <option value="4-2-3-1">4-2-3-1 Wide</option>
                                            <option value="4-3-3">4-3-3 Attack</option>
                                            <option value="4-4-2">4-4-2 Flat</option>
                                            <option value="3-5-2">3-5-2 Wing-Back</option>
                                            <option value="5-3-2">5-3-2 Defensive</option>
                                            <option value="4-1-4-1">4-1-4-1 Diamond</option>
                                        </select>
                                    </div>
                                    <div class="formation-stat">
                                        <span class="label">Tactic</span>
                                        <span class="value">Fluid Counter-Attack</span>
                                    </div>
                                    <div class="formation-stat">
                                        <span class="label">Familiarity</span>
                                        <span class="value">95%</span>
                                    </div>
                                    <div class="formation-stat">
                                        <span class="label">Current Phase</span>
                                        <select id="phase-dropdown" onchange="setFormationPhase(this.value)" 
                                                style="background: var(--neutral-400); color: white; border: 1px solid var(--neutral-500); 
                                                       border-radius: 4px; padding: 4px 8px; font-size: 11px;">
                                            <option value="attacking">In Possession</option>
                                            <option value="defending">Out of Possession</option>
                                            <option value="transition_attack">Attacking Transition</option>
                                            <option value="transition_defense">Defensive Transition</option>
                                        </select>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- CENTER COLUMN (30%) - Tactical Visualization -->
                            <div class="tactical-column">
                                <!-- Soccer Field (100% of left column) -->
                                <div class="soccer-field">
                                <svg id="formation-field" viewBox="0 -1 68 109" preserveAspectRatio="xMidYMid meet">
                                    <!-- Simplified Vertical FIFA Pitch (68m wide x 105m long) - Goals top/bottom -->
                                    <defs>
                                        <pattern id="grassPattern" patternUnits="userSpaceOnUse" width="4" height="4">
                                            <rect width="4" height="4" fill="#0e7c3a"/>
                                            <rect width="2" height="2" fill="#0a5a28"/>
                                            <rect x="2" y="2" width="2" height="2" fill="#0a5a28"/>
                                        </pattern>
                                    </defs>
                                    
                                    <!-- Field Background (68m wide x 105m long) -->
                                    <rect x="0" y="0" width="68" height="108" fill="#0e7c3a" pointer-events="none"/>
                                    
                                    <!-- Subtle grass stripes -->
                                    <rect x="0" y="0" width="68" height="13.125" opacity="0.05" fill="#fff" pointer-events="none"/>
                                    <rect x="0" y="26.25" width="68" height="13.125" opacity="0.05" fill="#fff" pointer-events="none"/>
                                    <rect x="0" y="52.5" width="68" height="13.125" opacity="0.05" fill="#fff" pointer-events="none"/>
                                    <rect x="0" y="78.75" width="68" height="13.125" opacity="0.05" fill="#fff" pointer-events="none"/>
                                    
                                    <!-- FIFA-Standard Field Markings -->
                                    <g stroke="white" stroke-width="0.15" fill="none" stroke-linejoin="round" pointer-events="none">
                                        <!-- Outer boundary -->
                                        <rect x="0" y="0" width="68" height="108"/>
                                        
                                        <!-- Halfway line -->
                                        <line x1="0" y1="54" x2="68" y2="54"/>
                                        
                                        <!-- Center circle (9.15m radius) -->
                                        <circle cx="34" cy="54" r="9.15"/>
                                        <circle cx="34" cy="54" r="0.2" fill="white"/>
                                        
                                        <!-- Penalty areas (40.32m wide, 16.5m deep) -->
                                        <!-- Bottom penalty area (defending goal) -->
                                        <rect x="13.84" y="0" width="40.32" height="16.5"/>
                                        <!-- Top penalty area (attacking goal) -->
                                        <rect x="13.84" y="91.5" width="40.32" height="16.5"/>
                                        
                                        <!-- Goal areas (18.32m wide, 5.5m deep) -->
                                        <!-- Bottom goal area -->
                                        <rect x="24.84" y="0" width="18.32" height="5.5"/>
                                        <!-- Top goal area -->
                                        <rect x="24.84" y="102.5" width="18.32" height="5.5"/>
                                        
                                        <!-- Penalty marks (11m from goal line) -->
                                        <circle cx="34" cy="11" r="0.2" fill="white"/>
                                        <circle cx="34" cy="97" r="0.2" fill="white"/>
                                        
                                        <!-- Penalty arcs - REVERTED to correct version (sweep-flag=0) -->
                                        <!-- Arc curves AWAY from goal (toward center field) = sweep-flag 0 -->
                                        <path d="M 26.69 16.5 A 9.15 9.15 0 0 0 41.31 16.5" stroke="white" stroke-width="0.15"/>
                                        <!-- Top arc: same calculation with correct sweep direction -->
                                        <path d="M 41.31 91.5 A 9.15 9.15 0 0 0 26.69 91.5" stroke="white" stroke-width="0.15"/>
                                        
                                        <!-- Corner arcs (1m radius) -->
                                        <path d="M 0 1 A 1 1 0 0 1 1 0"/>
                                        <path d="M 67 0 A 1 1 0 0 1 68 1"/>
                                        <path d="M 68 107 A 1 1 0 0 1 67 108"/>
                                        <path d="M 1 108 A 1 1 0 0 1 0 107"/>
                                        
                                        <!-- Goals (7.32m wide) -->
                                        <rect x="30.34" y="-0.3" width="7.32" height="0.3" stroke="white" stroke-width="0.2" fill="white"/>
                                        <rect x="30.34" y="108" width="7.32" height="0.3" stroke="white" stroke-width="0.2" fill="white"/>
                                    </g>
                                    
                                    <!-- Player markers positioned in meter coordinates -->
                                    <g id="formation-players"></g>
                                </svg>
                                </div>
                                
                                <!-- Formation Details (25% of left column) -->
                            </div>
                            
                            <!-- RIGHT COLUMN (40%) - Player Selection -->
                            <div class="player-selection">
                                <!-- New Header with Selection Info and Analysis -->
                                <div style="display: flex; justify-content: space-between; align-items: center; padding: 12px; border-bottom: 1px solid var(--primary-400);">
                                    <select id="selection-info" style="background: transparent; color: var(--primary-400); border: 1px solid var(--primary-400); border-radius: 4px; padding: 6px 10px; font-size: 10px; cursor: pointer; font-weight: 600;">
                                        <option value="">Selection Info</option>
                                        <option value="position">Show Position</option>
                                        <option value="rating">Show Rating</option>
                                        <option value="morale">Show Morale</option>
                                        <option value="form">Show Form</option>
                                    </select>
                                    <div style="display: flex; gap: 6px;">
                                        <button onclick="showSquadAnalysis()" style="background: transparent; color: var(--primary-400); border: 1px solid var(--primary-400); padding: 6px 12px; border-radius: 4px; font-size: 10px; cursor: pointer; font-weight: 600; min-width: 70px; height: 28px;">Analysis</button>
                                        <button onclick="openFilterDialog()" style="background: transparent; color: var(--primary-400); border: 1px solid var(--primary-400); padding: 6px 12px; border-radius: 4px; font-size: 10px; cursor: pointer; font-weight: 600; min-width: 70px; height: 28px;">Filter</button>
                                        <select onchange="autoPickFormation(this.value)" style="background: transparent; color: var(--primary-400); border: 1px solid var(--primary-400); border-radius: 4px; padding: 6px 10px; font-size: 10px; cursor: pointer; font-weight: 600; min-width: 70px; height: 28px;">
                                            <option value="">Auto-Pick</option>
                                            <option value="head">Head Coach</option>
                                            <option value="assistant">Assistant</option>
                                            <option value="scout">Scout</option>
                                        </select>
                                        <button onclick="clearFormation()" style="background: transparent; color: var(--accent-400); border: 1px solid var(--accent-400); padding: 6px 12px; border-radius: 4px; font-size: 10px; cursor: pointer; font-weight: 600; min-width: 70px; height: 28px;">Clear</button>
                                    </div>
                                </div>
                                <!-- Squad Player List -->
                                <div class="formation-info">
                                    <div id="formation-all-players">
                                        <!-- All players with detailed stats, ratings, and selection status -->
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <!-- Cards View (For Instructions, Set Pieces, Opposition, Analysis submenus) -->
                <div class="view-container" id="tactics-cards-view">
                    <div class="tile-container">
                        <!-- Tactics cards for non-formation submenus -->
                    </div>
                </div>
            </div>

            <!-- Training Page -->
            <div class="content-page" id="training-page" data-current-view="grid">
                <div class="view-container active" id="training-grid-view">
                    <div class="tile-container">
                        <!-- Training cards -->
                    </div>
                </div>
                <div class="view-container" id="training-single-view">
                    <div class="tile-container layout-single"></div>
                </div>
            </div>

            <!-- Transfers Page -->
            <div class="content-page" id="transfers-page" data-current-view="grid">
                <div class="view-container active" id="transfers-grid-view">
                    <div class="tile-container">
                        <!-- Transfer cards -->
                    </div>
                </div>
                <div class="view-container" id="transfers-single-view">
                    <div class="tile-container layout-single"></div>
                </div>
            </div>

            <!-- Finances Page -->
            <div class="content-page" id="finances-page" data-current-view="grid">
                <div class="view-container active" id="finances-grid-view">
                    <div class="tile-container">
                        <!-- Finance cards -->
                    </div>
                </div>
                <div class="view-container" id="finances-single-view">
                    <div class="tile-container layout-single"></div>
                </div>
            </div>

            <!-- Fixtures Page -->
            <div class="content-page" id="fixtures-page" data-current-view="grid">
                <div class="view-container active" id="fixtures-grid-view">
                    <div class="tile-container">
                        <!-- Fixture cards -->
                    </div>
                </div>
                <div class="view-container" id="fixtures-single-view">
                    <div class="tile-container layout-single"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Hamburger Menu FAB -->
    <div class="settings-fab" onclick="toggleMenu()">
        <svg viewBox="0 0 24 24">
            <path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2"/>
        </svg>
    </div>
    
    <!-- Hamburger Menu Dropdown -->
    <div class="hamburger-menu" id="hamburgerMenu">
        <div class="menu-item" onclick="goToMainMenu()">
            <svg viewBox="0 0 24 24" width="20" height="20">
                <path fill="currentColor" d="M10,20V14H14V20H19V12H22L12,3L2,12H5V20H10Z"/>
            </svg>
            <span>Main Menu</span>
        </div>
        <div class="menu-divider"></div>
        <div class="menu-item" onclick="loadLayout()">
            <svg viewBox="0 0 24 24" width="20" height="20">
                <path fill="currentColor" d="M14,2H6A2,2 0 0,0 4,4V20A2,2 0 0,0 6,22H18A2,2 0 0,0 20,20V8L14,2M18,20H6V4H13V9H18V20M12,11L8,15H10.5V19H13.5V15H16L12,11Z"/>
            </svg>
            <span>Load</span>
        </div>
        <div class="menu-item" onclick="saveLayout()">
            <svg viewBox="0 0 24 24" width="20" height="20">
                <path fill="currentColor" d="M15,9H5V5H15M12,19A3,3 0 0,1 9,16A3,3 0 0,1 12,13A3,3 0 0,1 15,16A3,3 0 0,1 12,19M17,3H5C3.89,3 3,3.9 3,5V19A2,2 0 0,0 5,21H19A2,2 0 0,0 21,19V7L17,3Z"/>
            </svg>
            <span>Save</span>
        </div>
        <div class="menu-item" onclick="saveAsLayout()">
            <svg viewBox="0 0 24 24" width="20" height="20">
                <path fill="currentColor" d="M15,9H5V5H15M12,19A3,3 0 0,1 9,16A3,3 0 0,1 12,13A3,3 0 0,1 15,16A3,3 0 0,1 12,19M17,3H5C3.89,3 3,3.9 3,5V19A2,2 0 0,0 5,21H19A2,2 0 0,0 21,19V7L17,3M19,19H5V5H16.17L19,7.83V19Z"/>
            </svg>
            <span>Save As</span>
        </div>
        <div class="menu-divider"></div>
        <div class="menu-item" onclick="openSettings()">
            <svg viewBox="0 0 24 24" width="20" height="20">
                <path fill="currentColor" d="M12,15.5A3.5,3.5 0 0,1 8.5,12A3.5,3.5 0 0,1 12,8.5A3.5,3.5 0 0,1 15.5,12A3.5,3.5 0 0,1 12,15.5M19.43,12.97C19.47,12.65 19.5,12.33 19.5,12C19.5,11.67 19.47,11.34 19.43,11L21.54,9.37C21.73,9.22 21.78,8.95 21.66,8.73L19.66,5.27C19.54,5.05 19.27,4.96 19.05,5.05L16.56,6.05C16.04,5.66 15.5,5.32 14.87,5.07L14.5,2.42C14.46,2.18 14.25,2 14,2H10C9.75,2 9.54,2.18 9.5,2.42L9.13,5.07C8.5,5.32 7.96,5.66 7.44,6.05L4.95,5.05C4.73,4.96 4.46,5.05 4.34,5.27L2.34,8.73C2.21,8.95 2.27,9.22 2.46,9.37L4.57,11C4.53,11.34 4.5,11.67 4.5,12C4.5,12.33 4.53,12.65 4.57,12.97L2.46,14.63C2.27,14.78 2.21,15.05 2.34,15.27L4.34,18.73C4.46,18.95 4.73,19.03 4.95,18.95L7.44,17.94C7.96,18.34 8.5,18.68 9.13,18.93L9.5,21.58C9.54,21.82 9.75,22 10,22H14C14.25,22 14.46,21.82 14.5,21.58L14.87,18.93C15.5,18.67 16.04,18.34 16.56,17.94L19.05,18.95C19.27,19.03 19.54,18.95 19.66,18.73L21.66,15.27C21.78,15.05 21.73,14.78 21.54,14.63L19.43,12.97Z"/>
            </svg>
            <span>Settings</span>
        </div>
        <div class="menu-divider"></div>
        <div class="menu-item" onclick="exitApp()">
            <svg viewBox="0 0 24 24" width="20" height="20">
                <path fill="currentColor" d="M19,3H5C3.89,3 3,3.89 3,5V9H5V5H19V19H5V15H3V19A2,2 0 0,0 5,21H19A2,2 0 0,0 21,19V5C21,3.89 20.1,3 19,3M10.08,15.58L11.5,17L16.5,12L11.5,7L10.08,8.41L12.67,11H3V13H12.67L10.08,15.58Z"/>
            </svg>
            <span>Exit</span>
        </div>
    </div>

    <!-- Settings Dialog -->
    <div class="overlay" onclick="closeSettings()"></div>
    <div class="settings-dialog">
        <div class="settings-header">
            <span class="settings-title">Settings</span>
            <button class="settings-close" onclick="closeSettings()">×</button>
        </div>
        <div class="settings-content">
            <div class="settings-group">
                <div class="settings-group-title">Display</div>
                <div class="setting-item">
                    <span class="setting-label">Dark Mode</span>
                    <input type="checkbox" checked>
                </div>
                <div class="setting-item">
                    <span class="setting-label">Animations</span>
                    <input type="checkbox" checked>
                </div>
            </div>
            <div class="settings-group">
                <div class="settings-group-title">Style Theme</div>
                <div class="setting-item">
                    <span class="setting-label">Classic (v16)</span>
                    <input type="radio" name="theme" checked>
                </div>
                <div class="setting-item">
                    <span class="setting-label">Dark Experimental</span>
                    <input type="radio" name="theme">
                </div>
            </div>
        </div>
    </div>

    <script>
        // ========================================
        // GLOBAL GRID CONFIGURATION SYSTEM
        // ========================================
        
        // Read CSS variables and create a centralized configuration
        window.GRID_CONFIG = (() => {
            const root = document.documentElement;
            const style = getComputedStyle(root);
            
            // Parse CSS variables
            const config = {
                // Grid dimensions
                columns: parseInt(style.getPropertyValue('--grid-columns')) || 37,
                rows: parseInt(style.getPropertyValue('--grid-rows')) || 19,
                cellSize: parseInt(style.getPropertyValue('--grid-cell-size')) || 32,
                gap: parseFloat(style.getPropertyValue('--grid-gap')) || 8,
                paddingV: parseInt(style.getPropertyValue('--grid-padding-v')) || 18,
                paddingH: parseInt(style.getPropertyValue('--grid-padding-h')) || 16,
                
                // Container dimensions
                containerWidth: parseInt(style.getPropertyValue('--container-width')) || 1688,
                containerHeight: parseInt(style.getPropertyValue('--container-height')) || 735,
                
                // Card constraints (can be overridden via CSS variables)
                minCardWidth: parseInt(style.getPropertyValue('--min-card-width')) || 5,
                minCardHeight: parseInt(style.getPropertyValue('--min-card-height')) || 3,
                defaultCardWidth: parseInt(style.getPropertyValue('--default-card-width')) || 14,
                defaultCardHeight: parseInt(style.getPropertyValue('--default-card-height')) || 8,
                
                // Calculated values
                get cellSizeWithGap() {
                    return this.cellSize + this.gap;
                },
                get maxCSSClasses() {
                    // Generate CSS classes for all grid cells
                    return {
                        width: this.columns, // Full 44 columns
                        height: this.rows    // Full 23 rows
                    };
                },
                get gridPixelWidth() {
                    return this.columns * this.cellSizeWithGap - this.gap;
                },
                get gridPixelHeight() {
                    return this.rows * this.cellSizeWithGap - this.gap;
                }
            };
            
            // Log configuration for debugging
            console.log('Grid Configuration Loaded:', config);
            
            return config;
        })();
        
        // Page state management - isolated per page
        const pageStates = new Map();
        
        // Initialize page states
        ['overview', 'squad', 'tactics', 'training', 'transfers', 'finances', 'fixtures'].forEach(page => {
            pageStates.set(page, {
                currentView: 'grid',
                selectedCardIndex: 0,
                cards: []
            });
        });

        // Show Tactics Formation (default first child)
        function showTacticsFormation(element) {
            // Update active submenu item
            setActiveSubmenuItem(element);
            
            // Hide cards view, show formation view
            document.getElementById('tactics-cards-view').classList.remove('active');
            document.getElementById('tactics-cards-view').style.display = 'none';
            
            const formationView = document.getElementById('tactics-formation-view');
            formationView.classList.add('active');
            formationView.style.display = 'flex';
            
            // Update state
            const state = pageStates.get('tactics');
            if (state) {
                state.activeSubmenu = 'formation';
                state.currentView = 'formation';
            }
            
            // Initialize formation
            setTimeout(() => renderFormationPlayers(), 100);
            
            console.log('Showing Tactics Formation (default)');
        }
        
        // Switch submenu within a tab
        function switchSubmenu(tab, submenu, element) {
            // Update active submenu item
            setActiveSubmenuItem(element);
            
            // Store submenu state
            const state = pageStates.get(tab);
            if (state) {
                state.activeSubmenu = submenu;
            }
            
            // Handle Tactics page specially
            if (tab === 'tactics') {
                if (submenu === 'formation') {
                    showTacticsFormation(element);
                } else {
                    // Show cards view for other submenus
                    document.getElementById('tactics-formation-view').classList.remove('active');
                    document.getElementById('tactics-formation-view').style.display = 'none';
                    
                    const cardsView = document.getElementById('tactics-cards-view');
                    cardsView.classList.add('active');
                    cardsView.style.display = 'flex';
                    
                    // Load cards for the specific submenu
                    loadPageCards(tab, submenu);
                }
            } else {
                // For other pages, normal submenu switching
                loadPageCards(tab, submenu);
            }
            
            console.log(`Switched to ${tab} → ${submenu}`);
        }

        // Switch tabs - Fixed to prevent double loading
        function switchTab(tab, element) {
            console.log(`=== SWITCHING TO TAB: ${tab} ===`);
            
            // Update active nav
            document.querySelectorAll('.nav-tab').forEach(t => t.classList.remove('active'));
            element.classList.add('active');
            
            // Hide ALL pages and their view containers properly
            document.querySelectorAll('.content-page').forEach(page => {
                page.classList.remove('active');
                // Hide all view containers within each page
                page.querySelectorAll('.view-container').forEach(view => {
                    view.classList.remove('active');
                    view.style.display = 'none';
                });
            });
            
            // Show selected page
            const page = document.getElementById(tab + '-page');
            if (page) {
                page.classList.add('active');
                
                // For Tactics page, Formation is the default (first child)
                if (tab === 'tactics') {
                    // Always show formation view by default (Formation is first child submenu)
                    const formationView = document.getElementById('tactics-formation-view');
                    if (formationView) {
                        formationView.classList.add('active');
                        formationView.style.display = 'flex';
                        setTimeout(() => renderFormationPlayers(), 100);
                    }
                } else {
                    // For other pages, reset to grid view
                    const gridView = page.querySelector(`#${tab}-grid-view`);
                    if (gridView) {
                        gridView.classList.add('active');
                        gridView.style.display = 'flex';
                    }
                }
            }
            
            // Update submenu
            document.querySelectorAll('.nav-submenu').forEach(s => s.classList.remove('active'));
            const submenu = document.getElementById(tab + '-submenu');
            if (submenu) submenu.classList.add('active');
            
            // ALWAYS load cards for the selected page to ensure correct content
            loadPageCards(tab);
            
            console.log(`=== TAB SWITCH COMPLETE: ${tab} ===`);
        }

        // Load cards for a specific page
        function loadPageCards(pageName, submenu = null) {
            const page = document.getElementById(pageName + '-page');
            
            // For Tactics, use the correct container based on submenu
            let gridView;
            if (pageName === 'tactics') {
                // For tactics, cards go into tactics-cards-view (not tactics-grid-view)
                gridView = page.querySelector(`#tactics-cards-view .tile-container`);
            } else {
                gridView = page.querySelector(`#${pageName}-grid-view .tile-container`);
            }
            
            if (!gridView) return;
            
            // Clear existing cards
            gridView.innerHTML = '';
            
            // Get submenu from state if not provided
            const state = pageStates.get(pageName);
            if (!submenu && state) {
                submenu = state.activeSubmenu || 'default';
            }
            
            // CRITICAL: Map submenu names correctly
            if (submenu === 'first-team') submenu = 'default';
            
            // Get cards for this page and submenu
            const cards = getCardsForPage(pageName, submenu);
            pageStates.get(pageName).cards = cards;
            
            cards.forEach(cardData => {
                const card = createCardFromData(cardData, pageName);
                gridView.appendChild(card);
            });
            
            // Re-initialize drag and resize handlers for new cards - OPTIMIZED
            setTimeout(() => {
                const cards = gridView.querySelectorAll('.card');
                
                // Only initialize handlers once per card
                cards.forEach(card => {
                    // Initialize drag for all cards (Aethelred and regular)
                    const header = card.querySelector('.card-header, .aethelred-card-header');
                    if (header && !header.hasAttribute('data-drag-initialized')) {
                        header.addEventListener('mousedown', initHeaderDrag);
                        header.setAttribute('data-drag-initialized', 'true');
                    }
                    
                    // Initialize resize handles for all cards
                    const resizeHandle = card.querySelector('.resize-handle');
                    if (resizeHandle && !resizeHandle.hasAttribute('data-resize-initialized')) {
                        resizeHandle.addEventListener('mousedown', (e) => initResizing(e, 'br'));
                        resizeHandle.setAttribute('data-resize-initialized', 'true');
                    }
                    const resizeHandleBL = card.querySelector('.resize-handle-bl');
                    if (resizeHandleBL && !resizeHandleBL.hasAttribute('data-resize-initialized')) {
                        resizeHandleBL.addEventListener('mousedown', (e) => initResizing(e, 'bl'));
                        resizeHandleBL.setAttribute('data-resize-initialized', 'true');
                    }
                });
                
                // Layout cards ONLY once and ONLY if needed
                if (cards.length > 0) {
                    layoutCards(gridView);
                }
            }, 50);
        }

        // Define card size presets based on content type and density
        // Following Football Manager's information density principles
        function getCardSizePresets() {
            return {
                // Minimal stat cards - single KPIs (6x3)
                stat: { 
                    width: 6, 
                    height: GRID_CONFIG.minCardHeight  // 3
                },
                // Standard info cards - 2-4 data points (6x4)
                standard: { 
                    width: 6, 
                    height: 4 
                },
                // Compact lists - 3-5 items (7x5)
                compact: { 
                    width: 7, 
                    height: 5 
                },
                // Data tables - columnar data (11x6)
                table: { 
                    width: 11, 
                    height: 6 
                },
                // Visual layouts - formations/tactics (10x6)
                visual: { 
                    width: 10, 
                    height: 6 
                },
                // Reports - text/analysis (9x5)
                report: { 
                    width: 9, 
                    height: 5 
                },
                // Squad lists - player rosters (10x7)
                roster: { 
                    width: 10, 
                    height: 7 
                }
            };
        }

        // DYNAMIC FM OVERVIEW - Responsive Grid Layout System
        // NO HARDCODED POSITIONS - Uses dynamic calculation based on container dimensions
        function getAethelredOverviewCards() {
            const gridCalc = calculateDynamicLayout();
            
            return [
                // TIER 1: FULL-WIDTH CRITICAL INFORMATION
                {
                    title: 'Match Predictor & Analysis',
                    componentType: 'MatchPredictorCard',
                    layout: { tier: 1, priority: 1, fillWidth: true },
                    tier: 'match-predictor',
                    data: getMatchPredictorData()
                },
                
                // TIER 2: THREE EQUAL IMPORTANT CARDS  
                {
                    title: 'Squad Health Matrix',
                    componentType: 'SquadHealthMatrixCard',
                    layout: { tier: 2, priority: 1, splitColumns: 3 },
                    tier: 'squad-health-matrix',
                    data: getSquadHealthData()
                },
                
                {
                    title: 'Tactical Momentum',
                    componentType: 'SummaryStatCard',
                    layout: { tier: 2, priority: 2, splitColumns: 3 },
                    tier: 'tactical-momentum',
                    data: getTacticalMomentumData()
                },
                
                {
                    title: 'Financial Flow',
                    componentType: 'SummaryStatCard',
                    layout: { tier: 2, priority: 3, splitColumns: 3 },
                    tier: 'financial-flow',
                    data: getFinancialFlowData()
                },
                
                // TIER 3: TWO WIDE ANALYTICAL CARDS
                {
                    title: 'Intelligence Hub',
                    componentType: 'SummaryStatCard',
                    layout: { tier: 3, priority: 1, splitColumns: 2 },
                    tier: 'intelligence-hub',
                    data: getIntelligenceHubData()
                },
                
                {
                    title: 'Training Optimizer',
                    componentType: 'TrainingOptimizerCard',
                    layout: { tier: 3, priority: 2, splitColumns: 2 },
                    tier: 'training-optimizer',
                    data: getTrainingOptimizerData()
                },
                
                // TIER 4: FOUR COMPACT MONITORING CARDS
                {
                    title: 'Form Pattern',
                    componentType: 'SummaryStatCard',
                    layout: { tier: 4, priority: 1, splitColumns: 4 },
                    tier: 'form-pattern',
                    data: getFormPatternData()
                },
                
                {
                    title: 'League Table',
                    componentType: 'RosterCard',
                    layout: { tier: 4, priority: 2, splitColumns: 2 }, // Make it wider (split by 2 instead of 4)
                    tier: 'league-table',
                    data: getLeagueTableData()
                },
                
                {
                    title: 'Pressure Points',
                    componentType: 'SummaryStatCard',
                    layout: { tier: 4, priority: 3, splitColumns: 2 }, // Adjusted to split by 2
                    tier: 'pressure-points',
                    data: getPressurePointsData()
                },
                
                {
                    title: 'Live Feed',
                    componentType: 'SummaryStatCard',
                    layout: { tier: 4, priority: 1, splitColumns: 3 }, // Move to different tier arrangement  
                    tier: 'live-feed',
                    data: getLiveFeedData()
                }
            ];
        }
        
        // DYNAMIC LAYOUT CALCULATION SYSTEM
        function calculateDynamicLayout() {
            const config = GRID_CONFIG;
            const totalRows = config.rows;
            const totalCols = config.columns;
            
            // Calculate tier heights based on content importance and available space
            const tierHeights = {
                1: Math.floor(totalRows * 0.25),  // 25% for critical match info
                2: Math.floor(totalRows * 0.30),  // 30% for key management data  
                3: Math.floor(totalRows * 0.30),  // 30% for analytical tools
                4: Math.floor(totalRows * 0.15)   // 15% for monitoring widgets
            };
            
            // Calculate tier starting positions
            const tierPositions = {
                1: { startRow: 1 },
                2: { startRow: 1 + tierHeights[1] + 1 },
                3: { startRow: 1 + tierHeights[1] + tierHeights[2] + 2 },
                4: { startRow: totalRows - tierHeights[4] + 1 }
            };
            
            console.log('Dynamic Layout Calculated:', { tierHeights, tierPositions, totalRows, totalCols });
            
            return { tierHeights, tierPositions, totalRows, totalCols };
        }
        
        // ENHANCED CARD CREATION - Uses Dynamic Positioning
        function createCardFromAethelredDataDynamic(cardData, pageName) {
            if (cardData.componentType) {
                const component = createAethelredComponent(cardData.componentType, cardData.data);
                
                // Calculate dynamic dimensions and positioning
                const layout = calculateCardDynamicLayout(cardData.layout || {});
                
                // Apply dynamic sizing
                component.classList.add('card', `w${layout.width}`, `h${layout.height}`);
                component.setAttribute('data-grid-w', layout.width);
                component.setAttribute('data-grid-h', layout.height);
                component.draggable = false;
                
                // Apply tier styling
                if (cardData.tier) {
                    component.setAttribute('data-tier', cardData.tier);
                    component.classList.add(`tier-${cardData.tier}`);
                }
                
                // Apply dynamic positioning
                if (layout.position) {
                    component.style.gridColumn = `${layout.position.column} / span ${layout.width}`;
                    component.style.gridRow = `${layout.position.row} / span ${layout.height}`;
                    component.setAttribute('data-positioned', 'true');
                }
                
                // Add resize handles
                const resizeHandleBR = document.createElement('div');
                resizeHandleBR.className = 'resize-handle';
                component.appendChild(resizeHandleBR);
                
                const resizeHandleBL = document.createElement('div');
                resizeHandleBL.className = 'resize-handle-bl';
                component.appendChild(resizeHandleBL);
                
                // Add card menu to Aethelred components
                const header = component.querySelector('.aethelred-card-header');
                if (header) {
                    header.setAttribute('ondblclick', 'expandCardFromHeader(this)');
                    header.style.cursor = 'pointer';
                    
                    const menuHTML = `
                        <div class="card-menu">
                            <button class="card-menu-btn" onclick="toggleCardMenu(this, event)" 
                                    aria-label="Card options menu" tabindex="0">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <circle cx="12" cy="12" r="1"/>
                                    <circle cx="12" cy="5" r="1"/>
                                    <circle cx="12" cy="19" r="1"/>
                                </svg>
                            </button>
                            <div class="card-menu-dropdown">
                                <div class="card-menu-item" onclick="expandCard(this)">Expand</div>
                                <div class="card-menu-item" onclick="pinCard(this)">Pin</div>
                                <div class="card-menu-item" onclick="removeCard(this)">Remove</div>
                                <div class="card-menu-item" onclick="replaceCard(this)">Replace</div>
                                <div class="card-menu-item" onclick="bookmarkCard(this)">Bookmark</div>
                            </div>
                        </div>
                    `;
                    header.insertAdjacentHTML('beforeend', menuHTML);
                }
                
                return component;
            }
            
            // Fallback to existing card creation system
            return createCardFromData(cardData, pageName);
        }
        
        function calculateCardDynamicLayout(layoutConfig) {
            const gridCalc = calculateDynamicLayout();
            const { tierHeights, tierPositions, totalRows, totalCols } = gridCalc;
            
            const tier = layoutConfig.tier || 1;
            const priority = layoutConfig.priority || 1;
            const splitColumns = layoutConfig.splitColumns || 1;
            const fillWidth = layoutConfig.fillWidth || false;
            
            let width, height, position;
            
            if (fillWidth) {
                // Full width cards
                width = totalCols;
                height = tierHeights[tier];
                position = {
                    row: tierPositions[tier].startRow,
                    column: 1
                };
            } else {
                // Split column cards
                const cardWidth = Math.floor(totalCols / splitColumns);
                const cardColumn = ((priority - 1) * cardWidth) + 1;
                
                width = cardWidth - 1; // Leave 1 column gap between cards
                height = tierHeights[tier];
                position = {
                    row: tierPositions[tier].startRow,
                    column: cardColumn
                };
            }
            
            // Ensure cards fit within grid boundaries
            if (position.row + height - 1 > totalRows) {
                height = totalRows - position.row + 1;
            }
            
            if (position.column + width - 1 > totalCols) {
                width = totalCols - position.column + 1;
            }
            
            console.log(`Dynamic layout for tier ${tier}, priority ${priority}:`, { width, height, position });
            
            return { width, height, position };
        }
        
        // PROFESSIONAL FM DATA PROVIDERS - Based on OverviewDesign.md Specification
        // =====================================================
        
        function getMatchPredictorData() {
            // Get team data from database for league positions and form
            const dynamicTable = generateDynamicLeagueTable();
            const homeTeamData = PREMIER_LEAGUE_DB.teams.find(t => t.id === 'manchester-united');
            const awayTeamData = PREMIER_LEAGUE_DB.teams.find(t => t.id === 'manchester-city');
            const homePosition = dynamicTable.find(entry => entry.team.id === 'manchester-united')?.position || 'N/A';
            const awayPosition = dynamicTable.find(entry => entry.team.id === 'manchester-city')?.position || 'N/A';
            
            return {
                header: { 
                    title: 'Match Predictor & Analysis'
                },
                body: {
                    competition: {
                        name: 'Premier League',
                        venue: 'Etihad Stadium',
                        location: 'Manchester (A)',
                        date: 'Saturday, 23 August',
                        time: '17:30',
                        weather: {
                            condition: 'Clear',
                            temperature: '18°C',
                            emoji: '☀️'
                        }
                    },
                    homeTeam: {
                        symbol: 'M',
                        name: 'MAN UNITED',
                        label: 'HOME',
                        position: homePosition,
                        form: homeTeamData?.form || ['W','W','D','L','W']
                    },
                    awayTeam: {
                        symbol: 'C',
                        name: 'MAN CITY',
                        label: 'AWAY',
                        position: awayPosition,
                        form: awayTeamData?.form || ['W','W','W','W','W']
                    },
                    probabilities: [
                        {
                            label: 'Home Win',
                            percentage: 67,
                            color: 'var(--primary-300)'
                        },
                        {
                            label: 'Draw',
                            percentage: 20,
                            color: '#f59e0b'
                        },
                        {
                            label: 'Away Win',
                            percentage: 13,
                            color: '#ef4444'
                        }
                    ],
                    tactical: {
                        homeFormation: '4-3-3',
                        awayFormation: '4-3-3',
                        battleType: 'Balanced',
                        keyBattle: {
                            homePlayer: 'CASEMIRO',
                            awayPlayer: 'DE BRUYNE',
                            area: 'Midfield'
                        },
                        h2h: {
                            results: ['W', 'W', 'L', 'W', 'L'],
                            summary: '3W • 2L'
                        },
                        context: {
                            referee: 'M. Oliver',
                            intensity: 'High Intensity'
                        }
                    },
                    additional: [
                        {
                            icon: '⚠️',
                            text: 'Haaland Threat (24 Goals)',
                            type: 'danger'
                        },
                        {
                            icon: '✅',
                            text: 'Perfect Conditions',
                            type: 'positive'
                        },
                        {
                            icon: '◆',
                            text: 'Tactical Battle',
                            type: 'neutral'
                        }
                    ]
                }
            };
        }
        
        function getSquadHealthData() {
            return {
                header: { title: 'Squad Health Matrix' },
                body: {
                    contentType: 'SquadHealthMatrix',
                    contentData: {
                        // Top-level metrics for the metrics row
                        metrics: {
                            fitness: 84,        // Squad fitness percentage
                            injuries: 3,        // Number of injured players
                            morale: 72,         // Calculated from morale distribution
                            riskAreas: 2        // Number of positions at risk
                        },
                        
                        // Detailed injury data for timeline and list
                        injuries: [
                            { player: 'Varane', eta: '3d', severity: 'medium', type: 'Hamstring' },
                            { player: 'Shaw', eta: '1w', severity: 'high', type: 'Ankle' },
                            { player: 'Martial', eta: '5d', severity: 'low', type: 'Groin' }
                        ],
                        
                        // Timeline configuration
                        timeline: {
                            horizon: 14,  // 14-day return horizon
                            currentDate: new Date().toISOString().split('T')[0]
                        },
                        
                        // Morale distribution data
                        morale: {
                            excellent: 8,   // Players with excellent morale
                            good: 5,       // Players with good morale  
                            neutral: 6,    // Players with neutral morale
                            poor: 3,       // Players with poor morale
                            terrible: 0    // Players with terrible morale
                        },
                        
                        // Risk areas by position
                        riskAreas: [
                            { position: 'CB', level: 'High', reason: 'Only 1 fit senior CB' },
                            { position: 'LW', level: 'Medium', reason: 'Key player injured' }
                        ],
                        
                        // Availability summary
                        availability: {
                            available: 19,  // Players available for selection
                            injured: 3,     // Players currently injured
                            atRisk: 5       // Players at risk of injury/suspension
                        }
                    }
                }
            };
        }
        
        function getTacticalMomentumData() {
            return {
                header: { title: 'Tactical Momentum' },
                body: {
                    contentType: 'StatRowList',
                    contentData: [
                        { label: 'Last 10 Games', value: '████████░░ 80%', valueType: 'positive' },
                        { label: '4-3-3 Success', value: '███████░ 78%', valueType: 'positive' },
                        { label: 'Press Effectiveness', value: '██████░░ 71%', valueType: 'positive' },
                        { label: 'Home Record', value: '████████ 94%', valueType: 'positive' },
                        { label: 'Set Pieces', value: '█████░░░ 64%', valueType: 'neutral' }
                    ]
                }
            };
        }
        
        function getFinancialFlowData() {
            return {
                header: { title: 'Financial Flow' },
                body: {
                    contentType: 'StatRowList',
                    contentData: [
                        { label: 'Transfer Budget', value: '████░░░ 67% (£80M)', valueType: 'positive' },
                        { label: 'Wage Budget', value: '███████ 92% (£2.8M/w)', valueType: 'negative' },
                        { label: 'FFP Status', value: '✅ Compliant', valueType: 'positive' },
                        { label: 'Burn Rate', value: '▼ £2.3M/week', valueType: 'positive' },
                        { label: 'Revenue Stream', value: '↗️ +12% vs last season', valueType: 'positive' }
                    ]
                }
            };
        }
        
        function getIntelligenceHubData() {
            return {
                header: { title: 'Intelligence Hub' },
                body: {
                    contentType: 'StatRowList',
                    contentData: [
                        { label: '⚠️ THREATS', value: 'Liverpool want your LB (£45M)', valueType: 'negative' },
                        { label: '🔍 OPPORTUNITIES', value: 'Juventus loan striker ready', valueType: 'positive' },
                        { label: '📊 ANALYSIS', value: 'Rival has 3 suspensions', valueType: 'positive' },
                        { label: '💡 SUGGESTION', value: 'Exploit their slow left back', valueType: 'positive' },
                        { label: '📈 TREND', value: 'Morale drop after benchings', valueType: 'negative' },
                        { label: '🎯 TARGET', value: 'Mount available for £60M', valueType: 'neutral' }
                    ]
                }
            };
        }
        
        function getTrainingOptimizerData() {
            return {
                header: { title: 'Training Overview' },
                body: {
                    contentType: 'TrainingCalendar',
                    contentData: {
                        // Week summary metrics
                        weekSummary: {
                            weeklyPlan: 'Intensive Phase',
                            riskLevel: 'high',
                            riskText: 'High Risk Thu-Fri',
                            totalLoad: 1280,
                            squadPerformance: 87
                        },
                        
                        // 7-day training schedule
                        trainingDays: [
                            {
                                day: 'monday',
                                name: 'Mon',
                                intensity: 'high',
                                load: 340,
                                notes: 'High-intensity session with tactical focus',
                                flags: [],
                                current: false,
                                risk: false
                            },
                            {
                                day: 'tuesday',
                                name: 'Tue',
                                intensity: 'high',
                                load: 280,
                                notes: 'Technical work + conditioning',
                                flags: [],
                                current: false,
                                risk: false
                            },
                            {
                                day: 'wednesday',
                                name: 'Wed',
                                intensity: 'rest',
                                load: 0,
                                notes: 'Recovery day - light activities only',
                                flags: [],
                                current: true,
                                risk: false
                            },
                            {
                                day: 'thursday',
                                name: 'Thu',
                                intensity: 'high',
                                load: 320,
                                notes: 'Match prep - risk of overload',
                                flags: ['risk'],
                                current: false,
                                risk: true
                            },
                            {
                                day: 'friday',
                                name: 'Fri',
                                intensity: 'high',
                                load: 340,
                                notes: 'Final prep - monitor fatigue',
                                flags: ['risk'],
                                current: false,
                                risk: true
                            },
                            {
                                day: 'saturday',
                                name: 'Sat',
                                intensity: 'match',
                                load: 0,
                                notes: 'Competition day - no training',
                                flags: ['match'],
                                current: false,
                                risk: false
                            },
                            {
                                day: 'sunday',
                                name: 'Sun',
                                intensity: 'off',
                                load: 0,
                                notes: 'Complete rest day',
                                flags: [],
                                current: false,
                                risk: false
                            }
                        ],
                        
                        // At-risk players section
                        atRiskPlayers: [
                            {
                                name: 'Rashford',
                                reason: 'High Load',
                                player: 'rashford'
                            },
                            {
                                name: 'Bruno',
                                reason: 'Fatigue',
                                player: 'bruno'
                            },
                            {
                                name: 'Casemiro',
                                reason: 'Age Risk',
                                player: 'casemiro'
                            }
                        ],
                        
                        // 4-week trend analysis
                        trendAnalysis: {
                            weeks: [
                                { label: 'W-3', load: 950, height: 60 },
                                { label: 'W-2', load: 1150, height: 75 },
                                { label: 'W-1', load: 1320, height: 90 },
                                { label: 'NOW', load: 1280, height: 85, current: true },
                                { label: 'W+1', load: 720, height: 45, future: true }
                            ],
                            stats: {
                                trend: '↓ Decreasing',
                                next: 'Recovery',
                                peak: '1320 (W-1)',
                                average: '1084'
                            }
                        }
                    }
                }
            };
        }
        
        function getFormPatternData() {
            return {
                header: { title: 'Form Pattern' },
                body: {
                    contentType: 'StatRowList',
                    contentData: [
                        { label: 'Visual', value: '╱╲  ╱╲', valueType: 'neutral' },
                        { label: 'Pattern', value: 'WWDLW', valueType: 'positive' },
                        { label: 'Points', value: '11/15', valueType: 'positive' },
                        { label: 'Trend', value: '↗️ Improving', valueType: 'positive' }
                    ]
                }
            };
        }
        
        function getLeagueTableData() {
            const dynamicTable = generateDynamicLeagueTable();
            
            return {
                header: { title: 'League Table' },
                body: {
                    contentType: 'EnhancedDataTable',
                    contentData: {
                        headers: ['#', 'Team', 'P', 'W', 'D', 'L', 'GF', 'GA', 'GD', 'Pts', 'Form'],
                        rows: dynamicTable.map(entry => {
                            const team = entry.team;
                            const gd = entry.goalDifference;
                            const gdDisplay = gd > 0 ? `+${gd}` : gd.toString();
                            
                            // Clean form display using CSS classes only (no inline styles)
                            const formDisplay = `<div class="form-indicators">` +
                                team.form.map(result => 
                                    `<span class="form-indicator form-${result.toLowerCase()}">${result}</span>`
                                ).join('') + `</div>`;
                            
                            // Clean goal difference display with CSS classes
                            const gdClass = gd > 0 ? 'positive' : gd < 0 ? 'negative' : 'neutral';
                            const gdFormatted = `<span class="goal-difference ${gdClass}">${gdDisplay}</span>`;
                            
                            return [
                                entry.position.toString(),
                                `<span class="team-name">${team.name}</span>`,
                                team.played.toString(),
                                team.won.toString(),
                                team.drawn.toString(),
                                team.lost.toString(),
                                team.goalsFor.toString(),
                                team.goalsAgainst.toString(),
                                gdFormatted,
                                `<span class="points">${entry.points}</span>`,
                                formDisplay
                            ];
                        }),
                        userTeamID: userTeamID,
                        zones: PREMIER_LEAGUE_DB.zones
                    }
                }
            };
        }
        
        function getPressurePointsData() {
            return {
                header: { title: 'Pressure Points' },
                body: {
                    contentType: 'StatRowList',
                    contentData: [
                        { label: 'Contracts', value: '⏰ 3 days left', valueType: 'negative' },
                        { label: 'Unhappy', value: '😡 2 players', valueType: 'negative' },
                        { label: 'Bid Received', value: '£67M ✓✗', valueType: 'neutral' },
                        { label: 'Board Trust', value: '███░ 75%', valueType: 'positive' }
                    ]
                }
            };
        }
        
        function getLiveFeedData() {
            return {
                header: { title: 'Live Feed' },
                body: {
                    contentType: 'StatRowList',
                    contentData: [
                        { label: '📰', value: 'Rashford declared fit', valueType: 'positive' },
                        { label: '📊', value: 'xG improved 23% vs last month', valueType: 'positive' },
                        { label: '⚽', value: 'Youth player promoted to first team', valueType: 'positive' },
                        { label: '🏥', value: 'Varane returns ahead of schedule', valueType: 'positive' }
                    ]
                }
            };
        }
        
        // SVG VISUAL ENHANCEMENT SYSTEM - Badges, Graphs, Geometric Art
        // =============================================================
        
        function createTeamBadgeSVG(teamSlug) {
            const badges = {
                'manchester-city': '#6CABDD',
                'manchester-united': '#DA020E', 
                'liverpool': '#C8102E',
                'arsenal': '#EF0107',
                'chelsea': '#034694',
                'tottenham': '#132257'
            };
            
            const color = badges[teamSlug] || '#666666';
            
            return `<svg width="24" height="24" viewBox="0 0 24 24" style="margin-right: 8px;">
                <defs>
                    <radialGradient id="badge-${teamSlug}" cx="50%" cy="30%" r="70%">
                        <stop offset="0%" stop-color="${color}"/>
                        <stop offset="100%" stop-color="${shadeColor(color, -20)}"/>
                    </radialGradient>
                </defs>
                <path d="M12 2L4 7v5c0 5.55 3.84 10.74 9 12 5.16-1.26 9-6.45 9-12V7l-8-5z" 
                      fill="url(#badge-${teamSlug})" 
                      stroke="${shadeColor(color, -40)}" 
                      stroke-width="1"/>
                <circle cx="12" cy="10" r="3" fill="white" opacity="0.9"/>
                <text x="12" y="14" text-anchor="middle" fill="white" font-size="8" font-weight="bold">
                    ${teamSlug.charAt(0).toUpperCase()}
                </text>
            </svg>`;
        }
        
        function createFormationVisualizationSVG(ourFormation, theirFormation) {
            return `<svg width="120" height="40" viewBox="0 0 120 40" style="background: #1a4d3a; border-radius: 4px;">
                <!-- Pitch lines -->
                <rect x="0" y="0" width="120" height="40" fill="#1a4d3a" stroke="#ffffff" stroke-width="0.5"/>
                <line x1="60" y1="0" x2="60" y2="40" stroke="#ffffff" stroke-width="0.5"/>
                
                <!-- Our formation (left side) -->
                <g fill="#00ff88">
                    <circle cx="15" cy="20" r="2"/> <!-- GK -->
                    <circle cx="25" cy="10" r="1.5"/> <!-- Defense -->
                    <circle cx="25" cy="20" r="1.5"/>
                    <circle cx="25" cy="30" r="1.5"/>
                    <circle cx="35" cy="15" r="1.5"/> <!-- Midfield -->
                    <circle cx="35" cy="25" r="1.5"/>
                    <circle cx="45" cy="20" r="1.5"/>
                    <circle cx="52" cy="12" r="1.5"/> <!-- Attack -->
                    <circle cx="52" cy="20" r="1.5"/>
                    <circle cx="52" cy="28" r="1.5"/>
                </g>
                
                <!-- Their formation (right side) -->
                <g fill="#ff4444">
                    <circle cx="105" cy="20" r="2"/> <!-- GK -->
                    <circle cx="95" cy="10" r="1.5"/> <!-- Defense -->
                    <circle cx="95" cy="20" r="1.5"/>
                    <circle cx="95" cy="30" r="1.5"/>
                    <circle cx="85" cy="15" r="1.5"/> <!-- Midfield -->
                    <circle cx="85" cy="25" r="1.5"/>
                    <circle cx="75" cy="20" r="1.5"/>
                    <circle cx="68" cy="12" r="1.5"/> <!-- Attack -->
                    <circle cx="68" cy="20" r="1.5"/>
                    <circle cx="68" cy="28" r="1.5"/>
                </g>
                
                <!-- Formation labels -->
                <text x="30" y="8" fill="white" font-size="8" text-anchor="middle">${ourFormation}</text>
                <text x="90" y="8" fill="white" font-size="8" text-anchor="middle">${theirFormation}</text>
            </svg>`;
        }
        
        function createWinProbabilityBarSVG(percentage) {
            const width = 100;
            const fillWidth = (percentage / 100) * width;
            const color = percentage > 60 ? '#10b981' : percentage > 40 ? '#f59e0b' : '#ef4444';
            
            return `<svg width="100" height="16" viewBox="0 0 100 16">
                <defs>
                    <linearGradient id="prob-gradient" x1="0%" y1="0%" x2="100%" y2="0%">
                        <stop offset="0%" stop-color="${color}"/>
                        <stop offset="100%" stop-color="${shadeColor(color, 20)}"/>
                    </linearGradient>
                </defs>
                <rect x="0" y="0" width="100" height="16" fill="#333" rx="8"/>
                <rect x="0" y="0" width="${fillWidth}" height="16" fill="url(#prob-gradient)" rx="8"/>
                <text x="50" y="11" text-anchor="middle" fill="white" font-size="10" font-weight="bold">
                    ${percentage}%
                </text>
            </svg>`;
        }
        
        function createH2HResultsSVG(results) {
            return `<svg width="80" height="16" viewBox="0 0 80 16">
                ${results.map((result, i) => {
                    const x = i * 16;
                    const color = result === 'W' ? '#10b981' : result === 'L' ? '#ef4444' : '#f59e0b';
                    return `<circle cx="${x + 8}" cy="8" r="6" fill="${color}" stroke="white" stroke-width="1"/>
                            <text x="${x + 8}" y="11" text-anchor="middle" fill="white" font-size="8" font-weight="bold">${result}</text>`;
                }).join('')}
            </svg>`;
        }
        
        function createPlayerBattleSVG(player1, player2) {
            return `<svg width="80" height="20" viewBox="0 0 80 20">
                <!-- Player 1 side -->
                <circle cx="15" cy="10" r="8" fill="#3b82f6" stroke="white" stroke-width="1"/>
                <text x="15" y="13" text-anchor="middle" fill="white" font-size="6" font-weight="bold">
                    ${player1.charAt(0)}
                </text>
                
                <!-- VS indicator -->
                <text x="40" y="13" text-anchor="middle" fill="#666" font-size="8" font-weight="bold">VS</text>
                
                <!-- Player 2 side -->
                <circle cx="65" cy="10" r="8" fill="#ef4444" stroke="white" stroke-width="1"/>
                <text x="65" y="13" text-anchor="middle" fill="white" font-size="6" font-weight="bold">
                    ${player2.charAt(0)}
                </text>
                
                <!-- Battle intensity lines -->
                <path d="M25 10 L55 10" stroke="#ff6b35" stroke-width="2" stroke-dasharray="2,2">
                    <animate attributeName="stroke-dashoffset" values="0;4" dur="1s" repeatCount="indefinite"/>
                </path>
            </svg>`;
        }
        
        function createFitnessMatrixSVG(fitnessData) {
            return `<svg width="100" height="60" viewBox="0 0 100 60">
                <!-- Body silhouette -->
                <path d="M35 10 Q40 5 45 10 L50 15 Q50 25 45 35 L40 50 Q35 55 30 50 L25 35 Q25 25 30 15 Z" 
                      fill="#1f2937" stroke="#4b5563" stroke-width="1"/>
                
                <!-- Fitness zones -->
                <circle cx="40" cy="15" r="3" fill="#10b981" opacity="0.8"/> <!-- Head -->
                <rect x="35" y="20" width="10" height="8" fill="#f59e0b" opacity="0.8" rx="2"/> <!-- Torso -->
                <rect x="32" y="30" width="6" height="12" fill="#ef4444" opacity="0.8" rx="2"/> <!-- Left leg -->
                <rect x="42" y="30" width="6" height="12" fill="#10b981" opacity="0.8" rx="2"/> <!-- Right leg -->
                
                <!-- Fitness bars -->
                <g transform="translate(55, 10)">
                    <rect x="0" y="0" width="40" height="8" fill="#333" rx="4"/>
                    <rect x="0" y="0" width="32" height="8" fill="#10b981" rx="4"/>
                    <text x="42" y="6" fill="#666" font-size="8">84%</text>
                </g>
                
                <!-- Injury indicators -->
                <text x="20" y="50" fill="#ef4444" font-size="8">⚠️ 3</text>
            </svg>`;
        }
        
        function createFormGraphSVG(formData) {
            const points = formData.map((result, i) => {
                const x = i * 15 + 10;
                const y = result === 'W' ? 10 : result === 'D' ? 20 : 30;
                return `${x},${y}`;
            }).join(' ');
            
            return `<svg width="100" height="40" viewBox="0 0 100 40">
                <defs>
                    <linearGradient id="form-gradient" x1="0%" y1="0%" x2="100%" y2="0%">
                        <stop offset="0%" stop-color="#ef4444"/>
                        <stop offset="50%" stop-color="#f59e0b"/>
                        <stop offset="100%" stop-color="#10b981"/>
                    </linearGradient>
                </defs>
                <polyline points="${points}" fill="none" stroke="url(#form-gradient)" stroke-width="2"/>
                ${formData.map((result, i) => {
                    const x = i * 15 + 10;
                    const y = result === 'W' ? 10 : result === 'D' ? 20 : 30;
                    const color = result === 'W' ? '#10b981' : result === 'D' ? '#f59e0b' : '#ef4444';
                    return `<circle cx="${x}" cy="${y}" r="3" fill="${color}" stroke="white" stroke-width="1"/>`;
                }).join('')}
            </svg>`;
        }
        
        function shadeColor(color, percent) {
            const R = parseInt(color.substring(1,3),16);
            const G = parseInt(color.substring(3,5),16);
            const B = parseInt(color.substring(5,7),16);
            const newR = parseInt(R * (100 + percent) / 100);
            const newG = parseInt(G * (100 + percent) / 100);
            const newB = parseInt(B * (100 + percent) / 100);
            return "#" + (0x1000000 + (newR<255?newR<1?0:newR:255)*0x10000 + (newG<255?newG<1?0:newG:255)*0x100 + (newB<255?newB<1?0:newB:255)).toString(16).slice(1);
        }
        
        // GLOBAL FOOTBALL MANAGEMENT DATABASE - JSON Data Structure
        // ========================================================
        
        // User Team Configuration - Dynamic Selection System
        let userTeamID = 'manchester-united'; // Current user's team
        
        // Premier League Database - Complete JSON Structure
        const PREMIER_LEAGUE_DB = {
            teams: [
                { 
                    id: 'manchester-city', 
                    name: 'Man City', 
                    played: 28, won: 22, drawn: 4, lost: 2, 
                    goalsFor: 78, goalsAgainst: 33, 
                    form: ['W','W','W','W','W'],
                    colors: {
                        primary: '#6CABDD',    // Sky Blue
                        secondary: '#1C2C5B',  // Navy Blue  
                        tertiary: '#FFFFFF',   // White
                        accent: '#97D8E8'      // Light Blue
                    }
                },
                { 
                    id: 'arsenal', 
                    name: 'Arsenal', 
                    played: 28, won: 20, drawn: 5, lost: 3, 
                    goalsFor: 73, goalsAgainst: 38, 
                    form: ['D','W','W','D','L'],
                    colors: {
                        primary: '#EF0107',    // Arsenal Red
                        secondary: '#063672',  // Arsenal Blue
                        tertiary: '#9C824A',   // Gold
                        accent: '#FF6B6B'      // Light Red
                    }
                },
                { 
                    id: 'liverpool', 
                    name: 'Liverpool', 
                    played: 28, won: 18, drawn: 6, lost: 4, 
                    goalsFor: 68, goalsAgainst: 40, 
                    form: ['L','W','W','W','W'],
                    colors: {
                        primary: '#C8102E',    // Liverpool Red
                        secondary: '#F6EB61',  // Yellow
                        tertiary: '#00B2A9',   // Teal
                        accent: '#FF4757'      // Bright Red
                    }
                },
                { 
                    id: 'manchester-united', 
                    name: 'Man United', 
                    played: 28, won: 17, drawn: 6, lost: 5, 
                    goalsFor: 55, goalsAgainst: 42, 
                    form: ['W','W','D','L','W'],
                    colors: {
                        primary: '#DA020E',    // United Red
                        secondary: '#FBE122',  // Yellow
                        tertiary: '#000000',   // Black
                        accent: '#FF6B35'      // Orange Red
                    }
                },
                { 
                    id: 'newcastle', 
                    name: 'Newcastle', 
                    played: 28, won: 16, drawn: 8, lost: 4, 
                    goalsFor: 62, goalsAgainst: 40, 
                    form: ['W','D','W','D','L'],
                    colors: {
                        primary: '#241F20',    // Black
                        secondary: '#FFFFFF',  // White
                        tertiary: '#00B2A9',   // Teal (new ownership)
                        accent: '#41EAD4'      // Mint Green
                    }
                },
                { 
                    id: 'tottenham', 
                    name: 'Tottenham', 
                    played: 28, won: 16, drawn: 6, lost: 6, 
                    goalsFor: 66, goalsAgainst: 48, 
                    form: ['L','W','W','D','W'],
                    colors: {
                        primary: '#132257',    // Navy Blue
                        secondary: '#FFFFFF',  // White
                        tertiary: '#F5F5DC',   // Lilywhite
                        accent: '#5A9FD4'      // Light Blue
                    }
                },
                { 
                    id: 'brighton', 
                    name: 'Brighton', 
                    played: 28, won: 15, drawn: 7, lost: 6, 
                    goalsFor: 58, goalsAgainst: 46, 
                    form: ['W','D','L','W','W'],
                    colors: {
                        primary: '#0057B8',    // Brighton Blue
                        secondary: '#FFCD00',  // Yellow
                        tertiary: '#FFFFFF',   // White
                        accent: '#74C0FC'      // Sky Blue
                    }
                },
                { 
                    id: 'chelsea', 
                    name: 'Chelsea', 
                    played: 28, won: 14, drawn: 9, lost: 5, 
                    goalsFor: 51, goalsAgainst: 43, 
                    form: ['D','D','W','W','D'],
                    colors: {
                        primary: '#034694',    // Chelsea Blue
                        secondary: '#FFFFFF',  // White
                        tertiary: '#ED1C24',   // Red
                        accent: '#74C0FC'      // Light Blue
                    }
                },
                { 
                    id: 'aston-villa', 
                    name: 'Aston Villa', 
                    played: 28, won: 14, drawn: 7, lost: 7, 
                    goalsFor: 49, goalsAgainst: 43, 
                    form: ['L','W','D','W','L'],
                    colors: {
                        primary: '#95BFE5',    // Claret Blue
                        secondary: '#FFCD00',  // Villa Yellow
                        tertiary: '#670E36',   // Claret
                        accent: '#A8E6CF'      // Light Green
                    }
                },
                { 
                    id: 'west-ham', 
                    name: 'West Ham', 
                    played: 28, won: 12, drawn: 8, lost: 8, 
                    goalsFor: 44, goalsAgainst: 42, 
                    form: ['L','D','W','L','D'],
                    colors: {
                        primary: '#7A263A',    // Claret
                        secondary: '#1BB1E7',  // Sky Blue
                        tertiary: '#F3D459',   // Gold
                        accent: '#FF6B6B'      // Light Red
                    }
                },
                { 
                    id: 'crystal-palace', 
                    name: 'Crystal Palace', 
                    played: 28, won: 11, drawn: 9, lost: 8, 
                    goalsFor: 40, goalsAgainst: 42, 
                    form: ['D','L','L','W','D'],
                    colors: {
                        primary: '#1B458F',    // Palace Blue
                        secondary: '#C4122E',  // Red
                        tertiary: '#A7A5A6',   // Silver
                        accent: '#74C0FC'      // Light Blue
                    }
                },
                { 
                    id: 'fulham', 
                    name: 'Fulham', 
                    played: 28, won: 11, drawn: 8, lost: 9, 
                    goalsFor: 38, goalsAgainst: 42, 
                    form: ['W','L','D','L','L'],
                    colors: {
                        primary: '#FFFFFF',    // White
                        secondary: '#000000',  // Black
                        tertiary: '#CC0000',   // Red
                        accent: '#DCDDE1'      // Light Grey
                    }
                },
                { 
                    id: 'wolves', 
                    name: 'Wolves', 
                    played: 28, won: 10, drawn: 8, lost: 10, 
                    goalsFor: 36, goalsAgainst: 44, 
                    form: ['L','D','W','D','L'],
                    colors: {
                        primary: '#FDB462',    // Old Gold
                        secondary: '#231F20',  // Black
                        tertiary: '#FFFFFF',   // White
                        accent: '#FFD700'      // Gold
                    }
                },
                { 
                    id: 'brentford', 
                    name: 'Brentford', 
                    played: 28, won: 9, drawn: 10, lost: 9, 
                    goalsFor: 35, goalsAgainst: 47, 
                    form: ['D','L','D','D','D'],
                    colors: {
                        primary: '#E30613',    // Red
                        secondary: '#FDB913',  // Yellow
                        tertiary: '#000000',   // Black
                        accent: '#FF6B6B'      // Light Red
                    }
                },
                { 
                    id: 'everton', 
                    name: 'Everton', 
                    played: 28, won: 8, drawn: 12, lost: 8, 
                    goalsFor: 32, goalsAgainst: 47, 
                    form: ['D','D','D','L','D'],
                    colors: {
                        primary: '#003399',    // Royal Blue
                        secondary: '#FFFFFF',  // White
                        tertiary: '#000000',   // Black
                        accent: '#74C0FC'      // Light Blue
                    }
                },
                { 
                    id: 'nottm-forest', 
                    name: 'Nottm Forest', 
                    played: 28, won: 8, drawn: 10, lost: 10, 
                    goalsFor: 30, goalsAgainst: 48, 
                    form: ['L','L','D','W','L'],
                    colors: {
                        primary: '#DD0000',    // Red
                        secondary: '#FFFFFF',  // White
                        tertiary: '#FFCD00',   // Yellow
                        accent: '#FF6B6B'      // Light Red
                    }
                },
                { 
                    id: 'luton', 
                    name: 'Luton', 
                    played: 28, won: 7, drawn: 10, lost: 11, 
                    goalsFor: 28, goalsAgainst: 50, 
                    form: ['L','L','D','L','D'],
                    colors: {
                        primary: '#F78F1E',    // Orange
                        secondary: '#002D5C',  // Navy
                        tertiary: '#FFFFFF',   // White
                        accent: '#FFB347'      // Light Orange
                    }
                },
                { 
                    id: 'burnley', 
                    name: 'Burnley', 
                    played: 28, won: 6, drawn: 8, lost: 14, 
                    goalsFor: 26, goalsAgainst: 54, 
                    form: ['L','L','L','L','D'],
                    colors: {
                        primary: '#6CABDD',    // Sky Blue
                        secondary: '#99D6EA',  // Light Blue
                        tertiary: '#FFFFFF',   // White
                        accent: '#87CEEB'      // Sky Blue Light
                    }
                },
                { 
                    id: 'sheffield-utd', 
                    name: 'Sheffield Utd', 
                    played: 28, won: 5, drawn: 7, lost: 16, 
                    goalsFor: 23, goalsAgainst: 58, 
                    form: ['L','L','L','L','L'],
                    colors: {
                        primary: '#EE2737',    // Red
                        secondary: '#FFFFFF',  // White
                        tertiary: '#000000',   // Black
                        accent: '#FF6B6B'      // Light Red
                    }
                },
                { 
                    id: 'bournemouth', 
                    name: 'Bournemouth', 
                    played: 28, won: 4, drawn: 6, lost: 18, 
                    goalsFor: 22, goalsAgainst: 64, 
                    form: ['L','L','L','L','L'],
                    colors: {
                        primary: '#DA020E',    // Red
                        secondary: '#000000',  // Black
                        tertiary: '#FFFFFF',   // White
                        accent: '#FF4757'      // Bright Red
                    }
                }
            ],
            
            // Competition Zone Definitions
            zones: {
                championsLeague: { start: 1, end: 4, color: '#10b981', label: 'Champions League' },
                europaLeague: { start: 5, end: 6, color: '#f59e0b', label: 'Europa League' },
                conferenceLeague: { start: 7, end: 7, color: '#8b5cf6', label: 'Conference League' },
                relegation: { start: 18, end: 20, color: '#ef4444', label: 'Relegation' }
            }
        };
        
        // Enhanced League Table Generator with JSON Data Binding
        function generateDynamicLeagueTable() {
            // Sort teams by points, then by goal difference
            const sortedTeams = [...PREMIER_LEAGUE_DB.teams].sort((a, b) => {
                const pointsDiff = (b.won * 3 + b.drawn) - (a.won * 3 + a.drawn);
                if (pointsDiff !== 0) return pointsDiff;
                return (b.goalsFor - b.goalsAgainst) - (a.goalsFor - a.goalsAgainst);
            });
            
            return sortedTeams.map((team, index) => {
                const position = index + 1;
                const points = team.won * 3 + team.drawn;
                const goalDifference = team.goalsFor - team.goalsAgainst;
                const isUserTeam = team.id === userTeamID;
                
                // Determine competition zone
                let zoneInfo = null;
                Object.entries(PREMIER_LEAGUE_DB.zones).forEach(([zoneName, zone]) => {
                    if (position >= zone.start && position <= zone.end) {
                        zoneInfo = zone;
                    }
                });
                
                return {
                    position: position,
                    team: team,
                    points: points,
                    goalDifference: goalDifference,
                    isUserTeam: isUserTeam,
                    zone: zoneInfo,
                    formString: team.form.join('')
                };
            });
        }
        
        // Color coding utility functions
        function getGoalDifferenceColor(gd) {
            if (gd > 15) return '#10b981';
            if (gd > 5) return '#84cc16';
            if (gd > 0) return '#22c55e';
            if (gd === 0) return '#6b7280';
            if (gd > -10) return '#f59e0b';
            return '#ef4444';
        }
        
        function getFormResultColor(result) {
            switch(result) {
                case 'W': return '#10b981';
                case 'D': return '#f59e0b';
                case 'L': return '#ef4444';
                default: return '#6b7280';
            }
        }
        
        // Create team form visual with fixed-size containers
        function createTeamFormVisual(formArray, size = 'small') {
            const containerSize = size === 'small' ? '12px' : '14px';
            const fontSize = size === 'small' ? '8px' : '9px';
            
            return formArray.map(result => 
                `<span style="
                    display: inline-block;
                    width: ${containerSize};
                    height: ${containerSize};
                    background: ${getFormResultColor(result)};
                    color: white;
                    font-weight: bold;
                    font-size: ${fontSize};
                    text-align: center;
                    line-height: ${containerSize};
                    border-radius: 2px;
                    margin-right: 2px;
                    font-family: var(--font-mono, monospace);
                ">${result}</span>`
            ).join('');
        }
        
        // User Team Management Functions
        function setUserTeam(teamID) {
            userTeamID = teamID;
            console.log(`User team changed to: ${teamID}`);
            
            // Refresh league table to show new highlighting
            const overviewPage = document.getElementById('overview-page');
            if (overviewPage && overviewPage.classList.contains('active')) {
                loadPageCards('overview');
            }
        }

        // LAYOUT EXPORT SYSTEM
        // ========================================

        function saveCurrentLayout() {
            try {
                // Extract complete layout information from the current grid
                const gridContainer = document.querySelector('.tile-container');
                if (!gridContainer) {
                    alert('Grid container not found');
                    return;
                }
                
                const cards = Array.from(gridContainer.querySelectorAll('.card'));
                const layout = {
                    metadata: {
                        gridConfig: {
                            columns: parseInt(getComputedStyle(document.documentElement).getPropertyValue('--grid-columns')),
                            rows: parseInt(getComputedStyle(document.documentElement).getPropertyValue('--grid-rows')),
                            cellSize: parseInt(getComputedStyle(document.documentElement).getPropertyValue('--grid-cell-size')),
                            gap: parseFloat(getComputedStyle(document.documentElement).getPropertyValue('--grid-gap')),
                            containerWidth: parseInt(getComputedStyle(document.documentElement).getPropertyValue('--container-width')),
                            containerHeight: parseInt(getComputedStyle(document.documentElement).getPropertyValue('--container-height'))
                        },
                        totalCards: cards.length,
                        timestamp: new Date().toISOString(),
                        page: document.querySelector('.nav-tab.active')?.textContent.toLowerCase() || 'overview',
                        currentTeam: userTeamID
                    },
                    cards: []
                };
                
                cards.forEach((card, index) => {
                    // Extract grid positioning
                    const computedStyle = getComputedStyle(card);
                    const gridColumnStart = computedStyle.gridColumnStart;
                    const gridRowStart = computedStyle.gridRowStart;
                    
                    // Extract width and height from classes
                    let width = null, height = null;
                    const classes = Array.from(card.classList);
                    classes.forEach(cls => {
                        const wMatch = cls.match(/^w(\d+)$/);
                        const hMatch = cls.match(/^h(\d+)$/);
                        if (wMatch) width = parseInt(wMatch[1]);
                        if (hMatch) height = parseInt(hMatch[1]);
                    });
                    
                    // Extract data attributes as fallback
                    const dataW = card.getAttribute('data-grid-w');
                    const dataH = card.getAttribute('data-grid-h');
                    if (dataW) width = parseInt(dataW);
                    if (dataH) height = parseInt(dataH);
                    
                    // Get card title from header
                    const headerSpan = card.querySelector('.card-header span, .aethelred-card-header span');
                    const title = headerSpan ? headerSpan.textContent.trim() : 'Unknown';
                    
                    // Get tier class
                    let tier = null;
                    classes.forEach(cls => {
                        if (cls.startsWith('tier-')) {
                            tier = cls;
                        }
                    });
                    
                    // Determine component type
                    let componentType = 'SummaryStatCard'; // Default
                    if (card.classList.contains('squad-health-matrix-card')) componentType = 'SquadHealthMatrixCard';
                    else if (card.classList.contains('aethelred-training-overview-card')) componentType = 'TrainingOptimizerCard';
                    else if (tier && tier.includes('match-predictor')) componentType = 'MatchPredictorCard';
                    else if (tier && tier.includes('league-table')) componentType = 'RosterCard';
                    
                    const cardData = {
                        index: index,
                        title: title,
                        componentType: componentType,
                        tier: tier,
                        dimensions: {
                            width: width,
                            height: height
                        },
                        gridPosition: {
                            columnStart: gridColumnStart !== 'auto' ? parseInt(gridColumnStart) : null,
                            rowStart: gridRowStart !== 'auto' ? parseInt(gridRowStart) : null,
                            columnSpan: width,
                            rowSpan: height
                        },
                        classes: classes.filter(cls => !cls.startsWith('w') && !cls.startsWith('h')), // Clean classes
                        bounds: {
                            x: card.offsetLeft,
                            y: card.offsetTop,
                            width: card.offsetWidth,
                            height: card.offsetHeight
                        }
                    };
                    
                    layout.cards.push(cardData);
                });
                
                // Create downloadable JSON file
                const dataStr = JSON.stringify(layout, null, 2);
                const dataUri = 'data:application/json;charset=utf-8,'+ encodeURIComponent(dataStr);
                
                const link = document.createElement('a');
                link.setAttribute('href', dataUri);
                link.setAttribute('download', `fm-layout-${layout.metadata.page}-${new Date().toISOString().slice(0,19).replace(/:/g,'-')}.json`);
                
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                
                console.log('Layout saved successfully:', layout);
                
                // Show success message
                showLayoutSaveMessage(`Layout saved with ${layout.cards.length} cards`);
                
            } catch (error) {
                console.error('Error saving layout:', error);
                alert('Error saving layout: ' + error.message);
            }
        }

        function showLayoutSaveMessage(message) {
            // Create temporary success message
            const notification = document.createElement('div');
            notification.style.cssText = `
                position: fixed;
                top: 100px;
                right: 20px;
                background: var(--accent-200);
                color: var(--neutral-100);
                padding: 12px 20px;
                border-radius: var(--border-radius);
                font-size: var(--font-size-sm);
                font-weight: 600;
                z-index: 9999;
                box-shadow: 0 4px 12px rgba(0,0,0,0.3);
                transform: translateX(100%);
                transition: transform 0.3s ease;
            `;
            notification.textContent = `✅ ${message}`;
            
            document.body.appendChild(notification);
            
            // Animate in
            setTimeout(() => {
                notification.style.transform = 'translateX(0)';
            }, 100);
            
            // Animate out and remove
            setTimeout(() => {
                notification.style.transform = 'translateX(100%)';
                setTimeout(() => {
                    if (document.body.contains(notification)) {
                        document.body.removeChild(notification);
                    }
                }, 300);
            }, 3000);
        }

        function loadLayoutFromFile() {
            // Create hidden file input
            const fileInput = document.createElement('input');
            fileInput.type = 'file';
            fileInput.accept = '.json';
            fileInput.style.display = 'none';
            
            fileInput.onchange = function(event) {
                const file = event.target.files[0];
                if (!file) return;
                
                const reader = new FileReader();
                reader.onload = function(e) {
                    try {
                        const layoutData = JSON.parse(e.target.result);
                        applyLayoutFromData(layoutData);
                        showLayoutSaveMessage(`Layout loaded with ${layoutData.cards.length} cards`);
                    } catch (error) {
                        console.error('Error parsing layout file:', error);
                        alert('Error loading layout: Invalid JSON file');
                    }
                };
                reader.readAsText(file);
                
                // Clean up
                document.body.removeChild(fileInput);
            };
            
            document.body.appendChild(fileInput);
            fileInput.click();
        }

        function applyLayoutFromData(layoutData) {
            try {
                // Validate layout data
                if (!layoutData.metadata || !layoutData.cards || !Array.isArray(layoutData.cards)) {
                    throw new Error('Invalid layout data format');
                }
                
                console.log('Applying layout:', layoutData);
                
                // Update grid configuration if needed
                const gridConfig = layoutData.metadata.gridConfig;
                if (gridConfig) {
                    const root = document.documentElement;
                    root.style.setProperty('--grid-columns', gridConfig.columns);
                    root.style.setProperty('--grid-rows', gridConfig.rows);
                    root.style.setProperty('--grid-cell-size', gridConfig.cellSize + 'px');
                    root.style.setProperty('--grid-gap', gridConfig.gap + 'px');
                    root.style.setProperty('--container-width', gridConfig.containerWidth + 'px');
                    root.style.setProperty('--container-height', gridConfig.containerHeight + 'px');
                }
                
                // Switch to the correct page if specified
                if (layoutData.metadata.page) {
                    const targetTab = document.querySelector(`[onclick*="${layoutData.metadata.page}"]`);
                    if (targetTab) {
                        targetTab.click();
                    }
                }
                
                // Set team if specified
                if (layoutData.metadata.currentTeam) {
                    setUserTeam(layoutData.metadata.currentTeam);
                }
                
                // Create custom layout function for these specific cards
                window.customLayoutData = layoutData;
                
                // Trigger layout refresh
                setTimeout(() => {
                    applyCustomLayout(layoutData);
                }, 500);
                
            } catch (error) {
                console.error('Error applying layout:', error);
                alert('Error applying layout: ' + error.message);
            }
        }

        function applyCustomLayout(layoutData) {
            // Override the default card generation for this specific layout
            const gridContainer = document.querySelector('.tile-container');
            if (!gridContainer) return;
            
            // Clear existing cards
            gridContainer.innerHTML = '';
            
            // Create cards based on loaded layout
            layoutData.cards.forEach(cardInfo => {
                let cardElement = null;
                
                // Create the appropriate card based on component type
                switch (cardInfo.componentType) {
                    case 'TrainingOptimizerCard':
                        cardElement = createTrainingOptimizerCard(getTrainingOptimizerData());
                        break;
                    case 'SquadHealthMatrixCard':
                        cardElement = createSquadHealthMatrixCard(getSquadHealthData());
                        break;
                    case 'MatchPredictorCard':
                        cardElement = createMatchPredictorCard(getMatchPredictorData());
                        break;
                    case 'RosterCard':
                        if (cardInfo.tier === 'tier-league-table') {
                            cardElement = createRosterCard(getLeagueTableData());
                        }
                        break;
                    case 'SummaryStatCard':
                    default:
                        // Determine which data function to use based on tier
                        let dataFunction = null;
                        if (cardInfo.tier === 'tier-tactical-momentum') dataFunction = getTacticalMomentumData;
                        else if (cardInfo.tier === 'tier-financial-flow') dataFunction = getFinancialFlowData;
                        else if (cardInfo.tier === 'tier-intelligence-hub') dataFunction = getIntelligenceHubData;
                        else if (cardInfo.tier === 'tier-form-pattern') dataFunction = getFormPatternData;
                        else if (cardInfo.tier === 'tier-pressure-points') dataFunction = getPressurePointsData;
                        else if (cardInfo.tier === 'tier-live-feed') dataFunction = getLiveFeedData;
                        
                        if (dataFunction) {
                            cardElement = createSummaryStatCard(dataFunction());
                        }
                        break;
                }
                
                if (cardElement) {
                    // Apply the loaded positioning and sizing
                    cardElement.className = `card w${cardInfo.dimensions.width} h${cardInfo.dimensions.height} ${cardInfo.tier}`;
                    cardElement.style.gridColumnStart = cardInfo.gridPosition.columnStart;
                    cardElement.style.gridRowStart = cardInfo.gridPosition.rowStart;
                    cardElement.style.gridColumnEnd = `span ${cardInfo.dimensions.width}`;
                    cardElement.style.gridRowEnd = `span ${cardInfo.dimensions.height}`;
                    
                    gridContainer.appendChild(cardElement);
                }
            });
            
            console.log(`Applied custom layout with ${layoutData.cards.length} cards`);
        }

        // AUTO-LOAD LAYOUT SYSTEM
        // ========================================

        // Embedded layout configurations that can be easily modified
        const EMBEDDED_LAYOUTS = {
            'custom-4-card': {
                "metadata": {
                    "gridConfig": {
                        "columns": 41,
                        "rows": 22,
                        "cellSize": 37,
                        "gap": 2.4,
                        "containerWidth": 1628,
                        "containerHeight": 881
                    },
                    "totalCards": 4,
                    "timestamp": "2025-08-22T08:20:00.000Z",
                    "page": "overview",
                    "description": "Custom 4-card layout focusing on key management areas"
                },
                "cards": [
                    {
                        "index": 0,
                        "title": "Training Overview",
                        "componentType": "TrainingOptimizerCard",
                        "tier": "tier-training-optimizer",
                        "dimensions": {
                            "width": 20,
                            "height": 10
                        },
                        "gridPosition": {
                            "columnStart": 1,
                            "rowStart": 1,
                            "columnSpan": 20,
                            "rowSpan": 10
                        }
                    },
                    {
                        "index": 1,
                        "title": "Squad Health Matrix",
                        "componentType": "SquadHealthMatrixCard",
                        "tier": "tier-squad-health-matrix",
                        "dimensions": {
                            "width": 21,
                            "height": 10
                        },
                        "gridPosition": {
                            "columnStart": 21,
                            "rowStart": 1,
                            "columnSpan": 21,
                            "rowSpan": 10
                        }
                    },
                    {
                        "index": 2,
                        "title": "League Table",
                        "componentType": "RosterCard",
                        "tier": "tier-league-table",
                        "dimensions": {
                            "width": 20,
                            "height": 12
                        },
                        "gridPosition": {
                            "columnStart": 1,
                            "rowStart": 11,
                            "columnSpan": 20,
                            "rowSpan": 12
                        }
                    },
                    {
                        "index": 3,
                        "title": "Intelligence Hub",
                        "componentType": "SummaryStatCard",
                        "tier": "tier-intelligence-hub",
                        "dimensions": {
                            "width": 21,
                            "height": 12
                        },
                        "gridPosition": {
                            "columnStart": 21,
                            "rowStart": 11,
                            "columnSpan": 21,
                            "rowSpan": 12
                        }
                    }
                ]
            }
        };

        async function autoLoadLayoutFromFolder() {
            try {
                console.log('Checking for auto-load layout configurations...');

                // Check if a custom layout is embedded and enabled
                const enableCustomLayout = false; // Set to false to disable auto-load
                const selectedLayout = 'custom-4-card'; // Change this to load different layouts

                if (enableCustomLayout && EMBEDDED_LAYOUTS[selectedLayout]) {
                    const layoutData = EMBEDDED_LAYOUTS[selectedLayout];
                    console.log(`Auto-loading embedded layout: ${selectedLayout}`);
                    
                    setTimeout(() => {
                        applyLayoutFromData(layoutData);
                        window.customLayoutLoaded = true;
                        showLayoutSaveMessage(`Auto-loaded: ${layoutData.metadata.description}`);
                    }, 200);
                    
                    return;
                }

                console.log('No auto-load layout enabled, using default layout');
                window.customLayoutLoaded = false;

            } catch (error) {
                console.error('Error in auto-load system:', error);
                window.customLayoutLoaded = false;
            }
        }

        // Enhanced load layout function with better error handling
        function loadLayoutFromFile() {
            // Create hidden file input
            const fileInput = document.createElement('input');
            fileInput.type = 'file';
            fileInput.accept = '.json';
            fileInput.style.display = 'none';
            
            fileInput.onchange = function(event) {
                const file = event.target.files[0];
                if (!file) return;
                
                const reader = new FileReader();
                reader.onload = function(e) {
                    try {
                        const layoutData = JSON.parse(e.target.result);
                        applyLayoutFromData(layoutData);
                        window.customLayoutLoaded = true;
                        showLayoutSaveMessage(`Layout loaded: ${layoutData.cards.length} cards from ${file.name}`);
                    } catch (error) {
                        console.error('Error parsing layout file:', error);
                        alert('Error loading layout: Invalid JSON file');
                    }
                };
                reader.readAsText(file);
                
                // Clean up
                document.body.removeChild(fileInput);
            };
            
            document.body.appendChild(fileInput);
            fileInput.click();
        }

        // TEAM DATABASE SYSTEM (colors preserved for future use)
        // ========================================

        function getUserTeamData() {
            return PREMIER_LEAGUE_DB.teams.find(team => team.id === userTeamID);
        }
        
        
        // Add team selection toggle to submenu
        function addTeamSelectionToggle() {
            const overviewSubmenu = document.getElementById('overview-submenu');
            if (overviewSubmenu && !overviewSubmenu.querySelector('.team-selector')) {
                const teamSelector = document.createElement('span');
                teamSelector.className = 'submenu-item team-selector';
                teamSelector.innerHTML = `
                    <select onchange="setUserTeam(this.value)" style="background: var(--neutral-200); border: 1px solid var(--neutral-400); color: var(--text-color); padding: 2px 4px; font-size: 11px;">
                        ${PREMIER_LEAGUE_DB.teams.map(team => 
                            `<option value="${team.id}" ${team.id === userTeamID ? 'selected' : ''}>${team.name}</option>`
                        ).join('')}
                    </select>
                `;
                teamSelector.title = 'Select Your Team';
                overviewSubmenu.querySelector('.submenu-content').appendChild(teamSelector);
            }
        }
        
        // REAL-TIME DATA INTEGRATION - REMOVED
        // Previous live data functionality removed as not needed

        // CARD LAYOUT SYSTEM

        // Get cards for a specific page and submenu
        function getCardsForPage(pageName, submenu = 'default') {
            const sizes = getCardSizePresets();
            
            // Override overview page to show Aethelred components
            if (pageName === 'overview') {
                return getAethelredOverviewCards();
            }
            
            // Squad submenu variations using Aethelred Design System
            if (pageName === 'squad') {
                switch(submenu) {
                    case 'reserves':
                        return [
                            // RosterCard for Reserve Squad (newPlan.md Card 2.2)
                            { 
                                title: 'Reserve Squad', 
                                componentType: 'RosterCard',
                                width: 11, height: 7,
                                data: {
                                    header: { title: 'Reserve Squad' },
                                    body: {
                                        contentType: 'DataTable',
                                        contentData: {
                                            headers: ['Name', 'Pos', 'Age', 'Nat', 'Apps', 'Value'],
                                            rows: [
                                                ['J. Smith', 'GK', 22, 'ENG', 8, '£2M'],
                                                ['M. Jones', 'CB', 20, 'SCO', 12, '£3M'],
                                                ['T. Brown', 'CM', 21, 'WAL', 10, '£2.5M'],
                                                ['L. Davis', 'LW', 19, 'ENG', 6, '£1.8M'],
                                                ['A. Wilson', 'ST', 23, 'IRL', 14, '£4M']
                                            ]
                                        }
                                    }
                                }
                            },
                            // SummaryStatCard for Development Progress (newPlan.md Card 1.2)
                            { 
                                title: 'Development Progress', 
                                componentType: 'SummaryStatCard',
                                width: 6, height: 5,
                                data: {
                                    header: { title: 'Development Progress' },
                                    body: {
                                        contentType: 'StatRowList',
                                        contentData: [
                                            { label: 'Overall Progress', value: '+12%', valueType: 'positive' },
                                            { label: 'Physical Development', value: '+8%', valueType: 'positive' },
                                            { label: 'Technical Skills', value: '+15%', valueType: 'positive' },
                                            { label: 'Mental Attributes', value: '+6%', valueType: 'neutral' },
                                            { label: 'Ready for First Team', value: '2 players', valueType: 'positive' }
                                        ]
                                    }
                                }
                            },
                            // SummaryStatCard for Loan Options
                            { 
                                title: 'Loan Options', 
                                componentType: 'SummaryStatCard',
                                width: 6, height: 4,
                                data: {
                                    header: { title: 'Loan Options' },
                                    body: {
                                        contentType: 'StatRowList',
                                        contentData: [
                                            { label: 'Available Loans', value: '5', valueType: 'neutral' },
                                            { label: 'Championship', value: '3 offers', valueType: 'positive' },
                                            { label: 'League One', value: '2 offers', valueType: 'neutral' }
                                        ]
                                    }
                                }
                            },
                            // TeamCohesionCard for Reserve Fitness (newPlan.md Card 3.2)
                            { 
                                title: 'Reserve Fitness', 
                                componentType: 'TeamCohesionCard',
                                width: 8, height: 4,
                                data: {
                                    header: { title: 'Reserve Fitness' },
                                    body: {
                                        contentType: 'MixedStatList',
                                        contentData: [
                                            { 
                                                type: 'StatBarRow', 
                                                data: { 
                                                    label: 'Squad Fitness',
                                                    bar: { value: 87, maxValue: 100, status: 'high' },
                                                    valueText: '87%'
                                                }
                                            },
                                            { type: 'StatRow', data: { label: 'Match Ready', value: '18/23', valueType: 'positive' } },
                                            { type: 'StatRow', data: { label: 'Injured', value: '1', valueType: 'warning' } }
                                        ]
                                    }
                                }
                            }
                        ];
                    case 'youth':
                        return [
                            // RosterCard for Youth Team (newPlan.md Card 2.2)
                            { 
                                title: 'Youth Team', 
                                componentType: 'RosterCard',
                                width: 11, height: 7,
                                data: {
                                    header: { title: 'Youth Team' },
                                    body: {
                                        contentType: 'DataTable',
                                        contentData: {
                                            headers: ['Name', 'Pos', 'Age', 'Potential', 'Development'],
                                            rows: [
                                                ['L. Garcia', 'AM', 16, '⭐⭐⭐⭐⭐', '95%'],
                                                ['K. Mitchell', 'ST', 17, '⭐⭐⭐⭐', '82%'],
                                                ['R. Thompson', 'CB', 16, '⭐⭐⭐⭐', '78%'],
                                                ['D. Anderson', 'CM', 17, '⭐⭐⭐', '71%'],
                                                ['M. Taylor', 'LW', 16, '⭐⭐⭐⭐', '86%']
                                            ]
                                        }
                                    }
                                }
                            },
                            // SummaryStatCard for Potential Stars
                            { 
                                title: 'Potential Stars', 
                                componentType: 'SummaryStatCard',
                                width: 6, height: 5,
                                data: {
                                    header: { title: 'Potential Stars' },
                                    body: {
                                        contentType: 'StatRowList',
                                        contentData: [
                                            { label: '5-Star Potential', value: '2 players', valueType: 'positive' },
                                            { label: '4-Star Potential', value: '5 players', valueType: 'positive' },
                                            { label: '3-Star Potential', value: '8 players', valueType: 'neutral' },
                                            { label: 'First Team Ready', value: '1 player', valueType: 'positive' }
                                        ]
                                    }
                                }
                            },
                            // SummaryStatCard for Academy Report
                            { 
                                title: 'Academy Report', 
                                componentType: 'SummaryStatCard',
                                width: 6, height: 4,
                                data: {
                                    header: { title: 'Academy Report' },
                                    body: {
                                        contentType: 'StatRowList',
                                        contentData: [
                                            { label: 'Academy Rating', value: 'Category 1', valueType: 'positive' },
                                            { label: 'Reputation', value: 'Excellent', valueType: 'positive' },
                                            { label: 'Facilities', value: 'World Class', valueType: 'positive' }
                                        ]
                                    }
                                }
                            },
                            // SummaryStatCard for Promotion Ready
                            { 
                                title: 'Promotion Ready', 
                                componentType: 'SummaryStatCard',
                                width: 6, height: 3,
                                data: {
                                    header: { title: 'Promotion Ready' },
                                    body: {
                                        contentType: 'StatRowList',
                                        contentData: [
                                            { label: 'Ready for Reserves', value: '3 players', valueType: 'positive' },
                                            { label: 'First Team Interest', value: '1 player', valueType: 'positive' }
                                        ]
                                    }
                                }
                            }
                        ];
                    case 'staff':
                        return [
                            // RosterCard for Coaching Staff (newPlan.md Card 2.2)
                            { 
                                title: 'Coaching Staff', 
                                componentType: 'RosterCard',
                                width: 11, height: 6,
                                data: {
                                    header: { title: 'Coaching Staff' },
                                    body: {
                                        contentType: 'DataTable',
                                        contentData: {
                                            headers: ['Role', 'Name', 'Age', 'Rating', 'Contract'],
                                            rows: [
                                                ['Assistant Manager', 'M. Phelan', 61, '4.5⭐', '2025'],
                                                ['Coach', 'D. Fletcher', 40, '4.2⭐', '2024'],
                                                ['GK Coach', 'C. Woods', 64, '4.8⭐', '2025'],
                                                ['Fitness Coach', 'G. Clegg', 58, '4.3⭐', '2024'],
                                                ['Set Piece Coach', 'E. Steele', 45, '4.1⭐', '2024']
                                            ]
                                        }
                                    }
                                }
                            },
                            // SummaryStatCard for Medical Team
                            { 
                                title: 'Medical Team', 
                                componentType: 'SummaryStatCard',
                                width: 6, height: 4,
                                data: {
                                    header: { title: 'Medical Team' },
                                    body: {
                                        contentType: 'StatRowList',
                                        contentData: [
                                            { label: 'Medical Staff', value: '8 specialists', valueType: 'positive' },
                                            { label: 'Physiotherapists', value: '4', valueType: 'neutral' },
                                            { label: 'Sports Scientists', value: '3', valueType: 'neutral' },
                                            { label: 'Team Doctor', value: 'Available', valueType: 'positive' }
                                        ]
                                    }
                                }
                            },
                            // SummaryStatCard for Scouting Network
                            { 
                                title: 'Scouting Network', 
                                componentType: 'SummaryStatCard',
                                width: 6, height: 5,
                                data: {
                                    header: { title: 'Scouting Network' },
                                    body: {
                                        contentType: 'StatRowList',
                                        contentData: [
                                            { label: 'Global Coverage', value: '85%', valueType: 'positive' },
                                            { label: 'Active Scouts', value: '12', valueType: 'neutral' },
                                            { label: 'Reports This Month', value: '47', valueType: 'positive' },
                                            { label: 'Priority Regions', value: 'South America', valueType: 'neutral' }
                                        ]
                                    }
                                }
                            },
                            // TeamCohesionCard for Staff Ratings
                            { 
                                title: 'Staff Ratings', 
                                componentType: 'TeamCohesionCard',
                                width: 8, height: 5,
                                data: {
                                    header: { title: 'Staff Ratings' },
                                    body: {
                                        contentType: 'MixedStatList',
                                        contentData: [
                                            { 
                                                type: 'StatBarRow', 
                                                data: { 
                                                    label: 'Overall Rating',
                                                    bar: { value: 84, maxValue: 100, status: 'high' },
                                                    valueText: '4.2⭐'
                                                }
                                            },
                                            { type: 'StatRow', data: { label: 'Coaching Quality', value: 'Excellent', valueType: 'positive' } },
                                            { type: 'StatRow', data: { label: 'Staff Morale', value: 'Very Good', valueType: 'positive' } }
                                        ]
                                    }
                                }
                            }
                        ];
                    case 'dynamics':
                        return [
                            // TeamCohesionCard implementing exact newPlan.md example
                            { 
                                title: 'Team Cohesion', 
                                componentType: 'TeamCohesionCard',
                                width: 10, height: 6,
                                data: {
                                    header: { title: 'Team Cohesion' },
                                    body: {
                                        contentType: 'MixedStatList',
                                        contentData: [
                                            { 
                                                type: 'StatBarRow', 
                                                data: { 
                                                    label: 'Unity',
                                                    bar: { value: 85, maxValue: 100, status: 'high' },
                                                    valueText: '85%'
                                                }
                                            },
                                            { type: 'StatRow', data: { label: 'Social Groups', value: 4, valueType: 'neutral' } },
                                            { type: 'StatRow', data: { label: 'Happy Players', value: '22/28', valueType: 'positive' } }
                                        ]
                                    }
                                }
                            },
                            // SummaryStatCard for Social Groups
                            { 
                                title: 'Social Groups', 
                                componentType: 'SummaryStatCard',
                                width: 6, height: 6,
                                data: {
                                    header: { title: 'Social Groups' },
                                    body: {
                                        contentType: 'StatRowList',
                                        contentData: [
                                            { label: 'Group Count', value: '4 groups', valueType: 'neutral' },
                                            { label: 'Leaders', value: 'Bruno, Casemiro', valueType: 'positive' },
                                            { label: 'Influencers', value: 'Rashford, Shaw', valueType: 'neutral' },
                                            { label: 'Popular Players', value: 'Mainoo, Garnacho', valueType: 'positive' },
                                            { label: 'Isolated Players', value: 'None', valueType: 'positive' }
                                        ]
                                    }
                                }
                            },
                            // TeamCohesionCard for Happiness Levels
                            { 
                                title: 'Happiness Levels', 
                                componentType: 'TeamCohesionCard',
                                width: 8, height: 6,
                                data: {
                                    header: { title: 'Happiness Levels' },
                                    body: {
                                        contentType: 'MixedStatList',
                                        contentData: [
                                            { 
                                                type: 'StatBarRow', 
                                                data: { 
                                                    label: 'Squad Happiness',
                                                    bar: { value: 78, maxValue: 100, status: 'high' },
                                                    valueText: '22/28 Happy'
                                                }
                                            },
                                            { type: 'StatRow', data: { label: 'Delighted', value: '8 players', valueType: 'positive' } },
                                            { type: 'StatRow', data: { label: 'Content', value: '14 players', valueType: 'neutral' } },
                                            { type: 'StatRow', data: { label: 'Unhappy', value: '6 players', valueType: 'warning' } }
                                        ]
                                    }
                                }
                            },
                            // SummaryStatCard for Team Hierarchy
                            { 
                                title: 'Team Hierarchy', 
                                componentType: 'SummaryStatCard',
                                width: 6, height: 5,
                                data: {
                                    header: { title: 'Team Hierarchy' },
                                    body: {
                                        contentType: 'StatRowList',
                                        contentData: [
                                            { label: 'Captain', value: 'Bruno Fernandes', valueType: 'positive' },
                                            { label: 'Vice Captain', value: 'Casemiro', valueType: 'positive' },
                                            { label: 'Leadership Group', value: '6 players', valueType: 'neutral' },
                                            { label: 'Respected Veterans', value: 'Varane, Shaw', valueType: 'positive' }
                                        ]
                                    }
                                }
                            }
                        ];
                    default: // First Team (default)
                        return [
                            // First Team Squad using exact newPlan.md RosterCard example
                            { 
                                title: 'First Team Squad', 
                                componentType: 'RosterCard',
                                width: 11, height: 8,
                                data: {
                                    header: { title: 'First Team Squad' },
                                    body: {
                                        contentType: 'DataTable',
                                        contentData: {
                                            headers: ['Name', 'Pos', 'Age', 'Nat', 'Avg', 'Value'],
                                            rows: [
                                                ['Andre Onana', 'GK', 28, 'CMR', 7.4, '£40M'],
                                                ['Diogo Dalot', 'RB', 25, 'POR', 7.2, '£35M'],
                                                ['Raphael Varane', 'CB', 31, 'FRA', 7.5, '£35M'],
                                                ['Lisandro Martinez', 'CB', 26, 'ARG', 7.6, '£55M'],
                                                ['Luke Shaw', 'LB', 29, 'ENG', 7.3, '£28M'],
                                                ['Casemiro', 'DM', 32, 'BRA', 7.5, '£45M'],
                                                ['Kobbie Mainoo', 'CM', 19, 'ENG', 7.3, '£40M'],
                                                ['Bruno Fernandes', 'AM', 29, 'POR', 8.2, '£75M'],
                                                ['Marcus Rashford', 'LW', 26, 'ENG', 7.8, '£85M'],
                                                ['Rasmus Hojlund', 'ST', 21, 'DEN', 7.2, '£65M']
                                            ]
                                        }
                                    }
                                }
                            },
                            // SummaryStatCard for Player Stats
                            { 
                                title: 'Player Stats', 
                                componentType: 'SummaryStatCard',
                                width: 6, height: 5,
                                data: {
                                    header: { title: 'Player Stats' },
                                    body: {
                                        contentType: 'StatRowList',
                                        contentData: [
                                            { label: 'Top Scorer', value: 'Rashford (3)', valueType: 'positive' },
                                            { label: 'Top Assists', value: 'Bruno (2)', valueType: 'positive' },
                                            { label: 'Avg Rating', value: '7.12', valueType: 'positive' },
                                            { label: 'Clean Sheets', value: '1', valueType: 'neutral' }
                                        ]
                                    }
                                }
                            },
                            // SummaryStatCard for Injury Report
                            { 
                                title: 'Injury Report', 
                                componentType: 'SummaryStatCard',
                                width: 6, height: 4,
                                data: {
                                    header: { title: 'Injury Report' },
                                    body: {
                                        contentType: 'StatRowList',
                                        contentData: [
                                            { label: 'L. Shaw (LB)', value: '2 weeks', valueType: 'warning' },
                                            { label: 'A. Martial (ST)', value: '4 weeks', valueType: 'negative' },
                                            { label: 'T. Malacia (LB)', value: '1 week', valueType: 'warning' }
                                        ]
                                    }
                                }
                            },
                            // TeamCohesionCard for Squad Morale
                            { 
                                title: 'Squad Morale', 
                                componentType: 'TeamCohesionCard',
                                width: 8, height: 4,
                                data: {
                                    header: { title: 'Squad Morale' },
                                    body: {
                                        contentType: 'MixedStatList',
                                        contentData: [
                                            { 
                                                type: 'StatBarRow', 
                                                data: { 
                                                    label: 'Overall Morale',
                                                    bar: { value: 92, maxValue: 100, status: 'high' },
                                                    valueText: 'Excellent'
                                                }
                                            },
                                            { type: 'StatRow', data: { label: 'Dressing Room', value: 'United', valueType: 'positive' } },
                                            { type: 'StatRow', data: { label: 'Team Leaders', value: 'Bruno, Casemiro', valueType: 'neutral' } }
                                        ]
                                    }
                                }
                            }
                        ];
                }
            }
            
            // Tactics submenu variations using enhanced Aethelred Design System
            if (pageName === 'tactics') {
                switch(submenu) {
                    case 'formation':
                    default:
                        return [
                            // Enhanced FormationCard with full-pitch visualization
                            { 
                                title: 'Current Formation', 
                                componentType: 'EnhancedFormationCard',
                                width: 12, height: 8,
                                data: {
                                    header: { title: 'Current Formation' },
                                    body: {
                                        contentType: 'FormationDisplay',
                                        contentData: {
                                            formationName: '4-2-3-1 Wide',
                                            tacticName: 'Fluid Counter-Attack',
                                            familiarity: 95,
                                            players: [
                                                { name: 'Onana', position: 'GK', coords: {x: 0.5, y: 0.95} },
                                                { name: 'Dalot', position: 'RB', coords: {x: 0.85, y: 0.75} },
                                                { name: 'Varane', position: 'CB', coords: {x: 0.65, y: 0.75} },
                                                { name: 'Martinez', position: 'CB', coords: {x: 0.35, y: 0.75} },
                                                { name: 'Shaw', position: 'LB', coords: {x: 0.15, y: 0.75} },
                                                { name: 'Casemiro', position: 'DM', coords: {x: 0.6, y: 0.55} },
                                                { name: 'Mainoo', position: 'CM', coords: {x: 0.4, y: 0.55} },
                                                { name: 'Garnacho', position: 'RW', coords: {x: 0.8, y: 0.35} },
                                                { name: 'Bruno', position: 'AM', coords: {x: 0.5, y: 0.35} },
                                                { name: 'Rashford', position: 'LW', coords: {x: 0.2, y: 0.35} },
                                                { name: 'Hojlund', position: 'ST', coords: {x: 0.5, y: 0.15} }
                                            ]
                                        }
                                    }
                                }
                            },
                            // SummaryStatCard for Alternative Tactics
                            { 
                                title: 'Alternative Tactics', 
                                componentType: 'SummaryStatCard',
                                width: 6, height: 5,
                                data: {
                                    header: { title: 'Alternative Tactics' },
                                    body: {
                                        contentType: 'StatRowList',
                                        contentData: [
                                            { label: 'Gegenpress', value: '4-3-3', valueType: 'neutral' },
                                            { label: 'Familiarity', value: '72%', valueType: 'warning' },
                                            { label: 'Tiki-Taka', value: '4-3-3 DM', valueType: 'neutral' },
                                            { label: 'Familiarity', value: '68%', valueType: 'warning' }
                                        ]
                                    }
                                }
                            },
                            // TeamCohesionCard for Tactical Familiarity
                            { 
                                title: 'Tactical Familiarity', 
                                componentType: 'TeamCohesionCard',
                                width: 8, height: 4,
                                data: {
                                    header: { title: 'Tactical Familiarity' },
                                    body: {
                                        contentType: 'MixedStatList',
                                        contentData: [
                                            { 
                                                type: 'StatBarRow', 
                                                data: { 
                                                    label: 'Current Tactic',
                                                    bar: { value: 95, maxValue: 100, status: 'high' },
                                                    valueText: '95%'
                                                }
                                            },
                                            { type: 'StatRow', data: { label: 'Alternative 1', value: '72%', valueType: 'warning' } },
                                            { type: 'StatRow', data: { label: 'Alternative 2', value: '68%', valueType: 'warning' } }
                                        ]
                                    }
                                }
                            }
                        ];
                    case 'instructions':
                        return [
                            // SummaryStatCard for Team Instructions
                            { 
                                title: 'Team Instructions', 
                                componentType: 'SummaryStatCard',
                                width: 8, height: 6,
                                data: {
                                    header: { title: 'Team Instructions' },
                                    body: {
                                        contentType: 'StatRowList',
                                        contentData: [
                                            { label: 'Mentality', value: 'Positive', valueType: 'positive' },
                                            { label: 'Team Width', value: 'Fairly Wide', valueType: 'neutral' },
                                            { label: 'Tempo', value: 'Higher', valueType: 'positive' },
                                            { label: 'Time Wasting', value: 'Never', valueType: 'positive' },
                                            { label: 'Defensive Line', value: 'Standard', valueType: 'neutral' },
                                            { label: 'Line of Engagement', value: 'Higher', valueType: 'positive' },
                                            { label: 'Pressing Intensity', value: 'More Often', valueType: 'positive' },
                                            { label: 'Prevent Short GK', value: 'Yes', valueType: 'neutral' }
                                        ]
                                    }
                                }
                            },
                            // RosterCard for Player Roles
                            { 
                                title: 'Player Roles', 
                                componentType: 'RosterCard',
                                width: 11, height: 7,
                                data: {
                                    header: { title: 'Player Roles' },
                                    body: {
                                        contentType: 'DataTable',
                                        contentData: {
                                            headers: ['Position', 'Player', 'Role', 'Duty'],
                                            rows: [
                                                ['GK', 'Onana', 'Sweeper Keeper', 'Support'],
                                                ['RB', 'Dalot', 'Complete Wing Back', 'Attack'],
                                                ['CB', 'Varane', 'Ball Playing Defender', 'Defend'],
                                                ['CB', 'Martinez', 'Ball Playing Defender', 'Defend'],
                                                ['LB', 'Shaw', 'Inverted Wing Back', 'Support'],
                                                ['DM', 'Casemiro', 'Deep Lying Playmaker', 'Defend'],
                                                ['CM', 'Mainoo', 'Box to Box Midfielder', 'Support'],
                                                ['RW', 'Garnacho', 'Inside Forward', 'Attack'],
                                                ['AM', 'Bruno', 'Advanced Playmaker', 'Support'],
                                                ['LW', 'Rashford', 'Inside Forward', 'Attack'],
                                                ['ST', 'Hojlund', 'Complete Forward', 'Support']
                                            ]
                                        }
                                    }
                                }
                            },
                            // SummaryStatCard for In Possession
                            { 
                                title: 'In Possession', 
                                componentType: 'SummaryStatCard',
                                width: 6, height: 4,
                                data: {
                                    header: { title: 'In Possession' },
                                    body: {
                                        contentType: 'StatRowList',
                                        contentData: [
                                            { label: 'Build Up Play', value: 'Play Out of Defence', valueType: 'positive' },
                                            { label: 'Attacking Width', value: 'Fairly Wide', valueType: 'neutral' },
                                            { label: 'Approach Play', value: 'Pass Into Space', valueType: 'positive' },
                                            { label: 'Final Third', value: 'Mixed Crosses', valueType: 'neutral' }
                                        ]
                                    }
                                }
                            },
                            // SummaryStatCard for In Transition
                            { 
                                title: 'In Transition', 
                                componentType: 'SummaryStatCard',
                                width: 6, height: 4,
                                data: {
                                    header: { title: 'In Transition' },
                                    body: {
                                        contentType: 'StatRowList',
                                        contentData: [
                                            { label: 'Counter Press', value: 'Yes', valueType: 'positive' },
                                            { label: 'Counter Attack', value: 'Yes', valueType: 'positive' },
                                            { label: 'Goalkeeper Distribution', value: 'Mixed', valueType: 'neutral' }
                                        ]
                                    }
                                }
                            },
                            // SummaryStatCard for Out of Possession
                            { 
                                title: 'Out of Possession', 
                                componentType: 'SummaryStatCard',
                                width: 6, height: 4,
                                data: {
                                    header: { title: 'Out of Possession' },
                                    body: {
                                        contentType: 'StatRowList',
                                        contentData: [
                                            { label: 'Defensive Shape', value: '4-2-3-1', valueType: 'neutral' },
                                            { label: 'Defensive Line', value: 'Standard', valueType: 'neutral' },
                                            { label: 'Pressing', value: 'Higher', valueType: 'positive' },
                                            { label: 'Offside Trap', value: 'Yes', valueType: 'positive' }
                                        ]
                                    }
                                }
                            }
                        ];
                    case 'set-pieces':
                        return [
                            // SetPieceCard for Corner Kicks
                            { 
                                title: 'Corner Kicks', 
                                componentType: 'SetPieceCard',
                                width: 8, height: 6,
                                data: {
                                    header: { title: 'Corner Kicks' },
                                    body: {
                                        contentType: 'SetPieceDisplay',
                                        contentData: {
                                            setPieceType: 'Corner Kick Setup',
                                            players: [
                                                { name: 'Bruno', role: 'Corner Taker', coords: {x: 0.95, y: 0.9} },
                                                { name: 'Maguire', role: 'Near Post', coords: {x: 0.45, y: 0.1} },
                                                { name: 'Varane', role: 'Far Post', coords: {x: 0.55, y: 0.1} },
                                                { name: 'Casemiro', role: 'Penalty Spot', coords: {x: 0.5, y: 0.3} },
                                                { name: 'Rashford', role: 'Short Option', coords: {x: 0.8, y: 0.7} },
                                                { name: 'Martinez', role: 'Back Post', coords: {x: 0.6, y: 0.05} }
                                            ]
                                        }
                                    }
                                }
                            },
                            // SetPieceCard for Free Kicks
                            { 
                                title: 'Free Kicks', 
                                componentType: 'SetPieceCard',
                                width: 8, height: 6,
                                data: {
                                    header: { title: 'Free Kicks' },
                                    body: {
                                        contentType: 'SetPieceDisplay',
                                        contentData: {
                                            setPieceType: 'Direct Free Kick',
                                            players: [
                                                { name: 'Bruno', role: 'Primary Taker', coords: {x: 0.5, y: 0.65} },
                                                { name: 'Rashford', role: 'Left Option', coords: {x: 0.45, y: 0.65} },
                                                { name: 'Maguire', role: 'Target', coords: {x: 0.5, y: 0.15} },
                                                { name: 'Varane', role: 'Target', coords: {x: 0.6, y: 0.1} },
                                                { name: 'Casemiro', role: 'Support', coords: {x: 0.3, y: 0.4} },
                                                { name: 'Mainoo', role: 'Wall Support', coords: {x: 0.7, y: 0.5} }
                                            ]
                                        }
                                    }
                                }
                            },
                            // SummaryStatCard for Set Piece Takers
                            { 
                                title: 'Set Piece Takers', 
                                componentType: 'SummaryStatCard',
                                width: 6, height: 5,
                                data: {
                                    header: { title: 'Set Piece Takers' },
                                    body: {
                                        contentType: 'StatRowList',
                                        contentData: [
                                            { label: 'Corners', value: 'Bruno Fernandes', valueType: 'positive' },
                                            { label: 'Direct Free Kicks', value: 'Rashford / Bruno', valueType: 'positive' },
                                            { label: 'Penalties', value: 'Bruno Fernandes', valueType: 'positive' },
                                            { label: 'Long Throw Ins', value: 'Maguire', valueType: 'neutral' }
                                        ]
                                    }
                                }
                            },
                            // TeamCohesionCard for Set Piece Effectiveness
                            { 
                                title: 'Set Piece Stats', 
                                componentType: 'TeamCohesionCard',
                                width: 8, height: 4,
                                data: {
                                    header: { title: 'Set Piece Stats' },
                                    body: {
                                        contentType: 'MixedStatList',
                                        contentData: [
                                            { 
                                                type: 'StatBarRow', 
                                                data: { 
                                                    label: 'Corner Conversion',
                                                    bar: { value: 18, maxValue: 100, status: 'medium' },
                                                    valueText: '18%'
                                                }
                                            },
                                            { type: 'StatRow', data: { label: 'Goals Scored', value: '4 corners', valueType: 'positive' } },
                                            { type: 'StatRow', data: { label: 'Free Kick Goals', value: '2', valueType: 'positive' } }
                                        ]
                                    }
                                }
                            }
                        ];
                    case 'opposition':
                        return [
                            // SummaryStatCard for Opposition Instructions
                            { 
                                title: 'Opposition Instructions', 
                                componentType: 'SummaryStatCard',
                                width: 8, height: 6,
                                data: {
                                    header: { title: 'Opposition Instructions' },
                                    body: {
                                        contentType: 'StatRowList',
                                        contentData: [
                                            { label: 'Liverpool - Salah', value: 'Press Intensely', valueType: 'positive' },
                                            { label: 'Liverpool - Van Dijk', value: 'Show Weaker Foot', valueType: 'neutral' },
                                            { label: 'Man City - De Bruyne', value: 'Tight Marking', valueType: 'positive' },
                                            { label: 'Man City - Haaland', value: 'Press Intensely', valueType: 'positive' },
                                            { label: 'Arsenal - Saka', value: 'Show Weaker Foot', valueType: 'neutral' },
                                            { label: 'Chelsea - Palmer', value: 'Tight Marking', valueType: 'positive' }
                                        ]
                                    }
                                }
                            },
                            // RosterCard for Upcoming Opposition Analysis
                            { 
                                title: 'Next Opposition: Liverpool', 
                                componentType: 'RosterCard',
                                width: 10, height: 6,
                                data: {
                                    header: { title: 'Next Opposition: Liverpool' },
                                    body: {
                                        contentType: 'DataTable',
                                        contentData: {
                                            headers: ['Player', 'Position', 'Threat Level', 'Instruction'],
                                            rows: [
                                                ['Mohamed Salah', 'RW', 'Very High', 'Press Intensely'],
                                                ['Darwin Nunez', 'ST', 'High', 'Tight Marking'],
                                                ['Luis Diaz', 'LW', 'High', 'Show Weaker Foot'],
                                                ['Virgil van Dijk', 'CB', 'High', 'Avoid Crosses'],
                                                ['Andy Robertson', 'LB', 'Medium', 'Standard'],
                                                ['Trent Alexander-Arnold', 'RB', 'High', 'Press When Possible']
                                            ]
                                        }
                                    }
                                }
                            },
                            // SummaryStatCard for Tactical Analysis
                            { 
                                title: 'Tactical Analysis', 
                                componentType: 'SummaryStatCard',
                                width: 6, height: 5,
                                data: {
                                    header: { title: 'Liverpool Analysis' },
                                    body: {
                                        contentType: 'StatRowList',
                                        contentData: [
                                            { label: 'Formation', value: '4-3-3', valueType: 'neutral' },
                                            { label: 'Playing Style', value: 'High Press', valueType: 'warning' },
                                            { label: 'Key Strength', value: 'Wing Play', valueType: 'warning' },
                                            { label: 'Weakness', value: 'High Line Vulnerable', valueType: 'positive' },
                                            { label: 'Recent Form', value: 'WWDLW', valueType: 'warning' }
                                        ]
                                    }
                                }
                            }
                        ];
                    case 'analysis':
                        return [
                            // TeamCohesionCard for Match Performance
                            { 
                                title: 'Formation Performance', 
                                componentType: 'TeamCohesionCard',
                                width: 10, height: 6,
                                data: {
                                    header: { title: 'Formation Performance' },
                                    body: {
                                        contentType: 'MixedStatList',
                                        contentData: [
                                            { 
                                                type: 'StatBarRow', 
                                                data: { 
                                                    label: 'Goals Per Game',
                                                    bar: { value: 2.1, maxValue: 3.0, status: 'high' },
                                                    valueText: '2.1'
                                                }
                                            },
                                            { 
                                                type: 'StatBarRow', 
                                                data: { 
                                                    label: 'Goals Against',
                                                    bar: { value: 1.2, maxValue: 3.0, status: 'high' },
                                                    valueText: '1.2'
                                                }
                                            },
                                            { type: 'StatRow', data: { label: 'Win Rate', value: '65%', valueType: 'positive' } },
                                            { type: 'StatRow', data: { label: 'Clean Sheet %', value: '35%', valueType: 'neutral' } }
                                        ]
                                    }
                                }
                            },
                            // RosterCard for Tactical Stats
                            { 
                                title: 'Tactical Statistics', 
                                componentType: 'RosterCard',
                                width: 10, height: 6,
                                data: {
                                    header: { title: 'Tactical Statistics' },
                                    body: {
                                        contentType: 'DataTable',
                                        contentData: {
                                            headers: ['Metric', 'Value', 'League Avg', 'Rating'],
                                            rows: [
                                                ['Possession %', '58%', '52%', 'Above Average'],
                                                ['Pass Completion', '87%', '84%', 'Good'],
                                                ['Shots per Game', '14.2', '12.8', 'Good'],
                                                ['Big Chances Created', '3.1', '2.4', 'Excellent'],
                                                ['Tackles per Game', '18.5', '16.2', 'Good'],
                                                ['Interceptions', '11.3', '9.8', 'Above Average']
                                            ]
                                        }
                                    }
                                }
                            }
                        ];
                }
            }
            
            // Training submenu variations using Aethelred Design System
            if (pageName === 'training') {
                switch(submenu) {
                    case 'schedule':
                    default:
                        return [
                            // RosterCard for Training Schedule
                            { 
                                title: 'Training Schedule', 
                                componentType: 'RosterCard',
                                width: 10, height: 6,
                                data: {
                                    header: { title: 'Training Schedule' },
                                    body: {
                                        contentType: 'DataTable',
                                        contentData: {
                                            headers: ['Day', 'Focus', 'Intensity', 'Duration'],
                                            rows: [
                                                ['Monday', 'Recovery', 'Light', '45 mins'],
                                                ['Tuesday', 'Tactical', 'Medium', '90 mins'],
                                                ['Wednesday', 'Physical', 'High', '60 mins'],
                                                ['Thursday', 'Technical', 'Medium', '75 mins'],
                                                ['Friday', 'Set Pieces', 'Light', '30 mins'],
                                                ['Saturday', 'Match Prep', 'Light', '30 mins']
                                            ]
                                        }
                                    }
                                }
                            },
                            // TeamCohesionCard for Fitness Levels
                            { 
                                title: 'Fitness Overview', 
                                componentType: 'TeamCohesionCard',
                                width: 8, height: 5,
                                data: {
                                    header: { title: 'Fitness Overview' },
                                    body: {
                                        contentType: 'MixedStatList',
                                        contentData: [
                                            { 
                                                type: 'StatBarRow', 
                                                data: { 
                                                    label: 'Squad Fitness',
                                                    bar: { value: 87, maxValue: 100, status: 'high' },
                                                    valueText: '87%'
                                                }
                                            },
                                            { 
                                                type: 'StatBarRow', 
                                                data: { 
                                                    label: 'Match Sharpness',
                                                    bar: { value: 78, maxValue: 100, status: 'medium' },
                                                    valueText: '78%'
                                                }
                                            },
                                            { type: 'StatRow', data: { label: 'Injury Risk', value: 'Medium', valueType: 'warning' } }
                                        ]
                                    }
                                }
                            },
                            // SummaryStatCard for Training Focus
                            { 
                                title: 'Training Focus', 
                                componentType: 'SummaryStatCard',
                                width: 6, height: 4,
                                data: {
                                    header: { title: 'Training Focus' },
                                    body: {
                                        contentType: 'StatRowList',
                                        contentData: [
                                            { label: 'This Week', value: 'Defensive Shape', valueType: 'positive' },
                                            { label: 'Next Week', value: 'Set Pieces', valueType: 'neutral' },
                                            { label: 'Monthly Goal', value: 'Possession Play', valueType: 'positive' }
                                        ]
                                    }
                                }
                            }
                        ];
                    case 'individual':
                        return [
                            // RosterCard for Individual Training
                            { 
                                title: 'Individual Training', 
                                componentType: 'RosterCard',
                                width: 11, height: 7,
                                data: {
                                    header: { title: 'Individual Training' },
                                    body: {
                                        contentType: 'DataTable',
                                        contentData: {
                                            headers: ['Player', 'Focus Area', 'Progress', 'Target Date'],
                                            rows: [
                                                ['Hojlund', 'Finishing', '75%', 'Dec 2024'],
                                                ['Mainoo', 'Passing', '82%', 'Nov 2024'],
                                                ['Garnacho', 'Decision Making', '68%', 'Jan 2025'],
                                                ['Antony', 'Weak Foot', '45%', 'Mar 2025'],
                                                ['Mount', 'Fitness Recovery', '60%', 'Oct 2024'],
                                                ['Sancho', 'Match Sharpness', '30%', 'Feb 2025']
                                            ]
                                        }
                                    }
                                }
                            },
                            // SummaryStatCard for Progress Summary
                            { 
                                title: 'Development Summary', 
                                componentType: 'SummaryStatCard',
                                width: 6, height: 5,
                                data: {
                                    header: { title: 'Development Summary' },
                                    body: {
                                        contentType: 'StatRowList',
                                        contentData: [
                                            { label: 'Players in Training', value: '12', valueType: 'neutral' },
                                            { label: 'Exceeding Targets', value: '4', valueType: 'positive' },
                                            { label: 'On Track', value: '6', valueType: 'neutral' },
                                            { label: 'Behind Schedule', value: '2', valueType: 'warning' }
                                        ]
                                    }
                                }
                            }
                        ];
                    case 'facilities':
                        return [
                            // SummaryStatCard for Training Facilities
                            { 
                                title: 'Training Facilities', 
                                componentType: 'SummaryStatCard',
                                width: 8, height: 6,
                                data: {
                                    header: { title: 'Training Facilities' },
                                    body: {
                                        contentType: 'StatRowList',
                                        contentData: [
                                            { label: 'Carrington Training Ground', value: 'World Class', valueType: 'positive' },
                                            { label: 'Youth Facilities', value: 'Excellent', valueType: 'positive' },
                                            { label: 'Medical Centre', value: 'State of the Art', valueType: 'positive' },
                                            { label: 'Gym Equipment', value: 'Excellent', valueType: 'positive' },
                                            { label: 'Pitches Available', value: '12', valueType: 'neutral' },
                                            { label: 'Indoor Training', value: 'Available', valueType: 'positive' }
                                        ]
                                    }
                                }
                            },
                            // TeamCohesionCard for Facility Usage
                            { 
                                title: 'Facility Utilization', 
                                componentType: 'TeamCohesionCard',
                                width: 8, height: 4,
                                data: {
                                    header: { title: 'Facility Utilization' },
                                    body: {
                                        contentType: 'MixedStatList',
                                        contentData: [
                                            { 
                                                type: 'StatBarRow', 
                                                data: { 
                                                    label: 'Capacity Usage',
                                                    bar: { value: 75, maxValue: 100, status: 'high' },
                                                    valueText: '75%'
                                                }
                                            },
                                            { type: 'StatRow', data: { label: 'Peak Hours', value: '9AM-11AM', valueType: 'neutral' } },
                                            { type: 'StatRow', data: { label: 'Maintenance Status', value: 'Excellent', valueType: 'positive' } }
                                        ]
                                    }
                                }
                            }
                        ];
                }
            }
            
            // Transfers submenu variations using Aethelred Design System
            if (pageName === 'transfers') {
                switch(submenu) {
                    default:
                        return [
                            // RosterCard for Transfer Targets
                            { 
                                title: 'Transfer Targets', 
                                componentType: 'RosterCard',
                                width: 12, height: 8,
                                data: {
                                    header: { title: 'Transfer Targets' },
                                    body: {
                                        contentType: 'DataTable',
                                        contentData: {
                                            headers: ['Player', 'Club', 'Pos', 'Age', 'Value', 'Status'],
                                            rows: [
                                                ['Jude Bellingham', 'Real Madrid', 'CM', 21, '£150M', 'Unlikely'],
                                                ['Victor Osimhen', 'Napoli', 'ST', 25, '£120M', 'Interested'],
                                                ['Jeremie Frimpong', 'Leverkusen', 'RB', 23, '£35M', 'Possible'],
                                                ['Michael Olise', 'Crystal Palace', 'RW', 22, '£45M', 'Interested'],
                                                ['Amadou Onana', 'Everton', 'DM', 22, '£40M', 'Possible']
                                            ]
                                        }
                                    }
                                }
                            },
                            // SummaryStatCard for Transfer Budget
                            { 
                                title: 'Transfer Budget', 
                                componentType: 'SummaryStatCard',
                                width: 6, height: 4,
                                data: {
                                    header: { title: 'Transfer Budget' },
                                    body: {
                                        contentType: 'StatRowList',
                                        contentData: [
                                            { label: 'Available Budget', value: '£120M', valueType: 'positive' },
                                            { label: 'Spent This Window', value: '£65M', valueType: 'neutral' },
                                            { label: 'Remaining', value: '£55M', valueType: 'positive' },
                                            { label: 'Wage Room', value: '£450K/week', valueType: 'neutral' }
                                        ]
                                    }
                                }
                            },
                            // SummaryStatCard for Scout Reports
                            { 
                                title: 'Scout Reports', 
                                componentType: 'SummaryStatCard',
                                width: 6, height: 4,
                                data: {
                                    header: { title: 'Scout Reports' },
                                    body: {
                                        contentType: 'StatRowList',
                                        contentData: [
                                            { label: 'New Reports', value: '12', valueType: 'neutral' },
                                            { label: 'Priority Targets', value: '3', valueType: 'positive' },
                                            { label: 'Scouts Active', value: '8', valueType: 'neutral' },
                                            { label: 'Regions Covered', value: '15', valueType: 'positive' }
                                        ]
                                    }
                                }
                            }
                        ];
                }
            }
            
            // Finances submenu variations using Aethelred Design System
            if (pageName === 'finances') {
                switch(submenu) {
                    default:
                        return [
                            // SummaryStatCard implementing exact newPlan.md Financial Overview example
                            { 
                                title: 'Financial Overview', 
                                componentType: 'SummaryStatCard',
                                width: 8, height: 8,
                                data: {
                                    header: { title: 'Financial Overview' },
                                    body: {
                                        contentType: 'StatRowList',
                                        contentData: [
                                            { label: 'Transfer Budget', value: '£45M', valueType: 'neutral' },
                                            { label: 'Wage Budget', value: '£2.3M/week', valueType: 'neutral' },
                                            { label: 'FFP Status', value: 'Compliant', valueType: 'positive' },
                                            { label: 'Current Balance', value: '£45.2M', valueType: 'positive' },
                                            { label: 'Revenue YTD', value: '£285M', valueType: 'positive' },
                                            { label: 'Expenses YTD', value: '£242M', valueType: 'neutral' },
                                            { label: 'Profit/Loss', value: '+£43M', valueType: 'positive' },
                                            { label: 'Projected Annual Revenue', value: '£580M', valueType: 'positive' }
                                        ]
                                    }
                                }
                            },
                            // RosterCard for Revenue Breakdown
                            { 
                                title: 'Revenue Streams', 
                                componentType: 'RosterCard',
                                width: 9, height: 6,
                                data: {
                                    header: { title: 'Revenue Streams' },
                                    body: {
                                        contentType: 'DataTable',
                                        contentData: {
                                            headers: ['Source', 'Annual', 'Monthly', 'Growth'],
                                            rows: [
                                                ['Matchday Revenue', '£110M', '£9.2M', '+5%'],
                                                ['Broadcasting', '£215M', '£17.9M', '+3%'],
                                                ['Commercial', '£275M', '£22.9M', '+8%'],
                                                ['Merchandise', '£125M', '£10.4M', '+12%'],
                                                ['Sponsorship', '£150M', '£12.5M', '+6%']
                                            ]
                                        }
                                    }
                                }
                            },
                            // TeamCohesionCard for FFP Status
                            { 
                                title: 'FFP Compliance', 
                                componentType: 'TeamCohesionCard',
                                width: 8, height: 4,
                                data: {
                                    header: { title: 'FFP Compliance' },
                                    body: {
                                        contentType: 'MixedStatList',
                                        contentData: [
                                            { 
                                                type: 'StatBarRow', 
                                                data: { 
                                                    label: 'Compliance Level',
                                                    bar: { value: 82, maxValue: 100, status: 'high' },
                                                    valueText: 'Compliant'
                                                }
                                            },
                                            { type: 'StatRow', data: { label: 'Squad Cost %', value: '82%', valueType: 'neutral' } },
                                            { type: 'StatRow', data: { label: 'Safety Margin', value: '£48M', valueType: 'positive' } }
                                        ]
                                    }
                                }
                            }
                        ];
                }
            }
            
            // Fixtures submenu variations using Aethelred Design System
            if (pageName === 'fixtures') {
                switch(submenu) {
                    default:
                        return [
                            // RosterCard for Upcoming Fixtures
                            { 
                                title: 'Upcoming Fixtures', 
                                componentType: 'RosterCard',
                                width: 10, height: 7,
                                data: {
                                    header: { title: 'Upcoming Fixtures' },
                                    body: {
                                        contentType: 'DataTable',
                                        contentData: {
                                            headers: ['Date', 'Opponent', 'Venue', 'Competition'],
                                            rows: [
                                                ['20 Aug', 'Liverpool', 'Home', 'Premier League'],
                                                ['24 Aug', 'Galatasaray', 'Away', 'Champions League'],
                                                ['27 Aug', 'Brighton', 'Away', 'Premier League'],
                                                ['02 Sep', 'Arsenal', 'Home', 'Premier League'],
                                                ['15 Sep', 'Crystal Palace', 'Away', 'Premier League']
                                            ]
                                        }
                                    }
                                }
                            },
                            // SummaryStatCard for Recent Form
                            { 
                                title: 'Recent Form', 
                                componentType: 'SummaryStatCard',
                                width: 6, height: 5,
                                data: {
                                    header: { title: 'Recent Form' },
                                    body: {
                                        contentType: 'StatRowList',
                                        contentData: [
                                            { label: 'Last 5 Matches', value: 'WWDLW', valueType: 'positive' },
                                            { label: 'Goals Scored', value: '12', valueType: 'positive' },
                                            { label: 'Goals Conceded', value: '7', valueType: 'warning' },
                                            { label: 'Points Earned', value: '10/15', valueType: 'positive' },
                                            { label: 'Home Record', value: 'W3 D1 L0', valueType: 'positive' }
                                        ]
                                    }
                                }
                            },
                            // SummaryStatCard for Competition Progress
                            { 
                                title: 'Competition Progress', 
                                componentType: 'SummaryStatCard',
                                width: 6, height: 4,
                                data: {
                                    header: { title: 'Competition Progress' },
                                    body: {
                                        contentType: 'StatRowList',
                                        contentData: [
                                            { label: 'Premier League', value: '4th Place', valueType: 'positive' },
                                            { label: 'Champions League', value: 'Group Stage', valueType: 'neutral' },
                                            { label: 'FA Cup', value: 'Round 3', valueType: 'neutral' },
                                            { label: 'Carabao Cup', value: 'Round 4', valueType: 'neutral' }
                                        ]
                                    }
                                }
                            }
                        ];
                }
            }
            
            // Default card templates for each page
            const cardTemplates = {
                overview: [
                    { title: 'Match Preview', ...sizes.report, content: generateMatchPreview() },
                    { title: 'Squad Summary', ...sizes.roster, content: generateSquadSummary() },
                    { title: 'League Table', ...sizes.table, content: generateLeagueTable() },
                    { title: 'Financial Overview', ...sizes.stat, content: generateFinancialOverview() },
                    { title: 'Training Schedule', ...sizes.compact, content: generateTrainingSchedule() },
                    { title: 'Recent Form', ...sizes.stat, content: generateRecentForm() }
                ],
                squad: [
                    { title: 'First Team Squad', ...sizes.roster, content: generateSquadList() },
                    { title: 'Player Stats', ...sizes.compact, content: generatePlayerStats() },
                    { title: 'Injury Report', ...sizes.compact, content: generateInjuryReport() },
                    { title: 'Morale', ...sizes.stat, content: generateMorale() }
                ],
                tactics: [
                    { title: 'Formation', ...sizes.visual, content: generateFormation() },
                    { title: 'Team Instructions', ...sizes.compact, content: generateInstructions() },
                    { title: 'Set Pieces', ...sizes.standard, content: generateSetPieces() },
                    { title: 'Opposition Instructions', ...sizes.standard, content: generateOpposition() }
                ],
                training: [
                    { title: 'Training Schedule', ...sizes.table, content: generateTrainingSchedule() },
                    { title: 'Fitness Levels', ...sizes.compact, content: generateFitnessLevels() },
                    { title: 'Individual Focus', ...sizes.standard, content: generateIndividualTraining() }
                ],
                transfers: [
                    { title: 'Transfer Targets', ...sizes.table, content: generateTransferTargets() },
                    { title: 'Transfer Budget', ...sizes.stat, content: generateTransferBudget() },
                    { title: 'Scout Reports', ...sizes.report, content: generateScoutReports() }
                ],
                finances: [
                    { title: 'Revenue Streams', ...sizes.compact, content: generateRevenue() },
                    { title: 'Expenses', ...sizes.stat, content: generateExpenses() },
                    { title: 'Financial Forecast', ...sizes.table, content: generateForecast() },
                    { title: 'FFP Status', ...sizes.stat, content: generateFFPStatus() }
                ],
                fixtures: [
                    { title: 'Upcoming Fixtures', ...sizes.table, content: generateFixtures() },
                    { title: 'Recent Results', ...sizes.compact, content: generateResults() },
                    { title: 'Competition Progress', ...sizes.standard, content: generateCompetitions() }
                ]
            };
            
            return cardTemplates[pageName] || [];
        }

        // Create a card element - handles both object data and direct params
        function createCardFromData(cardData, pageName) {
            // If this is an Aethelred component, use the factory system
            if (cardData.componentType) {
                return createCardFromAethelredData(cardData, pageName);
            }
            
            const card = document.createElement('div');
            // Apply width and height classes with configuration defaults
            const width = cardData.width || GRID_CONFIG.defaultCardWidth;
            const height = cardData.height || GRID_CONFIG.defaultCardHeight;
            card.className = `card w${width} h${height}`;
            card.setAttribute('data-grid-w', width);
            card.setAttribute('data-grid-h', height);
            card.draggable = false; // We use header dragging
            
            // Check if we're in single view to hide/show correct menu items
            const state = pageStates.get(pageName);
            const isExpanded = state && state.currentView === 'single';
            
            card.innerHTML = `
                <div class="card-header" ondblclick="expandCardFromHeader(this)">
                    <span>${cardData.title}</span>
                    <div class="card-menu">
                        <button class="card-menu-btn" onclick="toggleCardMenu(this, event)">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <circle cx="12" cy="12" r="1"/>
                                <circle cx="12" cy="12" r="5"/>
                            </svg>
                        </button>
                        <div class="card-menu-dropdown">
                            ${!isExpanded ? '<div class="card-menu-item" onclick="expandCard(this)">Expand</div>' : ''}
                            ${isExpanded ? '<div class="card-menu-item" onclick="restoreView(this)">Restore</div>' : ''}
                            <div class="card-menu-item" onclick="pinCard(this)">Pin</div>
                            <div class="card-menu-item" onclick="removeCard(this)">Remove</div>
                            <div class="card-menu-item" onclick="replaceCard(this)">Replace</div>
                            <div class="card-menu-item" onclick="bookmarkCard(this)">Bookmark</div>
                        </div>
                    </div>
                </div>
                <div class="card-body">
                    ${cardData.content}
                </div>
                <div class="resize-handle"></div>
                <div class="resize-handle-bl"></div>
            `;
            
            return card;
        }

        // Toggle card dropdown menu
        function toggleCardMenu(button, event) {
            event.stopPropagation();
            console.log('Card menu toggled');
            const dropdown = button.nextElementSibling;
            const allDropdowns = document.querySelectorAll('.card-menu-dropdown');
            
            allDropdowns.forEach(d => {
                if (d !== dropdown) d.classList.remove('active');
            });
            
            dropdown.classList.toggle('active');
            
            // Close on outside click
            setTimeout(() => {
                document.addEventListener('click', function closeDropdown(e) {
                    if (!button.contains(e.target) && !dropdown.contains(e.target)) {
                        dropdown.classList.remove('active');
                        document.removeEventListener('click', closeDropdown);
                    }
                });
            }, 0);
        }

        // Expand card to single view
        function expandCard(menuItem) {
            const card = menuItem.closest('.card');
            const cardTitle = card.querySelector('.card-header span')?.textContent || 'Unknown';
            console.log(`Expanding card: ${cardTitle}`);
            
            const page = card.closest('.content-page');
            const pageName = page.id.replace('-page', '');
            const gridView = page.querySelector(`#${pageName}-grid-view`);
            const cards = Array.from(gridView.querySelectorAll('.card'));
            const cardIndex = cards.indexOf(card);
            
            // Close dropdown
            const dropdown = menuItem.closest('.card-menu-dropdown');
            if (dropdown) dropdown.classList.remove('active');
            
            showSingleView(pageName, cardIndex);
        }

        // Expand from header double-click (or restore if already in single view) - Enhanced for Aethelred
        function expandCardFromHeader(header) {
            const card = header.closest('.card');
            // Support both regular and Aethelred card headers
            const cardTitle = card.querySelector('.card-header span, .aethelred-card-header span')?.textContent || 'Unknown';
            const page = card.closest('.content-page');
            const pageName = page.id.replace('-page', '');
            const state = pageStates.get(pageName);
            
            console.log(`Double-click on card: ${cardTitle}`);
            
            // If already in single view, restore to grid
            if (state.currentView === 'single') {
                console.log('Restoring to grid view');
                showGridView(pageName);
            } else {
                console.log('Expanding to single view');
                // Otherwise expand to single view
                const gridView = page.querySelector(`#${pageName}-grid-view`);
                const cards = Array.from(gridView.querySelectorAll('.card'));
                const cardIndex = cards.indexOf(card);
                showSingleView(pageName, cardIndex);
            }
        }

        // Restore view from carousel
        function restoreView(menuItem) {
            const page = menuItem.closest('.content-page');
            const pageName = page.id.replace('-page', '');
            
            // Close dropdown
            const dropdown = menuItem.closest('.card-menu-dropdown');
            if (dropdown) dropdown.classList.remove('active');
            
            showGridView(pageName);
        }

        // Show single view for a page
        function showSingleView(pageName, cardIndex) {
            const page = document.getElementById(pageName + '-page');
            const gridView = page.querySelector(`#${pageName}-grid-view`);
            const singleView = page.querySelector(`#${pageName}-single-view`);
            const state = pageStates.get(pageName);
            
            // Update state
            state.currentView = 'single';
            state.selectedCardIndex = cardIndex;
            
            // Hide grid, show single
            gridView.classList.remove('active');
            singleView.classList.add('active');
            
            // Create indicators
            const indicators = document.getElementById('cardIndicators');
            indicators.innerHTML = '';
            
            const cards = gridView.querySelectorAll('.card');
            cards.forEach((card, i) => {
                const indicator = document.createElement('div');
                indicator.className = 'card-indicator' + (i === cardIndex ? ' active' : '');
                indicator.textContent = i + 1;
                indicator.onclick = () => selectCard(pageName, i);
                
                // Add tooltip
                const tooltip = document.createElement('div');
                tooltip.className = 'card-indicator-tooltip';
                tooltip.textContent = card.querySelector('.card-header span').textContent;
                indicator.appendChild(tooltip);
                
                indicators.appendChild(indicator);
            });
            
            indicators.classList.add('active');
            
            // Clone card to single view
            const singleContainer = singleView.querySelector('.tile-container');
            singleContainer.innerHTML = '';
            const selectedCard = cards[cardIndex];
            if (selectedCard) {
                const clonedCard = selectedCard.cloneNode(true);
                clonedCard.classList.add('expanded');
                
                // Update menu for expanded state
                const expandItem = clonedCard.querySelector('.card-menu-item');
                if (expandItem && expandItem.textContent === 'Expand') {
                    expandItem.textContent = 'Restore';
                    expandItem.onclick = () => restoreView(expandItem);
                }
                
                singleContainer.appendChild(clonedCard);
            }
        }

        // Show grid view for a page
        function showGridView(pageName) {
            const page = document.getElementById(pageName + '-page');
            const gridView = page.querySelector(`#${pageName}-grid-view`);
            const singleView = page.querySelector(`#${pageName}-single-view`);
            const state = pageStates.get(pageName);
            
            // Update state
            state.currentView = 'grid';
            
            // Show grid, hide single
            gridView.classList.add('active');
            singleView.classList.remove('active');
            
            // Hide indicators
            document.getElementById('cardIndicators').classList.remove('active');
        }

        // Select card in single view
        function selectCard(pageName, index) {
            const page = document.getElementById(pageName + '-page');
            const gridView = page.querySelector(`#${pageName}-grid-view`);
            const singleView = page.querySelector(`#${pageName}-single-view`);
            const state = pageStates.get(pageName);
            
            // Update state
            state.selectedCardIndex = index;
            
            // Update indicators
            document.querySelectorAll('.card-indicator').forEach((ind, i) => {
                ind.classList.toggle('active', i === index);
            });
            
            // Update single view
            const cards = gridView.querySelectorAll('.card');
            const selectedCard = cards[index];
            if (selectedCard) {
                const singleContainer = singleView.querySelector('.tile-container');
                singleContainer.innerHTML = '';
                const clonedCard = selectedCard.cloneNode(true);
                clonedCard.classList.add('expanded');
                
                // Update menu for expanded state
                const expandItem = clonedCard.querySelector('.card-menu-item');
                if (expandItem && expandItem.textContent === 'Expand') {
                    expandItem.textContent = 'Restore';
                    expandItem.onclick = () => restoreView(expandItem);
                }
                
                singleContainer.appendChild(clonedCard);
            }
        }

        // Toggle single view (double-click header)
        function toggleSingleView() {
            const activePage = document.querySelector('.content-page.active');
            if (!activePage) return;
            
            const pageName = activePage.id.replace('-page', '');
            const state = pageStates.get(pageName);
            
            if (state.currentView === 'grid') {
                showSingleView(pageName, 0);
            } else {
                showGridView(pageName);
            }
        }

        // Additional generator functions for all pages
        // Overview page content generators
        function generateMatchPreview() {
            return `
                <div class="stat-row">
                    <span>Next Match:</span>
                    <strong>vs Liverpool (H)</strong>
                </div>
                <div class="stat-row">
                    <span>Date:</span>
                    <strong>Saturday, 15:00</strong>
                </div>
                <div class="stat-row">
                    <span>Competition:</span>
                    <strong>Premier League</strong>
                </div>
                <div class="stat-row">
                    <span>Form:</span>
                    <strong>WWDWL</strong>
                </div>
            `;
        }
        
        function generateSquadSummary() {
            return `
                <div class="stat-row">
                    <span class="stat-label">Total Squad</span>
                    <span class="stat-value">28</span>
                </div>
                <div class="stat-row">
                    <span class="stat-label">Average Age</span>
                    <span class="stat-value">26.3</span>
                </div>
                <div class="stat-row">
                    <span class="stat-label">Injuries</span>
                    <span class="stat-value negative">3</span>
                </div>
                <div class="stat-row">
                    <span class="stat-label">Team Morale</span>
                    <span class="stat-value positive">Excellent</span>
                </div>
                <div class="stat-row">
                    <span class="stat-label">Form (Last 5)</span>
                    <span class="stat-value">WWDWL</span>
                </div>
            `;
        }
        
        function generateFinancialOverview() {
            return `
                <div class="stat-row">
                    <span>Transfer Budget:</span>
                    <strong>£45M</strong>
                </div>
                <div class="stat-row">
                    <span>Wage Budget:</span>
                    <strong>£2.3M/week</strong>
                </div>
                <div class="stat-row">
                    <span>FFP Status:</span>
                    <strong style="color: var(--accent-200);">Compliant</strong>
                </div>
            `;
        }
        
        function generateTrainingSchedule() {
            return `
                <div class="stat-row">
                    <span>Monday:</span>
                    <strong>Recovery</strong>
                </div>
                <div class="stat-row">
                    <span>Tuesday:</span>
                    <strong>Tactical</strong>
                </div>
                <div class="stat-row">
                    <span>Wednesday:</span>
                    <strong>Physical</strong>
                </div>
                <div class="stat-row">
                    <span>Thursday:</span>
                    <strong>Technical</strong>
                </div>
                <div class="stat-row">
                    <span>Friday:</span>
                    <strong>Match Prep</strong>
                </div>
            `;
        }
        
        function generateRecentForm() {
            return `
                <div class="stat-row">
                    <span>Last 5:</span>
                    <strong>WWDWL</strong>
                </div>
                <div class="stat-row">
                    <span>Goals For:</span>
                    <strong>12</strong>
                </div>
                <div class="stat-row">
                    <span>Goals Against:</span>
                    <strong>7</strong>
                </div>
                <div class="stat-row">
                    <span>Points:</span>
                    <strong>10/15</strong>
                </div>
            `;
        }
        
        function generateStartingXI() {
            return `
                <div style="position: relative; background: linear-gradient(135deg, #0a4020 0%, #0f5132 100%); height: 300px; border-radius: 8px; padding: 20px;">
                    <div style="color: white; font-size: 14px; text-align: center;">
                        <div>GK: Onana</div>
                        <div style="margin-top: 20px;">Dalot - Varane - Martinez - Shaw</div>
                        <div style="margin-top: 20px;">Casemiro - Mainoo</div>
                        <div style="margin-top: 20px;">Garnacho - Bruno - Rashford</div>
                        <div style="margin-top: 20px;">Hojlund</div>
                    </div>
                </div>
            `;
        }
        
        function generatePlayerForm() {
            return `
                <div class="stat-row">
                    <span class="stat-label">Bruno Fernandes</span>
                    <span class="stat-value">⬆️ 8.2</span>
                </div>
                <div class="stat-row">
                    <span class="stat-label">Marcus Rashford</span>
                    <span class="stat-value">⬆️ 7.8</span>
                </div>
                <div class="stat-row">
                    <span class="stat-label">Kobbie Mainoo</span>
                    <span class="stat-value">➡️ 7.3</span>
                </div>
                <div class="stat-row">
                    <span class="stat-label">Antony</span>
                    <span class="stat-value">⬇️ 6.4</span>
                </div>
            `;
        }
        
        function generateSquadDepth() {
            return `
                <div class="stat-row">
                    <span class="stat-label">Goalkeepers</span>
                    <span class="stat-value">3</span>
                </div>
                <div class="stat-row">
                    <span class="stat-label">Defenders</span>
                    <span class="stat-value">9</span>
                </div>
                <div class="stat-row">
                    <span class="stat-label">Midfielders</span>
                    <span class="stat-value">7</span>
                </div>
                <div class="stat-row">
                    <span class="stat-label">Forwards</span>
                    <span class="stat-value">7</span>
                </div>
            `;
        }
        
        function generateContractExpiries() {
            return `
                <div class="stat-row">
                    <span class="stat-label">Varane</span>
                    <span class="stat-value"><span class="badge badge-danger">6 months</span></span>
                </div>
                <div class="stat-row">
                    <span class="stat-label">Martial</span>
                    <span class="stat-value"><span class="badge badge-danger">6 months</span></span>
                </div>
                <div class="stat-row">
                    <span class="stat-label">Evans</span>
                    <span class="stat-value"><span class="badge badge-warning">1 year</span></span>
                </div>
            `;
        }
        
        function generateYouthProspects() {
            return `
                <div class="stat-row">
                    <span class="stat-label">Kobbie Mainoo</span>
                    <span class="stat-value">⭐⭐⭐⭐⭐</span>
                </div>
                <div class="stat-row">
                    <span class="stat-label">Alejandro Garnacho</span>
                    <span class="stat-value">⭐⭐⭐⭐</span>
                </div>
                <div class="stat-row">
                    <span class="stat-label">Omari Forson</span>
                    <span class="stat-value">⭐⭐⭐</span>
                </div>
            `;
        }
        
        // Tactics page generators
        function generateCurrentTactic() {
            return `
                <div style="text-align: center; padding: 20px;">
                    <div style="font-size: 24px; font-weight: bold;">Fluid Counter-Attack</div>
                    <div style="margin-top: 10px; color: rgba(255,255,255,0.6);">4-2-3-1 Wide</div>
                    <div style="margin-top: 20px;">
                        <div class="badge badge-success">95% Familiarity</div>
                    </div>
                </div>
            `;
        }
        
        function generateAlternativeTactics() {
            return `
                <div class="stat-row">
                    <span class="stat-label">Gegenpress</span>
                    <span class="stat-value">4-3-3</span>
                </div>
                <div class="stat-row">
                    <span class="stat-label">Tiki-Taka</span>
                    <span class="stat-value">4-3-3 DM</span>
                </div>
                <div class="stat-row">
                    <span class="stat-label">Route One</span>
                    <span class="stat-value">4-4-2</span>
                </div>
            `;
        }
        
        function generateTeamInstructions() {
            return `
                <div class="stat-row">
                    <span class="stat-label">Build Up</span>
                    <span class="stat-value">Play Out of Defence</span>
                </div>
                <div class="stat-row">
                    <span class="stat-label">Chance Creation</span>
                    <span class="stat-value">Mixed Passes</span>
                </div>
                <div class="stat-row">
                    <span class="stat-label">Defence</span>
                    <span class="stat-value">Higher Line</span>
                </div>
            `;
        }
        
        function generatePlayerRoles() {
            return `
                <table class="data-table">
                    <thead>
                        <tr><th>Position</th><th>Player</th><th>Role</th></tr>
                    </thead>
                    <tbody>
                        <tr><td>GK</td><td>Onana</td><td>Sweeper Keeper</td></tr>
                        <tr><td>RB</td><td>Dalot</td><td>Complete Wing Back</td></tr>
                        <tr><td>CB</td><td>Varane</td><td>Ball Playing Defender</td></tr>
                        <tr><td>CB</td><td>Martinez</td><td>Ball Playing Defender</td></tr>
                        <tr><td>LB</td><td>Shaw</td><td>Inverted Wing Back</td></tr>
                        <tr><td>DM</td><td>Casemiro</td><td>Deep Lying Playmaker</td></tr>
                        <tr><td>CM</td><td>Mainoo</td><td>Box to Box</td></tr>
                        <tr><td>RW</td><td>Garnacho</td><td>Inside Forward</td></tr>
                        <tr><td>AM</td><td>Bruno</td><td>Advanced Playmaker</td></tr>
                        <tr><td>LW</td><td>Rashford</td><td>Inside Forward</td></tr>
                        <tr><td>ST</td><td>Hojlund</td><td>Complete Forward</td></tr>
                    </tbody>
                </table>
            `;
        }
        
        function generateSetPieces() {
            return `
                <div class="stat-row">
                    <span class="stat-label">Corners</span>
                    <span class="stat-value">Bruno</span>
                </div>
                <div class="stat-row">
                    <span class="stat-label">Free Kicks</span>
                    <span class="stat-value">Bruno/Rashford</span>
                </div>
                <div class="stat-row">
                    <span class="stat-label">Penalties</span>
                    <span class="stat-value">Bruno</span>
                </div>
            `;
        }
        
        function generateOppositionAnalysis() {
            return `
                <div class="stat-row">
                    <span class="stat-label">Next: Liverpool</span>
                    <span class="stat-value">4-3-3</span>
                </div>
                <div class="stat-row">
                    <span class="stat-label">Strength</span>
                    <span class="stat-value">High Press</span>
                </div>
                <div class="stat-row">
                    <span class="stat-label">Weakness</span>
                    <span class="stat-value">High Line</span>
                </div>
            `;
        }
        
        function generateMatchPrep() {
            return `
                <div class="stat-row">
                    <span class="stat-label">Focus</span>
                    <span class="stat-value">Defensive Shape</span>
                </div>
                <div class="stat-row">
                    <span class="stat-label">Match Practice</span>
                    <span class="stat-value">Scheduled</span>
                </div>
                <div class="stat-row">
                    <span class="stat-label">Team Talk</span>
                    <span class="stat-value">Passionate</span>
                </div>
            `;
        }
        
        function generateTacticalFamiliarity() {
            return `
                <div class="stat-row">
                    <span class="stat-label">Current Tactic</span>
                    <span class="stat-value">95%</span>
                </div>
                <div class="stat-row">
                    <span class="stat-label">Alternative 1</span>
                    <span class="stat-value">72%</span>
                </div>
                <div class="stat-row">
                    <span class="stat-label">Alternative 2</span>
                    <span class="stat-value">68%</span>
                </div>
            `;
        }
        
        // Training page generators
        function generateIndividualTraining() {
            return `
                <table class="data-table">
                    <thead>
                        <tr><th>Player</th><th>Focus</th><th>Progress</th></tr>
                    </thead>
                    <tbody>
                        <tr><td>Hojlund</td><td>Finishing</td><td>75%</td></tr>
                        <tr><td>Mainoo</td><td>Passing</td><td>82%</td></tr>
                        <tr><td>Garnacho</td><td>Decision Making</td><td>68%</td></tr>
                        <tr><td>Antony</td><td>Weak Foot</td><td>45%</td></tr>
                        <tr><td>Mount</td><td>Fitness</td><td>60%</td></tr>
                    </tbody>
                </table>
            `;
        }
        
        function generateTrainingIntensity() {
            return `
                <div class="stat-row">
                    <span class="stat-label">Overall</span>
                    <span class="stat-value">Medium</span>
                </div>
                <div class="stat-row">
                    <span class="stat-label">Match Prep</span>
                    <span class="stat-value">High</span>
                </div>
                <div class="stat-row">
                    <span class="stat-label">Recovery</span>
                    <span class="stat-value">Low</span>
                </div>
            `;
        }
        
        function generateCoachesReport() {
            return `
                <div class="stat-row">
                    <span class="stat-label">Best Trainer</span>
                    <span class="stat-value">Bruno Fernandes</span>
                </div>
                <div class="stat-row">
                    <span class="stat-label">Most Improved</span>
                    <span class="stat-value">Kobbie Mainoo</span>
                </div>
                <div class="stat-row">
                    <span class="stat-label">Needs Attention</span>
                    <span class="stat-value">Sancho</span>
                </div>
            `;
        }
        
        function generateYouthDevelopment() {
            return `
                <div class="stat-row">
                    <span class="stat-label">U23 Position</span>
                    <span class="stat-value">2nd</span>
                </div>
                <div class="stat-row">
                    <span class="stat-label">U18 Position</span>
                    <span class="stat-value">1st</span>
                </div>
                <div class="stat-row">
                    <span class="stat-label">Academy Rating</span>
                    <span class="stat-value">⭐⭐⭐⭐⭐</span>
                </div>
            `;
        }
        
        function generateTrainingFacilities() {
            return `
                <div class="stat-row">
                    <span class="stat-label">Carrington</span>
                    <span class="stat-value">World Class</span>
                </div>
                <div class="stat-row">
                    <span class="stat-label">Youth Facilities</span>
                    <span class="stat-value">Excellent</span>
                </div>
                <div class="stat-row">
                    <span class="stat-label">Medical Centre</span>
                    <span class="stat-value">State of the Art</span>
                </div>
            `;
        }
        
        function generateFitnessLevels() {
            return `
                <div class="stat-row">
                    <span class="stat-label">Squad Average</span>
                    <span class="stat-value">87%</span>
                </div>
                <div class="stat-row">
                    <span class="stat-label">Match Fitness</span>
                    <span class="stat-value">92%</span>
                </div>
                <div class="stat-row">
                    <span class="stat-label">Injury Risk</span>
                    <span class="stat-value"><span class="badge badge-warning">Medium</span></span>
                </div>
            `;
        }
        
        function generateTrainingFocus() {
            return `
                <div class="stat-row">
                    <span class="stat-label">This Week</span>
                    <span class="stat-value">Defensive Shape</span>
                </div>
                <div class="stat-row">
                    <span class="stat-label">Next Week</span>
                    <span class="stat-value">Set Pieces</span>
                </div>
                <div class="stat-row">
                    <span class="stat-label">Monthly</span>
                    <span class="stat-value">Possession</span>
                </div>
            `;
        }
        
        // Transfer page generators
        function generateTransferTargets() {
            return `
                <table class="data-table">
                    <thead>
                        <tr><th>Player</th><th>Club</th><th>Position</th><th>Value</th></tr>
                    </thead>
                    <tbody>
                        <tr><td>J. Frimpong</td><td>Leverkusen</td><td>RB</td><td>£40M</td></tr>
                        <tr><td>J. Branthwaite</td><td>Everton</td><td>CB</td><td>£60M</td></tr>
                        <tr><td>A. Onana</td><td>Everton</td><td>CM</td><td>£50M</td></tr>
                        <tr><td>M. Gusto</td><td>Chelsea</td><td>RB</td><td>£35M</td></tr>
                        <tr><td>I. Toney</td><td>Brentford</td><td>ST</td><td>£70M</td></tr>
                    </tbody>
                </table>
            `;
        }
        
        function generateTransferBudget() {
            return `
                <div class="stat-row">
                    <span class="stat-label">Available</span>
                    <span class="stat-value">£55M</span>
                </div>
                <div class="stat-row">
                    <span class="stat-label">Spent</span>
                    <span class="stat-value">£65M</span>
                </div>
                <div class="stat-row">
                    <span class="stat-label">Sales</span>
                    <span class="stat-value">£32M</span>
                </div>
            `;
        }
        
        function generateScoutingReport() {
            return `
                <div class="stat-row">
                    <span class="stat-label">Top Target</span>
                    <span class="stat-value">J. Frimpong</span>
                </div>
                <div class="stat-row">
                    <span class="stat-label">Scout Rating</span>
                    <span class="stat-value">⭐⭐⭐⭐</span>
                </div>
                <div class="stat-row">
                    <span class="stat-label">Recommendation</span>
                    <span class="stat-value"><span class="badge badge-success">Sign</span></span>
                </div>
            `;
        }
        
        function generateTransferHistory() {
            return `
                <div class="stat-row">
                    <span class="stat-label">In: Hojlund</span>
                    <span class="stat-value">£72M</span>
                </div>
                <div class="stat-row">
                    <span class="stat-label">In: Mount</span>
                    <span class="stat-value">£60M</span>
                </div>
                <div class="stat-row">
                    <span class="stat-label">Out: Fred</span>
                    <span class="stat-value">£15M</span>
                </div>
            `;
        }
        
        function generateContractNegotiations() {
            return `
                <div class="stat-row">
                    <span class="stat-label">Rashford</span>
                    <span class="stat-value">Extension talks</span>
                </div>
                <div class="stat-row">
                    <span class="stat-label">Mainoo</span>
                    <span class="stat-value">New deal offered</span>
                </div>
                <div class="stat-row">
                    <span class="stat-label">Varane</span>
                    <span class="stat-value">Considering options</span>
                </div>
            `;
        }
        
        function generateLoanWatch() {
            return `
                <div class="stat-row">
                    <span class="stat-label">Greenwood</span>
                    <span class="stat-value">Getafe - 8 goals</span>
                </div>
                <div class="stat-row">
                    <span class="stat-label">Amrabat</span>
                    <span class="stat-value">Option to buy</span>
                </div>
            `;
        }
        
        function generateShortlist() {
            return `
                <div class="stat-row">
                    <span class="stat-label">Defenders</span>
                    <span class="stat-value">3 targets</span>
                </div>
                <div class="stat-row">
                    <span class="stat-label">Midfielders</span>
                    <span class="stat-value">2 targets</span>
                </div>
                <div class="stat-row">
                    <span class="stat-label">Forwards</span>
                    <span class="stat-value">1 target</span>
                </div>
            `;
        }
        
        function generateAgentOffers() {
            return `
                <div class="stat-row">
                    <span class="stat-label">K. Benzema</span>
                    <span class="stat-value">Free transfer</span>
                </div>
                <div class="stat-row">
                    <span class="stat-label">S. Ramos</span>
                    <span class="stat-value">6 month deal</span>
                </div>
            `;
        }
        
        // Finance page generators
        function generateRevenueStreams() {
            return `
                <div class="stat-row">
                    <span class="stat-label">Matchday</span>
                    <span class="stat-value">£110M/year</span>
                </div>
                <div class="stat-row">
                    <span class="stat-label">Broadcasting</span>
                    <span class="stat-value">£215M/year</span>
                </div>
                <div class="stat-row">
                    <span class="stat-label">Commercial</span>
                    <span class="stat-value">£275M/year</span>
                </div>
            `;
        }
        
        function generateWageStructure() {
            return `
                <table class="data-table">
                    <thead>
                        <tr><th>Player</th><th>Weekly Wage</th></tr>
                    </thead>
                    <tbody>
                        <tr><td>Casemiro</td><td>£350K</td></tr>
                        <tr><td>Varane</td><td>£340K</td></tr>
                        <tr><td>Bruno</td><td>£300K</td></tr>
                        <tr><td>Rashford</td><td>£300K</td></tr>
                        <tr><td>Mount</td><td>£250K</td></tr>
                    </tbody>
                </table>
            `;
        }
        
        function generateFFPCompliance() {
            return `
                <div class="stat-row">
                    <span class="stat-label">Status</span>
                    <span class="stat-value"><span class="badge badge-success">Compliant</span></span>
                </div>
                <div class="stat-row">
                    <span class="stat-label">Margin</span>
                    <span class="stat-value">£48M</span>
                </div>
                <div class="stat-row">
                    <span class="stat-label">Next Review</span>
                    <span class="stat-value">June 2024</span>
                </div>
            `;
        }
        
        function generateSponsorshipDeals() {
            return `
                <div class="stat-row">
                    <span class="stat-label">Kit Sponsor</span>
                    <span class="stat-value">TeamViewer £47M</span>
                </div>
                <div class="stat-row">
                    <span class="stat-label">Kit Manufacturer</span>
                    <span class="stat-value">Adidas £90M</span>
                </div>
                <div class="stat-row">
                    <span class="stat-label">Stadium Rights</span>
                    <span class="stat-value">Available</span>
                </div>
            `;
        }
        
        function generateStadiumRevenue() {
            return `
                <div class="stat-row">
                    <span class="stat-label">Capacity</span>
                    <span class="stat-value">74,310</span>
                </div>
                <div class="stat-row">
                    <span class="stat-label">Avg Attendance</span>
                    <span class="stat-value">73,881</span>
                </div>
                <div class="stat-row">
                    <span class="stat-label">Revenue/Match</span>
                    <span class="stat-value">£3.8M</span>
                </div>
            `;
        }
        
        function generateTransferBalance() {
            return `
                <div class="stat-row">
                    <span class="stat-label">Incoming</span>
                    <span class="stat-value">+£132M</span>
                </div>
                <div class="stat-row">
                    <span class="stat-label">Outgoing</span>
                    <span class="stat-value">-£48M</span>
                </div>
                <div class="stat-row">
                    <span class="stat-label">Net Spend</span>
                    <span class="stat-value">-£84M</span>
                </div>
            `;
        }
        
        function generateSeasonProjection() {
            return `
                <div class="stat-row">
                    <span class="stat-label">Revenue</span>
                    <span class="stat-value">£590M</span>
                </div>
                <div class="stat-row">
                    <span class="stat-label">Profit</span>
                    <span class="stat-value">£45M</span>
                </div>
                <div class="stat-row">
                    <span class="stat-label">Growth</span>
                    <span class="stat-value">+8%</span>
                </div>
            `;
        }
        
        // Fixtures page generators
        function generateNextMatch() {
            return `
                <div style="text-align: center; padding: 20px;">
                    <div style="font-size: 18px; font-weight: bold;">Manchester United vs Liverpool</div>
                    <div style="margin-top: 10px;">Old Trafford</div>
                    <div style="margin-top: 10px;">Sunday, 15:00</div>
                    <div style="margin-top: 20px;">
                        <span class="badge badge-info">Premier League</span>
                    </div>
                </div>
            `;
        }
        
        function generateRecentResults() {
            return `
                <div class="stat-row">
                    <span class="stat-label">vs Arsenal</span>
                    <span class="stat-value"><span class="badge badge-success">W 2-1</span></span>
                </div>
                <div class="stat-row">
                    <span class="stat-label">@ Chelsea</span>
                    <span class="stat-value"><span class="badge badge-warning">D 1-1</span></span>
                </div>
                <div class="stat-row">
                    <span class="stat-label">vs City</span>
                    <span class="stat-value"><span class="badge badge-danger">L 0-2</span></span>
                </div>
            `;
        }
        
        function generateUpcomingFixtures() {
            return `
                <table class="data-table">
                    <thead>
                        <tr><th>Date</th><th>Opponent</th><th>Comp</th></tr>
                    </thead>
                    <tbody>
                        <tr><td>Sun</td><td>Liverpool (H)</td><td>PL</td></tr>
                        <tr><td>Wed</td><td>Fulham (A)</td><td>PL</td></tr>
                        <tr><td>Sat</td><td>Brighton (H)</td><td>PL</td></tr>
                        <tr><td>Tue</td><td>Bayern (A)</td><td>UCL</td></tr>
                        <tr><td>Sat</td><td>Bournemouth (A)</td><td>PL</td></tr>
                    </tbody>
                </table>
            `;
        }
        
        function generateCompetitionProgress() {
            return `
                <div class="stat-row">
                    <span class="stat-label">Premier League</span>
                    <span class="stat-value">6th</span>
                </div>
                <div class="stat-row">
                    <span class="stat-label">Champions League</span>
                    <span class="stat-value">Group Stage</span>
                </div>
                <div class="stat-row">
                    <span class="stat-label">FA Cup</span>
                    <span class="stat-value">4th Round</span>
                </div>
            `;
        }
        
        function generateHeadToHead() {
            return `
                <div class="stat-row">
                    <span class="stat-label">vs Liverpool</span>
                    <span class="stat-value">W2 D1 L2</span>
                </div>
                <div class="stat-row">
                    <span class="stat-label">Goals For</span>
                    <span class="stat-value">8</span>
                </div>
                <div class="stat-row">
                    <span class="stat-label">Goals Against</span>
                    <span class="stat-value">7</span>
                </div>
            `;
        }
        
        function generateSeasonStats() {
            return `
                <div class="stat-row">
                    <span class="stat-label">Played</span>
                    <span class="stat-value">20</span>
                </div>
                <div class="stat-row">
                    <span class="stat-label">Won</span>
                    <span class="stat-value">12</span>
                </div>
                <div class="stat-row">
                    <span class="stat-label">Drawn</span>
                    <span class="stat-value">3</span>
                </div>
                <div class="stat-row">
                    <span class="stat-label">Lost</span>
                    <span class="stat-value">5</span>
                </div>
            `;
        }
        
        function generateFixtureCongestion() {
            return `
                <div class="stat-row">
                    <span class="stat-label">Next 7 days</span>
                    <span class="stat-value">3 matches</span>
                </div>
                <div class="stat-row">
                    <span class="stat-label">Next 14 days</span>
                    <span class="stat-value">5 matches</span>
                </div>
                <div class="stat-row">
                    <span class="stat-label">Rotation</span>
                    <span class="stat-value"><span class="badge badge-warning">Recommended</span></span>
                </div>
            `;
        }
        
        // Card actions (v16 menu items)
        function pinCard(menuItem) {
            const card = menuItem.closest('.card');
            const wasPinned = card.classList.contains('pinned');
            card.classList.toggle('pinned');
            console.log(`Card ${wasPinned ? 'unpinned' : 'pinned'}`);
            
            // Update menu text
            menuItem.textContent = wasPinned ? 'Pin' : 'Unpin';
            
            // Re-initialize drag handler for this card when unpinning
            if (wasPinned) {
                const header = card.querySelector('.card-header');
                if (header && !header.hasAttribute('data-drag-initialized')) {
                    header.addEventListener('mousedown', initHeaderDrag);
                    header.setAttribute('data-drag-initialized', 'true');
                }
            }
            
            // Close dropdown
            const dropdown = menuItem.closest('.card-menu-dropdown');
            dropdown.classList.remove('active');
        }

        function removeCard(menuItem) {
            const card = menuItem.closest('.card');
            const cardTitle = card.querySelector('.card-header span')?.textContent || 'Unknown';
            console.log(`Removing card: ${cardTitle}`);
            card.remove();
        }

        function replaceCard(menuItem) {
            const card = menuItem.closest('.card');
            const cardTitle = card.querySelector('.card-header span')?.textContent || 'Unknown';
            console.log(`Replace card requested for: ${cardTitle}`);
            // Add replace functionality
        }

        function bookmarkCard(menuItem) {
            console.log('Bookmark card functionality');
            // Add bookmark functionality
        }

        // Continue simulation
        function continueSim() {
            console.log('Continuing simulation...');
            // Add simulation logic here
        }

        // Advance time
        function advanceTime() {
            console.log('Advancing time...');
            // Add time advancement logic
        }

        // Settings
        // Hamburger menu functions
        function toggleMenu() {
            const menu = document.getElementById('hamburgerMenu');
            menu.classList.toggle('active');
            
            // Close menu when clicking outside
            if (menu.classList.contains('active')) {
                document.addEventListener('click', closeMenuOnClickOutside);
            }
        }
        
        function closeMenuOnClickOutside(e) {
            const menu = document.getElementById('hamburgerMenu');
            const fab = document.querySelector('.settings-fab');
            
            if (!menu.contains(e.target) && !fab.contains(e.target)) {
                menu.classList.remove('active');
                document.removeEventListener('click', closeMenuOnClickOutside);
            }
        }
        
        function loadLayout() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.json';
            input.onchange = e => {
                const file = e.target.files[0];
                const reader = new FileReader();
                reader.onload = event => {
                    try {
                        const layout = JSON.parse(event.target.result);
                        // Apply loaded layout
                        const cards = document.querySelectorAll('.card');
                        layout.cards.forEach((cardData, index) => {
                            if (cards[index]) {
                                const card = cards[index];
                                // Apply width
                                if (cardData.width && cardData.width > 1) {
                                    card.className = card.className.replace(/wide-\d/, '');
                                    card.classList.add(`wide-${cardData.width}`);
                                }
                                // Apply height
                                if (cardData.height && cardData.height !== 'auto') {
                                    card.style.height = cardData.height;
                                }
                                // Apply pinned state
                                if (cardData.pinned) {
                                    card.classList.add('pinned');
                                    card.draggable = false;
                                }
                            }
                        });
                        alert('Layout loaded successfully!');
                    } catch (error) {
                        alert('Error loading layout: ' + error.message);
                    }
                };
                reader.readAsText(file);
            };
            input.click();
            document.getElementById('hamburgerMenu').classList.remove('active');
        }
        
        function saveLayout() {
            const layout = {
                cards: [],
                timestamp: new Date().toISOString()
            };
            
            // Collect current card positions and sizes
            document.querySelectorAll('.card').forEach(card => {
                layout.cards.push({
                    title: card.querySelector('.card-header span').textContent,
                    width: card.className.match(/wide-(\d)/)?.[1] || 1,
                    height: card.style.height || 'auto',
                    pinned: card.classList.contains('pinned')
                });
            });
            
            const dataStr = JSON.stringify(layout, null, 2);
            const dataUri = 'data:application/json;charset=utf-8,'+ encodeURIComponent(dataStr);
            
            const link = document.createElement('a');
            link.setAttribute('href', dataUri);
            link.setAttribute('download', 'fm-layout.json');
            link.click();
            
            document.getElementById('hamburgerMenu').classList.remove('active');
        }
        
        function saveAsLayout() {
            const filename = prompt('Enter layout name:', 'my-layout');
            if (filename) {
                const layout = {
                    cards: [],
                    timestamp: new Date().toISOString()
                };
                
                document.querySelectorAll('.card').forEach(card => {
                    layout.cards.push({
                        title: card.querySelector('.card-header span').textContent,
                        width: card.className.match(/wide-(\d)/)?.[1] || 1,
                        height: card.style.height || 'auto'
                    });
                });
                
                const dataStr = JSON.stringify(layout, null, 2);
                const dataUri = 'data:application/json;charset=utf-8,'+ encodeURIComponent(dataStr);
                
                const link = document.createElement('a');
                link.setAttribute('href', dataUri);
                link.setAttribute('download', filename + '.json');
                link.click();
            }
            document.getElementById('hamburgerMenu').classList.remove('active');
        }
        
        function goToMainMenu() {
            // Navigate to main menu or home page
            if (confirm('Return to Main Menu? Any unsaved changes will be lost.')) {
                window.location.href = 'index.html'; // or wherever the main menu is
            }
            document.getElementById('hamburgerMenu').classList.remove('active');
        }
        
        function exitApp() {
            if (confirm('Are you sure you want to exit?')) {
                window.close();
            }
            document.getElementById('hamburgerMenu').classList.remove('active');
        }
        
        function openSettings() {
            document.getElementById('hamburgerMenu').classList.remove('active');
            document.querySelector('.overlay').classList.add('active');
            document.querySelector('.settings-dialog').classList.add('active');
        }

        function closeSettings() {
            document.querySelector('.overlay').classList.remove('active');
            document.querySelector('.settings-dialog').classList.remove('active');
        }

        // ========================================
        // AETHELRED DESIGN SYSTEM IMPLEMENTATION
        // Based on newPlan.md specifications
        // ========================================
        
        // StatRow Component (Widget 1.1) - Fundamental atom for key-value pairs
        // Data Contract: {label: string, value: string|number, valueType: 'positive'|'negative'|'warning'|'neutral'}
        function createStatRow(data) {
            // Validate data contract per newPlan.md specifications
            if (!data || typeof data.label !== 'string') {
                throw new Error('StatRow requires valid label string');
            }
            if (data.value === undefined || data.value === null) {
                throw new Error('StatRow requires valid value');
            }
            
            const valueType = data.valueType || 'neutral';
            const validValueTypes = ['positive', 'negative', 'warning', 'neutral'];
            if (!validValueTypes.includes(valueType)) {
                throw new Error(`StatRow valueType must be one of: ${validValueTypes.join(', ')}`);
            }
            
            // Create StatRow element following newPlan.md structure
            const statRow = document.createElement('div');
            statRow.className = 'stat-row';
            
            const label = document.createElement('span');
            label.className = 'stat-label';
            label.textContent = data.label;
            
            const value = document.createElement('span');
            value.className = `stat-value${valueType !== 'neutral' ? ' ' + valueType : ''}`;
            // Use innerHTML to support SVG graphics and HTML content
            if (typeof data.value === 'string' && data.value.includes('<')) {
                value.innerHTML = data.value;
            } else {
                value.textContent = data.value;
            }
            
            statRow.appendChild(label);
            statRow.appendChild(value);
            
            return statRow;
        }

        // TrainingOptimizerCard Component - Complete calendar-based training interface
        // Data Contract: {header: {title: string}, body: {contentType: 'TrainingCalendar', contentData: {weekSummary, trainingDays, atRiskPlayers, trendAnalysis}}}
        function createTrainingOptimizerCard(data) {
            // Validate data contract
            if (!data || !data.header || typeof data.header.title !== 'string') {
                throw new Error('TrainingOptimizerCard requires valid header.title string');
            }
            if (!data.body || data.body.contentType !== 'TrainingCalendar' || !data.body.contentData) {
                throw new Error('TrainingOptimizerCard requires body.contentType = "TrainingCalendar" and contentData object');
            }

            const contentData = data.body.contentData;
            
            // Create main card container
            const card = document.createElement('div');
            card.className = 'card aethelred-training-overview-card';
            
            // Create header
            const header = document.createElement('div');
            header.className = 'card-header';
            header.innerHTML = `
                <span>${data.header.title}</span>
                <div class="card-menu">
                    <button class="card-menu-btn" aria-label="Card options menu">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <circle cx="12" cy="12" r="1"></circle>
                            <circle cx="12" cy="5" r="1"></circle>
                            <circle cx="12" cy="19" r="1"></circle>
                        </svg>
                    </button>
                </div>
            `;
            
            // Create main container
            const container = document.createElement('div');
            container.className = 'aethelred-training-calendar-container card-body';
            
            // Create week summary section
            const weekSummary = createWeekSummarySection(contentData.weekSummary);
            
            // Create training calendar
            const trainingCalendar = createTrainingCalendarSection(contentData.trainingDays);
            
            // Create analytics section
            const analyticsSection = createAnalyticsSection(contentData.atRiskPlayers, contentData.trendAnalysis);
            
            // Assemble the card
            container.appendChild(weekSummary);
            container.appendChild(trainingCalendar);
            container.appendChild(analyticsSection);
            
            card.appendChild(header);
            card.appendChild(container);
            
            // Initialize interactions and animations
            setTimeout(() => {
                initializeTrainingOverviewCard(card);
            }, 100);
            
            return card;
        }

        // Helper function to create week summary section
        function createWeekSummarySection(weekSummary) {
            const section = document.createElement('div');
            section.className = 'aethelred-training-week-summary';
            section.setAttribute('data-summary', 'week-overview');
            
            section.innerHTML = `
                <div class="aethelred-week-overview">
                    <div class="aethelred-week-overview-label">Weekly Plan</div>
                    <div class="aethelred-week-overview-value">${weekSummary.weeklyPlan}</div>
                </div>
                <div class="aethelred-week-risk-indicator" data-risk-level="${weekSummary.riskLevel}">
                    <span class="aethelred-risk-icon">⚠</span>
                    <span class="aethelred-risk-text">${weekSummary.riskText}</span>
                </div>
                <div class="aethelred-week-load-total" data-total-load="${weekSummary.totalLoad}">
                    <span class="aethelred-load-total-value">${weekSummary.totalLoad}</span>
                    <span class="aethelred-load-total-label">Total Load</span>
                </div>
                <div class="aethelred-week-load-total" data-performance="${weekSummary.squadPerformance}">
                    <span class="aethelred-load-total-value">${weekSummary.squadPerformance}%</span>
                    <span class="aethelred-load-total-label">Squad Performance</span>
                </div>
            `;
            
            return section;
        }

        // Helper function to create training calendar section
        function createTrainingCalendarSection(trainingDays) {
            const calendar = document.createElement('div');
            calendar.className = 'aethelred-training-calendar-week';
            calendar.setAttribute('data-week', 'current');
            
            trainingDays.forEach(day => {
                const daySlot = createTrainingDaySlot(day);
                calendar.appendChild(daySlot);
            });
            
            return calendar;
        }

        // Helper function to create individual training day slot
        function createTrainingDaySlot(day) {
            const slot = document.createElement('div');
            slot.className = `aethelred-training-day-slot intensity-${day.intensity}`;
            slot.setAttribute('data-day', day.day);
            slot.setAttribute('data-load', day.load);
            
            // Add current day and risk classes
            if (day.current) slot.classList.add('current-day');
            if (day.risk) slot.classList.add('risk-high');
            if (day.intensity === 'match') slot.classList.add('day-type-match');
            if (day.intensity === 'off') slot.classList.add('day-off');
            
            // Create day header
            const header = document.createElement('div');
            header.className = 'aethelred-training-day-header';
            
            const flagsHtml = day.flags.map(flag => {
                const flagClass = flag === 'risk' ? 'flag-risk' : flag === 'match' ? 'flag-match' : '';
                const flagIcon = flag === 'risk' ? '⚠' : flag === 'match' ? '⚽' : flag;
                return `<span class="aethelred-training-day-flag ${flagClass}">${flagIcon}</span>`;
            }).join('');
            
            header.innerHTML = `
                <span class="aethelred-training-day-name">${day.name}</span>
                <div class="aethelred-training-day-flags">${flagsHtml}</div>
            `;
            
            // Create day status
            const status = document.createElement('div');
            status.className = 'aethelred-training-day-status';
            status.innerHTML = `<div class="aethelred-training-intensity-label">${day.intensity.charAt(0).toUpperCase() + day.intensity.slice(1)}</div>`;
            
            // Create day notes
            const notes = document.createElement('div');
            notes.className = 'aethelred-training-day-notes';
            notes.textContent = day.notes;
            
            // Create load meter
            const loadMeter = createLoadMeter(day.load);
            
            // Assemble day slot
            slot.appendChild(header);
            slot.appendChild(status);
            slot.appendChild(notes);
            slot.appendChild(loadMeter);
            
            return slot;
        }

        // Helper function to create load meter
        function createLoadMeter(load) {
            const meter = document.createElement('div');
            meter.className = 'aethelred-training-load-meter';
            
            const maxLoad = 340; // Maximum load for percentage calculation
            const percentage = Math.min((load / maxLoad) * 100, 100);
            
            let loadClass = 'load-low';
            if (load > 250) loadClass = 'load-high';
            else if (load > 100) loadClass = 'load-medium';
            
            meter.innerHTML = `
                <div class="aethelred-training-load-bar ${loadClass}" style="width: ${percentage}%"></div>
                <div class="aethelred-training-load-value">${load}</div>
            `;
            
            return meter;
        }

        // Helper function to create analytics section
        function createAnalyticsSection(atRiskPlayers, trendAnalysis) {
            const section = document.createElement('div');
            section.className = 'aethelred-training-analytics-section';
            
            // Create at-risk players section
            const atRiskSection = document.createElement('div');
            atRiskSection.className = 'aethelred-at-risk-players-section';
            atRiskSection.setAttribute('data-section', 'at-risk');
            
            const atRiskList = atRiskPlayers.map(player => `
                <div class="aethelred-at-risk-player" data-player="${player.player}">
                    <span class="aethelred-at-risk-player-name">${player.name}</span>
                    <span class="aethelred-at-risk-reason">${player.reason}</span>
                </div>
            `).join('');
            
            atRiskSection.innerHTML = `
                <div class="aethelred-at-risk-title">At-Risk Players</div>
                <div class="aethelred-at-risk-list">${atRiskList}</div>
            `;
            
            // Create trend analysis section
            const trendSection = document.createElement('div');
            trendSection.className = 'aethelred-trend-analysis-section';
            trendSection.setAttribute('data-section', 'trends');
            
            const trendBars = trendAnalysis.weeks.map(week => {
                const classes = ['aethelred-trend-bar'];
                if (week.current) classes.push('current-week');
                if (week.future) classes.push('next-week');
                
                return `
                    <div class="aethelred-trend-week">
                        <div class="${classes.join(' ')}" style="height: ${week.height}%;" title="${week.label}: ${week.load}"></div>
                        <span class="aethelred-trend-label">${week.label}</span>
                    </div>
                `;
            }).join('');
            
            trendSection.innerHTML = `
                <div class="aethelred-trend-analysis-title">4-Week Trend</div>
                <div class="aethelred-trend-chart">${trendBars}</div>
                <div class="aethelred-trend-stats">
                    <div>Trend: ${trendAnalysis.stats.trend}</div>
                    <div>Next: ${trendAnalysis.stats.next}</div>
                    <div>Peak: ${trendAnalysis.stats.peak}</div>
                    <div>Avg: ${trendAnalysis.stats.average}</div>
                </div>
            `;
            
            // Assemble analytics section
            section.appendChild(atRiskSection);
            section.appendChild(trendSection);
            
            return section;
        }

        // Initialize Training Overview Card interactions and animations
        function initializeTrainingOverviewCard(card) {
            // Animate load bars on load
            const loadBars = card.querySelectorAll('.aethelred-training-load-bar');
            loadBars.forEach((bar, index) => {
                const targetWidth = bar.style.width;
                bar.style.width = '0%';
                
                setTimeout(() => {
                    bar.style.width = targetWidth;
                }, 300 + (index * 100));
            });

            // Add interactive functionality for day slots
            const daySlots = card.querySelectorAll('.aethelred-training-day-slot');
            daySlots.forEach(slot => {
                slot.addEventListener('click', function() {
                    const day = this.dataset.day;
                    const load = this.dataset.load;
                    const intensity = this.querySelector('.aethelred-training-intensity-label').textContent;
                    
                    console.log(`Training Day Clicked:`, {
                        day: day,
                        load: load,
                        intensity: intensity,
                        element: this
                    });
                    
                    // Add visual feedback
                    this.style.transform = 'scale(0.98)';
                    setTimeout(() => {
                        this.style.transform = '';
                    }, 150);
                });

                // Add hover effects
                slot.addEventListener('mouseenter', function() {
                    this.style.transition = 'transform 0.2s ease';
                    this.style.transform = 'translateY(-2px)';
                });

                slot.addEventListener('mouseleave', function() {
                    this.style.transform = '';
                });
            });

            // At-risk players interactions
            const atRiskPlayers = card.querySelectorAll('.aethelred-at-risk-player');
            atRiskPlayers.forEach(player => {
                player.addEventListener('click', function() {
                    const playerName = this.dataset.player;
                    console.log(`At-risk player clicked: ${playerName}`, this);
                    
                    // Add visual feedback
                    this.style.transform = 'scale(1.02)';
                    setTimeout(() => {
                        this.style.transform = '';
                    }, 150);
                });

                // Add hover effects
                player.addEventListener('mouseenter', function() {
                    this.style.transition = 'transform 0.2s ease';
                    this.style.cursor = 'pointer';
                });

                player.addEventListener('mouseleave', function() {
                    this.style.transform = '';
                });
            });

            // Summary section interactions
            const summaryElements = card.querySelectorAll('[data-summary], [data-section]');
            summaryElements.forEach(element => {
                element.addEventListener('click', function() {
                    const section = this.dataset.summary || this.dataset.section;
                    console.log(`Section Clicked: ${section}`, this);
                    
                    // Add visual feedback
                    this.style.transition = 'transform 0.2s ease';
                    this.style.transform = 'scale(1.01)';
                    setTimeout(() => {
                        this.style.transform = '';
                    }, 150);
                });
            });

            // Add click handlers for trend bars
            const trendBars = card.querySelectorAll('.aethelred-trend-bar');
            trendBars.forEach(bar => {
                bar.addEventListener('click', function() {
                    const week = this.parentElement.querySelector('.aethelred-trend-label').textContent;
                    const title = this.getAttribute('title');
                    console.log(`Trend bar clicked: ${week}`, title);
                    
                    // Visual feedback
                    this.style.transition = 'transform 0.2s ease';
                    this.style.transform = 'scaleY(1.1)';
                    setTimeout(() => {
                        this.style.transform = '';
                    }, 150);
                });

                bar.addEventListener('mouseenter', function() {
                    this.style.cursor = 'pointer';
                    this.style.opacity = '0.8';
                });

                bar.addEventListener('mouseleave', function() {
                    this.style.opacity = '';
                });
            });
        }
        
        // SummaryStatCard Component (Card 1.2) - Collection of primary KPIs  
        // Data Contract: {header: {title: string}, body: {contentType: 'StatRowList', contentData: [StatRow objects]}}
        function createSummaryStatCard(data) {
            // Validate data contract per newPlan.md specifications
            if (!data || !data.header || typeof data.header.title !== 'string') {
                throw new Error('SummaryStatCard requires valid header.title string');
            }
            if (!data.body || data.body.contentType !== 'StatRowList' || !Array.isArray(data.body.contentData)) {
                throw new Error('SummaryStatCard requires body.contentType = "StatRowList" and contentData array');
            }
            
            // Create card structure following newPlan.md specifications
            const card = document.createElement('div');
            card.className = 'card';
            
            // Create aethelred-card-header as specified in newPlan.md
            const header = document.createElement('div');
            header.className = 'aethelred-card-header card-header';
            header.innerHTML = `<span>${data.header.title}</span>`;
            
            // Create aethelred-card-body as specified in newPlan.md
            const body = document.createElement('div');
            body.className = 'aethelred-card-body card-body';
            
            // Render StatRowList contentType per newPlan.md
            data.body.contentData.forEach(statRowData => {
                const statRow = createStatRow(statRowData);
                body.appendChild(statRow);
            });
            
            card.appendChild(header);
            card.appendChild(body);
            
            return card;
        }
        
        // MiniTable Component (Widget 2.1) - Structured tabular data
        // Data Contract: {headers: [string, string, ...], rows: [[string|number, ...], ...]}
        function createMiniTable(data) {
            // Validate data contract per newPlan.md specifications
            if (!data || !Array.isArray(data.headers)) {
                throw new Error('MiniTable requires valid headers array');
            }
            if (!Array.isArray(data.rows)) {
                throw new Error('MiniTable requires valid rows array');
            }
            
            // Create MiniTable structure following newPlan.md specifications
            const table = document.createElement('table');
            table.className = 'mini-table';
            
            // Create header row with uppercase, semi-transparent labels
            const thead = document.createElement('thead');
            const headerRow = document.createElement('tr');
            data.headers.forEach(headerText => {
                const th = document.createElement('th');
                th.textContent = headerText;
                headerRow.appendChild(th);
            });
            thead.appendChild(headerRow);
            table.appendChild(thead);
            
            // Create body rows with hover effect support
            const tbody = document.createElement('tbody');
            data.rows.forEach(rowData => {
                const row = document.createElement('tr');
                rowData.forEach(cellData => {
                    const td = document.createElement('td');
                    td.textContent = cellData;
                    row.appendChild(td);
                });
                tbody.appendChild(row);
            });
            table.appendChild(tbody);
            
            return table;
        }
        
        // RosterCard Component (Card 2.2) - Most critical component for player/staff lists
        // Data Contract: {header: {title: string}, body: {contentType: 'DataTable', contentData: {headers: [...], rows: [...]}}}
        function createRosterCard(data) {
            // Validate data contract per newPlan.md specifications
            if (!data || !data.header || typeof data.header.title !== 'string') {
                throw new Error('RosterCard requires valid header.title string');
            }
            if (!data.body || !['DataTable', 'EnhancedDataTable'].includes(data.body.contentType)) {
                throw new Error('RosterCard requires body.contentType = "DataTable" or "EnhancedDataTable"');
            }
            if (!data.body.contentData || !Array.isArray(data.body.contentData.headers) || !Array.isArray(data.body.contentData.rows)) {
                throw new Error('RosterCard requires contentData with headers and rows arrays');
            }
            
            // Create card structure following newPlan.md specifications
            const card = document.createElement('div');
            card.className = 'card';
            
            // Create aethelred-card-header
            const header = document.createElement('div');
            header.className = 'aethelred-card-header card-header';
            header.innerHTML = `<span>${data.header.title}</span>`;
            
            // Create aethelred-card-body with full .data-table styling
            const body = document.createElement('div');
            body.className = 'aethelred-card-body card-body';
            
            // Create DataTable following newPlan.md specifications
            const table = document.createElement('table');
            table.className = 'data-table';
            
            // Create header with proper styling
            const thead = document.createElement('thead');
            const headerRow = document.createElement('tr');
            data.body.contentData.headers.forEach(headerText => {
                const th = document.createElement('th');
                th.textContent = headerText;
                headerRow.appendChild(th);
            });
            thead.appendChild(headerRow);
            table.appendChild(thead);
            
            // Create body rows with enhanced features for league table
            const tbody = document.createElement('tbody');
            data.body.contentData.rows.forEach((rowData, rowIndex) => {
                const row = document.createElement('tr');
                
                // Enhanced features for EnhancedDataTable (league table)
                if (data.body.contentType === 'EnhancedDataTable') {
                    const contentData = data.body.contentData;
                    const position = parseInt(rowData[0]);
                    
                    // Check if this is the user's team
                    if (contentData.userTeamID) {
                        const dynamicTable = generateDynamicLeagueTable();
                        const isUserTeam = dynamicTable[rowIndex]?.isUserTeam;
                        if (isUserTeam) {
                            row.classList.add('current-position');
                        }
                    }
                    
                    // Add competition zone demarcations with clean CSS classes
                    if (contentData.zones) {
                        Object.entries(contentData.zones).forEach(([zoneName, zone]) => {
                            if (position >= zone.start && position <= zone.end) {
                                // Use CSS class names that match Example.html pattern
                                const zoneClassName = `zone-${zoneName.replace(/([A-Z])/g, '-$1').toLowerCase()}`;
                                row.classList.add(zoneClassName);
                                row.setAttribute('title', zone.label);
                            }
                        });
                    }
                }
                
                rowData.forEach(cellData => {
                    const td = document.createElement('td');
                    // Use innerHTML for enhanced content, textContent for plain text
                    if (typeof cellData === 'string' && cellData.includes('<')) {
                        td.innerHTML = cellData;
                    } else {
                        td.textContent = cellData;
                    }
                    row.appendChild(td);
                });
                tbody.appendChild(row);
            });
            table.appendChild(tbody);
            
            body.appendChild(table);
            card.appendChild(header);
            card.appendChild(body);
            
            return card;
        }
        
        // StatBar Component (Widget 3.1) - Visual percentage representation  
        // Data Contract: {value: number, maxValue: number, status: 'high'|'medium'|'low'}
        function createStatBar(data) {
            // Validate data contract per newPlan.md specifications
            if (!data || typeof data.value !== 'number' || typeof data.maxValue !== 'number') {
                throw new Error('StatBar requires valid value and maxValue numbers');
            }
            if (data.maxValue <= 0) {
                throw new Error('StatBar maxValue must be greater than 0');
            }
            
            const status = data.status || 'medium';
            const validStatuses = ['high', 'medium', 'low'];
            if (!validStatuses.includes(status)) {
                throw new Error(`StatBar status must be one of: ${validStatuses.join(', ')}`);
            }
            
            // Create StatBar structure following newPlan.md specifications
            const container = document.createElement('div');
            container.className = 'stat-bar';
            
            const fill = document.createElement('div');
            fill.className = `stat-bar-fill ${status}`;
            
            // Calculate percentage width
            const percentage = Math.max(0, Math.min(100, (data.value / data.maxValue) * 100));
            fill.style.width = `${percentage}%`;
            
            container.appendChild(fill);
            return container;
        }
        
        // StatBarRow Component - Combines StatBar with label and value text
        // Used within TeamCohesionCard MixedStatList per newPlan.md
        function createStatBarRow(data) {
            // Validate that we have the required fields
            if (!data || typeof data.label !== 'string') {
                throw new Error('StatBarRow requires valid label string');
            }
            if (!data.bar || typeof data.bar.value !== 'number') {
                throw new Error('StatBarRow requires valid bar.value number');
            }
            
            // Create the container row
            const row = document.createElement('div');
            row.className = 'stat-row';
            
            // Create label
            const label = document.createElement('span');
            label.className = 'stat-label';
            label.textContent = data.label;
            
            // Create the bar section (middle)
            const barContainer = document.createElement('div');
            barContainer.style.flex = '1';
            barContainer.style.margin = '0 10px';
            
            const statBar = createStatBar(data.bar);
            barContainer.appendChild(statBar);
            
            // Create value text (right)
            const valueText = document.createElement('span');
            valueText.className = 'stat-value';
            valueText.textContent = data.valueText || `${Math.round((data.bar.value / data.bar.maxValue) * 100)}%`;
            
            row.appendChild(label);
            row.appendChild(barContainer);
            row.appendChild(valueText);
            
            return row;
        }
        
        // TeamCohesionCard Component (Card 3.2) - Visual team dynamics summary
        // Data Contract: {header: {title: string}, body: {contentType: 'MixedStatList', contentData: [{type, data}, ...]}}
        function createTeamCohesionCard(data) {
            // Validate data contract per newPlan.md specifications
            if (!data || !data.header || typeof data.header.title !== 'string') {
                throw new Error('TeamCohesionCard requires valid header.title string');
            }
            if (!data.body || data.body.contentType !== 'MixedStatList' || !Array.isArray(data.body.contentData)) {
                throw new Error('TeamCohesionCard requires body.contentType = "MixedStatList" and contentData array');
            }
            
            // Create card structure following newPlan.md specifications
            const card = document.createElement('div');
            card.className = 'card';
            
            // Create aethelred-card-header
            const header = document.createElement('div');
            header.className = 'aethelred-card-header card-header';
            header.innerHTML = `<span>${data.header.title}</span>`;
            
            // Create aethelred-card-body containing mix of StatRow and StatBar components
            const body = document.createElement('div');
            body.className = 'aethelred-card-body card-body';
            
            // Render MixedStatList contentType per newPlan.md
            data.body.contentData.forEach(item => {
                if (item.type === 'StatBarRow') {
                    const statBarRow = createStatBarRow(item.data);
                    body.appendChild(statBarRow);
                } else if (item.type === 'StatRow') {
                    const statRow = createStatRow(item.data);
                    body.appendChild(statRow);
                } else {
                    throw new Error(`Unknown MixedStatList item type: ${item.type}. Must be 'StatBarRow' or 'StatRow'`);
                }
            });
            
            card.appendChild(header);
            card.appendChild(body);
            
            return card;
        }
        
        // SquadHealthMatrixCard Component - Enhanced health monitoring dashboard
        // Data Contract: {header: {title: string}, body: {contentType: 'SquadHealthMatrix', contentData: {metrics, injuries, timeline, morale, riskAreas, availability}}}
        function createSquadHealthMatrixCard(data) {
            // Validate data contract
            if (!data || !data.header || typeof data.header.title !== 'string') {
                throw new Error('SquadHealthMatrixCard requires valid header.title string');
            }
            if (!data.body || data.body.contentType !== 'SquadHealthMatrix') {
                throw new Error('SquadHealthMatrixCard requires body.contentType = "SquadHealthMatrix"');
            }

            const healthData = data.body.contentData;
            if (!healthData || !healthData.metrics) {
                throw new Error('SquadHealthMatrixCard requires contentData with metrics');
            }

            // Create main card container
            const card = document.createElement('div');
            card.className = 'card squad-health-matrix-card';
            card.setAttribute('role', 'region');
            card.setAttribute('aria-label', 'Squad Health Monitoring Dashboard');
            
            // Create header with accessibility
            const header = document.createElement('div');
            header.className = 'aethelred-card-header card-header';
            header.setAttribute('role', 'heading');
            header.setAttribute('aria-level', '2');
            header.innerHTML = `<span>${data.header.title}</span>`;
            
            // Create body with enhanced layout
            const body = document.createElement('div');
            body.className = 'aethelred-card-body card-body squad-health-matrix-container';
            
            // Create metrics row (4-column grid)
            const metricsRow = document.createElement('section');
            metricsRow.className = 'health-metrics-row';
            metricsRow.setAttribute('data-section', 'metrics');
            metricsRow.setAttribute('role', 'group');
            metricsRow.setAttribute('aria-label', 'Key Health Metrics');
            
            // Fitness metric
            const fitnessCard = createHealthMetricCard('fitness', 'Squad Fitness', 
                `${healthData.metrics.fitness}%`, healthData.metrics.fitness, 100, 'percentage');
            
            // Injuries metric  
            const injuriesCard = createHealthMetricCard('injuries', 'Active Injuries',
                `${healthData.metrics.injuries} ${healthData.metrics.injuries === 1 ? 'Player' : 'Players'}`,
                healthData.metrics.injuries, 22, 'inverse');
                
            // Morale metric
            const moraleValue = calculateMoraleValue(healthData.morale);
            const moraleCard = createHealthMetricCard('morale', 'Squad Morale',
                moraleValue.text, moraleValue.percentage, 100, 'percentage');
                
            // Risk areas metric
            const riskCard = createHealthMetricCard('risk', 'Risk Areas',
                `${healthData.riskAreas.length} ${healthData.riskAreas.length === 1 ? 'Position' : 'Positions'}`,
                healthData.riskAreas.length, 11, 'inverse');
                
            metricsRow.appendChild(fitnessCard);
            metricsRow.appendChild(injuriesCard);
            metricsRow.appendChild(moraleCard);
            metricsRow.appendChild(riskCard);
            
            // Create detail blocks grid (3-column layout)
            const detailsGrid = document.createElement('section');
            detailsGrid.className = 'health-details-grid';
            
            // Injuries & Timeline block
            const injuriesBlock = createInjuriesTimelineBlock(healthData.injuries, healthData.timeline);
            
            // Morale distribution block  
            const moraleBlock = createMoraleDistributionBlock(healthData.morale);
            
            // Risk areas block
            const riskBlock = createRiskAreasBlock(healthData.riskAreas, healthData.availability);
            
            detailsGrid.appendChild(injuriesBlock);
            detailsGrid.appendChild(moraleBlock);
            detailsGrid.appendChild(riskBlock);
            
            // Assemble card
            body.appendChild(metricsRow);
            body.appendChild(detailsGrid);
            card.appendChild(header);
            card.appendChild(body);
            
            // Add interactive event handlers
            addSquadHealthMatrixInteractivity(card);
            
            return card;
        }
        
        // Helper function to create health metric cards
        function createHealthMetricCard(type, label, valueText, value, maxValue, valueType) {
            const card = document.createElement('div');
            card.className = `health-metric-card metric-${type}`;
            card.setAttribute('data-metric', type);
            card.setAttribute('role', 'button');
            card.setAttribute('tabindex', '0');
            card.setAttribute('aria-label', `${label}: ${valueText}. Click for details.`);
            
            // Calculate percentage for progress bar
            let percentage;
            if (valueType === 'percentage') {
                percentage = value;
            } else if (valueType === 'inverse') {
                percentage = Math.min(100, (value / maxValue) * 100);
            }
            
            // Determine status based on metric type and value
            let status = 'neutral';
            if (type === 'fitness') {
                status = value >= 80 ? 'good' : value >= 60 ? 'warning' : 'critical';
            } else if (type === 'injuries') {
                status = value === 0 ? 'good' : value <= 3 ? 'warning' : 'critical';
            } else if (type === 'morale') {
                status = value >= 70 ? 'good' : value >= 50 ? 'warning' : 'critical';
            } else if (type === 'risk') {
                status = value === 0 ? 'good' : value <= 2 ? 'warning' : 'critical';
            }
            
            card.innerHTML = `
                <div class="health-metric-label">${label}</div>
                <div class="health-metric-value status-${status}">${valueText}</div>
                <div class="health-metric-indicator">
                    <div class="health-metric-fill" style="width: ${percentage}%"></div>
                </div>
            `;
            
            return card;
        }
        
        // Helper function to calculate morale value and status
        function calculateMoraleValue(moraleData) {
            if (!moraleData) return { text: 'Unknown', percentage: 0 };
            
            const { excellent = 0, good = 0, neutral = 0, poor = 0, terrible = 0 } = moraleData;
            const total = excellent + good + neutral + poor + terrible;
            
            if (total === 0) return { text: 'No Data', percentage: 0 };
            
            const positiveRatio = ((excellent + good) / total) * 100;
            
            let text;
            if (positiveRatio >= 70) text = 'Excellent';
            else if (positiveRatio >= 50) text = 'Good';
            else if (positiveRatio >= 30) text = 'Mixed';
            else text = 'Concerning';
            
            return { text, percentage: positiveRatio };
        }
        
        // Helper function to create injuries timeline block
        function createInjuriesTimelineBlock(injuries, timeline) {
            const block = document.createElement('div');
            block.className = 'health-detail-block';
            block.setAttribute('data-block', 'injuries-timeline');
            
            block.innerHTML = `
                <div class="health-detail-title">Injuries & Return Timeline</div>
                <div class="injuries-list" id="injuries-list"></div>
                <div class="returns-timeline" id="returns-timeline">
                    <div class="timeline-track"></div>
                    <div class="timeline-ticks"></div>
                </div>
                <div class="health-matrix-legend">
                    <span>14-day horizon • Short-term: &lt;7d • Long-term: &gt;7d</span>
                </div>
            `;
            
            // Populate injuries list
            const injuriesList = block.querySelector('.injuries-list');
            injuries.forEach(injury => {
                const item = document.createElement('div');
                const days = parseTimeTodays(injury.eta);
                item.className = `injury-item ${days <= 7 ? 'short-term' : 'long-term'}`;
                item.setAttribute('data-player', injury.player.toLowerCase().replace(/\s+/g, '-'));
                
                item.innerHTML = `
                    <div class="injury-player-name">${injury.player}</div>
                    <div class="injury-eta">${injury.eta}</div>
                `;
                injuriesList.appendChild(item);
            });
            
            // Create timeline
            const timelineContainer = block.querySelector('.returns-timeline');
            const ticksContainer = timelineContainer.querySelector('.timeline-ticks');
            
            // Create timeline ticks (14 days)
            for (let i = 0; i < 14; i++) {
                const tick = document.createElement('div');
                tick.className = 'timeline-tick';
                ticksContainer.appendChild(tick);
            }
            
            // Add timeline markers for returns
            injuries.forEach(injury => {
                const days = parseTimeTodays(injury.eta);
                if (days <= 14) {
                    const percentage = (days / 14) * 100;
                    const marker = document.createElement('div');
                    marker.className = 'timeline-marker';
                    marker.style.left = `${percentage}%`;
                    marker.setAttribute('data-player', injury.player.toLowerCase().replace(/\s+/g, '-'));
                    
                    marker.innerHTML = `
                        <div class="timeline-marker-label">${injury.player} • ${injury.eta}</div>
                        <div class="timeline-marker-pin"></div>
                    `;
                    
                    timelineContainer.appendChild(marker);
                }
            });
            
            return block;
        }
        
        // Helper function to create morale distribution block
        function createMoraleDistributionBlock(moraleData) {
            const block = document.createElement('div');
            block.className = 'health-detail-block';
            block.setAttribute('data-block', 'morale');
            
            block.innerHTML = `
                <div class="health-detail-title">Squad Morale Distribution</div>
                <div class="morale-distribution">
                    <div class="morale-scale" id="morale-scale"></div>
                    <div class="morale-summary">
                        <div>😊 Excellent: <span id="morale-excellent">${moraleData.excellent || 0}</span></div>
                        <div>😐 Neutral: <span id="morale-neutral">${moraleData.neutral || 0}</span></div>
                        <div>🙂 Good: <span id="morale-good">${moraleData.good || 0}</span></div>
                        <div>😔 Poor: <span id="morale-poor">${moraleData.poor || 0}</span></div>
                    </div>
                </div>
            `;
            
            // Populate morale scale (10 cells)
            const scale = block.querySelector('.morale-scale');
            const { excellent = 0, good = 0, neutral = 0, poor = 0, terrible = 0 } = moraleData;
            const total = excellent + good + neutral + poor + terrible;
            
            if (total > 0) {
                const factor = 10 / total;
                
                // Create cells for each mood category
                const moodCategories = [
                    { count: excellent, className: 'mood-excellent', symbol: '😊' },
                    { count: good, className: 'mood-good', symbol: '🙂' },
                    { count: neutral, className: 'mood-neutral', symbol: '😐' },
                    { count: poor, className: 'mood-poor', symbol: '😕' },
                    { count: terrible, className: 'mood-terrible', symbol: '😔' }
                ];
                
                moodCategories.forEach(category => {
                    const cellCount = Math.round(category.count * factor);
                    for (let i = 0; i < cellCount; i++) {
                        const cell = document.createElement('div');
                        cell.className = `morale-cell ${category.className}`;
                        cell.textContent = category.symbol;
                        scale.appendChild(cell);
                    }
                });
                
                // Pad to 10 cells if needed
                while (scale.children.length < 10) {
                    const cell = document.createElement('div');
                    cell.className = 'morale-cell';
                    scale.appendChild(cell);
                }
            }
            
            return block;
        }
        
        // Helper function to create risk areas block
        function createRiskAreasBlock(riskAreas, availability) {
            const block = document.createElement('div');
            block.className = 'health-detail-block';
            block.setAttribute('data-block', 'risk-areas');
            
            block.innerHTML = `
                <div class="health-detail-title">Positional Risk Assessment</div>
                <div class="risk-areas-list" id="risk-areas-list"></div>
                <div class="health-availability-indicator">
                    <div class="availability-stat stat-available">
                        <div class="availability-value">${availability.available}</div>
                        <div class="availability-label">Available</div>
                    </div>
                    <div class="availability-stat stat-injured">
                        <div class="availability-value">${availability.injured}</div>
                        <div class="availability-label">Injured</div>
                    </div>
                    <div class="availability-stat stat-risk">
                        <div class="availability-value">${availability.atRisk}</div>
                        <div class="availability-label">At Risk</div>
                    </div>
                </div>
            `;
            
            // Populate risk areas list
            const riskAreasList = block.querySelector('.risk-areas-list');
            riskAreas.forEach(riskArea => {
                const item = document.createElement('div');
                item.className = 'risk-area-item';
                item.setAttribute('data-position', riskArea.position.toLowerCase());
                
                item.innerHTML = `
                    <div class="risk-area-position">${riskArea.position}</div>
                    <div class="risk-area-level">${riskArea.level}</div>
                `;
                
                riskAreasList.appendChild(item);
            });
            
            return block;
        }
        
        // Helper function to parse time strings to days
        function parseTimeTodays(timeStr) {
            if (/(\d+)d/i.test(timeStr)) {
                return parseInt(timeStr.match(/(\d+)d/i)[1]);
            } else if (/(\d+)w/i.test(timeStr)) {
                return parseInt(timeStr.match(/(\d+)w/i)[1]) * 7;
            }
            return 0;
        }
        
        // Interactive event handlers for Squad Health Matrix
        function addSquadHealthMatrixInteractivity(card) {
            // Metric cards click handlers
            const metricCards = card.querySelectorAll('.health-metric-card');
            metricCards.forEach(metricCard => {
                metricCard.addEventListener('click', function() {
                    const metric = this.dataset.metric;
                    console.log(`Health metric clicked: ${metric}`, this);
                    
                    // Add visual feedback
                    this.style.transform = 'scale(0.98)';
                    setTimeout(() => {
                        this.style.transform = '';
                    }, 150);
                    
                    // Could trigger detailed view or action based on metric type
                    switch(metric) {
                        case 'fitness':
                            console.log('Show detailed fitness breakdown');
                            break;
                        case 'injuries':
                            console.log('Show injury management panel');
                            break;
                        case 'morale':
                            console.log('Show morale factors analysis');
                            break;
                        case 'risk':
                            console.log('Show risk mitigation strategies');
                            break;
                    }
                });
                
                // Keyboard support for metric cards
                metricCard.addEventListener('keydown', function(e) {
                    if (e.key === 'Enter' || e.key === ' ') {
                        e.preventDefault();
                        this.click();
                    }
                });
                
                // Hover effects for metric cards
                metricCard.addEventListener('mouseenter', function() {
                    this.style.transform = 'translateY(-2px)';
                    this.style.boxShadow = '0 4px 12px rgba(0,0,0,0.3)';
                });
                
                metricCard.addEventListener('mouseleave', function() {
                    this.style.transform = '';
                    this.style.boxShadow = '';
                });
            });
            
            // Detail blocks click handlers
            const detailBlocks = card.querySelectorAll('.health-detail-block');
            detailBlocks.forEach(block => {
                block.addEventListener('click', function() {
                    const blockType = this.dataset.block;
                    console.log(`Health detail block clicked: ${blockType}`, this);
                    
                    // Add visual feedback
                    this.style.transform = 'scale(0.98)';
                    setTimeout(() => {
                        this.style.transform = '';
                    }, 150);
                });
            });
            
            // Individual injury items click handlers  
            const injuryItems = card.querySelectorAll('.injury-item');
            injuryItems.forEach(item => {
                item.addEventListener('click', function(e) {
                    e.stopPropagation();
                    const player = this.dataset.player;
                    console.log(`Injury item clicked: ${player}`, this);
                    
                    // Add visual feedback
                    this.style.transform = 'scale(0.95)';
                    setTimeout(() => {
                        this.style.transform = '';
                    }, 150);
                    
                    // Could show player detail or injury management options
                });
            });
            
            // Risk area items click handlers
            const riskAreaItems = card.querySelectorAll('.risk-area-item');
            riskAreaItems.forEach(item => {
                item.addEventListener('click', function(e) {
                    e.stopPropagation();
                    const position = this.dataset.position;
                    console.log(`Risk area clicked: ${position}`, this);
                    
                    // Add visual feedback
                    this.style.transform = 'scale(0.95)';
                    setTimeout(() => {
                        this.style.transform = '';
                    }, 150);
                    
                    // Could show position analysis or squad options
                });
            });
            
            // Timeline markers click handlers
            const timelineMarkers = card.querySelectorAll('.timeline-marker');
            timelineMarkers.forEach(marker => {
                marker.addEventListener('click', function(e) {
                    e.stopPropagation();
                    const player = this.dataset.player;
                    console.log(`Timeline marker clicked: ${player}`, this);
                    
                    // Add visual feedback
                    const pin = this.querySelector('.timeline-marker-pin');
                    pin.style.background = 'var(--accent-200)';
                    setTimeout(() => {
                        pin.style.background = '';
                    }, 300);
                    
                    // Could show detailed injury timeline or treatment options
                });
            });
            
            // Morale cells hover effects
            const moraleCells = card.querySelectorAll('.morale-cell');
            moraleCells.forEach(cell => {
                cell.addEventListener('mouseenter', function() {
                    if (this.textContent) {
                        this.style.transform = 'scale(1.2)';
                        this.style.zIndex = '10';
                    }
                });
                
                cell.addEventListener('mouseleave', function() {
                    this.style.transform = '';
                    this.style.zIndex = '';
                });
            });
            
            // Availability stats click handlers
            const availabilityStats = card.querySelectorAll('.availability-stat');
            availabilityStats.forEach(stat => {
                stat.addEventListener('click', function(e) {
                    e.stopPropagation();
                    const statType = this.classList.contains('stat-available') ? 'available' :
                                   this.classList.contains('stat-injured') ? 'injured' : 'at-risk';
                    console.log(`Availability stat clicked: ${statType}`, this);
                    
                    // Add visual feedback
                    this.style.transform = 'scale(0.95)';
                    setTimeout(() => {
                        this.style.transform = '';
                    }, 150);
                    
                    // Could filter squad view or show detailed player lists
                });
            });
        }
        
        // FormationCard Component (Card 3.3) - Tactical formation display
        // Data Contract: {header: {title: string}, body: {contentType: 'FormationDisplay', contentData: {formationName, tacticName, familiarity, players: [{name, position, coords: {x, y}}]}}}
        function createFormationCard(data) {
            // Validate data contract per newPlan.md specifications
            if (!data || !data.header || typeof data.header.title !== 'string') {
                throw new Error('FormationCard requires valid header.title string');
            }
            if (!data.body || data.body.contentType !== 'FormationDisplay') {
                throw new Error('FormationCard requires body.contentType = "FormationDisplay"');
            }
            
            const formationData = data.body.contentData;
            if (!formationData || typeof formationData.formationName !== 'string' || 
                typeof formationData.tacticName !== 'string' || 
                typeof formationData.familiarity !== 'number' ||
                !Array.isArray(formationData.players)) {
                throw new Error('FormationCard requires contentData with formationName, tacticName, familiarity, and players array');
            }
            
            // Create card structure following newPlan.md specifications
            const card = document.createElement('div');
            card.className = 'card';
            
            // Create aethelred-card-header
            const header = document.createElement('div');
            header.className = 'aethelred-card-header card-header';
            header.innerHTML = `<span>${data.header.title}</span>`;
            
            // Create aethelred-card-body containing custom-rendered formation view
            const body = document.createElement('div');
            body.className = 'aethelred-card-body card-body';
            body.style.padding = '20px';
            body.style.textAlign = 'center';
            
            // Formation and tactic display
            const formationTitle = document.createElement('div');
            formationTitle.style.fontSize = '18px';
            formationTitle.style.fontWeight = 'bold';
            formationTitle.style.color = 'var(--primary-400)';
            formationTitle.style.marginBottom = '8px';
            formationTitle.textContent = formationData.formationName;
            
            const tacticTitle = document.createElement('div');
            tacticTitle.style.fontSize = '14px';
            tacticTitle.style.color = 'rgba(255,255,255,0.6)';
            tacticTitle.style.marginBottom = '20px';
            tacticTitle.textContent = formationData.tacticName;
            
            // Create stylized pitch background with player markers per newPlan.md
            const pitchContainer = document.createElement('div');
            pitchContainer.style.position = 'relative';
            pitchContainer.style.background = 'linear-gradient(135deg, #1a4c2e 0%, #2d5c3f 50%, #1a4c2e 100%)';
            pitchContainer.style.height = '200px';
            pitchContainer.style.borderRadius = '8px';
            pitchContainer.style.border = '2px solid rgba(255,255,255,0.2)';
            pitchContainer.style.marginBottom = '15px';
            pitchContainer.style.overflow = 'hidden';
            
            // Add pitch markings
            const centerLine = document.createElement('div');
            centerLine.style.position = 'absolute';
            centerLine.style.left = '50%';
            centerLine.style.top = '10px';
            centerLine.style.bottom = '10px';
            centerLine.style.width = '1px';
            centerLine.style.background = 'rgba(255,255,255,0.3)';
            centerLine.style.transform = 'translateX(-50%)';
            pitchContainer.appendChild(centerLine);
            
            // Add center circle
            const centerCircle = document.createElement('div');
            centerCircle.style.position = 'absolute';
            centerCircle.style.left = '50%';
            centerCircle.style.top = '50%';
            centerCircle.style.width = '60px';
            centerCircle.style.height = '60px';
            centerCircle.style.border = '1px solid rgba(255,255,255,0.3)';
            centerCircle.style.borderRadius = '50%';
            centerCircle.style.transform = 'translate(-50%, -50%)';
            pitchContainer.appendChild(centerCircle);
            
            // Place player markers at specified coordinates (0-1 scale per newPlan.md)
            formationData.players.forEach(player => {
                const playerMarker = document.createElement('div');
                playerMarker.style.position = 'absolute';
                playerMarker.style.width = '48px';
                playerMarker.style.height = '48px';
                playerMarker.style.background = 'var(--primary-400)';
                playerMarker.style.borderRadius = '50%';
                playerMarker.style.border = '2px solid white';
                playerMarker.style.display = 'flex';
                playerMarker.style.alignItems = 'center';
                playerMarker.style.justifyContent = 'center';
                playerMarker.style.fontSize = '8px';
                playerMarker.style.fontWeight = 'bold';
                playerMarker.style.color = 'white';
                
                // Convert 0-1 coordinates to pixel positions
                const leftPercent = player.coords.x * 100;
                const topPercent = player.coords.y * 100;
                playerMarker.style.left = `${leftPercent}%`;
                playerMarker.style.top = `${topPercent}%`;
                playerMarker.style.transform = 'translate(-50%, -50%)';
                
                // Add player position abbreviation
                playerMarker.textContent = player.position.substring(0, 2);
                playerMarker.title = `${player.name} (${player.position})`;
                
                pitchContainer.appendChild(playerMarker);
            });
            
            // Familiarity display
            const familiarityDisplay = document.createElement('div');
            familiarityDisplay.style.fontSize = '12px';
            familiarityDisplay.style.color = 'rgba(255,255,255,0.8)';
            familiarityDisplay.textContent = `Familiarity: ${formationData.familiarity}%`;
            
            body.appendChild(formationTitle);
            body.appendChild(tacticTitle);
            body.appendChild(pitchContainer);
            body.appendChild(familiarityDisplay);
            
            card.appendChild(header);
            card.appendChild(body);
            
            return card;
        }
        
        // SetPieceCard Component - Half-pitch tactical visualization from main.html
        // Data Contract: {header: {title: string}, body: {contentType: 'SetPieceDisplay', contentData: {setPieceType, players: [{name, role, coords: {x, y}}]}}}
        function createSetPieceCard(data) {
            // Validate data contract
            if (!data || !data.header || typeof data.header.title !== 'string') {
                throw new Error('SetPieceCard requires valid header.title string');
            }
            if (!data.body || data.body.contentType !== 'SetPieceDisplay') {
                throw new Error('SetPieceCard requires body.contentType = "SetPieceDisplay"');
            }
            
            const setPieceData = data.body.contentData;
            if (!setPieceData || typeof setPieceData.setPieceType !== 'string' || !Array.isArray(setPieceData.players)) {
                throw new Error('SetPieceCard requires contentData with setPieceType (string) and players array');
            }
            
            // Create card structure
            const card = document.createElement('div');
            card.className = 'card';
            
            // Create header
            const header = document.createElement('div');
            header.className = 'aethelred-card-header card-header';
            header.innerHTML = `<span>${data.header.title}</span>`;
            
            // Create body with half-pitch visualization
            const body = document.createElement('div');
            body.className = 'aethelred-card-body card-body';
            body.style.padding = '16px';
            body.style.textAlign = 'center';
            
            // Set piece type title
            const setPieceTitle = document.createElement('div');
            setPieceTitle.style.fontSize = '16px';
            setPieceTitle.style.fontWeight = 'bold';
            setPieceTitle.style.color = 'var(--primary-400)';
            setPieceTitle.style.marginBottom = '16px';
            setPieceTitle.textContent = setPieceData.setPieceType;
            
            // Create half-pitch container with goal-relative positioning
            const pitchContainer = document.createElement('div');
            pitchContainer.style.position = 'relative';
            pitchContainer.style.width = '100%';
            pitchContainer.style.maxWidth = '350px';
            pitchContainer.style.height = '200px';
            pitchContainer.style.margin = '0 auto 16px auto';
            pitchContainer.style.background = 'linear-gradient(to bottom, #0a3d1a 0%, #1a6329 25%, #2a7339 50%, #1a6329 75%, #0a3d1a 100%)';
            pitchContainer.style.borderRadius = '12px';
            pitchContainer.style.border = '3px solid rgba(255,255,255,0.3)';
            pitchContainer.style.overflow = 'visible';
            
            // Add goal area (bottom of half-pitch)
            const goalArea = document.createElement('div');
            goalArea.style.position = 'absolute';
            goalArea.style.bottom = '0';
            goalArea.style.left = '50%';
            goalArea.style.width = '100px';
            goalArea.style.height = '8px';
            goalArea.style.background = 'rgba(255,255,255,0.8)';
            goalArea.style.transform = 'translateX(-50%)';
            goalArea.style.borderRadius = '4px 4px 0 0';
            pitchContainer.appendChild(goalArea);
            
            // Add penalty area outline
            const penaltyArea = document.createElement('div');
            penaltyArea.style.position = 'absolute';
            penaltyArea.style.bottom = '0';
            penaltyArea.style.left = '50%';
            penaltyArea.style.width = '160px';
            penaltyArea.style.height = '60px';
            penaltyArea.style.border = '2px solid rgba(255,255,255,0.4)';
            penaltyArea.style.borderBottom = 'none';
            penaltyArea.style.transform = 'translateX(-50%)';
            pitchContainer.appendChild(penaltyArea);
            
            // Add goal area outline
            const goalAreaOutline = document.createElement('div');
            goalAreaOutline.style.position = 'absolute';
            goalAreaOutline.style.bottom = '0';
            goalAreaOutline.style.left = '50%';
            goalAreaOutline.style.width = '80px';
            goalAreaOutline.style.height = '20px';
            goalAreaOutline.style.border = '1px solid rgba(255,255,255,0.3)';
            goalAreaOutline.style.borderBottom = 'none';
            goalAreaOutline.style.transform = 'translateX(-50%)';
            pitchContainer.appendChild(goalAreaOutline);
            
            // Determine set piece marker type for consistent styling
            const setPieceType = setPieceData.setPieceType.toLowerCase();
            let markerClass = 'corner';
            if (setPieceType.includes('freekick') || setPieceType.includes('free kick')) {
                markerClass = 'freekick';
            } else if (setPieceType.includes('penalty')) {
                markerClass = 'penalty';
            }
            
            // Place set piece markers
            setPieceData.players.forEach(player => {
                const marker = document.createElement('div');
                marker.style.position = 'absolute';
                marker.style.width = '20px';
                marker.style.height = '20px';
                marker.style.borderRadius = '50%';
                marker.style.transform = 'translate(-50%, -50%)';
                marker.style.display = 'flex';
                marker.style.alignItems = 'center';
                marker.style.justifyContent = 'center';
                marker.style.fontSize = '8px';
                marker.style.fontWeight = '600';
                marker.style.color = 'white';
                marker.style.textShadow = '0 1px 2px rgba(0,0,0,0.8)';
                marker.style.boxShadow = '0 2px 4px rgba(0,0,0,0.3)';
                marker.style.transition = 'all 0.2s ease';
                marker.style.border = '2px solid rgba(255,255,255,0.9)';
                
                // Apply set piece specific colors
                if (markerClass === 'corner') {
                    marker.style.background = 'var(--accent-300)'; // Amber for corners
                } else if (markerClass === 'freekick') {
                    marker.style.background = 'var(--accent-400)'; // Red for free kicks
                } else if (markerClass === 'penalty') {
                    marker.style.background = 'var(--primary-400)'; // Blue for penalties
                }
                
                // Position marker using coordinates (0-1 scale)
                const leftPercent = player.coords.x * 100;
                const topPercent = player.coords.y * 100;
                marker.style.left = `${leftPercent}%`;
                marker.style.top = `${topPercent}%`;
                
                // Add player initials
                const initials = player.name.split(' ').map(n => n.charAt(0)).join('').toUpperCase();
                marker.textContent = initials;
                marker.title = `${player.name} (${player.role || player.position})`;
                
                pitchContainer.appendChild(marker);
            });
            
            body.appendChild(setPieceTitle);
            body.appendChild(pitchContainer);
            
            card.appendChild(header);
            card.appendChild(body);
            
            return card;
        }
        
        // Enhanced FormationCard Component - Full-pitch visualization from main.html
        // Includes goal areas, penalty boxes, center circle, position-specific colors
        function createEnhancedFormationCard(data) {
            // Validate data contract (same as FormationCard)
            if (!data || !data.header || typeof data.header.title !== 'string') {
                throw new Error('Enhanced FormationCard requires valid header.title string');
            }
            if (!data.body || data.body.contentType !== 'FormationDisplay') {
                throw new Error('Enhanced FormationCard requires body.contentType = "FormationDisplay"');
            }
            
            const formationData = data.body.contentData;
            if (!formationData || typeof formationData.formationName !== 'string' || 
                typeof formationData.tacticName !== 'string' || 
                typeof formationData.familiarity !== 'number' ||
                !Array.isArray(formationData.players)) {
                throw new Error('Enhanced FormationCard requires contentData with formationName, tacticName, familiarity, and players array');
            }
            
            // Create card structure
            const card = document.createElement('div');
            card.className = 'card';
            
            // Create header
            const header = document.createElement('div');
            header.className = 'aethelred-card-header card-header';
            header.innerHTML = `<span>${data.header.title}</span>`;
            
            // Create body with enhanced full-pitch visualization
            const body = document.createElement('div');
            body.className = 'aethelred-card-body card-body';
            body.style.padding = '16px';
            body.style.textAlign = 'center';
            body.style.minHeight = '400px';
            
            // Formation header
            const formationHeader = document.createElement('div');
            formationHeader.style.marginBottom = '16px';
            
            const tacticTitle = document.createElement('div');
            tacticTitle.style.fontSize = '18px';
            tacticTitle.style.fontWeight = '600';
            tacticTitle.style.color = 'var(--primary-400)';
            tacticTitle.style.marginBottom = '4px';
            tacticTitle.textContent = formationData.tacticName;
            
            const formationName = document.createElement('div');
            formationName.style.fontSize = '16px';
            formationName.style.color = 'rgba(255,255,255,0.7)';
            formationName.style.marginBottom = '12px';
            formationName.textContent = formationData.formationName;
            
            formationHeader.appendChild(tacticTitle);
            formationHeader.appendChild(formationName);
            
            // Create enhanced full-pitch background
            const pitchContainer = document.createElement('div');
            pitchContainer.style.position = 'relative';
            pitchContainer.style.width = '100%';
            pitchContainer.style.maxWidth = '400px';
            pitchContainer.style.height = '280px';
            pitchContainer.style.margin = '0 auto 16px auto';
            pitchContainer.style.background = 'linear-gradient(to bottom, #0a3d1a 0%, #1a6329 25%, #2a7339 50%, #1a6329 75%, #0a3d1a 100%)';
            pitchContainer.style.borderRadius = '12px';
            pitchContainer.style.border = '3px solid rgba(255,255,255,0.3)';
            pitchContainer.style.overflow = 'visible';
            pitchContainer.style.boxShadow = 'inset 0 0 20px rgba(0,0,0,0.3), 0 4px 20px rgba(0,0,0,0.2)';
            
            // Add center line
            const centerLine = document.createElement('div');
            centerLine.style.position = 'absolute';
            centerLine.style.top = '50%';
            centerLine.style.left = '0';
            centerLine.style.right = '0';
            centerLine.style.height = '2px';
            centerLine.style.background = 'rgba(255,255,255,0.4)';
            centerLine.style.transform = 'translateY(-50%)';
            pitchContainer.appendChild(centerLine);
            
            // Add center circle
            const centerCircle = document.createElement('div');
            centerCircle.style.position = 'absolute';
            centerCircle.style.top = '50%';
            centerCircle.style.left = '50%';
            centerCircle.style.width = '100px';
            centerCircle.style.height = '100px';
            centerCircle.style.border = '2px solid rgba(255,255,255,0.4)';
            centerCircle.style.borderRadius = '50%';
            centerCircle.style.transform = 'translate(-50%, -50%)';
            pitchContainer.appendChild(centerCircle);
            
            // Add goal areas (top and bottom)
            const goalAreaTop = document.createElement('div');
            goalAreaTop.style.position = 'absolute';
            goalAreaTop.style.top = '0';
            goalAreaTop.style.left = '50%';
            goalAreaTop.style.width = '80px';
            goalAreaTop.style.height = '25px';
            goalAreaTop.style.background = 'rgba(255,255,255,0.1)';
            goalAreaTop.style.border = '1px solid rgba(255,255,255,0.3)';
            goalAreaTop.style.borderTop = 'none';
            goalAreaTop.style.borderRadius = '0 0 8px 8px';
            goalAreaTop.style.transform = 'translateX(-50%)';
            pitchContainer.appendChild(goalAreaTop);
            
            const goalAreaBottom = document.createElement('div');
            goalAreaBottom.style.position = 'absolute';
            goalAreaBottom.style.bottom = '0';
            goalAreaBottom.style.left = '50%';
            goalAreaBottom.style.width = '80px';
            goalAreaBottom.style.height = '25px';
            goalAreaBottom.style.background = 'rgba(255,255,255,0.1)';
            goalAreaBottom.style.border = '1px solid rgba(255,255,255,0.3)';
            goalAreaBottom.style.borderBottom = 'none';
            goalAreaBottom.style.borderRadius = '8px 8px 0 0';
            goalAreaBottom.style.transform = 'translateX(-50%)';
            pitchContainer.appendChild(goalAreaBottom);
            
            // Add penalty areas (top and bottom)
            const penaltyAreaTop = document.createElement('div');
            penaltyAreaTop.style.position = 'absolute';
            penaltyAreaTop.style.top = '0';
            penaltyAreaTop.style.left = '50%';
            penaltyAreaTop.style.width = '140px';
            penaltyAreaTop.style.height = '50px';
            penaltyAreaTop.style.border = '1px solid rgba(255,255,255,0.25)';
            penaltyAreaTop.style.borderTop = 'none';
            penaltyAreaTop.style.transform = 'translateX(-50%)';
            pitchContainer.appendChild(penaltyAreaTop);
            
            const penaltyAreaBottom = document.createElement('div');
            penaltyAreaBottom.style.position = 'absolute';
            penaltyAreaBottom.style.bottom = '0';
            penaltyAreaBottom.style.left = '50%';
            penaltyAreaBottom.style.width = '140px';
            penaltyAreaBottom.style.height = '50px';
            penaltyAreaBottom.style.border = '1px solid rgba(255,255,255,0.25)';
            penaltyAreaBottom.style.borderBottom = 'none';
            penaltyAreaBottom.style.transform = 'translateX(-50%)';
            pitchContainer.appendChild(penaltyAreaBottom);
            
            // Helper function to get position-specific color
            function getPositionColor(position) {
                const pos = position.toUpperCase();
                if (pos === 'GK') return 'var(--accent-300)'; // Amber for goalkeeper
                if (['CB', 'LB', 'RB', 'WB', 'LWB', 'RWB'].includes(pos)) return 'var(--primary-300)'; // Blue for defenders
                if (['CM', 'DM', 'AM', 'LM', 'RM'].includes(pos)) return 'var(--accent-200)'; // Green for midfielders
                if (['ST', 'CF', 'LW', 'RW', 'LF', 'RF'].includes(pos)) return 'var(--accent-400)'; // Red for forwards
                return 'var(--accent-200)'; // Default to green
            }
            
            // Place player markers with position-specific colors
            formationData.players.forEach(player => {
                const marker = document.createElement('div');
                marker.style.position = 'absolute';
                marker.style.width = '48px';
                marker.style.height = '48px';
                marker.style.background = getPositionColor(player.position);
                marker.style.border = '2px solid rgba(255,255,255,0.9)';
                marker.style.borderRadius = '50%';
                marker.style.transform = 'translate(-50%, -50%)';
                marker.style.display = 'flex';
                marker.style.alignItems = 'center';
                marker.style.justifyContent = 'center';
                marker.style.fontSize = '9px';
                marker.style.fontWeight = '600';
                marker.style.color = 'white';
                marker.style.textShadow = '0 1px 2px rgba(0,0,0,0.8)';
                marker.style.boxShadow = '0 2px 4px rgba(0,0,0,0.3)';
                marker.style.cursor = 'pointer';
                marker.style.transition = 'all 0.2s ease';
                
                // Enhanced hover interactions with tactical intelligence
                marker.addEventListener('mouseenter', () => {
                    marker.style.transform = 'translate(-50%, -50%) scale(1.3)';
                    marker.style.background = 'var(--accent-200)';
                    marker.style.boxShadow = '0 6px 12px rgba(0, 255, 136, 0.6), 0 0 20px rgba(0, 255, 136, 0.3)';
                    marker.style.border = '3px solid rgba(255, 255, 255, 1)';
                    marker.style.zIndex = '100';
                    
                    // Show tactical tooltip
                    const tooltip = document.createElement('div');
                    tooltip.className = 'player-tactical-tooltip';
                    tooltip.style.position = 'absolute';
                    tooltip.style.bottom = '120%';
                    tooltip.style.left = '50%';
                    tooltip.style.transform = 'translateX(-50%)';
                    tooltip.style.background = 'var(--neutral-400)';
                    tooltip.style.color = 'white';
                    tooltip.style.padding = '6px 10px';
                    tooltip.style.borderRadius = 'var(--border-radius)';
                    tooltip.style.fontSize = '10px';
                    tooltip.style.whiteSpace = 'nowrap';
                    tooltip.style.zIndex = '101';
                    tooltip.style.boxShadow = '0 4px 12px rgba(0,0,0,0.4)';
                    tooltip.textContent = `${player.name} (${player.position})`;
                    marker.appendChild(tooltip);
                });
                marker.addEventListener('mouseleave', () => {
                    marker.style.transform = 'translate(-50%, -50%) scale(1)';
                    marker.style.background = getPositionColor(player.position);
                    marker.style.boxShadow = '0 2px 4px rgba(0,0,0,0.3)';
                    marker.style.border = '2px solid rgba(255,255,255,0.9)';
                    marker.style.zIndex = '1';
                    
                    // Remove tooltip
                    const tooltip = marker.querySelector('.player-tactical-tooltip');
                    if (tooltip) tooltip.remove();
                });
                
                // Convert 0-1 coordinates to pixel positions
                // Invert Y coordinate so 0 = top (attacking goal), 1 = bottom (defending goal)
                const leftPercent = player.coords.x * 100;
                const topPercent = (1 - player.coords.y) * 100;
                marker.style.left = `${leftPercent}%`;
                marker.style.top = `${topPercent}%`;
                
                // Add player initials
                const initials = player.name.split(' ').map(n => n.charAt(0).toUpperCase()).slice(0, 2).join('');
                marker.textContent = initials;
                marker.title = `${player.name} (${player.position})`;
                
                pitchContainer.appendChild(marker);
            });
            
            // Familiarity display
            const familiarityDisplay = document.createElement('div');
            familiarityDisplay.style.fontSize = '12px';
            familiarityDisplay.style.color = 'rgba(255,255,255,0.8)';
            familiarityDisplay.innerHTML = `Familiarity: <span style="font-weight: 600; color: var(--accent-200);">${formationData.familiarity}%</span>`;
            
            body.appendChild(formationHeader);
            body.appendChild(pitchContainer);
            body.appendChild(familiarityDisplay);
            
            card.appendChild(header);
            card.appendChild(body);
            
            return card;
        }
        
        // ========================================
        // COMPONENT FACTORY SYSTEM
        // Enables dynamic component creation from data contracts
        // ========================================
        
        // Aethelred Component Factory - renders any component from its data contract
        function createAethelredComponent(componentType, data) {
            switch (componentType) {
                case 'StatRow':
                    return createStatRow(data);
                case 'SummaryStatCard':
                    return createSummaryStatCard(data);
                case 'TrainingOptimizerCard':
                    return createTrainingOptimizerCard(data);
                case 'MiniTable':
                    return createMiniTable(data);
                case 'RosterCard':
                    return createRosterCard(data);
                case 'StatBar':
                    return createStatBar(data);
                case 'TeamCohesionCard':
                    return createTeamCohesionCard(data);
                case 'SquadHealthMatrixCard':
                    return createSquadHealthMatrixCard(data);
                case 'FormationCard':
                    return createFormationCard(data);
                case 'EnhancedFormationCard':
                    return createEnhancedFormationCard(data);
                case 'SetPieceCard':
                    return createSetPieceCard(data);
                case 'MatchPredictorCard':
                    return createMatchPredictorCard(data);
                default:
                    throw new Error(`Unknown Aethelred component type: ${componentType}`);
            }
        }
        
        // ENHANCED MatchPredictorCard Component - System Font Integration with Professional Enhancements
        function createMatchPredictorCard(data) {
            if (!data || !data.header || !data.body) {
                throw new Error('MatchPredictorCard requires valid header and body');
            }
            
            const card = document.createElement('div');
            card.className = 'card';
            
            // Create header using system styling - consistent with other cards
            const header = document.createElement('div');
            header.className = 'aethelred-card-header card-header';
            header.innerHTML = `<span>${data.header.title}</span>`;
            
            // Create body with enhanced structure
            const body = document.createElement('div');
            body.className = 'aethelred-card-body card-body';
            
            const { competition, homeTeam, awayTeam, probabilities, tactical, additional } = data.body;
            
            body.innerHTML = `
                <!-- Competition Header Tile -->
                <div class="competition-header" style="
                    background: var(--neutral-300);
                    border: 1px solid rgba(255,255,255,0.1);
                    border-radius: var(--border-radius);
                    padding: 8px 12px;
                    margin-bottom: 12px;
                    text-align: center;
                    font-family: inherit;
                ">
                    <div style="font-size: var(--font-size-base); font-weight: 600; color: var(--accent-200); margin-bottom: 2px;">
                        ${competition.name}
                    </div>
                    <div style="font-size: var(--font-size-sm); color: rgba(255,255,255,0.8);">
                        ${competition.venue} • ${competition.location} • ${competition.date} ${competition.time}
                    </div>
                    <div style="font-size: var(--font-size-sm); color: var(--accent-200); margin-top: 4px;">
                        ${competition.weather.emoji} ${competition.weather.condition}, ${competition.weather.temperature}
                    </div>
                </div>
                
                <!-- Teams Section -->
                <div class="teams-section" style="margin-bottom: 12px;">
                    <div class="teams-grid" style="display: grid; grid-template-columns: 1fr 40px 1fr; align-items: center; gap: 12px; margin-bottom: 8px;">
                        <div class="team" style="display: flex; align-items: center; gap: 10px;">
                            <div class="team-symbol" style="
                                width: 32px; height: 32px; 
                                background: var(--primary-300); 
                                border: 1px solid rgba(255,255,255,0.2); 
                                display: flex; align-items: center; justify-content: center; 
                                font-weight: 700; font-size: var(--font-size-base); 
                                color: white; border-radius: var(--border-radius);
                                font-family: inherit;
                            ">${homeTeam.symbol}</div>
                            <div class="team-info">
                                <div style="display: flex; align-items: center; gap: 6px; margin-bottom: 2px;">
                                    <h3 style="font-size: var(--font-size-md); font-weight: 700; margin: 0; color: white; font-family: inherit;">${homeTeam.name}</h3>
                                    <span style="font-size: var(--font-size-xs); color: var(--accent-200); font-weight: 600; background: var(--neutral-400); padding: 1px 4px; border-radius: var(--border-radius);">#${homeTeam.position}</span>
                                </div>
                                <div style="font-size: var(--font-size-xs); color: rgba(255,255,255,0.6); text-transform: uppercase; letter-spacing: 1px; margin-bottom: 4px;">${homeTeam.label}</div>
                                <div class="team-form">${createTeamFormVisual(homeTeam.form, 'small')}</div>
                            </div>
                        </div>
                        
                        <div class="vs-divider" style="
                            display: flex; align-items: center; justify-content: center; 
                            font-size: var(--font-size-sm); font-weight: 700; 
                            color: rgba(255,255,255,0.6); letter-spacing: 2px;
                            font-family: inherit;
                        ">VS</div>
                        
                        <div class="team team--away" style="display: flex; flex-direction: row-reverse; align-items: center; gap: 10px; text-align: right;">
                            <div class="team-symbol" style="
                                width: 32px; height: 32px; 
                                background: #ef4444; 
                                border: 1px solid rgba(255,255,255,0.2); 
                                display: flex; align-items: center; justify-content: center; 
                                font-weight: 700; font-size: var(--font-size-base); 
                                color: white; border-radius: var(--border-radius);
                                font-family: inherit;
                            ">${awayTeam.symbol}</div>
                            <div class="team-info">
                                <div style="display: flex; align-items: center; gap: 6px; margin-bottom: 2px; justify-content: flex-end;">
                                    <span style="font-size: var(--font-size-xs); color: var(--accent-200); font-weight: 600; background: var(--neutral-400); padding: 1px 4px; border-radius: var(--border-radius);">#${awayTeam.position}</span>
                                    <h3 style="font-size: var(--font-size-md); font-weight: 700; margin: 0; color: white; font-family: inherit;">${awayTeam.name}</h3>
                                </div>
                                <div style="font-size: var(--font-size-xs); color: rgba(255,255,255,0.6); text-transform: uppercase; letter-spacing: 1px; margin-bottom: 4px;">${awayTeam.label}</div>
                                <div class="team-form" style="text-align: right;">${createTeamFormVisual(awayTeam.form, 'small')}</div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Probability Section -->
                    <div class="probability-section" style="display: grid; gap: 6px;">
                        ${probabilities.map(prob => `
                            <div class="probability-row" style="display: grid; grid-template-columns: 70px 1fr 50px; align-items: center; gap: 12px;">
                                <div class="prob-label" style="font-size: var(--font-size-xs); font-weight: 600; color: rgba(255,255,255,0.6); text-transform: uppercase; letter-spacing: 1px; font-family: inherit;">${prob.label}</div>
                                <div class="prob-bar" style="height: 10px; background: var(--neutral-400); border: 1px solid rgba(255,255,255,0.1); position: relative; overflow: hidden; border-radius: var(--border-radius);">
                                    <div class="prob-fill" style="height: 100%; position: absolute; left: 0; top: 0; width: ${prob.percentage}%; background: ${prob.color}; transition: width 1.2s ease;"></div>
                                </div>
                                <div class="prob-percentage" style="font-weight: 700; font-size: var(--font-size-sm); text-align: right; color: white; font-family: inherit;">${prob.percentage}%</div>
                            </div>
                        `).join('')}
                    </div>
                </div>
                
                <!-- Tactical Section -->
                <div class="tactical-section" style="display: grid; grid-template-columns: 1fr 1fr; gap: 4px; margin-bottom: 4px;">
                    <div class="formation-display" style="background: var(--neutral-300); border: 1px solid rgba(255,255,255,0.1); padding: 8px; border-radius: var(--border-radius);">
                        <div class="formation-title" style="font-size: var(--font-size-xs); color: rgba(255,255,255,0.6); text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 4px; font-family: inherit;">Formation Battle</div>
                        <div class="formation-grid" style="display: flex; align-items: center; justify-content: center; gap: 6px; margin-bottom: 4px;">
                            <div class="formation-badge" style="background: var(--neutral-400); border: 1px solid rgba(255,255,255,0.1); padding: 2px 6px; font-size: var(--font-size-xs); font-weight: 600; color: white; border-radius: var(--border-radius); font-family: inherit;">${tactical.homeFormation}</div>
                            <div class="formation-vs" style="font-size: var(--font-size-xs); color: rgba(255,255,255,0.6); font-weight: 700; font-family: inherit;">VS</div>
                            <div class="formation-badge" style="background: var(--neutral-400); border: 1px solid rgba(255,255,255,0.1); padding: 2px 6px; font-size: var(--font-size-xs); font-weight: 600; color: white; border-radius: var(--border-radius); font-family: inherit;">${tactical.awayFormation}</div>
                        </div>
                        <div style="font-size: var(--font-size-xs); color: rgba(255,255,255,0.6); text-align: center; font-family: inherit;">${tactical.battleType}</div>
                    </div>
                    
                    <div class="key-duel" style="background: var(--neutral-300); border: 1px solid rgba(255,255,255,0.1); padding: 8px; border-radius: var(--border-radius);">
                        <div class="duel-title" style="font-size: var(--font-size-xs); color: rgba(255,255,255,0.6); text-transform: uppercase; letter-spacing: 1px; margin-bottom: 6px; font-family: inherit;">Key Battle</div>
                        <div class="duel-matchup" style="display: grid; grid-template-columns: 1fr auto 1fr; align-items: center; gap: 6px;">
                            <div class="duel-player" style="text-align: left;">
                                <div class="duel-name" style="font-size: var(--font-size-sm); font-weight: 600; color: white; font-family: inherit;">${tactical.keyBattle.homePlayer}</div>
                            </div>
                            <div class="duel-vs" style="font-size: var(--font-size-xs); color: rgba(255,255,255,0.6); font-weight: 700; letter-spacing: 1px; font-family: inherit;">VS</div>
                            <div class="duel-player" style="text-align: right;">
                                <div class="duel-name" style="font-size: var(--font-size-sm); font-weight: 600; color: white; font-family: inherit;">${tactical.keyBattle.awayPlayer}</div>
                            </div>
                        </div>
                        <div style="font-size: var(--font-size-xs); color: rgba(255,255,255,0.6); text-align: center; margin-top: 3px; font-family: inherit;">${tactical.keyBattle.area}</div>
                    </div>
                    
                    <div class="stat-card" style="background: var(--neutral-300); border: 1px solid rgba(255,255,255,0.1); padding: 8px; border-radius: var(--border-radius);">
                        <div class="stat-title" style="font-size: var(--font-size-xs); color: rgba(255,255,255,0.6); text-transform: uppercase; letter-spacing: 1px; margin-bottom: 6px; font-family: inherit;">H2H Last 5</div>
                        <div class="h2h-results" style="display: flex; gap: 3px; margin-bottom: 4px; justify-content: center;">
                            ${tactical.h2h.results.map(result => `
                                <div class="h2h-result" style="width: 14px; height: 14px; display: flex; align-items: center; justify-content: center; font-size: var(--font-size-xs); font-weight: 700; background: ${getFormResultColor(result)}; color: white; border-radius: var(--border-radius); font-family: inherit;">${result}</div>
                            `).join('')}
                        </div>
                        <div style="font-size: var(--font-size-xs); color: rgba(255,255,255,0.6); text-align: center; font-family: inherit;">${tactical.h2h.summary}</div>
                    </div>
                    
                    <div class="stat-card" style="background: var(--neutral-300); border: 1px solid rgba(255,255,255,0.1); padding: 8px; border-radius: var(--border-radius);">
                        <div class="stat-title" style="font-size: var(--font-size-xs); color: rgba(255,255,255,0.6); text-transform: uppercase; letter-spacing: 1px; margin-bottom: 6px; font-family: inherit;">Match Context</div>
                        <div style="font-size: var(--font-size-xs); color: rgba(255,255,255,0.7); line-height: 1.4; text-align: center; font-family: inherit;">
                            <div style="margin-bottom: 2px;">Referee: ${tactical.context.referee}</div>
                            <div>${tactical.context.intensity}</div>
                        </div>
                    </div>
                </div>
                
                <!-- Additional Info - Center Justified -->
                <div class="additional-info" style="
                    padding: 8px 12px; 
                    background: var(--neutral-300); 
                    border-top: 1px solid rgba(255,255,255,0.1); 
                    display: flex; 
                    justify-content: center;
                    align-items: center;
                    gap: 16px;
                    border-radius: 0 0 var(--border-radius) var(--border-radius);
                    font-family: inherit;
                ">
                    ${additional.map(info => `
                        <div class="info-item" style="
                            display: flex; 
                            align-items: center; 
                            gap: 4px; 
                            font-size: var(--font-size-xs); 
                            color: ${info.type === 'danger' ? '#ef4444' : info.type === 'positive' ? '#10b981' : 'rgba(255,255,255,0.7)'};
                            font-family: inherit;
                        ">
                            <span class="info-icon">${info.icon}</span>
                            <span>${info.text}</span>
                        </div>
                    `).join('')}
                </div>
            `;
            
            card.appendChild(header);
            card.appendChild(body);
            
            return card;
        }
        
        // Enhanced card creation with Aethelred component support
        // ENHANCED Aethelred card creation with DYNAMIC positioning system  
        function createCardFromAethelredData(cardData, pageName) {
            // Use new dynamic system if layout config exists
            if (cardData.layout) {
                return createCardFromAethelredDataDynamic(cardData, pageName);
            }
            
            // Fallback to legacy system for backward compatibility
            if (cardData.componentType) {
                const component = createAethelredComponent(cardData.componentType, cardData.data);
                
                // Add essential card functionality to Aethelred components
                component.classList.add('card');
                component.draggable = false;
                
                // Add grid sizing attributes for layout system
                const width = cardData.width || 6;
                const height = cardData.height || 3;
                component.setAttribute('data-grid-w', width);
                component.setAttribute('data-grid-h', height);
                
                // ENHANCED: Add tier data attributes for hierarchy management
                if (cardData.tier) {
                    component.setAttribute('data-tier', cardData.tier);
                    // Apply tier-specific styling classes
                    component.classList.add(`tier-${cardData.tier}`);
                }
                
                // CRITICAL: Add proper CSS classes for grid system compatibility
                component.classList.add(`w${width}`, `h${height}`);
                component.style.gridColumn = `span ${width}`;
                component.style.gridRow = `span ${height}`;
                
                // ENHANCED: Handle explicit positioning from FM hierarchy
                if (cardData.position) {
                    const { row, column } = cardData.position;
                    if (row && column) {
                        component.style.gridColumn = `${column} / span ${width}`;
                        component.style.gridRow = `${row} / span ${height}`;
                        component.setAttribute('data-positioned', 'true');
                    }
                }
                
                // Add resize handles that were missing
                const resizeHandleBR = document.createElement('div');
                resizeHandleBR.className = 'resize-handle';
                component.appendChild(resizeHandleBR);
                
                const resizeHandleBL = document.createElement('div');
                resizeHandleBL.className = 'resize-handle-bl';
                component.appendChild(resizeHandleBL);
                
                // Add card menu to Aethelred components with accessibility
                const header = component.querySelector('.aethelred-card-header');
                if (header) {
                    // Clean professional headers without priority indicators
                    
                    // Add double-click handler for expansion
                    header.setAttribute('ondblclick', 'expandCardFromHeader(this)');
                    header.style.cursor = 'pointer';
                    
                    const menuHTML = `
                        <div class="card-menu">
                            <button class="card-menu-btn" onclick="toggleCardMenu(this, event)" 
                                    aria-label="Card options menu" tabindex="0">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" aria-hidden="true">
                                    <circle cx="12" cy="12" r="1"/>
                                    <circle cx="12" cy="12" r="5"/>
                                </svg>
                            </button>
                            <div class="card-menu-dropdown" role="menu" aria-hidden="true">
                                <div class="card-menu-item" onclick="expandCard(this)" role="menuitem" tabindex="0">Expand</div>
                                <div class="card-menu-item" onclick="pinCard(this)" role="menuitem" tabindex="0">Pin</div>
                                <div class="card-menu-item" onclick="removeCard(this)" role="menuitem" tabindex="0">Remove</div>
                                <div class="card-menu-item" onclick="replaceCard(this)" role="menuitem" tabindex="0">Replace</div>
                                <div class="card-menu-item" onclick="bookmarkCard(this)" role="menuitem" tabindex="0">Bookmark</div>
                            </div>
                        </div>
                    `;
                    header.innerHTML += menuHTML;
                }
                
                return component;
            }
            
            // Fallback to existing card creation system
            return createCardFromData(cardData, pageName);
        }
        
        // ========================================
        // DEMONSTRATION: Financial Overview Card using SummaryStatCard
        // Implements exact example from newPlan.md specifications
        // ========================================
        
        // Generate Financial Overview using SummaryStatCard per newPlan.md example
        function generateFinancialOverviewAethelred() {
            const financialOverviewData = {
                componentType: 'SummaryStatCard',
                width: 6,
                height: 4,
                data: {
                    header: { 
                        title: 'Financial Overview' 
                    },
                    body: {
                        contentType: 'StatRowList',
                        contentData: [
                            { label: 'Transfer Budget', value: '£45M', valueType: 'neutral' },
                            { label: 'Wage Budget', value: '£2.3M/week', valueType: 'neutral' },
                            { label: 'FFP Status', value: 'Compliant', valueType: 'positive' }
                        ]
                    }
                }
            };
            
            return createCardFromAethelredData(financialOverviewData);
        }
        
        // Generate Team Cohesion card using TeamCohesionCard per newPlan.md example
        function generateTeamCohesionAethelred() {
            const teamCohesionData = {
                componentType: 'TeamCohesionCard',
                width: 8,
                height: 5,
                data: {
                    header: { 
                        title: 'Team Cohesion' 
                    },
                    body: {
                        contentType: 'MixedStatList',
                        contentData: [
                            { 
                                type: 'StatBarRow', 
                                data: { 
                                    label: 'Unity',
                                    bar: { value: 85, maxValue: 100, status: 'high' },
                                    valueText: '85%'
                                }
                            },
                            { 
                                type: 'StatRow', 
                                data: { label: 'Social Groups', value: 4, valueType: 'neutral' }
                            },
                            { 
                                type: 'StatRow', 
                                data: { label: 'Happy Players', value: '22/28', valueType: 'positive' }
                            }
                        ]
                    }
                }
            };
            
            return createCardFromAethelredData(teamCohesionData);
        }
        
        // Generate Formation card using FormationCard per newPlan.md example
        function generateFormationAethelred() {
            const formationData = {
                componentType: 'FormationCard',
                width: 10,
                height: 6,
                data: {
                    header: { 
                        title: 'Formation' 
                    },
                    body: {
                        contentType: 'FormationDisplay',
                        contentData: {
                            formationName: '4-2-3-1 Wide',
                            tacticName: 'Fluid Counter-Attack',
                            familiarity: 95,
                            players: [
                                { name: 'Onana', position: 'GK', coords: {x: 0.5, y: 0.05} },
                                { name: 'Dalot', position: 'RB', coords: {x: 0.85, y: 0.25} },
                                { name: 'Varane', position: 'CB', coords: {x: 0.65, y: 0.25} },
                                { name: 'Martinez', position: 'CB', coords: {x: 0.35, y: 0.25} },
                                { name: 'Shaw', position: 'LB', coords: {x: 0.15, y: 0.25} },
                                { name: 'Casemiro', position: 'DM', coords: {x: 0.6, y: 0.45} },
                                { name: 'Mainoo', position: 'CM', coords: {x: 0.4, y: 0.45} },
                                { name: 'Garnacho', position: 'RW', coords: {x: 0.8, y: 0.65} },
                                { name: 'Bruno', position: 'AM', coords: {x: 0.5, y: 0.65} },
                                { name: 'Rashford', position: 'LW', coords: {x: 0.2, y: 0.65} },
                                { name: 'Hojlund', position: 'ST', coords: {x: 0.5, y: 0.85} }
                            ]
                        }
                    }
                }
            };
            
            return createCardFromAethelredData(formationData);
        }
        
        // Generate First Team Squad using RosterCard per newPlan.md example  
        function generateFirstTeamSquadAethelred() {
            const rosterData = {
                componentType: 'RosterCard',
                width: 11,
                height: 7,
                data: {
                    header: { 
                        title: 'First Team Squad' 
                    },
                    body: {
                        contentType: 'DataTable',
                        contentData: {
                            headers: ['Name', 'Pos', 'Age', 'Nat', 'Avg', 'Value'],
                            rows: [
                                ['Andre Onana', 'GK', 28, 'CMR', 7.4, '£40M'],
                                ['Diogo Dalot', 'RB', 25, 'POR', 7.2, '£35M'],
                                ['Raphael Varane', 'CB', 31, 'FRA', 7.5, '£35M'],
                                ['Lisandro Martinez', 'CB', 26, 'ARG', 7.6, '£55M'],
                                ['Luke Shaw', 'LB', 29, 'ENG', 7.3, '£28M'],
                                ['Casemiro', 'DM', 32, 'BRA', 7.5, '£45M'],
                                ['Kobbie Mainoo', 'CM', 19, 'ENG', 7.3, '£40M'],
                                ['Bruno Fernandes', 'AM', 29, 'POR', 8.2, '£75M'],
                                ['Alejandro Garnacho', 'LW', 20, 'ARG', 7.4, '£50M'],
                                ['Marcus Rashford', 'LW', 26, 'ENG', 7.8, '£85M'],
                                ['Rasmus Hojlund', 'ST', 21, 'DEN', 7.2, '£65M']
                            ]
                        }
                    }
                }
            };
            
            return createCardFromAethelredData(rosterData);
        }

        // Keyboard navigation
        document.addEventListener('keydown', (e) => {
            const activePage = document.querySelector('.content-page.active');
            if (!activePage) return;
            
            const pageName = activePage.id.replace('-page', '');
            const state = pageStates.get(pageName);
            
            if (state.currentView === 'single') {
                if (e.key === 'ArrowLeft') {
                    selectCard(pageName, Math.max(0, state.selectedCardIndex - 1));
                } else if (e.key === 'ArrowRight') {
                    const cardCount = state.cards.length;
                    selectCard(pageName, Math.min(cardCount - 1, state.selectedCardIndex + 1));
                } else if (e.key === 'Escape') {
                    showGridView(pageName);
                }
            }
        });

        // Content generation functions
        function generateMatchPreview() {
            return `
                <div class="stat-row">
                    <span class="stat-label">Next Match</span>
                    <span class="stat-value">vs Liverpool</span>
                </div>
                <div class="stat-row">
                    <span class="stat-label">Competition</span>
                    <span class="stat-value">Premier League</span>
                </div>
                <div class="stat-row">
                    <span class="stat-label">Date</span>
                    <span class="stat-value">20 Aug 2024</span>
                </div>
                <div class="stat-row">
                    <span class="stat-label">Venue</span>
                    <span class="stat-value">Old Trafford</span>
                </div>
                <div class="stat-row">
                    <span class="stat-label">Form</span>
                    <span class="stat-value">WWDLW</span>
                </div>
            `;
        }

        function generateSquadSummary() {
            return `
                <div class="stat-row">
                    <span class="stat-label">Total Players</span>
                    <span class="stat-value">28</span>
                </div>
                <div class="stat-row">
                    <span class="stat-label">First Team</span>
                    <span class="stat-value">23</span>
                </div>
                <div class="stat-row">
                    <span class="stat-label">Reserves</span>
                    <span class="stat-value">5</span>
                </div>
                <div class="stat-row">
                    <span class="stat-label">Average Age</span>
                    <span class="stat-value">26.3 years</span>
                </div>
                <div class="stat-row">
                    <span class="stat-label">Youngest Player</span>
                    <span class="stat-value">Mainoo (19)</span>
                </div>
                <div class="stat-row">
                    <span class="stat-label">Oldest Player</span>
                    <span class="stat-value">Heaton (38)</span>
                </div>
                <div class="stat-row">
                    <span class="stat-label">Foreign Players</span>
                    <span class="stat-value">18/25</span>
                </div>
                <div class="stat-row">
                    <span class="stat-label">Home Grown</span>
                    <span class="stat-value">7/8 required</span>
                </div>
                <div class="stat-row">
                    <span class="stat-label">EU Players</span>
                    <span class="stat-value">8</span>
                </div>
                <div class="stat-row">
                    <span class="stat-label">Non-EU Players</span>
                    <span class="stat-value">10</span>
                </div>
                <div class="stat-row">
                    <span class="stat-label">Team Value</span>
                    <span class="stat-value">£842M</span>
                </div>
                <div class="stat-row">
                    <span class="stat-label">Avg Player Value</span>
                    <span class="stat-value">£30M</span>
                </div>
                <div class="stat-row">
                    <span class="stat-label">Highest Value</span>
                    <span class="stat-value">Rashford (£85M)</span>
                </div>
                <div class="stat-row">
                    <span class="stat-label">Total Wages</span>
                    <span class="stat-value">£3.2M/week</span>
                </div>
                <div class="stat-row">
                    <span class="stat-label">Highest Earner</span>
                    <span class="stat-value">Casemiro (£350K/w)</span>
                </div>
                <div class="stat-row">
                    <span class="stat-label">Average Wage</span>
                    <span class="stat-value">£114K/week</span>
                </div>
                <div class="stat-row">
                    <span class="stat-label">Squad Morale</span>
                    <span class="stat-value"><span class="badge badge-success">Excellent</span></span>
                </div>
                <div class="stat-row">
                    <span class="stat-label">Team Cohesion</span>
                    <span class="stat-value">82%</span>
                </div>
                <div class="stat-row">
                    <span class="stat-label">Dressing Room</span>
                    <span class="stat-value">United</span>
                </div>
                <div class="stat-row">
                    <span class="stat-label">Captain</span>
                    <span class="stat-value">Bruno Fernandes</span>
                </div>
                <div class="stat-row">
                    <span class="stat-label">Vice Captain</span>
                    <span class="stat-value">Casemiro</span>
                </div>
            `;
        }

        function generateLeagueTable() {
            return `
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>#</th>
                            <th>Team</th>
                            <th>P</th>
                            <th>W</th>
                            <th>D</th>
                            <th>L</th>
                            <th>GF</th>
                            <th>GA</th>
                            <th>GD</th>
                            <th>Pts</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr><td>1</td><td>Man City</td><td>3</td><td>3</td><td>0</td><td>0</td><td>10</td><td>2</td><td>+8</td><td>9</td></tr>
                        <tr><td>2</td><td>Arsenal</td><td>3</td><td>2</td><td>1</td><td>0</td><td>8</td><td>3</td><td>+5</td><td>7</td></tr>
                        <tr><td>3</td><td>Liverpool</td><td>3</td><td>2</td><td>1</td><td>0</td><td>7</td><td>3</td><td>+4</td><td>7</td></tr>
                        <tr style="background: rgba(0,148,204,0.1);"><td>4</td><td>Man United</td><td>3</td><td>2</td><td>0</td><td>1</td><td>5</td><td>3</td><td>+2</td><td>6</td></tr>
                        <tr><td>5</td><td>Brighton</td><td>3</td><td>2</td><td>0</td><td>1</td><td>6</td><td>5</td><td>+1</td><td>6</td></tr>
                        <tr><td>6</td><td>Chelsea</td><td>3</td><td>1</td><td>2</td><td>0</td><td>5</td><td>4</td><td>+1</td><td>5</td></tr>
                        <tr><td>7</td><td>Newcastle</td><td>3</td><td>1</td><td>2</td><td>0</td><td>4</td><td>3</td><td>+1</td><td>5</td></tr>
                        <tr><td>8</td><td>Tottenham</td><td>3</td><td>1</td><td>1</td><td>1</td><td>4</td><td>4</td><td>0</td><td>4</td></tr>
                        <tr><td>9</td><td>West Ham</td><td>3</td><td>1</td><td>1</td><td>1</td><td>3</td><td>4</td><td>-1</td><td>4</td></tr>
                        <tr><td>10</td><td>Aston Villa</td><td>3</td><td>1</td><td>1</td><td>1</td><td>3</td><td>5</td><td>-2</td><td>4</td></tr>
                        <tr><td>11</td><td>Fulham</td><td>3</td><td>1</td><td>0</td><td>2</td><td>3</td><td>5</td><td>-2</td><td>3</td></tr>
                        <tr><td>12</td><td>Brentford</td><td>3</td><td>1</td><td>0</td><td>2</td><td>3</td><td>6</td><td>-3</td><td>3</td></tr>
                        <tr><td>13</td><td>Crystal Palace</td><td>3</td><td>0</td><td>2</td><td>1</td><td>2</td><td>4</td><td>-2</td><td>2</td></tr>
                        <tr><td>14</td><td>Leicester</td><td>3</td><td>0</td><td>2</td><td>1</td><td>2</td><td>5</td><td>-3</td><td>2</td></tr>
                        <tr><td>15</td><td>Wolves</td><td>3</td><td>0</td><td>2</td><td>1</td><td>1</td><td>3</td><td>-2</td><td>2</td></tr>
                        <tr><td>16</td><td>Ipswich</td><td>3</td><td>0</td><td>1</td><td>2</td><td>2</td><td>5</td><td>-3</td><td>1</td></tr>
                        <tr><td>17</td><td>Southampton</td><td>3</td><td>0</td><td>1</td><td>2</td><td>1</td><td>4</td><td>-3</td><td>1</td></tr>
                        <tr><td>18</td><td>Everton</td><td>3</td><td>0</td><td>1</td><td>2</td><td>1</td><td>5</td><td>-4</td><td>1</td></tr>
                        <tr><td>19</td><td>Bournemouth</td><td>3</td><td>0</td><td>0</td><td>3</td><td>2</td><td>7</td><td>-5</td><td>0</td></tr>
                        <tr><td>20</td><td>Nottm Forest</td><td>3</td><td>0</td><td>0</td><td>3</td><td>1</td><td>6</td><td>-5</td><td>0</td></tr>
                    </tbody>
                </table>
            `;
        }

        function generateFinancialOverview() {
            return `
                <div class="stat-row">
                    <span class="stat-label">Current Balance</span>
                    <span class="stat-value" style="color: var(--accent-200);">£45.2M</span>
                </div>
                <div class="stat-row">
                    <span class="stat-label">Transfer Budget</span>
                    <span class="stat-value">£120M</span>
                </div>
                <div class="stat-row">
                    <span class="stat-label">Remaining Budget</span>
                    <span class="stat-value">£55M</span>
                </div>
                <div class="stat-row">
                    <span class="stat-label">Wage Budget</span>
                    <span class="stat-value">£3.8M/w</span>
                </div>
                <div class="stat-row">
                    <span class="stat-label">Used Wages</span>
                    <span class="stat-value">£2.96M/w (78%)</span>
                </div>
                <div class="stat-row">
                    <span class="stat-label">Available Wages</span>
                    <span class="stat-value">£840K/w</span>
                </div>
                <div class="stat-row">
                    <span class="stat-label">FFP Status</span>
                    <span class="stat-value"><span class="badge badge-success">Compliant</span></span>
                </div>
                <div class="stat-row">
                    <span class="stat-label">FFP Room</span>
                    <span class="stat-value">£48M</span>
                </div>
                <div class="stat-row">
                    <span class="stat-label">Revenue YTD</span>
                    <span class="stat-value">£285M</span>
                </div>
                <div class="stat-row">
                    <span class="stat-label">Expenses YTD</span>
                    <span class="stat-value">£242M</span>
                </div>
                <div class="stat-row">
                    <span class="stat-label">Profit/Loss</span>
                    <span class="stat-value" style="color: var(--accent-200);">+£43M</span>
                </div>
                <div class="stat-row">
                    <span class="stat-label">Projected Annual</span>
                    <span class="stat-value">£580M revenue</span>
                </div>
                <div class="stat-row">
                    <span class="stat-label">Stadium Income</span>
                    <span class="stat-value">£3.8M/match</span>
                </div>
                <div class="stat-row">
                    <span class="stat-label">Merchandise</span>
                    <span class="stat-value">£125M/year</span>
                </div>
                <div class="stat-row">
                    <span class="stat-label">TV Revenue</span>
                    <span class="stat-value">£215M/year</span>
                </div>
                <div class="stat-row">
                    <span class="stat-label">Sponsorship</span>
                    <span class="stat-value">£150M/year</span>
                </div>
            `;
        }

        function generateTrainingSchedule() {
            return `
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>Day</th>
                            <th>Focus</th>
                            <th>Intensity</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr><td>Monday</td><td>Recovery</td><td>Light</td></tr>
                        <tr><td>Tuesday</td><td>Tactical</td><td>Medium</td></tr>
                        <tr><td>Wednesday</td><td>Physical</td><td>High</td></tr>
                        <tr><td>Thursday</td><td>Technical</td><td>Medium</td></tr>
                        <tr><td>Friday</td><td>Set Pieces</td><td>Light</td></tr>
                        <tr><td>Saturday</td><td>Match</td><td>-</td></tr>
                        <tr><td>Sunday</td><td>Rest</td><td>-</td></tr>
                    </tbody>
                </table>
            `;
        }

        function generateSquadList() {
            return `
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>Name</th>
                            <th>Pos</th>
                            <th>Age</th>
                            <th>Nat</th>
                            <th>Apps</th>
                            <th>Gls</th>
                            <th>Ast</th>
                            <th>Avg</th>
                            <th>Value</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr><td>Andre Onana</td><td>GK</td><td>28</td><td>CMR</td><td>3</td><td>0</td><td>0</td><td>7.4</td><td>£40M</td></tr>
                        <tr><td>Tom Heaton</td><td>GK</td><td>38</td><td>ENG</td><td>0</td><td>0</td><td>0</td><td>-</td><td>£500K</td></tr>
                        <tr><td>Altay Bayindir</td><td>GK</td><td>26</td><td>TUR</td><td>0</td><td>0</td><td>0</td><td>-</td><td>£12M</td></tr>
                        <tr><td>Diogo Dalot</td><td>RB</td><td>25</td><td>POR</td><td>3</td><td>0</td><td>1</td><td>7.2</td><td>£35M</td></tr>
                        <tr><td>Aaron Wan-Bissaka</td><td>RB</td><td>26</td><td>ENG</td><td>1</td><td>0</td><td>0</td><td>6.8</td><td>£20M</td></tr>
                        <tr><td>Luke Shaw</td><td>LB</td><td>29</td><td>ENG</td><td>2</td><td>0</td><td>1</td><td>7.3</td><td>£28M</td></tr>
                        <tr><td>Tyrell Malacia</td><td>LB</td><td>25</td><td>NED</td><td>0</td><td>0</td><td>0</td><td>-</td><td>£15M</td></tr>
                        <tr><td>Sergio Reguilon</td><td>LB</td><td>27</td><td>ESP</td><td>0</td><td>0</td><td>0</td><td>-</td><td>£12M</td></tr>
                        <tr><td>Raphael Varane</td><td>CB</td><td>31</td><td>FRA</td><td>2</td><td>0</td><td>0</td><td>7.5</td><td>£35M</td></tr>
                        <tr><td>Lisandro Martinez</td><td>CB</td><td>26</td><td>ARG</td><td>3</td><td>0</td><td>0</td><td>7.6</td><td>£55M</td></tr>
                        <tr><td>Harry Maguire</td><td>CB</td><td>31</td><td>ENG</td><td>1</td><td>0</td><td>0</td><td>6.9</td><td>£20M</td></tr>
                        <tr><td>Victor Lindelof</td><td>CB</td><td>30</td><td>SWE</td><td>1</td><td>0</td><td>0</td><td>6.7</td><td>£18M</td></tr>
                        <tr><td>Jonny Evans</td><td>CB</td><td>36</td><td>NIR</td><td>0</td><td>0</td><td>0</td><td>-</td><td>£2M</td></tr>
                        <tr><td>Casemiro</td><td>DM</td><td>32</td><td>BRA</td><td>3</td><td>1</td><td>0</td><td>7.5</td><td>£45M</td></tr>
                        <tr><td>Sofyan Amrabat</td><td>DM</td><td>28</td><td>MAR</td><td>1</td><td>0</td><td>0</td><td>6.5</td><td>£18M</td></tr>
                        <tr><td>Christian Eriksen</td><td>CM</td><td>32</td><td>DEN</td><td>2</td><td>0</td><td>1</td><td>7.1</td><td>£15M</td></tr>
                        <tr><td>Mason Mount</td><td>CM</td><td>25</td><td>ENG</td><td>1</td><td>0</td><td>0</td><td>6.6</td><td>£55M</td></tr>
                        <tr><td>Scott McTominay</td><td>CM</td><td>27</td><td>SCO</td><td>2</td><td>0</td><td>0</td><td>6.8</td><td>£25M</td></tr>
                        <tr><td>Kobbie Mainoo</td><td>CM</td><td>19</td><td>ENG</td><td>3</td><td>0</td><td>1</td><td>7.3</td><td>£40M</td></tr>
                        <tr><td>Bruno Fernandes (C)</td><td>AM</td><td>29</td><td>POR</td><td>3</td><td>1</td><td>2</td><td>8.2</td><td>£75M</td></tr>
                        <tr><td>Marcus Rashford</td><td>LW</td><td>26</td><td>ENG</td><td>3</td><td>2</td><td>0</td><td>7.8</td><td>£85M</td></tr>
                        <tr><td>Alejandro Garnacho</td><td>LW</td><td>20</td><td>ARG</td><td>3</td><td>1</td><td>1</td><td>7.4</td><td>£50M</td></tr>
                        <tr><td>Jadon Sancho</td><td>RW</td><td>24</td><td>ENG</td><td>0</td><td>0</td><td>0</td><td>-</td><td>£40M</td></tr>
                        <tr><td>Antony</td><td>RW</td><td>24</td><td>BRA</td><td>2</td><td>0</td><td>0</td><td>6.4</td><td>£35M</td></tr>
                        <tr><td>Amad Diallo</td><td>RW</td><td>22</td><td>CIV</td><td>1</td><td>0</td><td>0</td><td>6.7</td><td>£25M</td></tr>
                        <tr><td>Facundo Pellistri</td><td>RW</td><td>22</td><td>URU</td><td>0</td><td>0</td><td>0</td><td>-</td><td>£8M</td></tr>
                        <tr><td>Rasmus Hojlund</td><td>ST</td><td>21</td><td>DEN</td><td>3</td><td>1</td><td>0</td><td>7.2</td><td>£65M</td></tr>
                        <tr><td>Anthony Martial</td><td>ST</td><td>28</td><td>FRA</td><td>0</td><td>0</td><td>0</td><td>-</td><td>£15M</td></tr>
                    </tbody>
                </table>
            `;
        }

        function generatePlayerStats() {
            return `
                <div class="stat-row">
                    <span class="stat-label">Top Scorer</span>
                    <span class="stat-value">Rashford (3)</span>
                </div>
                <div class="stat-row">
                    <span class="stat-label">Top Assists</span>
                    <span class="stat-value">Bruno (2)</span>
                </div>
                <div class="stat-row">
                    <span class="stat-label">Avg Rating</span>
                    <span class="stat-value">7.12</span>
                </div>
                <div class="stat-row">
                    <span class="stat-label">Clean Sheets</span>
                    <span class="stat-value">1</span>
                </div>
            `;
        }

        function generateInjuryReport() {
            return `
                <div class="stat-row">
                    <span class="stat-label">L. Shaw (LB)</span>
                    <span class="stat-value"><span class="badge badge-warning">2 weeks</span></span>
                </div>
                <div class="stat-row">
                    <span class="stat-label">A. Martial (ST)</span>
                    <span class="stat-value"><span class="badge badge-danger">4 weeks</span></span>
                </div>
                <div class="stat-row">
                    <span class="stat-label">T. Malacia (LB)</span>
                    <span class="stat-value"><span class="badge badge-warning">1 week</span></span>
                </div>
            `;
        }

        function generateMorale() {
            return `
                <div class="stat-row">
                    <span class="stat-label">Squad Morale</span>
                    <span class="stat-value"><span class="badge badge-success">Excellent</span></span>
                </div>
                <div class="stat-row">
                    <span class="stat-label">Dressing Room</span>
                    <span class="stat-value">United</span>
                </div>
                <div class="stat-row">
                    <span class="stat-label">Team Leaders</span>
                    <span class="stat-value">Bruno, Casemiro</span>
                </div>
            `;
        }

        function generateFormation() {
            return `
                <div style="text-align: center; padding: 20px;">
                    <div style="font-size: 28px; font-weight: bold; color: var(--primary-400);">4-2-3-1</div>
                    <div style="margin-top: 10px; color: rgba(255,255,255,0.6);">Balanced Attack</div>
                    <div style="margin-top: 20px; font-size: 12px;">
                        <div>GK: Onana</div>
                        <div>DEF: Dalot - Varane - Martinez - Shaw</div>
                        <div>MID: Casemiro - Eriksen</div>
                        <div>ATT: Antony - Bruno - Rashford</div>
                        <div>ST: Hojlund</div>
                    </div>
                </div>
            `;
        }

        function generateInstructions() {
            return `
                <div class="stat-row">
                    <span class="stat-label">Mentality</span>
                    <span class="stat-value">Positive</span>
                </div>
                <div class="stat-row">
                    <span class="stat-label">Width</span>
                    <span class="stat-value">Fairly Wide</span>
                </div>
                <div class="stat-row">
                    <span class="stat-label">Tempo</span>
                    <span class="stat-value">Higher</span>
                </div>
                <div class="stat-row">
                    <span class="stat-label">Defensive Line</span>
                    <span class="stat-value">Standard</span>
                </div>
                <div class="stat-row">
                    <span class="stat-label">Pressing</span>
                    <span class="stat-value">More Often</span>
                </div>
            `;
        }

        function generateSetPieces() {
            return `
                <div class="stat-row">
                    <span class="stat-label">Corners</span>
                    <span class="stat-value">Bruno Fernandes</span>
                </div>
                <div class="stat-row">
                    <span class="stat-label">Free Kicks</span>
                    <span class="stat-value">Rashford / Bruno</span>
                </div>
                <div class="stat-row">
                    <span class="stat-label">Penalties</span>
                    <span class="stat-value">Bruno Fernandes</span>
                </div>
                <div class="stat-row">
                    <span class="stat-label">Throw Ins</span>
                    <span class="stat-value">Long</span>
                </div>
            `;
        }

        function generateOpposition() {
            return `
                <div class="stat-row">
                    <span class="stat-label">Liverpool</span>
                    <span class="stat-value">Press Salah</span>
                </div>
                <div class="stat-row">
                    <span class="stat-label">Man City</span>
                    <span class="stat-value">Tight Marking</span>
                </div>
                <div class="stat-row">
                    <span class="stat-label">Arsenal</span>
                    <span class="stat-value">Show Weaker Foot</span>
                </div>
            `;
        }

        function generateFitnessLevels() {
            return `
                <div class="stat-row">
                    <span class="stat-label">Squad Fitness</span>
                    <span class="stat-value">85%</span>
                </div>
                <div class="stat-row">
                    <span class="stat-label">Match Sharpness</span>
                    <span class="stat-value">78%</span>
                </div>
                <div class="stat-row">
                    <span class="stat-label">Injury Risk</span>
                    <span class="stat-value"><span class="badge badge-warning">Medium</span></span>
                </div>
            `;
        }

        function generateIndividualTraining() {
            return `
                <div class="stat-row">
                    <span class="stat-label">Hojlund</span>
                    <span class="stat-value">Finishing</span>
                </div>
                <div class="stat-row">
                    <span class="stat-label">Garnacho</span>
                    <span class="stat-value">Crossing</span>
                </div>
                <div class="stat-row">
                    <span class="stat-label">Mainoo</span>
                    <span class="stat-value">Passing</span>
                </div>
            `;
        }

        function generateTransferTargets() {
            return `
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>Name</th>
                            <th>Club</th>
                            <th>Pos</th>
                            <th>Age</th>
                            <th>Scout</th>
                            <th>Value</th>
                            <th>Status</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr><td>Jude Bellingham</td><td>Real Madrid</td><td>CM</td><td>21</td><td>95</td><td>£150M</td><td>Unlikely</td></tr>
                        <tr><td>Victor Osimhen</td><td>Napoli</td><td>ST</td><td>25</td><td>92</td><td>£120M</td><td>Interested</td></tr>
                        <tr><td>Jeremie Frimpong</td><td>Leverkusen</td><td>RB</td><td>23</td><td>88</td><td>£35M</td><td>Possible</td></tr>
                        <tr><td>Florian Wirtz</td><td>Leverkusen</td><td>AM</td><td>21</td><td>91</td><td>£85M</td><td>Monitoring</td></tr>
                        <tr><td>Josko Gvardiol</td><td>Man City</td><td>CB</td><td>22</td><td>90</td><td>£75M</td><td>Unlikely</td></tr>
                        <tr><td>Michael Olise</td><td>Crystal Palace</td><td>RW</td><td>22</td><td>85</td><td>£45M</td><td>Interested</td></tr>
                        <tr><td>Evan Ferguson</td><td>Brighton</td><td>ST</td><td>19</td><td>83</td><td>£50M</td><td>Monitoring</td></tr>
                        <tr><td>Enzo Fernandez</td><td>Chelsea</td><td>CM</td><td>23</td><td>89</td><td>£65M</td><td>Unlikely</td></tr>
                        <tr><td>Amadou Onana</td><td>Everton</td><td>DM</td><td>22</td><td>84</td><td>£40M</td><td>Possible</td></tr>
                        <tr><td>Pedro Neto</td><td>Wolves</td><td>LW</td><td>24</td><td>86</td><td>£50M</td><td>Interested</td></tr>
                        <tr><td>Jarrod Bowen</td><td>West Ham</td><td>RW</td><td>27</td><td>82</td><td>£35M</td><td>Backup</td></tr>
                        <tr><td>Ivan Toney</td><td>Brentford</td><td>ST</td><td>28</td><td>81</td><td>£30M</td><td>Backup</td></tr>
                        <tr><td>Moussa Diaby</td><td>Aston Villa</td><td>RW</td><td>25</td><td>83</td><td>£38M</td><td>Monitoring</td></tr>
                        <tr><td>Jean-Clair Todibo</td><td>Nice</td><td>CB</td><td>24</td><td>84</td><td>£32M</td><td>Possible</td></tr>
                        <tr><td>Benjamin Sesko</td><td>RB Leipzig</td><td>ST</td><td>21</td><td>85</td><td>£45M</td><td>Interested</td></tr>
                    </tbody>
                </table>
            `;
        }

        function generateTransferBudget() {
            return `
                <div class="stat-row">
                    <span class="stat-label">Available</span>
                    <span class="stat-value" style="color: var(--accent-200);">£120M</span>
                </div>
                <div class="stat-row">
                    <span class="stat-label">Spent</span>
                    <span class="stat-value">£65M</span>
                </div>
                <div class="stat-row">
                    <span class="stat-label">Wage Room</span>
                    <span class="stat-value">£450k/w</span>
                </div>
            `;
        }

        function generateScoutReports() {
            return `
                <div class="stat-row">
                    <span class="stat-label">New Reports</span>
                    <span class="stat-value">12</span>
                </div>
                <div class="stat-row">
                    <span class="stat-label">Priority Targets</span>
                    <span class="stat-value">3</span>
                </div>
                <div class="stat-row">
                    <span class="stat-label">Scouts Active</span>
                    <span class="stat-value">8</span>
                </div>
            `;
        }

        function generateRevenue() {
            return `
                <div class="stat-row">
                    <span class="stat-label">Matchday</span>
                    <span class="stat-value">£110M</span>
                </div>
                <div class="stat-row">
                    <span class="stat-label">Commercial</span>
                    <span class="stat-value">£275M</span>
                </div>
                <div class="stat-row">
                    <span class="stat-label">Broadcasting</span>
                    <span class="stat-value">£215M</span>
                </div>
            `;
        }

        function generateExpenses() {
            return `
                <div class="stat-row">
                    <span class="stat-label">Wages</span>
                    <span class="stat-value">£198M</span>
                </div>
                <div class="stat-row">
                    <span class="stat-label">Operations</span>
                    <span class="stat-value">£87M</span>
                </div>
                <div class="stat-row">
                    <span class="stat-label">Transfers</span>
                    <span class="stat-value">£125M</span>
                </div>
            `;
        }

        function generateForecast() {
            return `
                <div class="stat-row">
                    <span class="stat-label">Projected Profit</span>
                    <span class="stat-value" style="color: var(--accent-200);">£45M</span>
                </div>
                <div class="stat-row">
                    <span class="stat-label">FFP Status</span>
                    <span class="stat-value"><span class="badge badge-success">Compliant</span></span>
                </div>
                <div class="stat-row">
                    <span class="stat-label">Next Season Budget</span>
                    <span class="stat-value">£180M</span>
                </div>
            `;
        }

        function generateFFPStatus() {
            return `
                <div class="stat-row">
                    <span class="stat-label">Current Status</span>
                    <span class="stat-value"><span class="badge badge-success">Compliant</span></span>
                </div>
                <div class="stat-row">
                    <span class="stat-label">Squad Cost</span>
                    <span class="stat-value">82%</span>
                </div>
                <div class="stat-row">
                    <span class="stat-label">Margin</span>
                    <span class="stat-value">£48M</span>
                </div>
            `;
        }

        function generateFixtures() {
            return `
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>Date</th>
                            <th>Opponent</th>
                            <th>Venue</th>
                            <th>Comp</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr><td>20 Aug</td><td>Liverpool</td><td>H</td><td>PL</td></tr>
                        <tr><td>24 Aug</td><td>Galatasaray</td><td>A</td><td>UCL</td></tr>
                        <tr><td>27 Aug</td><td>Brighton</td><td>A</td><td>PL</td></tr>
                        <tr><td>02 Sep</td><td>Arsenal</td><td>H</td><td>PL</td></tr>
                    </tbody>
                </table>
            `;
        }

        function generateRecentForm() {
            return `
                <div class="stat-row">
                    <span class="stat-label">Last 5 Matches</span>
                    <span class="stat-value">W W D L W</span>
                </div>
                <div class="stat-row">
                    <span class="stat-label">Goals Scored</span>
                    <span class="stat-value">12</span>
                </div>
                <div class="stat-row">
                    <span class="stat-label">Goals Conceded</span>
                    <span class="stat-value">7</span>
                </div>
                <div class="stat-row">
                    <span class="stat-label">Points</span>
                    <span class="stat-value">10/15</span>
                </div>
            `;
        }
        
        function generateResults() {
            return `
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>Date</th>
                            <th>Result</th>
                            <th>Comp</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr><td>13 Aug</td><td>W 2-1 vs Wolves</td><td>PL</td></tr>
                        <tr><td>06 Aug</td><td>L 0-2 vs Spurs</td><td>PL</td></tr>
                        <tr><td>01 Aug</td><td>W 3-0 vs Fulham</td><td>PL</td></tr>
                    </tbody>
                </table>
            `;
        }

        function generateCompetitions() {
            return `
                <div class="stat-row">
                    <span class="stat-label">Premier League</span>
                    <span class="stat-value">4th</span>
                </div>
                <div class="stat-row">
                    <span class="stat-label">Champions League</span>
                    <span class="stat-value">Group Stage</span>
                </div>
                <div class="stat-row">
                    <span class="stat-label">FA Cup</span>
                    <span class="stat-value">R3</span>
                </div>
                <div class="stat-row">
                    <span class="stat-label">Carabao Cup</span>
                    <span class="stat-value">R4</span>
                </div>
            `;
        }

        // REMOVED OLD RESIZE FUNCTION - See initResize below for the correct implementation

        // Grid Layout with explicit positioning support
        function layoutCards(container) {
            if (!container) return;
            
            console.log('layoutCards called on container:', container.id || container.className);
            const cards = Array.from(container.querySelectorAll('.card')).filter(card => !card.classList.contains('drag-placeholder'));
            
            // Build grid occupation map using configuration
            const grid = [];
            const maxRows = Math.max(30, GRID_CONFIG.rows * 2); // Allow for overflow
            for (let i = 0; i < maxRows; i++) {
                grid[i] = new Array(GRID_CONFIG.columns).fill(false);
            }
            
            // First pass: place cards with explicit positions
            const cardsToAutoPlace = [];
            
            cards.forEach((card, index) => {
                // Get dimensions from data attributes first (most reliable)
                let width = parseInt(card.getAttribute('data-grid-w'));
                let height = parseInt(card.getAttribute('data-grid-h'));
                
                // Fallback to CSS classes if no data attributes
                if (!width) {
                    for (let w = 1; w <= GRID_CONFIG.maxCSSClasses.width; w++) {
                        if (card.classList.contains(`w${w}`)) {
                            width = w;
                            break;
                        }
                    }
                    width = width || GRID_CONFIG.defaultCardWidth;
                }
                if (!height) {
                    for (let h = 1; h <= GRID_CONFIG.maxCSSClasses.height; h++) {
                        if (card.classList.contains(`h${h}`)) {
                            height = h;
                            break;
                        }
                    }
                    height = height || GRID_CONFIG.defaultCardHeight;
                }
                console.log(`Card ${index}: detected w${width} h${height}, classes:`, card.className);
                
                // Check if card has explicit positioning
                const gridColumn = card.style.gridColumn;
                const gridRow = card.style.gridRow;
                
                if (gridColumn && gridRow) {
                    // Extract position from CSS grid values
                    const colMatch = gridColumn.match(/(\d+)\s*\/\s*span\s*(\d+)/);
                    const rowMatch = gridRow.match(/(\d+)\s*\/\s*span\s*(\d+)/);
                    
                    if (colMatch && rowMatch) {
                        const col = parseInt(colMatch[1]) - 1; // Convert to 0-indexed
                        const row = parseInt(rowMatch[1]) - 1;
                        
                        // Mark space as occupied
                        for (let r = 0; r < height && row + r < maxRows; r++) {
                            for (let c = 0; c < width && col + c < GRID_CONFIG.columns; c++) {
                                grid[row + r][col + c] = true;
                            }
                        }
                    }
                } else {
                    cardsToAutoPlace.push(card);
                }
            });
            
            // Second pass: auto-place remaining cards
            cardsToAutoPlace.forEach((card, index) => {
                // Get dimensions from data attributes first (most reliable)
                let width = parseInt(card.getAttribute('data-grid-w'));
                let height = parseInt(card.getAttribute('data-grid-h'));
                
                // Fallback to CSS classes if no data attributes
                if (!width) {
                    for (let w = 1; w <= GRID_CONFIG.maxCSSClasses.width; w++) {
                        if (card.classList.contains(`w${w}`)) {
                            width = w;
                            break;
                        }
                    }
                    width = width || GRID_CONFIG.defaultCardWidth;
                }
                if (!height) {
                    for (let h = 1; h <= GRID_CONFIG.maxCSSClasses.height; h++) {
                        if (card.classList.contains(`h${h}`)) {
                            height = h;
                            break;
                        }
                    }
                    height = height || GRID_CONFIG.defaultCardHeight;
                }
                console.log(`Auto-placing card ${index}: w${width} h${height}`);
                
                // Find first available spot
                let placed = false;
                for (let row = 0; row < maxRows - height + 1 && !placed; row++) {
                    for (let col = 0; col <= GRID_CONFIG.columns - width && !placed; col++) {
                        // Check if space is free
                        let canPlace = true;
                        for (let r = 0; r < height; r++) {
                            for (let c = 0; c < width; c++) {
                                if (grid[row + r][col + c]) {
                                    canPlace = false;
                                    break;
                                }
                            }
                            if (!canPlace) break;
                        }
                        
                        if (canPlace) {
                            // Mark space as occupied
                            for (let r = 0; r < height; r++) {
                                for (let c = 0; c < width; c++) {
                                    grid[row + r][col + c] = true;
                                }
                            }
                            // Place card (grid is 1-indexed in CSS)
                            card.style.gridColumn = `${col + 1} / span ${width}`;
                            card.style.gridRow = `${row + 1} / span ${height}`;
                            placed = true;
                        }
                    }
                }
            });
        }
        
        // Resize functionality for grid sizes
        function initResize() {
            // Bottom-right handles
            document.querySelectorAll('.resize-handle').forEach(handle => {
                if (!handle.hasAttribute('data-resize-initialized')) {
                    handle.addEventListener('mousedown', (e) => initResizing(e, 'br'));
                    handle.setAttribute('data-resize-initialized', 'true');
                }
            });
            
            // Bottom-left handles
            document.querySelectorAll('.resize-handle-bl').forEach(handle => {
                if (!handle.hasAttribute('data-resize-initialized')) {
                    handle.addEventListener('mousedown', (e) => initResizing(e, 'bl'));
                    handle.setAttribute('data-resize-initialized', 'true');
                }
            });
        }

        // Helper function to get all cards and their positions
        function getCardPositions(container, excludeCard = null) {
            const cards = Array.from(container.querySelectorAll('.card')).filter(c => 
                c !== excludeCard && !c.classList.contains('drag-placeholder')
            );
            
            return cards.map(card => {
                const gridCol = card.style.gridColumn;
                const gridRow = card.style.gridRow;
                let col = 1, row = 1, width = 1, height = 1;
                
                // Extract position
                if (gridCol) {
                    const match = gridCol.match(/(\d+)\s*\/\s*span\s*(\d+)/);
                    if (match) {
                        col = parseInt(match[1]);
                        width = parseInt(match[2]);
                    } else if (gridCol.includes('span')) {
                        width = parseInt(gridCol.match(/span\s*(\d+)/)[1]);
                    }
                }
                
                if (gridRow) {
                    const match = gridRow.match(/(\d+)\s*\/\s*span\s*(\d+)/);
                    if (match) {
                        row = parseInt(match[1]);
                        height = parseInt(match[2]);
                    } else if (gridRow.includes('span')) {
                        height = parseInt(gridRow.match(/span\s*(\d+)/)[1]);
                    }
                }
                
                // Fallback to data attributes
                width = parseInt(card.getAttribute('data-grid-w')) || width;
                height = parseInt(card.getAttribute('data-grid-h')) || height;
                
                return {
                    card,
                    col,
                    row,
                    width,
                    height,
                    endCol: col + width - 1,
                    endRow: row + height - 1
                };
            });
        }
        
        // Check if two rectangles overlap
        function rectanglesOverlap(r1, r2) {
            return !(r1.endCol < r2.col || r2.endCol < r1.col ||
                     r1.endRow < r2.row || r2.endRow < r1.row);
        }
        
        // Push cards in a specific direction with auto-squishing
        function pushCard(card, direction, distance, allCards) {
            const cardPos = allCards.find(c => c.card === card);
            if (!cardPos) return false;
            
            // Get card's minimum size (its creation size)
            const minWidth = parseInt(card.getAttribute('data-grid-w')) || cardPos.width;
            const minHeight = parseInt(card.getAttribute('data-grid-h')) || cardPos.height;
            
            let newCol = cardPos.col;
            let newRow = cardPos.row;
            let newWidth = cardPos.width;
            let newHeight = cardPos.height;
            
            switch(direction) {
                case 'right': newCol += distance; break;
                case 'left': newCol -= distance; break;
                case 'down': newRow += distance; break;
                case 'up': newRow -= distance; break;
            }
            
            // First check if position is out of bounds
            if (newCol < 1 || newRow < 1) {
                return false;
            }
            
            // If the card would go out of bounds, try to squish it
            let squished = false;
            if (newCol + cardPos.width - 1 > GRID_CONFIG.columns) {
                // Try to squish width
                newWidth = GRID_CONFIG.columns - newCol + 1;
                if (newWidth < minWidth) {
                    // Can't squish enough, adjust position too
                    newCol = GRID_CONFIG.columns - minWidth + 1;
                    newWidth = minWidth;
                    if (newCol < 1) return false; // Can't fit at all
                }
                squished = true;
            }
            
            if (newRow + cardPos.height - 1 > GRID_CONFIG.rows) {
                // Try to squish height
                newHeight = GRID_CONFIG.rows - newRow + 1;
                if (newHeight < minHeight) {
                    // Can't squish enough, adjust position too
                    newRow = GRID_CONFIG.rows - minHeight + 1;
                    newHeight = minHeight;
                    if (newRow < 1) return false; // Can't fit at all
                }
                squished = true;
            }
            
            // Check for collisions with other cards and try to squish if needed
            let testPos = {
                col: newCol,
                row: newRow,
                width: newWidth,
                height: newHeight,
                endCol: newCol + newWidth - 1,
                endRow: newRow + newHeight - 1
            };
            
            const overlappingCards = allCards.filter(other => 
                other.card !== card && rectanglesOverlap(testPos, other)
            );
            
            if (overlappingCards.length > 0) {
                // Try to squish to fit
                for (const other of overlappingCards) {
                    if (direction === 'right' || direction === 'left') {
                        // Squish width to avoid collision
                        const availableWidth = other.col - newCol;
                        if (availableWidth >= minWidth && availableWidth < newWidth) {
                            newWidth = availableWidth;
                            squished = true;
                        }
                    } else if (direction === 'down' || direction === 'up') {
                        // Squish height to avoid collision
                        const availableHeight = other.row - newRow;
                        if (availableHeight >= minHeight && availableHeight < newHeight) {
                            newHeight = availableHeight;
                            squished = true;
                        }
                    }
                }
                
                // Recheck with new dimensions
                testPos = {
                    col: newCol,
                    row: newRow,
                    width: newWidth,
                    height: newHeight,
                    endCol: newCol + newWidth - 1,
                    endRow: newRow + newHeight - 1
                };
                
                const stillOverlapping = allCards.some(other => 
                    other.card !== card && rectanglesOverlap(testPos, other)
                );
                
                if (stillOverlapping) {
                    return false; // Can't push even with squishing
                }
            }
            
            // Add animation class
            card.classList.add('transitioning', 'pushed');
            if (squished) card.classList.add('squished');
            
            // Update position and size
            card.style.gridColumn = `${newCol} / span ${newWidth}`;
            card.style.gridRow = `${newRow} / span ${newHeight}`;
            
            // Update size classes if squished
            if (squished) {
                // Remove old size classes
                for (let w = 1; w <= GRID_CONFIG.maxCSSClasses.width; w++) {
                    card.classList.remove(`w${w}`);
                }
                for (let h = 1; h <= GRID_CONFIG.maxCSSClasses.height; h++) {
                    card.classList.remove(`h${h}`);
                }
                // Add new size classes
                card.classList.add(`w${newWidth}`, `h${newHeight}`);
                card.setAttribute('data-grid-w', newWidth);
                card.setAttribute('data-grid-h', newHeight);
            }
            
            cardPos.col = newCol;
            cardPos.row = newRow;
            cardPos.width = newWidth;
            cardPos.height = newHeight;
            cardPos.endCol = testPos.endCol;
            cardPos.endRow = testPos.endRow;
            
            // Remove animation classes after transition
            setTimeout(() => {
                card.classList.remove('transitioning', 'pushed', 'squished');
            }, 300);
            
            return true;
        }
        
        function initResizing(e, corner = 'br') {
            e.preventDefault();
            e.stopPropagation();
            
            const card = e.target.closest('.card');
            if (!card) return;
            
            console.log(`=== RESIZE START (${corner}) ===`);
            
            const container = card.closest('.tile-container');
            const gridOverlay = container?.querySelector('.grid-overlay');
            
            // Show grid overlay
            if (gridOverlay) gridOverlay.classList.add('active');
            
            // Get STARTING dimensions
            let startWidth = parseInt(card.getAttribute('data-grid-w'));
            let startHeight = parseInt(card.getAttribute('data-grid-h'));
            
            // Fallback to reading from classes if no data attributes
            if (!startWidth) {
                for (let w = 1; w <= GRID_CONFIG.maxCSSClasses.width; w++) {
                    if (card.classList.contains(`w${w}`)) {
                        startWidth = w;
                        break;
                    }
                }
                startWidth = startWidth || GRID_CONFIG.defaultCardWidth;
            }
            if (!startHeight) {
                for (let h = 1; h <= GRID_CONFIG.maxCSSClasses.height; h++) {
                    if (card.classList.contains(`h${h}`)) {
                        startHeight = h;
                        break;
                    }
                }
                startHeight = startHeight || GRID_CONFIG.defaultCardHeight;
            }
            
            console.log(`Starting dimensions: w${startWidth} h${startHeight}`);
            
            const startX = e.clientX;
            const startY = e.clientY;
            
            // Get current position from grid styles
            const gridColumn = card.style.gridColumn;
            const gridRow = card.style.gridRow;
            let colStart = 1, rowStart = 1;
            
            // Extract starting position if explicitly set
            if (gridColumn && gridColumn.includes('/')) {
                const match = gridColumn.match(/(\d+)\s*\/\s*span/);
                if (match) colStart = parseInt(match[1]);
            }
            if (gridRow && gridRow.includes('/')) {
                const match = gridRow.match(/(\d+)\s*\/\s*span/);
                if (match) rowStart = parseInt(match[1]);
            }
            
            // Store INITIAL positions and dimensions at start of resize
            const initialColStart = colStart;
            const initialRowStart = rowStart;
            const initialWidth = startWidth;
            const initialHeight = startHeight;
            const initialRightEdge = colStart + startWidth - 1; // For bottom-left resize
            
            console.log(`Starting position: col ${colStart}, row ${rowStart}`);
            
            // Use sensible minimums that don't cause snapping
            // Since cards can be created at 6×3, that should be our minimum
            const MIN_WIDTH = 6;   // Smallest card width (stat cards)
            const MIN_HEIGHT = 3;  // Smallest card height
            const CELL_SIZE = GRID_CONFIG.cellSizeWithGap;
            
            console.log(`Using minimum size: ${MIN_WIDTH}×${MIN_HEIGHT}`);
            
            // Store original positions of all cards for undo
            const originalPositions = getCardPositions(container);
            let lastValidWidth = startWidth;
            let lastValidHeight = startHeight;
            
            function doResize(e) {
                const deltaX = e.clientX - startX;
                const deltaY = e.clientY - startY;
                
                // Calculate cell deltas
                const cellsDeltaX = Math.round(deltaX / CELL_SIZE);
                const cellsDeltaY = Math.round(deltaY / CELL_SIZE);
                
                let desiredWidth, desiredHeight, newColStart, newRowStart;
                
                if (corner === 'br') {
                    // Bottom-right: simple resize from fixed top-left
                    // Use INITIAL position, add delta
                    desiredWidth = Math.max(MIN_WIDTH, Math.min(GRID_CONFIG.columns - initialColStart + 1, initialWidth + cellsDeltaX));
                    desiredHeight = Math.max(MIN_HEIGHT, Math.min(GRID_CONFIG.rows - initialRowStart + 1, initialHeight + cellsDeltaY));
                    newColStart = initialColStart; // Position never changes for BR
                    newRowStart = initialRowStart;
                } else {
                    // Bottom-left: resize from fixed top-right corner
                    // The right edge must stay at its INITIAL position
                    
                    console.log(`BL resize: initialRightEdge=${initialRightEdge}, initialWidth=${initialWidth}, cellsDeltaX=${cellsDeltaX}`);
                    
                    // Calculate new width based on initial width and delta
                    // When dragging left (negative cellsDeltaX), width increases
                    desiredWidth = Math.max(MIN_WIDTH, initialWidth - cellsDeltaX);
                    desiredHeight = Math.max(MIN_HEIGHT, Math.min(GRID_CONFIG.rows - initialRowStart + 1, initialHeight + cellsDeltaY));
                    
                    // Calculate new left position to keep right edge at initial position
                    newColStart = initialRightEdge - desiredWidth + 1;
                    newRowStart = initialRowStart;
                    
                    console.log(`BL resize: desiredWidth=${desiredWidth}, newColStart=${newColStart}`);
                    
                    // Boundary checks
                    if (newColStart < 1) {
                        // Hit left boundary - clamp position and adjust width
                        newColStart = 1;
                        desiredWidth = initialRightEdge;  // Width from column 1 to initial right edge
                    }
                    
                    // Ensure we don't exceed maximum width
                    if (desiredWidth > GRID_CONFIG.columns) {
                        desiredWidth = GRID_CONFIG.columns;
                        newColStart = initialRightEdge - desiredWidth + 1;
                    }
                }
                
                // Only process if size actually changed
                if (desiredWidth === lastValidWidth && desiredHeight === lastValidHeight && 
                    newColStart === colStart && newRowStart === rowStart) {
                    return;
                }
                
                console.log(`Attempting resize to: w${desiredWidth} h${desiredHeight} at (${newColStart}, ${newRowStart})`);
                
                // Get current positions of all cards
                const allCards = getCardPositions(container, card);
                
                // Calculate the new bounds for the resizing card
                const newBounds = {
                    col: newColStart,
                    row: newRowStart,
                    width: desiredWidth,
                    height: desiredHeight,
                    endCol: newColStart + desiredWidth - 1,
                    endRow: newRowStart + desiredHeight - 1
                };
                
                // Check if we're shrinking (always allow shrinking)
                const isShrinking = desiredWidth < lastValidWidth || desiredHeight < lastValidHeight;
                
                if (!isShrinking) {
                    // Only check overlaps when expanding
                    const overlappingCards = allCards.filter(other => 
                        rectanglesOverlap(newBounds, other)
                    );
                    
                    if (overlappingCards.length > 0) {
                        console.log(`Found ${overlappingCards.length} overlapping cards`);
                        
                        // Check if any overlapping card is pinned
                        const pinnedOverlap = overlappingCards.find(other => other.card.classList.contains('pinned'));
                        if (pinnedOverlap) {
                            console.log('Cannot resize - would overlap with pinned card');
                            return; // Block resize
                        }
                        
                        // Determine push direction based on resize
                        const isExpandingRight = corner === 'br' && desiredWidth > lastValidWidth;
                        const isExpandingLeft = corner === 'bl' && desiredWidth > lastValidWidth;
                        const isExpandingDown = desiredHeight > lastValidHeight;
                        
                        let canPush = true;
                        const pushOperations = [];
                        
                        // Try to push overlapping cards
                        for (const overlap of overlappingCards) {
                            let pushed = false;
                            
                            if (corner === 'br') {
                                // Bottom-right resize - try to push right or down
                                if (isExpandingRight && overlap.col >= colStart + lastValidWidth) {
                                    // Push right
                                    const pushDistance = newBounds.endCol - overlap.col + 1;
                                    if (overlap.col + overlap.width - 1 + pushDistance <= GRID_CONFIG.columns) {
                                        pushOperations.push({ card: overlap.card, direction: 'right', distance: pushDistance });
                                        pushed = true;
                                    }
                                }
                                
                                if (!pushed && isExpandingDown && overlap.row >= rowStart + lastValidHeight) {
                                    // Push down
                                    const pushDistance = newBounds.endRow - overlap.row + 1;
                                    if (overlap.row + overlap.height - 1 + pushDistance <= GRID_CONFIG.rows) {
                                        pushOperations.push({ card: overlap.card, direction: 'down', distance: pushDistance });
                                        pushed = true;
                                    }
                                }
                            } else {
                                // Bottom-left resize - try to push left or down
                                if (isExpandingLeft) {
                                    // When expanding left, push any overlapping card to the left
                                    const pushDistance = overlap.endCol - newBounds.col + 1;
                                    if (overlap.col - pushDistance >= 1) {
                                        pushOperations.push({ card: overlap.card, direction: 'left', distance: pushDistance });
                                        pushed = true;
                                    }
                                }
                                
                                if (!pushed && isExpandingDown && overlap.row >= rowStart + lastValidHeight) {
                                    // Push down
                                    const pushDistance = newBounds.endRow - overlap.row + 1;
                                    if (overlap.row + overlap.height - 1 + pushDistance <= GRID_CONFIG.rows) {
                                        pushOperations.push({ card: overlap.card, direction: 'down', distance: pushDistance });
                                        pushed = true;
                                    }
                                }
                            }
                            
                            if (!pushed) {
                                // Can't push this card - block the resize
                                canPush = false;
                                break;
                            }
                        }
                    
                        if (canPush && pushOperations.length > 0) {
                            // Before pushing, verify no push will hit a pinned card
                            for (const op of pushOperations) {
                                // Check if this push would overlap with any pinned card
                                const testCards = getCardPositions(container);
                                for (const test of testCards) {
                                    if (test.card.classList.contains('pinned') && test.card !== op.card) {
                                        // Simulate the push to check for collision
                                        const currentCol = parseInt(op.card.style.gridColumn.match(/(\d+)/)?.[1] || 1);
                                        const currentRow = parseInt(op.card.style.gridRow.match(/(\d+)/)?.[1] || 1);
                                        const cardWidth = parseInt(op.card.getAttribute('data-grid-w') || 1);
                                        const cardHeight = parseInt(op.card.getAttribute('data-grid-h') || 2);
                                        
                                        let newCol = currentCol;
                                        let newRow = currentRow;
                                        if (op.direction === 'right') newCol += op.distance;
                                        if (op.direction === 'left') newCol -= op.distance;
                                        if (op.direction === 'down') newRow += op.distance;
                                        if (op.direction === 'up') newRow -= op.distance;
                                        
                                        const pushBounds = {
                                            col: newCol,
                                            row: newRow,
                                            width: cardWidth,
                                            height: cardHeight,
                                            endCol: newCol + cardWidth - 1,
                                            endRow: newRow + cardHeight - 1
                                        };
                                        
                                        if (rectanglesOverlap(pushBounds, test)) {
                                            console.log('Cannot push - would hit pinned card');
                                            return; // Abort resize
                                        }
                                    }
                                }
                            }
                            
                            // Execute all push operations
                            for (const op of pushOperations) {
                                pushCard(op.card, op.direction, op.distance, allCards);
                            }
                        } else if (!canPush) {
                            console.log('Cannot expand - blocked by other cards');
                            return; // Don't resize if we can't push
                        }
                    }
                }
                
                // Update the resizing card
                lastValidWidth = desiredWidth;
                lastValidHeight = desiredHeight;
                
                // Update card attributes
                card.setAttribute('data-grid-w', desiredWidth);
                card.setAttribute('data-grid-h', desiredHeight);
                
                // Always update position with explicit column/row for clarity
                card.style.gridColumn = `${newColStart} / span ${desiredWidth}`;
                card.style.gridRow = `${newRowStart} / span ${desiredHeight}`;
                
                // Update CSS classes for compatibility
                for (let w = 1; w <= GRID_CONFIG.maxCSSClasses.width; w++) card.classList.remove(`w${w}`);
                for (let h = 1; h <= GRID_CONFIG.maxCSSClasses.height; h++) card.classList.remove(`h${h}`);
                if (desiredWidth <= GRID_CONFIG.maxCSSClasses.width) card.classList.add(`w${desiredWidth}`);
                if (desiredHeight <= GRID_CONFIG.maxCSSClasses.height) card.classList.add(`h${desiredHeight}`);
            }
            
            function stopResize() {
                console.log('=== RESIZE END ===');
                console.log(`Final size: w${card.getAttribute('data-grid-w')} h${card.getAttribute('data-grid-h')}`);
                
                document.removeEventListener('mousemove', doResize);
                document.removeEventListener('mouseup', stopResize);
                
                // Hide grid overlay
                if (gridOverlay) gridOverlay.classList.remove('active');
            }
            
            document.addEventListener('mousemove', doResize);
            document.addEventListener('mouseup', stopResize);
        }
        
        // Sortable Grid with Edge Snapping
        let draggedCard = null;
        let placeholder = null;
        let dropIndicator = null;
        
        function initDragAndDrop() {
            document.querySelectorAll('.card').forEach(card => {
                // Only make header draggable
                const header = card.querySelector('.card-header');
                if (header && !header.hasAttribute('data-drag-initialized')) {
                    header.addEventListener('mousedown', initHeaderDrag);
                    header.setAttribute('data-drag-initialized', 'true');
                }
            });
            
            // Create drop indicator element
            dropIndicator = document.createElement('div');
            dropIndicator.className = 'drop-indicator horizontal';
            document.body.appendChild(dropIndicator);
        }
        
        function initHeaderDrag(e) {
            // Don't prevent default immediately - let double-click work
            // e.preventDefault(); // REMOVED to allow double-click
            
            // Ignore if clicking on buttons or menu items
            if (e.target.closest('.card-menu-btn') || 
                e.target.closest('.card-menu-dropdown') || 
                e.target.closest('.resize-handle') ||
                e.target.closest('.resize-handle-bl')) {
                return;
            }
            
            const card = this.closest('.card');
            
            // Don't allow dragging pinned cards
            if (card.classList.contains('pinned')) {
                return;
            }
            
            // Add a small delay to distinguish from double-click
            let dragTimeout;
            let startX = e.clientX;
            let startY = e.clientY;
            let isDragging = false;
            
            const container = card.parentNode;
            const gridOverlay = container?.querySelector('.grid-overlay');
            
            // Start drag only after mouse moves a minimum distance
            function checkForDrag(moveEvent) {
                const deltaX = Math.abs(moveEvent.clientX - startX);
                const deltaY = Math.abs(moveEvent.clientY - startY);
                
                // If mouse moved more than 5 pixels, start dragging
                if (deltaX > 5 || deltaY > 5) {
                    clearTimeout(dragTimeout);
                    document.removeEventListener('mousemove', checkForDrag);
                    document.removeEventListener('mouseup', cancelDrag);
                    
                    // Now prevent default and start actual drag
                    moveEvent.preventDefault();
                    isDragging = true;
                    
                    // Show grid overlay during drag
                    if (gridOverlay) gridOverlay.classList.add('active');
                    
                    // Continue with drag logic using current mouse position
                    startDragging(card, container, gridOverlay, moveEvent);
                }
            }
            
            function cancelDrag() {
                clearTimeout(dragTimeout);
                document.removeEventListener('mousemove', checkForDrag);
                document.removeEventListener('mouseup', cancelDrag);
            }
            
            // Listen for mouse movement to detect drag intent
            document.addEventListener('mousemove', checkForDrag);
            document.addEventListener('mouseup', cancelDrag);
            
            // Cancel drag detection after 200ms (double-click window)
            dragTimeout = setTimeout(cancelDrag, 200);
        }
        
        function startDragging(card, container, gridOverlay, e) {
            // This is the actual drag logic, moved from initHeaderDrag
            console.log('=== DRAG START ===');
            
            // Create a placeholder
            placeholder = document.createElement('div');
            placeholder.className = 'card drag-placeholder';
            
            // Get card dimensions - try data attributes first, then CSS classes
            let cardWidth = card.getAttribute('data-grid-w');
            let cardHeight = card.getAttribute('data-grid-h');
            
            // If no data attributes, read from CSS classes
            if (!cardWidth) {
                for (let w = 1; w <= GRID_CONFIG.maxCSSClasses.width; w++) {
                    if (card.classList.contains(`w${w}`)) {
                        cardWidth = w;
                        break;
                    }
                }
                cardWidth = cardWidth || GRID_CONFIG.defaultCardWidth;
            }
            if (!cardHeight) {
                for (let h = 1; h <= GRID_CONFIG.maxCSSClasses.height; h++) {
                    if (card.classList.contains(`h${h}`)) {
                        cardHeight = h;
                        break;
                    }
                }
                cardHeight = cardHeight || GRID_CONFIG.defaultCardHeight;
            }
            
            console.log(`Dragging card with dimensions: w${cardWidth} h${cardHeight}`);
            
            placeholder.setAttribute('data-grid-w', cardWidth);
            placeholder.setAttribute('data-grid-h', cardHeight);
            
            // Get current grid position of the card
            const cardGridCol = card.style.gridColumn;
            const cardGridRow = card.style.gridRow;
            
            // Set placeholder to match card's current position
            placeholder.style.gridColumn = cardGridCol || `span ${cardWidth}`;
            placeholder.style.gridRow = cardGridRow || `span ${cardHeight}`;
            
            // Get initial card position before removing from flow
            const initialRect = card.getBoundingClientRect();
            const offsetX = e.clientX - initialRect.left;
            const offsetY = e.clientY - initialRect.top;
            
            // Insert placeholder at card's position
            container.insertBefore(placeholder, card);
            
            // Remove card from flow temporarily
            container.removeChild(card);
            
            // Hide the actual card during drag
            card.classList.add('dragging');
            card.style.display = 'none';
            
            document.body.classList.add('dragging');
            
            function handleMouseMove(e) {
                // Calculate grid position from mouse coordinates
                const containerRect = container.getBoundingClientRect();
                // The card's top-left corner position if we weren't dragging with offset
                const cardX = e.clientX - offsetX;
                const cardY = e.clientY - offsetY;
                // Position relative to container content area (accounting for padding)
                const relativeX = cardX - containerRect.left - GRID_CONFIG.paddingH;
                const relativeY = cardY - containerRect.top - GRID_CONFIG.paddingV;
                
                // Calculate grid cell using configuration
                const cellSize = GRID_CONFIG.cellSizeWithGap;
                
                const gridCol = Math.max(1, Math.min(GRID_CONFIG.columns, Math.floor(relativeX / cellSize) + 1));
                const gridRow = Math.max(1, Math.min(GRID_CONFIG.rows, Math.floor(relativeY / cellSize) + 1));
                
                // Get card dimensions
                const cardWidth = parseInt(placeholder.getAttribute('data-grid-w')) || 1;
                const cardHeight = parseInt(placeholder.getAttribute('data-grid-h')) || 2;
                
                // Ensure card fits within grid bounds
                const finalCol = Math.min(gridCol, GRID_CONFIG.columns - cardWidth + 1);
                const finalRow = Math.min(gridRow, GRID_CONFIG.rows - cardHeight + 1);
                
                // Position placeholder at calculated grid position
                placeholder.style.gridColumn = `${finalCol} / span ${cardWidth}`;
                placeholder.style.gridRow = `${finalRow} / span ${cardHeight}`;
                
                // Store grid position for final placement
                placeholder.setAttribute('data-target-col', finalCol);
                placeholder.setAttribute('data-target-row', finalRow);
            }
            
            function handleMouseUp() {
                document.removeEventListener('mousemove', handleMouseMove);
                document.removeEventListener('mouseup', handleMouseUp);
                
                // Set card position explicitly from placeholder
                const targetCol = parseInt(placeholder.getAttribute('data-target-col'));
                const targetRow = parseInt(placeholder.getAttribute('data-target-row'));
                const cardWidth = parseInt(placeholder.getAttribute('data-grid-w'));
                const cardHeight = parseInt(placeholder.getAttribute('data-grid-h'));
                
                // Check if dropping would overlap ANY other card (pinned or not)
                let canDrop = true;
                const allCards = container.querySelectorAll('.card');
                for (const otherCard of allCards) {
                    // Skip the placeholder and the card being dragged
                    if (otherCard === card || otherCard.classList.contains('drag-placeholder')) continue;
                    const otherCol = parseInt(otherCard.style.gridColumn.match(/(\d+)/)?.[1] || 1);
                    const otherRow = parseInt(otherCard.style.gridRow.match(/(\d+)/)?.[1] || 1);
                    const otherWidth = parseInt(otherCard.getAttribute('data-grid-w') || 
                                               otherCard.style.gridColumn.match(/span (\d+)/)?.[1] || 1);
                    const otherHeight = parseInt(otherCard.getAttribute('data-grid-h') || 
                                                otherCard.style.gridRow.match(/span (\d+)/)?.[1] || 1);
                    
                    // Check for overlap
                    if (targetCol < otherCol + otherWidth && targetCol + cardWidth > otherCol &&
                        targetRow < otherRow + otherHeight && targetRow + cardHeight > otherRow) {
                        canDrop = false;
                        console.log('Cannot drop - would overlap with another card');
                        break;
                    }
                }
                
                // Clean up card styles
                card.style.display = '';
                card.classList.remove('dragging');
                
                if (targetCol && targetRow && canDrop) {
                    card.style.gridColumn = `${targetCol} / span ${cardWidth}`;
                    card.style.gridRow = `${targetRow} / span ${cardHeight}`;
                    // Ensure data attributes are set on the card
                    card.setAttribute('data-grid-w', cardWidth);
                    card.setAttribute('data-grid-h', cardHeight);
                    
                    // Replace placeholder with card at new position
                    container.insertBefore(card, placeholder);
                } else {
                    // Return to original position (before placeholder)
                    container.insertBefore(card, placeholder);
                }
                
                // Remove placeholder
                container.removeChild(placeholder);
                
                document.body.classList.remove('dragging');
                
                // Hide grid overlay
                if (gridOverlay) gridOverlay.classList.remove('active');
                
                placeholder = null;
            }
            
            document.addEventListener('mousemove', handleMouseMove);
            document.addEventListener('mouseup', handleMouseUp);
        }
        
        // Removed unused HTML5 drag handlers - using mouse events instead

        // Add grid overlays to containers
        function addGridOverlays() {
            document.querySelectorAll('.tile-container').forEach(container => {
                if (!container.querySelector('.grid-overlay')) {
                    const overlay = document.createElement('div');
                    overlay.className = 'grid-overlay';
                    container.appendChild(overlay);
                }
            });
        }
        
        // Initialize card features when cards are loaded - OPTIMIZED to prevent excessive calls
        function initializeCardFeatures() {
            console.log('=== INITIALIZING CARD FEATURES ===');
            
            setTimeout(() => {
                // Add grid overlays
                addGridOverlays();
                
                // Layout cards ONLY for active containers to prevent excessive calls
                const activeContainer = document.querySelector('.view-container.active .tile-container');
                if (activeContainer && activeContainer.children.length > 0) {
                    layoutCards(activeContainer);
                }
                
                initResize();
                initDragAndDrop();
                
                console.log('=== CARD FEATURES INITIALIZED ===');
            }, 100);
        }

        // Define loadAllPages first
        function loadAllPages() {
            loadSquadPage();
            loadTacticsPage();
            loadTrainingPage();
            loadTransfersPage();
            loadFinancesPage();
            loadFixturesPage();
        }
        
        // Universal card creation function with proper sizing
        function createCard(title, content, sizeClass = '') {
            const sizes = getCardSizePresets();
            let w = GRID_CONFIG.defaultCardWidth, h = GRID_CONFIG.defaultCardHeight;
            
            // Map size classes to content-appropriate presets
            if (sizeClass.includes('stat')) {
                ({ width: w, height: h } = sizes.stat);
            } else if (sizeClass.includes('standard')) {
                ({ width: w, height: h } = sizes.standard);
            } else if (sizeClass.includes('compact')) {
                ({ width: w, height: h } = sizes.compact);
            } else if (sizeClass.includes('table')) {
                ({ width: w, height: h } = sizes.table);
            } else if (sizeClass.includes('visual')) {
                ({ width: w, height: h } = sizes.visual);
            } else if (sizeClass.includes('report')) {
                ({ width: w, height: h } = sizes.report);
            } else if (sizeClass.includes('roster')) {
                ({ width: w, height: h } = sizes.roster);
            } else if (sizeClass.includes('small')) {
                ({ width: w, height: h } = sizes.stat);  // Map old 'small' to 'stat'
            } else if (sizeClass.includes('wide')) {
                ({ width: w, height: h } = sizes.table);  // Map old 'wide' to 'table'
                if (sizeClass.includes('wide-2')) {
                    w = Math.min(w + 2, 14);  // Slightly wider variant
                }
            } else if (sizeClass.includes('tall')) {
                ({ width: w, height: h } = sizes.roster);  // Map old 'tall' to 'roster'
                if (sizeClass.includes('tall-2')) {
                    h = Math.min(h + 2, 9);  // Slightly taller variant
                }
            }
            
            // Always include data attributes for drag/drop
            return `<div class="card" data-grid-w="${w}" data-grid-h="${h}" style="grid-column: span ${w}; grid-row: span ${h};">
                <div class="card-header">
                    <span>${title}</span>
                    ${getCardMenuHTML()}
                </div>
                <div class="card-content" style="padding: 20px; overflow: auto;">${content || '<p>Loading...</p>'}</div>
                <div class="resize-handle"></div>
                <div class="resize-handle-bl"></div>
            </div>`;
        }
        
        function loadSquadPage() {
            const container = document.querySelector('#squad-grid-view .tile-container');
            container.innerHTML = `
                ${createCard('Starting XI', generateStartingXI(), 'standard')}
                ${createCard('Squad List', generateSquadList(), 'tall')}
                ${createCard('Formation', generateFormation(), 'small')}
                ${createCard('Player Form', generatePlayerForm(), 'small')}
                ${createCard('Squad Depth', generateSquadDepth(), 'small')}
                ${createCard('Injury Report', generateInjuryReport(), 'small')}
            `;
            setTimeout(() => initializeCardFeatures(), 100);
        }
        
        function getCardMenuHTML() {
            return `
                <button class="card-menu-btn" onclick="toggleCardMenu(this, event)">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="12" cy="12" r="1"/>
                        <circle cx="12" cy="12" r="5"/>
                    </svg>
                </button>
                <div class="card-menu-dropdown">
                    <div class="card-menu-item" onclick="pinCard(this)">Pin</div>
                    <div class="card-menu-item" onclick="removeCard(this)">Remove</div>
                    <div class="card-menu-item" onclick="replaceCard(this)">Replace</div>
                    <div class="card-menu-item" onclick="bookmarkCard(this)">Bookmark</div>
                </div>
            `;
        }
        
        function loadTacticsPage() {
            const container = document.querySelector('#tactics-grid-view .tile-container');
            container.innerHTML = `
                ${createCard('Current Tactic', generateCurrentTactic(), 'wide-2')}
                ${createCard('Alternative Tactics', generateAlternativeTactics())}
                ${createCard('Team Instructions', generateTeamInstructions(), 'wide-2')}
                ${createCard('Player Roles', generatePlayerRoles(), 'wide-2 tall-2')}
                ${createCard('Set Pieces', generateSetPieces())}
                ${createCard('Opposition Analysis', generateOppositionAnalysis())}
                ${createCard('Match Preparation', generateMatchPrep())}
                ${createCard('Tactical Familiarity', generateTacticalFamiliarity())}
            `;
            setTimeout(() => initializeCardFeatures(), 100);
        }
        
        function loadTrainingPage() {
            const container = document.querySelector('#training-grid-view .tile-container');
            container.innerHTML = `
                ${createCard('Training Schedule', generateTrainingSchedule(), 'wide-2')}
                ${createCard('Individual Training', generateIndividualTraining(), 'wide-2 tall-2')}
                ${createCard('Training Intensity', generateTrainingIntensity())}
                ${createCard('Coaches Report', generateCoachesReport())}
                ${createCard('Youth Development', generateYouthDevelopment())}
                ${createCard('Training Facilities', generateTrainingFacilities())}
                ${createCard('Fitness Levels', generateFitnessLevels())}
                ${createCard('Training Focus', generateTrainingFocus())}
            `;
            setTimeout(() => initializeCardFeatures(), 100);
        }
        
        function loadTransfersPage() {
            const container = document.querySelector('#transfers-grid-view .tile-container');
            container.innerHTML = `
                ${createCard('Transfer Targets', generateTransferTargets(), 'wide-2 tall-2')}
                ${createCard('Transfer Budget', generateTransferBudget())}
                ${createCard('Scouting Report', generateScoutingReport(), 'wide-2')}
                ${createCard('Transfer History', generateTransferHistory())}
                ${createCard('Contract Negotiations', generateContractNegotiations())}
                ${createCard('Loan Watch', generateLoanWatch())}
                ${createCard('Shortlist', generateShortlist())}
                ${createCard('Agent Offers', generateAgentOffers())}
            `;
            setTimeout(() => initializeCardFeatures(), 100);
        }
        
        function loadFinancesPage() {
            const container = document.querySelector('#finances-grid-view .tile-container');
            container.innerHTML = `
                ${createCard('Financial Overview', generateFinancialOverview(), 'wide-2')}
                ${createCard('Revenue Streams', generateRevenueStreams(), 'wide-2')}
                ${createCard('Wage Structure', generateWageStructure(), 'tall-2')}
                ${createCard('FFP Compliance', generateFFPCompliance())}
                ${createCard('Sponsorship Deals', generateSponsorshipDeals())}
                ${createCard('Stadium Revenue', generateStadiumRevenue())}
                ${createCard('Transfer Balance', generateTransferBalance())}
                ${createCard('Season Projection', generateSeasonProjection())}
            `;
            setTimeout(() => initializeCardFeatures(), 100);
        }
        
        function loadFixturesPage() {
            const container = document.querySelector('#fixtures-grid-view .tile-container');
            container.innerHTML = `
                ${createCard('Next Match', generateNextMatch(), 'wide-2')}
                ${createCard('Recent Results', generateRecentResults())}
                ${createCard('Upcoming Fixtures', generateUpcomingFixtures(), 'tall-2')}
                ${createCard('League Table', generateLeagueTable(), 'wide-2 tall-2')}
                ${createCard('Competition Progress', generateCompetitionProgress())}
                ${createCard('Head to Head', generateHeadToHead())}
                ${createCard('Season Stats', generateSeasonStats())}
                ${createCard('Fixture Congestion', generateFixtureCongestion())}
            `;
            setTimeout(() => initializeCardFeatures(), 100);
        }
        
        // Reinitialize when switching tabs
        const originalSwitchTab = switchTab;
        window.switchTab = function(tab, element) {
            originalSwitchTab(tab, element);
            setTimeout(() => {
                initializeCardFeatures();
            }, 100);
        };
        
        // Generate dynamic CSS classes based on configuration
        function generateDynamicGridClasses() {
            const style = document.createElement('style');
            let css = '/* Dynamically generated grid classes */\n';
            
            // Generate width classes
            for (let w = 1; w <= GRID_CONFIG.maxCSSClasses.width; w++) {
                css += `.card.w${w} { grid-column: span ${w}; }\n`;
            }
            
            // Generate height classes
            for (let h = 1; h <= GRID_CONFIG.maxCSSClasses.height; h++) {
                css += `.card.h${h} { grid-row: span ${h}; }\n`;
            }
            
            style.textContent = css;
            document.head.appendChild(style);
            console.log(`Generated CSS classes: w1-w${GRID_CONFIG.maxCSSClasses.width}, h1-h${GRID_CONFIG.maxCSSClasses.height}`);
        }
        
        // Initialize everything after all functions are defined
        generateDynamicGridClasses(); // Generate CSS classes first
        
        // SINGLE initialization to prevent duplicates
        document.addEventListener('DOMContentLoaded', function() {
            // Check for auto-load layouts first
            autoLoadLayoutFromFolder();
            
            // Load ONLY the Overview page initially (fallback if no auto-load)
            setTimeout(() => {
                if (!window.customLayoutLoaded) {
                    loadPageCards('overview');
                }
                
                // Initialize features ONCE
                initializeCardFeatures();
            }, 100);
        });
        
        // Fallback if DOMContentLoaded already fired
        if (document.readyState === 'loading') {
            // Do nothing, DOMContentLoaded will handle it
        } else {
            // DOM already loaded, initialize immediately
            autoLoadLayoutFromFolder();
            setTimeout(() => {
                if (!window.customLayoutLoaded) {
                    loadPageCards('overview');
                }
                initializeCardFeatures();
            }, 100);
        }
        
        // Show initial submenu for Overview tab
        document.getElementById('overview-submenu').classList.add('active');
        
        // Initialize team selector for dynamic league table highlighting
        setTimeout(() => {
            addTeamSelectionToggle();
        }, 200);
        
        // ========================================
        // PROFESSIONAL FORMATION INTERFACE SYSTEM
        // FIFA-standard proportions and interactive positioning
        // ========================================
        
        // CENTRAL FORMATION DATABASE - Single source of truth
        // Correct order: GK → RB → CB → CB → LB → DM → CM → AM → LW → RW → ST
        let centralFormationDB = {
            currentPhase: 'attacking',
            players: [
                { index: 0, id: 1, name: 'Onana', position: 'GK', role: 'SK', number: 1, tacticalPos: { x: 34, y: 98 } },
                { index: 1, id: 2, name: 'Dalot', position: 'RB', role: 'WB', number: 20, tacticalPos: { x: 58, y: 82 } },
                { index: 2, id: 4, name: 'Varane', position: 'CB', role: 'BPD', number: 19, tacticalPos: { x: 22, y: 86 } },
                { index: 3, id: 5, name: 'Martinez', position: 'CB', role: 'CD', number: 6, tacticalPos: { x: 46, y: 86 } },
                { index: 4, id: 3, name: 'Shaw', position: 'LB', role: 'WB', number: 23, tacticalPos: { x: 10, y: 82 } },
                { index: 5, id: 6, name: 'Casemiro', position: 'DM', role: 'DLP', number: 18, tacticalPos: { x: 26, y: 70 } },
                { index: 6, id: 7, name: 'Mainoo', position: 'CM', role: 'BBM', number: 37, tacticalPos: { x: 42, y: 70 } },
                { index: 7, id: 8, name: 'Bruno', position: 'AM', role: 'AP', number: 8, tacticalPos: { x: 34, y: 50 } },
                { index: 8, id: 9, name: 'Rashford', position: 'LW', role: 'IF', number: 10, tacticalPos: { x: 10, y: 38 } },
                { index: 9, id: 10, name: 'Garnacho', position: 'RW', role: 'W', number: 17, tacticalPos: { x: 58, y: 38 } },
                { index: 10, id: 11, name: 'Hojlund', position: 'ST', role: 'CF', number: 11, tacticalPos: { x: 34, y: 18 } }
            ]
        };
        
        // Formation data with multiple tactical phases (based on formation-example.html)
        let currentFormationPhase = 'attacking';
        let isDraggingPlayer = false;
        let draggedPlayerId = null;
        
        // Global grid occupancy tracker for swap detection
        let gridOccupancy = new Map(); // Maps "x,y" coordinates to player objects
        
        // Squad roster for player assignment
        // Enhanced 27-player squad following FM hierarchy structure
        const squadRoster = [
            // Starting XI - Using proper football position terminology
            { id: 1, name: 'Andre Onana', position: 'GK', number: 1, squadRole: 'GK', nationality: 'CMR', age: 28, rating: 85, condition: 95, morale: 'Content' },
            { id: 2, name: 'Diogo Dalot', position: 'RB', number: 20, squadRole: 'RB', nationality: 'POR', age: 25, rating: 78, condition: 88, morale: 'Happy' },
            { id: 3, name: 'Luke Shaw', position: 'LB', number: 23, squadRole: 'LB', nationality: 'ENG', age: 29, rating: 82, condition: 72, morale: 'Content' },
            { id: 4, name: 'Raphael Varane', position: 'CB', number: 19, squadRole: 'LCB', nationality: 'FRA', age: 31, rating: 84, condition: 90, morale: 'Happy' },
            { id: 5, name: 'Lisandro Martinez', position: 'CB', number: 6, squadRole: 'RCB', nationality: 'ARG', age: 26, rating: 86, condition: 94, morale: 'Content' },
            { id: 6, name: 'Casemiro', position: 'DM', number: 18, squadRole: 'DM', nationality: 'BRA', age: 32, rating: 88, condition: 85, morale: 'Happy' },
            { id: 7, name: 'Kobbie Mainoo', position: 'CM', number: 37, squadRole: 'CM', nationality: 'ENG', age: 19, rating: 76, condition: 92, morale: 'Delighted' },
            { id: 8, name: 'Bruno Fernandes', position: 'AM', number: 8, squadRole: 'AM', nationality: 'POR', age: 29, rating: 89, condition: 88, morale: 'Content' },
            { id: 9, name: 'Marcus Rashford', position: 'LW', number: 10, squadRole: 'LW', nationality: 'ENG', age: 26, rating: 85, condition: 78, morale: 'Happy' },
            { id: 10, name: 'Alejandro Garnacho', position: 'RW', number: 17, squadRole: 'RW', nationality: 'ARG', age: 20, rating: 79, condition: 91, morale: 'Delighted' },
            { id: 11, name: 'Rasmus Hojlund', position: 'ST', number: 11, squadRole: 'ST', nationality: 'DEN', age: 21, rating: 81, condition: 89, morale: 'Content' },
            // Substitutes (Sub01-Sub11)
            { id: 12, name: 'Tom Heaton', position: 'GK', number: 22, squadRole: 'Sub01', nationality: 'ENG', age: 38, rating: 72, condition: 85, morale: 'Content' },
            { id: 13, name: 'Harry Maguire', position: 'CB', number: 5, squadRole: 'Sub02', nationality: 'ENG', age: 31, rating: 78, condition: 87, morale: 'Unhappy' },
            { id: 14, name: 'Aaron Wan-Bissaka', position: 'RB', number: 29, squadRole: 'Sub03', nationality: 'ENG', age: 26, rating: 76, condition: 89, morale: 'Content' },
            { id: 15, name: 'Mason Mount', position: 'CM', number: 7, squadRole: 'Sub04', nationality: 'ENG', age: 25, rating: 77, condition: 83, morale: 'Unhappy' },
            { id: 16, name: 'Antony', position: 'RW', number: 21, squadRole: 'Sub05', nationality: 'BRA', age: 24, rating: 75, condition: 86, morale: 'Content' },
            { id: 17, name: 'Anthony Martial', position: 'ST', number: 9, squadRole: 'Sub06', nationality: 'FRA', age: 28, rating: 76, condition: 71, morale: 'Unhappy' },
            { id: 18, name: 'Christian Eriksen', position: 'CM', number: 14, squadRole: 'Sub07', nationality: 'DEN', age: 32, rating: 80, condition: 88, morale: 'Content' },
            { id: 19, name: 'Amad Diallo', position: 'RW', number: 16, squadRole: 'Sub08', nationality: 'CIV', age: 22, rating: 74, condition: 92, morale: 'Happy' },
            { id: 20, name: 'Scott McTominay', position: 'CM', number: 39, squadRole: 'Sub09', nationality: 'SCO', age: 27, rating: 75, condition: 87, morale: 'Content' },
            // Reserves (Not in match squad)
            { id: 21, name: 'Altay Bayindir', position: 'GK', number: 1, squadRole: 'Reserves', nationality: 'TUR', age: 26, rating: 73, condition: 89, morale: 'Content' },
            { id: 22, name: 'Victor Lindelof', position: 'CB', number: 2, squadRole: 'Reserves', nationality: 'SWE', age: 30, rating: 77, condition: 84, morale: 'Unhappy' },
            { id: 23, name: 'Tyrell Malacia', position: 'LB', number: 12, squadRole: 'Reserves', nationality: 'NED', age: 25, rating: 74, condition: 65, morale: 'Injured' },
            { id: 24, name: 'Sofyan Amrabat', position: 'DM', number: 4, squadRole: 'Reserves', nationality: 'MAR', age: 28, rating: 76, condition: 88, morale: 'Content' },
            { id: 25, name: 'Facundo Pellistri', position: 'RW', number: 28, squadRole: 'Reserves', nationality: 'URU', age: 22, rating: 71, condition: 90, morale: 'Happy' },
            { id: 26, name: 'Hannibal Mejbri', position: 'CM', number: 46, squadRole: 'Reserves', nationality: 'TUN', age: 21, rating: 69, condition: 93, morale: 'Delighted' },
            { id: 27, name: 'Sergio Reguilon', position: 'LB', number: 15, squadRole: 'Reserves', nationality: 'ESP', age: 27, rating: 75, condition: 86, morale: 'Content' }
        ];
        
        const formationData = {
            attacking: [
                { id: 1, x: 34, y: 98, position: 'GK', number: 1, name: 'Onana', role: 'Sweeper Keeper' },
                { id: 2, x: 10, y: 82, position: 'LB', number: 23, name: 'Shaw', role: 'Inverted Wing Back' },
                { id: 3, x: 22, y: 86, position: 'CB', number: 19, name: 'Varane', role: 'Ball Playing Defender' },
                { id: 4, x: 46, y: 86, position: 'CB', number: 6, name: 'Martinez', role: 'Ball Playing Defender' },
                { id: 5, x: 58, y: 82, position: 'RB', number: 20, name: 'Dalot', role: 'Complete Wing Back' },
                { id: 6, x: 26, y: 70, position: 'DM', number: 18, name: 'Casemiro', role: 'Deep Lying Playmaker' },
                { id: 7, x: 42, y: 70, position: 'CM', number: 37, name: 'Mainoo', role: 'Box to Box Midfielder' },
                { id: 8, x: 10, y: 38, position: 'LW', number: 10, name: 'Rashford', role: 'Inside Forward' },
                { id: 9, x: 34, y: 50, position: 'AM', number: 8, name: 'Bruno', role: 'Advanced Playmaker' },
                { id: 10, x: 58, y: 38, position: 'RW', number: 17, name: 'Garnacho', role: 'Inside Forward' },
                { id: 11, x: 34, y: 18, position: 'ST', number: 11, name: 'Hojlund', role: 'Complete Forward' }
            ],
            defending: [
                { id: 1, x: 50, y: 92, position: 'GK', number: 1, name: 'Onana' },
                { id: 2, x: 10, y: 82, position: 'LB', number: 23, name: 'Shaw' },
                { id: 3, x: 35, y: 85, position: 'CB', number: 19, name: 'Varane' },
                { id: 4, x: 65, y: 85, position: 'CB', number: 6, name: 'Martinez' },
                { id: 5, x: 90, y: 82, position: 'RB', number: 20, name: 'Dalot' },
                { id: 6, x: 30, y: 68, position: 'DM', number: 18, name: 'Casemiro' },
                { id: 7, x: 70, y: 68, position: 'CM', number: 37, name: 'Mainoo' },
                { id: 8, x: 15, y: 52, position: 'LW', number: 10, name: 'Rashford' },
                { id: 9, x: 50, y: 62, position: 'AM', number: 8, name: 'Bruno' },
                { id: 10, x: 85, y: 52, position: 'RW', number: 17, name: 'Garnacho' },
                { id: 11, x: 50, y: 42, position: 'ST', number: 11, name: 'Hojlund' }
            ],
            transition_attack: [
                { id: 1, x: 50, y: 88, position: 'GK', number: 1, name: 'Onana' },
                { id: 2, x: 5, y: 65, position: 'LB', number: 23, name: 'Shaw' },
                { id: 3, x: 35, y: 77, position: 'CB', number: 19, name: 'Varane' },
                { id: 4, x: 65, y: 77, position: 'CB', number: 6, name: 'Martinez' },
                { id: 5, x: 95, y: 65, position: 'RB', number: 20, name: 'Dalot' },
                { id: 6, x: 35, y: 52, position: 'DM', number: 18, name: 'Casemiro' },
                { id: 7, x: 65, y: 52, position: 'CM', number: 37, name: 'Mainoo' },
                { id: 8, x: 8, y: 25, position: 'LW', number: 10, name: 'Rashford' },
                { id: 9, x: 50, y: 35, position: 'AM', number: 8, name: 'Bruno' },
                { id: 10, x: 92, y: 25, position: 'RW', number: 17, name: 'Garnacho' },
                { id: 11, x: 50, y: 12, position: 'ST', number: 11, name: 'Hojlund' }
            ],
            transition_defense: [
                { id: 1, x: 50, y: 90, position: 'GK', number: 1, name: 'Onana' },
                { id: 2, x: 20, y: 75, position: 'LB', number: 23, name: 'Shaw' },
                { id: 3, x: 35, y: 80, position: 'CB', number: 19, name: 'Varane' },
                { id: 4, x: 65, y: 80, position: 'CB', number: 6, name: 'Martinez' },
                { id: 5, x: 80, y: 75, position: 'RB', number: 20, name: 'Dalot' },
                { id: 6, x: 30, y: 62, position: 'DM', number: 18, name: 'Casemiro' },
                { id: 7, x: 70, y: 62, position: 'CM', number: 37, name: 'Mainoo' },
                { id: 8, x: 25, y: 47, position: 'LW', number: 10, name: 'Rashford' },
                { id: 9, x: 50, y: 55, position: 'AM', number: 8, name: 'Bruno' },
                { id: 10, x: 75, y: 47, position: 'RW', number: 17, name: 'Garnacho' },
                { id: 11, x: 50, y: 32, position: 'ST', number: 11, name: 'Hojlund' }
            ]
        };
        
        // Get position-specific CSS class
        function getPositionClass(position) {
            const pos = position.toUpperCase();
            if (pos === 'GK') return 'goalkeeper';
            if (['CB', 'LB', 'RB', 'WB', 'LWB', 'RWB'].includes(pos)) return 'defender';
            if (['CM', 'DM', 'AM', 'LM', 'RM'].includes(pos)) return 'midfielder';
            if (['ST', 'CF', 'LW', 'RW', 'LF', 'RF'].includes(pos)) return 'forward';
            return 'midfielder';
        }
        
        // Initialize systems from central database
        function initializeFromCentralDB() {
            updateFormationFromCentralDB();
            updateGlobalSquadSlotsFromCentralDB();
        }
        
        // Render players on the SVG field and populate player lists
        function renderFormationPlayers() {
            const playersGroup = document.getElementById('formation-players');
            if (!playersGroup) return;
            
            playersGroup.innerHTML = '';
            
            // Initialize from central database on first render
            if (!formationData[currentFormationPhase] || formationData[currentFormationPhase].length === 0) {
                initializeFromCentralDB();
            }
            
            const currentPlayers = formationData[currentFormationPhase];
            
            // Render players on field using meter coordinates
            currentPlayers.forEach(player => {
                const positionClass = getPositionClass(player.position);
                
                // Create player circle with gradient and shadow (tile effect)
                const circle = document.createElementNS('http://www.w3.org/2000/svg', 'circle');
                circle.setAttribute('cx', player.x);
                circle.setAttribute('cy', player.y);
                circle.setAttribute('r', '2.25');
                circle.setAttribute('stroke', 'rgba(255,255,255,0.8)');
                circle.setAttribute('stroke-width', '0.3');
                circle.setAttribute('class', `formation-player ${positionClass}`);
                circle.setAttribute('data-player-id', player.id);
                circle.setAttribute('pointer-events', 'auto');
                circle.style.cursor = 'grab'; // Base cursor is grab
                
                // Enhanced position-specific colors with gradients and shadows
                let baseColor, shadowColor;
                switch(positionClass) {
                    case 'goalkeeper': 
                        baseColor = '#FFcc00'; 
                        shadowColor = 'rgba(255,204,0,0.4)';
                        break;
                    case 'defender': 
                        baseColor = '#0096CC'; 
                        shadowColor = 'rgba(0,150,204,0.4)';
                        break; 
                    case 'midfielder': 
                        baseColor = '#00E078'; 
                        shadowColor = 'rgba(0,224,120,0.4)';
                        break;
                    case 'forward': 
                        baseColor = '#FF0032'; 
                        shadowColor = 'rgba(255,0,50,0.4)';
                        break;
                    default: 
                        baseColor = '#00E078'; 
                        shadowColor = 'rgba(0,224,120,0.4)';
                        break;
                }
                
                // Create gradient definition
                const gradientId = `gradient-${player.id}`;
                const gradient = document.createElementNS('http://www.w3.org/2000/svg', 'radialGradient');
                gradient.setAttribute('id', gradientId);
                gradient.setAttribute('cx', '30%');
                gradient.setAttribute('cy', '30%');
                gradient.innerHTML = `
                    <stop offset="0%" style="stop-color:${baseColor};stop-opacity:1"/>
                    <stop offset="100%" style="stop-color:${baseColor};stop-opacity:0.9"/>
                `;
                
                // Add gradient to defs
                let defs = playersGroup.querySelector('defs');
                if (!defs) {
                    defs = document.createElementNS('http://www.w3.org/2000/svg', 'defs');
                    playersGroup.appendChild(defs);
                }
                defs.appendChild(gradient);
                
                // Apply gradient and shadow
                circle.setAttribute('fill', `url(#${gradientId})`);
                circle.style.filter = `drop-shadow(0 2px 4px ${shadowColor})`;
                
                // Create player number text
                const numberText = document.createElementNS('http://www.w3.org/2000/svg', 'text');
                numberText.setAttribute('x', player.x);
                numberText.setAttribute('y', player.y + 0.5);
                numberText.setAttribute('text-anchor', 'middle');
                numberText.setAttribute('fill', 'white');
                numberText.setAttribute('font-size', '2');
                numberText.setAttribute('font-weight', 'bold');
                numberText.setAttribute('class', 'player-number-svg');
                numberText.setAttribute('data-player-id', player.id);
                numberText.style.pointerEvents = 'none';
                numberText.textContent = player.number;
                
                // Position labels removed as requested - only player number and name remain
                
                // Create player name text (below icon)
                const nameText = document.createElementNS('http://www.w3.org/2000/svg', 'text');
                nameText.setAttribute('x', player.x);
                nameText.setAttribute('y', player.y + 4.5);
                nameText.setAttribute('text-anchor', 'middle');
                nameText.setAttribute('fill', 'white');
                nameText.setAttribute('font-size', '2.2');
                nameText.setAttribute('font-weight', '500');
                nameText.setAttribute('class', 'player-name-svg');
                nameText.setAttribute('data-player-id', player.id);
                nameText.style.pointerEvents = 'none';
                nameText.style.textShadow = '0 0 2px rgba(0,0,0,0.8)';
                nameText.textContent = player.name;
                
                // Add event handlers for dragging with grab/grabbing cursors
                circle.addEventListener('mousedown', (e) => startPlayerDrag(player.id, e));
                circle.addEventListener('mouseenter', () => {
                    circle.style.cursor = 'grab';
                });
                circle.addEventListener('mouseleave', () => {
                    circle.style.cursor = 'grab';
                });
                
                playersGroup.appendChild(circle);
                playersGroup.appendChild(numberText);
                playersGroup.appendChild(nameText);
            });
            
            // Update grid occupancy tracker
            updateGridOccupancy();
            
            // Populate combined player list
            renderCombinedPlayerList();
        }
        
        // Render Starting XI list with role assignment
        function renderStartingXI() {
            const container = document.getElementById('formation-starting-xi');
            if (!container) return;
            
            const currentPlayers = formationData[currentFormationPhase];
            container.innerHTML = '';
            
            currentPlayers.forEach(player => {
                const playerDiv = document.createElement('div');
                playerDiv.className = 'formation-stat';
                playerDiv.innerHTML = `
                    <div>
                        <div style="font-size: 11px; font-weight: 600; color: rgba(255,255,255,0.9);">
                            #${player.number} ${player.name}
                        </div>
                        <div style="font-size: 9px; color: rgba(255,255,255,0.6);">
                            ${player.position} - ${player.role || 'No Role'}
                        </div>
                    </div>
                    <button class="formation-role-btn" onclick="changePlayerRole(${player.id})" 
                            style="font-size: 9px; padding: 2px 6px; background: var(--neutral-400); 
                                   border: 1px solid var(--neutral-500); border-radius: 2px; 
                                   color: rgba(255,255,255,0.8); cursor: pointer;">
                        Change Role
                    </button>
                `;
                container.appendChild(playerDiv);
            });
        }
        
        // Render available bench players
        function renderAvailablePlayers() {
            const container = document.getElementById('formation-available-players');
            if (!container) return;
            
            const currentPlayers = formationData[currentFormationPhase];
            const usedPlayerIds = currentPlayers.map(p => p.id);
            const availablePlayers = squadRoster.filter(p => !usedPlayerIds.includes(p.id));
            
            container.innerHTML = '';
            
            availablePlayers.forEach(player => {
                const playerDiv = document.createElement('div');
                playerDiv.className = 'formation-stat';
                playerDiv.style.cursor = 'pointer';
                playerDiv.style.opacity = '0.8';
                playerDiv.innerHTML = `
                    <div>
                        <div style="font-size: 10px; font-weight: 500; color: rgba(255,255,255,0.7);">
                            #${player.number} ${player.name}
                        </div>
                        <div style="font-size: 8px; color: rgba(255,255,255,0.5);">
                            ${player.position} - Available
                        </div>
                    </div>
                    <button class="formation-role-btn" onclick="assignPlayerToFormation(${player.id})" 
                            style="font-size: 8px; padding: 1px 4px; background: var(--primary-300); 
                                   border: 1px solid var(--primary-400); border-radius: 2px; 
                                   color: white; cursor: pointer;">
                        Add
                    </button>
                `;
                container.appendChild(playerDiv);
            });
        }
        
        // Change player tactical role (position-based roles)
        function changePlayerRole(playerId) {
            const roles = {
                'GK': ['Sweeper Keeper', 'Goalkeeper'],
                'CB': ['Ball Playing Defender', 'Central Defender', 'Libero'],
                'LB': ['Inverted Wing Back', 'Wing Back', 'Full Back'],
                'RB': ['Complete Wing Back', 'Wing Back', 'Full Back'],
                'DM': ['Deep Lying Playmaker', 'Defensive Midfielder', 'Anchor Man'],
                'CM': ['Box to Box Midfielder', 'Central Midfielder', 'Roaming Playmaker'],
                'AM': ['Advanced Playmaker', 'Attacking Midfielder', 'Trequartista'],
                'LW': ['Inside Forward', 'Winger', 'Inverted Winger'],
                'RW': ['Inside Forward', 'Winger', 'Inverted Winger'],
                'ST': ['Complete Forward', 'Advanced Forward', 'Target Man']
            };
            
            const currentPlayers = formationData[currentFormationPhase];
            const player = currentPlayers.find(p => p.id === playerId);
            if (!player) return;
            
            const availableRoles = roles[player.position] || ['Standard'];
            const currentRoleIndex = availableRoles.indexOf(player.role || '') || 0;
            const nextRoleIndex = (currentRoleIndex + 1) % availableRoles.length;
            
            player.role = availableRoles[nextRoleIndex];
            
            // Re-render to update display
            renderStartingXI();
            renderCombinedPlayerList();
            
            console.log(`Changed ${player.name} tactical role to: ${player.role}`);
        }
        
        // Generate dynamic squad roles based on current formation
        function getAvailableSquadRoles() {
            const currentPlayers = formationData[currentFormationPhase];
            const formationRoles = [];
            
            // Generate formation-based roles from current tactical setup with proper football terminology
            const positionCounts = {};
            
            // First pass: count positions
            currentPlayers.forEach(player => {
                positionCounts[player.position] = (positionCounts[player.position] || 0) + 1;
            });
            
            // Second pass: assign proper positional roles
            const positionIndexes = {};
            currentPlayers.forEach((player, index) => {
                const position = player.position;
                const count = positionCounts[position];
                
                if (count === 1) {
                    // Single player in position - use base position
                    formationRoles.push(position);
                } else if (count === 2) {
                    // Two players - use L/R variants
                    const currentIndex = (positionIndexes[position] || 0) + 1;
                    positionIndexes[position] = currentIndex;
                    
                    if (position === 'CB') {
                        formationRoles.push(currentIndex === 1 ? 'LCB' : 'RCB');
                    } else if (position === 'CM') {
                        formationRoles.push(currentIndex === 1 ? 'LCM' : 'RCM');
                    } else if (position === 'DM') {
                        formationRoles.push(currentIndex === 1 ? 'LDM' : 'RDM');
                    } else if (position === 'AM') {
                        formationRoles.push(currentIndex === 1 ? 'LAM' : 'RAM');
                    } else {
                        // Fallback for other positions
                        formationRoles.push(`${position}${currentIndex}`);
                    }
                } else if (count === 3) {
                    // Three players - use L/C/R variants
                    const currentIndex = (positionIndexes[position] || 0) + 1;
                    positionIndexes[position] = currentIndex;
                    
                    if (position === 'CB') {
                        const roles = ['LCB', 'CB', 'RCB'];
                        formationRoles.push(roles[currentIndex - 1]);
                    } else if (position === 'CM') {
                        const roles = ['LCM', 'CM', 'RCM'];
                        formationRoles.push(roles[currentIndex - 1]);
                    } else {
                        formationRoles.push(`${position}${currentIndex}`);
                    }
                } else {
                    // More than 3 - use numbered system
                    const currentIndex = (positionIndexes[position] || 0) + 1;
                    positionIndexes[position] = currentIndex;
                    formationRoles.push(`${position}${currentIndex}`);
                }
            });
            
            // Add substitute roles (Sub01-Sub11)
            const subRoles = [];
            for (let i = 1; i <= 11; i++) {
                subRoles.push(`Sub${i.toString().padStart(2, '0')}`);
            }
            
            return {
                formation: formationRoles,
                substitutes: subRoles,
                reserves: ['Reserves']
            };
        }
        
        // Change player squad role (Dynamic formation positions, Sub01-Sub11, Reserves)
        function changeSquadRole(playerId, newSquadRole) {
            const player = squadRoster.find(p => p.id === playerId);
            if (!player) return;
            
            const oldRole = player.squadRole;
            const availableRoles = getAvailableSquadRoles();
            
            // Handle formation position assignment
            if (availableRoles.formation.includes(newSquadRole)) {
                // Check if another player already has this formation role
                const conflictPlayer = squadRoster.find(p => p.id !== playerId && p.squadRole === newSquadRole);
                if (conflictPlayer) {
                    // Move the conflicting player to reserves
                    conflictPlayer.squadRole = 'Reserves';
                    // Remove conflicting player from formation
                    removePlayerFromFormationBySquadRole(conflictPlayer.squadRole);
                    console.log(`Moved ${conflictPlayer.name} to Reserves due to role conflict`);
                }
                
                // Assign new role
                player.squadRole = newSquadRole;
                
                // Automatically add to formation if not already there
                if (!isPlayerInFormation(playerId)) {
                    addPlayerToFormationByRole(player, newSquadRole);
                }
            } else {
                // Assigning to Sub or Reserves - remove from formation
                player.squadRole = newSquadRole;
                
                // Automatically remove from formation if currently on field
                if (isPlayerInFormation(playerId)) {
                    removePlayerFromFormation(playerId);
                }
            }
            
            // Re-render everything to update visual representation
            renderCombinedPlayerList();
            renderFormationPlayers();
            
            console.log(`Changed ${player.name} squad role from ${oldRole} to ${newSquadRole}`);
        }
        
        // Change player tactical role (playing style)
        function changeTacticalRole(playerId, newTacticalRole) {
            const currentPlayers = formationData[currentFormationPhase];
            const player = currentPlayers.find(p => p.id === playerId);
            if (!player) return;
            
            const oldRole = player.role;
            player.role = newTacticalRole;
            
            // Re-render to update display
            renderCombinedPlayerList();
            renderFormationPlayers();
            
            console.log(`Changed ${player.name} tactical role from ${oldRole} to ${newTacticalRole}`);
        }
        
        // Helper function to check if player is in current formation
        function isPlayerInFormation(playerId) {
            const currentPlayers = formationData[currentFormationPhase];
            return currentPlayers.some(p => p.id === playerId);
        }
        
        // Helper function to add player to formation based on squad role
        function addPlayerToFormationByRole(player, squadRole) {
            const currentPlayers = formationData[currentFormationPhase];
            
            // Find default position for this squad role
            const defaultPositions = {
                'GK': { x: 34, y: 97 },
                'LB': { x: 8, y: 83 }, 'RB': { x: 60, y: 83 },
                'LCB': { x: 22, y: 87 }, 'RCB': { x: 46, y: 87 }, 'CB': { x: 34, y: 87 },
                'LDM': { x: 20, y: 70 }, 'RDM': { x: 48, y: 70 }, 'DM': { x: 34, y: 70 },
                'LCM': { x: 20, y: 60 }, 'RCM': { x: 48, y: 60 }, 'CM': { x: 34, y: 60 },
                'LAM': { x: 20, y: 50 }, 'RAM': { x: 48, y: 50 }, 'AM': { x: 34, y: 50 },
                'LW': { x: 10, y: 37 }, 'RW': { x: 58, y: 37 },
                'ST': { x: 34, y: 17 }
            };
            
            const defaultPos = defaultPositions[squadRole] || { x: 34, y: 50 };
            
            // Add player to formation
            const newFormationPlayer = {
                id: player.id,
                x: defaultPos.x,
                y: defaultPos.y,
                position: player.position,
                number: player.number,
                name: player.name,
                role: 'Standard'
            };
            
            currentPlayers.push(newFormationPlayer);
        }
        
        // Helper function to remove player from formation by squad role
        function removePlayerFromFormationBySquadRole(squadRole) {
            // This is handled by the existing removePlayerFromFormation function
            // when the conflicting player is found
        }
        
        // Assign bench player to formation
        function assignPlayerToFormation(playerId) {
            const benchPlayer = squadRoster.find(p => p.id === playerId);
            if (!benchPlayer) return;
            
            const currentPlayers = formationData[currentFormationPhase];
            if (currentPlayers.length >= 11) {
                console.log('Formation is full - cannot add more players');
                return;
            }
            
            // Find default position for this player type
            const defaultPositions = {
                'GK': { x: 52.5, y: 60 },
                'CB': { x: 52.5, y: 50 },
                'LB': { x: 10, y: 45 },
                'RB': { x: 95, y: 45 },
                'DM': { x: 52.5, y: 40 },
                'CM': { x: 52.5, y: 35 },
                'AM': { x: 52.5, y: 28 },
                'LW': { x: 15, y: 20 },
                'RW': { x: 90, y: 20 },
                'ST': { x: 52.5, y: 12 }
            };
            
            const defaultPos = defaultPositions[benchPlayer.preferred] || { x: 52.5, y: 34 };
            
            // Add player to formation
            const newPlayer = {
                id: benchPlayer.id,
                x: defaultPos.x,
                y: defaultPos.y,
                position: benchPlayer.position,
                number: benchPlayer.number,
                name: benchPlayer.name,
                role: 'Standard'
            };
            
            currentPlayers.push(newPlayer);
            
            // Re-render everything
            renderFormationPlayers();
            
            console.log(`Added ${benchPlayer.name} to formation`);
        }
        
        // Fixed 22-slot squad management system with dropdowns and drag-swap functionality
        // Global squad slots data - persistent state (simplified without duty)
        let globalSquadSlots = [
            // Starting XI slots (1-11)
            { id: 1, position: 'GK', role: 'SK', assignedPlayer: null },
            { id: 2, position: 'RB', role: 'WB', assignedPlayer: null },
            { id: 3, position: 'CB', role: 'BPD', assignedPlayer: null },
            { id: 4, position: 'CB', role: 'CD', assignedPlayer: null },
            { id: 5, position: 'LB', role: 'WB', assignedPlayer: null },
            { id: 6, position: 'DM', role: 'DLP', assignedPlayer: null },
            { id: 7, position: 'CM', role: 'BBM', assignedPlayer: null },
            { id: 8, position: 'AM', role: 'AP', assignedPlayer: null },
            { id: 9, position: 'LW', role: 'IF', assignedPlayer: null },
            { id: 10, position: 'RW', role: 'W', assignedPlayer: null },
            { id: 11, position: 'ST', role: 'CF', assignedPlayer: null },
            // Substitute slots (12-22) with proper naming
            { id: 12, position: 'Sub01', role: '', assignedPlayer: null },
            { id: 13, position: 'Sub02', role: '', assignedPlayer: null },
            { id: 14, position: 'Sub03', role: '', assignedPlayer: null },
            { id: 15, position: 'Sub04', role: '', assignedPlayer: null },
            { id: 16, position: 'Sub05', role: '', assignedPlayer: null },
            { id: 17, position: 'Sub06', role: '', assignedPlayer: null },
            { id: 18, position: 'Sub07', role: '', assignedPlayer: null },
            { id: 19, position: 'Sub08', role: '', assignedPlayer: null },
            { id: 20, position: 'Sub09', role: '', assignedPlayer: null },
            { id: 21, position: 'Sub10', role: '', assignedPlayer: null },
            { id: 22, position: 'Sub11', role: '', assignedPlayer: null }
        ];

        function renderCombinedPlayerList() {
            const container = document.getElementById('formation-all-players');
            if (!container) return;
            
            container.innerHTML = '';
            
            // Initialize from central database if needed
            if (!globalSquadSlots.some(slot => slot.assignedPlayer)) {
                initializeFromCentralDB();
            }
            
            // Render all 22 squad slots using Aethelred modular system
            globalSquadSlots.forEach((slot, index) => {
                createAethelredSquadSlot(container, slot, index);
            });
        }
        
        // Squad Slot Design System - Modular Components with CSS Variables
        const SQUAD_SLOT_CONFIG = {
            height: '42px',
            gap: '4px',
            positionSectionWidth: '110px', // Fixed width for consistency
            borderRadius: 'var(--border-radius)',
            transition: 'all 0.2s ease'
        };

        // Enhanced Position Color System - new mapping
        function getPositionColorVariable(position) {
            const pos = position.toUpperCase();
            if (pos === 'GK') return '#FFcc00'; // Bright yellow/gold for goalkeeper
            if (['CB', 'LB', 'RB', 'WB', 'LWB', 'RWB'].includes(pos)) return '#0096CC'; // Blue for defenders
            if (['CM', 'DM', 'AM', 'LM', 'RM'].includes(pos)) return '#00E078'; // Green for midfielders
            if (['ST', 'CF', 'LW', 'RW', 'LF', 'RF'].includes(pos)) return '#FF0032'; // Red for forwards
            if (pos.startsWith('SUB')) return 'var(--neutral-300)'; // Neutral for substitutes
            return 'var(--neutral-400)'; // Default neutral
        }
        
        // Role dropdown color system - darker shades of position colors
        function getRoleDropdownColor(position) {
            const pos = position.toUpperCase();
            if (pos === 'GK') return '#CCA300'; // Darker yellow/gold
            if (['CB', 'LB', 'RB', 'WB', 'LWB', 'RWB'].includes(pos)) return '#0078A3'; // Darker blue
            if (['CM', 'DM', 'AM', 'LM', 'RM'].includes(pos)) return '#00B862'; // Darker green
            if (['ST', 'CF', 'LW', 'RW', 'LF', 'RF'].includes(pos)) return '#CC0029'; // Darker red
            return 'var(--neutral-400)'; // Default
        }

        // AETHELRED SQUAD SLOT COMPONENT - Modular Design System
        function createAethelredSquadSlot(container, slot, index) {
            // Generate player data
            const player = slot.assignedPlayer;
            const isStartingXI = slot.id <= 11;
            
            // Create main slot container with standardized styling
            const squadSlot = createSquadSlotContainer(slot);
            
            // Compose slot from modular components
            const positionBadge = createPositionBadgeComponent(slot, isStartingXI);
            const roleAbilitySection = createRoleAbilityComponent(player);
            const playerSelector = createPlayerSelectorComponent(slot, player);
            const statusIcons = createStatusIconsComponent(player);
            const ratingDisplay = createRatingDisplayComponent(player);
            
            // Assemble components with proper layout
            const slotContent = document.createElement('div');
            slotContent.className = 'squad-slot-content';
            slotContent.style.cssText = `
                display: flex; width: 100%; height: 100%;
            `;
            
            slotContent.appendChild(positionBadge);
            slotContent.appendChild(roleAbilitySection);
            slotContent.appendChild(playerSelector);
            slotContent.appendChild(statusIcons);
            slotContent.appendChild(ratingDisplay);
            
            squadSlot.appendChild(slotContent);
            
            // Add drag-and-drop functionality
            addSlotDragDropHandlers(squadSlot, slot);
            
            container.appendChild(squadSlot);
        }
        
        // SQUAD SLOT CONTAINER - Base container with standardized styling
        function createSquadSlotContainer(slot) {
            const container = document.createElement('div');
            container.className = 'aethelred-squad-slot';
            container.setAttribute('data-slot-id', slot.id);
            container.setAttribute('draggable', 'true');
            container.style.cssText = `
                display: flex; align-items: stretch; padding: 0;
                margin-bottom: ${SQUAD_SLOT_CONFIG.gap};
                background: var(--neutral-200); 
                border-radius: ${SQUAD_SLOT_CONFIG.borderRadius};
                border: 1px solid var(--neutral-300);
                transition: ${SQUAD_SLOT_CONFIG.transition};
                height: ${SQUAD_SLOT_CONFIG.height};
                cursor: pointer; overflow: hidden;
            `;
            return container;
        }
        
        // POSITION BADGE COMPONENT - Compact sizing with right-edge role dropdown
        function createPositionBadgeComponent(slot, isStartingXI) {
            const container = document.createElement('div');
            container.className = 'aethelred-position-section';
            container.style.cssText = `
                display: flex; align-items: stretch;
                width: ${SQUAD_SLOT_CONFIG.positionSectionWidth};
                height: 100%;
            `;
            
            // Position badge (compact, doesn't envelope dropdown)
            const badge = document.createElement('div');
            badge.className = 'aethelred-position-badge';
            
            const positionColor = getPositionColorVariable(slot.position);
            const badgeWidth = isStartingXI ? '54px' : '110px'; // Compact for starting XI (110-56=54), full for subs
            
            badge.style.cssText = `
                display: flex; align-items: center; justify-content: center;
                width: ${badgeWidth}; height: 100%;
                background: ${positionColor}; padding: 4px 8px;
            `;
            
            // Position label 
            const positionLabel = document.createElement('div');
            positionLabel.className = 'position-label';
            positionLabel.style.cssText = `
                font-size: var(--font-size-sm); color: white;
                font-weight: 400; text-align: center;
                text-shadow: 1px 1px 2px rgba(0,0,0,0.8);
            `;
            positionLabel.textContent = slot.position || 'POS';
            
            badge.appendChild(positionLabel);
            container.appendChild(badge);
            
            // Role dropdown at right edge (only for starting XI)
            if (isStartingXI) {
                const roleDropdown = createRoleDropdownComponent(slot);
                container.appendChild(roleDropdown);
            }
            
            return container;
        }
        
        // ROLE DROPDOWN COMPONENT - Simple select dropdown
        function createRoleDropdownComponent(slot) {
            const dropdown = document.createElement('select');
            dropdown.className = 'aethelred-role-dropdown';
            dropdown.setAttribute('onchange', `changeSlotRole(${slot.id}, this.value)`);
            const roleColor = getRoleDropdownColor(slot.position);
            dropdown.style.cssText = `
                background: ${roleColor}; color: white;
                border: none; border-radius: 0;
                padding: 4px 8px; font-size: var(--font-size-xs);
                font-weight: 400; cursor: pointer; width: 60px; height: 100%;
                text-shadow: 1px 1px 2px rgba(0,0,0,0.8);
            `;
            
            const roles = ['SK', 'WB', 'BPD', 'CD', 'DLP', 'BBM', 'AP', 'IF', 'W', 'CF'];
            roles.forEach(role => {
                const option = document.createElement('option');
                option.value = role;
                option.textContent = role;
                if (slot.role === role) option.selected = true;
                dropdown.appendChild(option);
            });
            
            return dropdown;
        }
        
        // ROLE ABILITY COMPONENT - Subtle star rating display
        function createRoleAbilityComponent(player) {
            const section = document.createElement('div');
            section.className = 'aethelred-role-ability';
            section.style.cssText = `
                display: flex; align-items: center; padding: 0 8px;
                background: var(--neutral-300);
            `;
            
            const stars = document.createElement('div');
            stars.style.cssText = `
                color: var(--accent-300); font-size: var(--font-size-sm);
                font-weight: 400; line-height: 1;
            `;
            stars.textContent = player ? getStarRating(player.rating) : '☆☆☆☆☆';
            
            section.appendChild(stars);
            return section;
        }
        
        // PLAYER SELECTOR COMPONENT - Regular dropdown with white text
        function createPlayerSelectorComponent(slot, player) {
            const section = document.createElement('div');
            section.className = 'aethelred-player-selector';
            section.style.cssText = `
                flex: 1; display: flex; align-items: stretch;
                background: var(--neutral-300);
            `;
            
            section.innerHTML = createPlayerSelectionDropdown(slot, player);
            return section;
        }
        
        // STATUS ICONS COMPONENT - Condition, Sharpness, Morale indicators
        function createStatusIconsComponent(player) {
            const section = document.createElement('div');
            section.className = 'aethelred-status-icons';
            section.style.cssText = `
                display: flex; align-items: center; gap: 4px;
                padding: 0 8px; background: var(--neutral-300);
            `;
            
            if (player) {
                // Generate varied test ranges for comprehensive testing
                const condition = player.condition || Math.floor(Math.random() * 80) + 20; // Range 20-100 for testing
                const sharpness = Math.floor(Math.random() * 60) + 40; // Range 40-100 for testing
                const morale = typeof player.morale === 'number' ? player.morale : Math.floor(Math.random() * 80) + 20; // Range 20-100 for testing
                
                section.innerHTML = `
                    ${getConditionIcon(condition)}
                    ${getSharpnessIcon(sharpness)}
                    ${getMoraleIcon(morale)}
                `;
            } else {
                section.innerHTML = `
                    ${getEmptyIcon()}
                    ${getEmptyIcon()}
                    ${getEmptyIcon()}
                `;
            }
            
            return section;
        }
        
        // RATING DISPLAY COMPONENT - White text, no borders
        function createRatingDisplayComponent(player) {
            const section = document.createElement('div');
            section.className = 'aethelred-rating-display';
            section.style.cssText = `
                min-width: 40px; display: flex; align-items: center;
                justify-content: center; background: var(--neutral-300);
            `;
            
            const rating = document.createElement('span');
            rating.style.cssText = `
                font-size: var(--font-size-sm); color: white;
                font-weight: 400;
            `;
            
            const matchRating = player ? (Math.random() * 3 + 6).toFixed(1) : '-';
            rating.textContent = matchRating;
            
            section.appendChild(rating);
            return section;
        }
        
        // Legacy function cleanup - remove old dynamic system
        function renderOldPlayerList() {
            // Render all 27 squad players with FM-style detailed information
            squadRoster.forEach((player, index) => {
                const isSelected = selectedPlayerIds.includes(player.id);
                const selectedPlayer = currentPlayers.find(p => p.id === player.id);
                
                // Determine player background color based on squad role
                let roleColor = 'transparent';
                let roleText = player.squadRole;
                const availableRoles = getAvailableSquadRoles();
                
                if (availableRoles.formation.includes(player.squadRole)) {
                    roleColor = 'rgba(0, 255, 136, 0.15)'; // Green tint for formation positions
                    roleText = `Formation ${player.squadRole}`;
                } else if (player.squadRole.startsWith('Sub')) {
                    roleColor = 'rgba(255, 184, 0, 0.1)'; // Amber tint for substitutes
                    roleText = player.squadRole;
                } else {
                    roleColor = 'rgba(100, 100, 100, 0.1)'; // Gray tint for reserves
                    roleText = 'Reserves';
                }
                
                const playerDiv = document.createElement('div');
                playerDiv.className = 'fm-player-item';
                playerDiv.setAttribute('data-player-id', player.id);
                playerDiv.setAttribute('draggable', 'true');
                playerDiv.style.cssText = `
                    display: flex; align-items: center; padding: 10px 12px; margin-bottom: 4px;
                    background: ${isSelected ? 'rgba(0, 148, 204, 0.2)' : roleColor};
                    border-left: ${isSelected ? '3px solid var(--primary-400)' : '3px solid transparent'};
                    border-radius: 4px; cursor: pointer; transition: all 0.2s ease;
                    border: ${isSelected ? '1px solid var(--primary-300)' : '1px solid transparent'};
                    min-height: 50px;
                `;
                
                // Add hover effects
                playerDiv.addEventListener('mouseenter', () => {
                    if (!isSelected) {
                        playerDiv.style.background = 'rgba(255,255,255,0.05)';
                        playerDiv.style.borderColor = 'rgba(255,255,255,0.2)';
                    }
                });
                playerDiv.addEventListener('mouseleave', () => {
                    if (!isSelected) {
                        playerDiv.style.background = roleColor;
                        playerDiv.style.borderColor = 'transparent';
                    }
                });
                
                // Get nationality flag (simplified to 3-letter codes for now)
                const nationalityFlag = getNationalityFlag(player.nationality);
                
                // Get star rating display
                const starRating = getStarRating(player.rating);
                
                // Get condition color
                const conditionColor = getConditionColor(player.condition);
                
                // Get morale color  
                const moraleColor = getMoraleColor(player.morale);
                
                // Get position badge color and generate meaningful status data
                const positionBadgeColor = getPositionBadgeColor(player.squadRole);
                const conditionIcon = getConditionIcon(player.condition);
                const moraleIcon = getMoraleIcon(player.morale);
                const sharpness = Math.floor(Math.random() * 35) + 65; // Improved range 65-100 // Generate sharpness 70-99
                const sharpnessIcon = getSharpnessIcon(sharpness);
                const matchRating = (Math.random() * 3 + 6).toFixed(1); // Generate 6.0-9.0 rating
                
                // Generate enhanced 2-line player card HTML with meaningful icons
                playerDiv.innerHTML = `
                    <div style="display: flex; align-items: center; flex: 1; min-width: 0;">
                        <!-- Squad Position Badge -->
                        <div style="width: 32px; height: 32px; background: ${positionBadgeColor}; border-radius: 6px; 
                                    display: flex; align-items: center; justify-content: center; margin-right: 12px;
                                    font-size: 10px; font-weight: 700; color: white; flex-shrink: 0; text-shadow: 0 1px 2px rgba(0,0,0,0.5);">
                            ${player.squadRole}
                        </div>
                        
                        <!-- LEFT SIDE: Name (top) + Role (bottom) - 2 Rows -->
                        <div style="flex: 1; min-width: 0; overflow: hidden; display: flex; flex-direction: column; justify-content: center;">
                            <!-- TOP ROW: Player Name -->
                            <div style="margin-bottom: 3px;">
                                <span style="font-size: 16px; font-weight: 600; 
                                           color: ${isSelected ? 'var(--primary-400)' : 'rgba(255,255,255,0.95)'};
                                           white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">
                                    ${player.name}
                                </span>
                            </div>
                            
                            <!-- BOTTOM ROW: Role Dropdown -->
                            <div style="display: flex; align-items: center;">
                                ${isSelected ? `
                                <div style="display: flex; align-items: center; gap: 6px;">
                                    <span style="color: rgba(255,255,255,0.7); font-size: 11px; font-weight: 500;">Role:</span>
                                    ${createTacticalRoleDropdown(player)}
                                </div>` : 
                                `<span style="color: rgba(255,255,255,0.6); font-size: 11px; font-style: italic;">
                                    ${roleText} - Available for selection
                                </span>`}
                            </div>
                        </div>
                        
                        <!-- RIGHT SIDE: Single Horizontal Row Vertically Centered -->
                        <div style="display: flex; align-items: center; justify-content: center; gap: 8px;
                                   padding: 6px 12px; background: rgba(255,255,255,0.05); border-radius: 6px;
                                   min-width: 140px; height: 100%;">
                            <!-- Match Rating -->
                            <span style="font-size: 16px; color: var(--accent-300); font-weight: 700;
                                       background: rgba(0,148,204,0.2); padding: 4px 8px; border-radius: 4px; 
                                       border: 1px solid rgba(0,148,204,0.3);" 
                                  title="Match Rating">${matchRating}</span>
                            
                            <!-- Status Icons -->
                            ${conditionIcon}
                            ${sharpnessIcon}
                            ${moraleIcon}
                            
                            <!-- Star Rating -->
                            <span style="color: var(--accent-300); font-size: 12px; font-weight: 600;">${starRating}</span>
                        </div>
                        
                        <!-- Drag Handle for List Reordering -->
                        <div style="display: flex; align-items: center; flex-shrink: 0; margin-left: 8px;">
                            <div style="width: 14px; height: 14px; display: flex; align-items: center; justify-content: center;
                                        cursor: grab; opacity: 0.6;" onmousedown="event.stopPropagation();" 
                                        title="Drag to reorder squad list">
                                <svg width="10" height="10" viewBox="0 0 24 24" fill="rgba(255,255,255,0.4)">
                                    <path d="M11 18c0 1.1-.9 2-2 2s-2-.9-2-2 .9-2 2-2 2 .9 2 2zm-2-8c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2zm0-6c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2zm6 4c1.1 0 2-.9 2-2s-.9-2-2-2-2 .9-2 2 .9 2 2 2zm0 2c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2zm0 6c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2z"/>
                                </svg>
                            </div>
                        </div>
                    </div>
                `;
                
                // Add drag and drop functionality
                addPlayerDragDropHandlers(playerDiv, player);
                
                container.appendChild(playerDiv);
            });
        }
        
        // Create dynamic squad role dropdown based on current formation
        function createSquadRoleDropdown(player, roleColor) {
            const availableRoles = getAvailableSquadRoles();
            let options = '';
            
            // Add formation position options
            availableRoles.formation.forEach(role => {
                const selected = player.squadRole === role ? 'selected' : '';
                options += `<option value="${role}" ${selected}>${role}</option>`;
            });
            
            // Add substitute options
            availableRoles.substitutes.forEach(role => {
                const selected = player.squadRole === role ? 'selected' : '';
                options += `<option value="${role}" ${selected}>${role}</option>`;
            });
            
            // Add reserves option
            availableRoles.reserves.forEach(role => {
                const selected = player.squadRole === role ? 'selected' : '';
                options += `<option value="${role}" ${selected}>${role}</option>`;
            });
            
            return `<select onchange="changeSquadRole(${player.id}, this.value); event.stopPropagation();" 
                            style="font-size: 10px; padding: 3px 6px; background: var(--neutral-400); 
                                   color: rgba(255,255,255,0.9); border: 1px solid rgba(255,255,255,0.3); 
                                   border-radius: 3px; cursor: pointer; min-width: 70px; flex: 1;">
                        ${options}
                    </select>`;
        }
        
        // Create tactical role dropdown for formation players
        function createTacticalRoleDropdown(player) {
            const roles = {
                'GK': ['Sweeper Keeper', 'Goalkeeper'],
                'CB': ['Ball Playing Defender', 'Central Defender', 'Libero'],
                'LB': ['Inverted Wing Back', 'Wing Back', 'Full Back'],
                'RB': ['Complete Wing Back', 'Wing Back', 'Full Back'],
                'DM': ['Deep Lying Playmaker', 'Defensive Midfielder', 'Anchor Man'],
                'CM': ['Box to Box Midfielder', 'Central Midfielder', 'Roaming Playmaker'],
                'AM': ['Advanced Playmaker', 'Attacking Midfielder', 'Trequartista'],
                'LW': ['Inside Forward', 'Winger', 'Inverted Winger'],
                'RW': ['Inside Forward', 'Winger', 'Inverted Winger'],
                'ST': ['Complete Forward', 'Advanced Forward', 'Target Man']
            };
            
            const availableRoles = roles[player.position] || ['Standard'];
            const currentFormationPlayer = formationData[currentFormationPhase].find(p => p.id === player.id);
            const currentRole = currentFormationPlayer?.role || 'Standard';
            
            let options = '';
            availableRoles.forEach(role => {
                const selected = currentRole === role ? 'selected' : '';
                options += `<option value="${role}" ${selected}>${role}</option>`;
            });
            
            return `<select onchange="changeTacticalRole(${player.id}, this.value); event.stopPropagation();" 
                            style="font-size: 11px; padding: 4px 6px; background: var(--neutral-400); 
                                   color: rgba(255,255,255,0.9); border: 1px solid rgba(255,255,255,0.3); 
                                   border-radius: 3px; cursor: pointer; width: 120px; max-width: 120px;">
                        ${options}
                    </select>`;
        }
        
        // Helper functions for player information display
        function getNationalityFlag(nationality) {
            // Return SVG flag icon (simplified colored circle for now)
            const flagColors = {
                'ENG': '#FF0000', 'POR': '#00FF00', 'FRA': '#0000FF', 'ARG': '#87CEEB',
                'BRA': '#FFFF00', 'DEN': '#FF0000', 'CMR': '#00FF00', 'TUR': '#FF0000',
                'SWE': '#FFFF00', 'NED': '#FF8C00', 'MAR': '#FF0000', 'CIV': '#FF8C00',
                'SCO': '#0000FF', 'URU': '#87CEEB', 'TUN': '#FF0000', 'ESP': '#FFFF00'
            };
            const color = flagColors[nationality] || '#808080';
            return `<div style="width: 8px; height: 8px; background: ${color}; border-radius: 50%; 
                                border: 1px solid rgba(255,255,255,0.3); flex-shrink: 0;"></div>`;
        }
        
        function getStarRating(rating) {
            const stars = Math.round(rating / 20); // Convert 0-100 rating to 0-5 stars
            return '★'.repeat(Math.max(1, Math.min(5, stars))) + '☆'.repeat(5 - Math.max(1, Math.min(5, stars)));
        }
        
        function getConditionColor(condition) {
            if (condition >= 90) return 'var(--accent-200)';      // Green - Excellent
            if (condition >= 80) return 'var(--accent-300)';      // Amber - Good  
            if (condition >= 70) return 'var(--accent-400)';      // Red - Poor
            return 'var(--accent-400)';                           // Red - Very Poor
        }
        
        function getMoraleColor(morale) {
            switch(morale) {
                case 'Delighted': return 'var(--accent-200)';      // Green
                case 'Happy': return 'var(--accent-200)';          // Green
                case 'Content': return 'rgba(255,255,255,0.8)';    // White
                case 'Unhappy': return 'var(--accent-400)';        // Red
                case 'Injured': return 'var(--accent-400)';        // Red
                default: return 'rgba(255,255,255,0.6)';           // Gray
            }
        }
        
        // Get position badge color based on squad role
        function getPositionBadgeColor(squadRole) {
            if (squadRole === 'GK' || squadRole === 'GK1' || squadRole === 'GK2') {
                return 'var(--accent-300)'; // Amber for goalkeepers
            } else if (['LB', 'RB', 'LCB', 'RCB', 'CB'].includes(squadRole)) {
                return 'var(--primary-300)'; // Blue for defenders
            } else if (['DM', 'CM', 'LCM', 'RCM', 'AM', 'LAM', 'RAM'].includes(squadRole)) {
                return 'var(--accent-200)'; // Green for midfielders
            } else if (['LW', 'RW', 'ST'].includes(squadRole)) {
                return 'var(--accent-400)'; // Red for forwards
            } else if (squadRole.startsWith('Sub')) {
                return 'var(--neutral-400)'; // Gray for substitutes
            } else {
                return 'var(--neutral-500)'; // Darker gray for reserves
            }
        }
        
        // Get meaningful condition icon (heart with dynamic colors) - Enhanced Vector Art
        function getConditionIcon(condition) {
            const color = condition >= 90 ? '#00ff88' : condition >= 80 ? '#ffb800' : '#ff4757';
            const strokeColor = condition >= 90 ? '#00dd77' : condition >= 80 ? '#dd9900' : '#dd3344';
            const fillPercent = Math.max(20, condition);
            
            return `<div title="Condition: ${condition}%" style="width: 18px; height: 18px; position: relative; cursor: help;">
                        <svg width="18" height="18" viewBox="0 0 24 24" style="position: absolute;">
                            <!-- Heart outline -->
                            <path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z" 
                                  stroke="${strokeColor}" stroke-width="2" fill="none"/>
                            <!-- Heart fill based on condition -->
                            <path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z" 
                                  fill="${color}" opacity="${Math.min(1.0, fillPercent / 70)}"/>
                        </svg>
                    </div>`;
        }
        
        // Get sharpness icon (lightning with dynamic intensity) - Enhanced Vector Art
        function getSharpnessIcon(sharpness) {
            // Enhanced visibility range for better low-value visibility
            let color, strokeColor, intensity;
            
            if (sharpness >= 95) {
                color = '#00FFFF';        // Brightest cyan for peak sharpness  
                strokeColor = '#00DDDD';
                intensity = 1.0;          // Maximum brightness
            } else if (sharpness >= 85) {
                color = '#00CCFF';        // Bright blue for excellent
                strokeColor = '#00AADD';
                intensity = 0.95;
            } else if (sharpness >= 70) {
                color = '#0099FF';        // Standard blue for good
                strokeColor = '#0077CC';
                intensity = 0.85;
            } else if (sharpness >= 50) {
                color = '#5599CC';        // Medium blue for average
                strokeColor = '#4477AA';
                intensity = 0.75;
            } else {
                color = '#7799DD';        // Lighter blue for low (much more visible)
                strokeColor = '#5577BB';
                intensity = 0.7;          // Increased from 0.3 for visibility
            }
            
            return `<div title="Sharpness: ${sharpness}%" style="width: 18px; height: 18px; position: relative; cursor: help;">
                        <svg width="18" height="18" viewBox="0 0 24 24" style="position: absolute;">
                            <!-- Lightning bolt -->
                            <path d="M13 2L8.5 12h3L10 22l4.5-10h-3L13 2z" 
                                  fill="${color}" opacity="${intensity}"
                                  stroke="${strokeColor}" stroke-width="1.5"/>
                            <!-- Lightning energy lines -->
                            <path d="M13 2L8.5 12h3L10 22l4.5-10h-3L13 2z" 
                                  fill="none" 
                                  stroke="${color}" stroke-width="0.8" opacity="0.9"/>
                        </svg>
                    </div>`;
        }
        
        // Enhanced morale icon with numerical values and non-linear form color progression
        function getMoraleIcon(moraleValue) {
            // 5-direction morale system with specific colors
            let moraleText, color, rotation;
            
            if (moraleValue >= 80) {
                moraleText = 'Delighted';
                color = '#008080';        // Teal
                rotation = '0deg';        // North (pointing up)
            } else if (moraleValue >= 60) {
                moraleText = 'Happy';  
                color = '#00ff00';        // Green
                rotation = '45deg';       // Northeast
            } else if (moraleValue >= 40) {
                moraleText = 'Content';
                color = '#ffff00';        // Yellow
                rotation = '90deg';       // East (pointing right)
            } else if (moraleValue >= 20) {
                moraleText = 'Unhappy';
                color = '#ff8800';        // Orange
                rotation = '135deg';      // Southeast
            } else {
                moraleText = 'Dejected';
                color = '#ff0000';        // Red
                rotation = '180deg';      // South (pointing down)
            }
            
            return `<div title="Morale: ${moraleValue}% (${moraleText})" style="width: 18px; height: 18px; position: relative; cursor: help;">
                        <svg width="18" height="18" viewBox="0 0 24 24" style="position: absolute; transform: rotate(${rotation});">
                            <!-- Much thicker arrow: 40% head (triangle) + 60% tail (thick rectangle) -->
                            <path d="M12 1.5l5 10h-3v11.5h-4V11.5H7l5-10z" 
                                  fill="${color}" 
                                  stroke="rgba(0,0,0,0.5)" stroke-width="1.5"/>
                        </svg>
                    </div>`;
        }
        
        // UNIFIED SWAP FUNCTION - Works for both pitch and player-selection
        function unifiedPlayerSwap(playerIndex1, playerIndex2) {
            if (playerIndex1 === playerIndex2) return;
            
            const player1 = centralFormationDB.players[playerIndex1];
            const player2 = centralFormationDB.players[playerIndex2];
            
            if (!player1 || !player2) {
                console.error(`Invalid player indices: ${playerIndex1}, ${playerIndex2}`);
                return;
            }
            
            // ROLE-ONLY SWAP: Players swap roles but keep their tactical positions
            const temp = {
                id: player1.id,
                name: player1.name,
                number: player1.number
            };
            
            // Only swap player assignments, NOT tactical positions or slot characteristics
            player1.id = player2.id;
            player1.name = player2.name;
            player1.number = player2.number;
            // Keep player1.position, player1.role, and player1.tacticalPos unchanged
            
            player2.id = temp.id;
            player2.name = temp.name;
            player2.number = temp.number;
            // Keep player2.position, player2.role, and player2.tacticalPos unchanged
            
            // Debug: Log tactical positions before and after swap
            console.log(`BEFORE UPDATE: Player1 tacticalPos: (${player1.tacticalPos.x}, ${player1.tacticalPos.y})`);
            console.log(`BEFORE UPDATE: Player2 tacticalPos: (${player2.tacticalPos.x}, ${player2.tacticalPos.y})`);
            
            // Update all UI systems
            updateFormationFromCentralDB();
            updateGlobalSquadSlotsFromCentralDB();
            
            // Debug: Check if formationData was updated
            console.log('FormationData after update:', formationData[currentFormationPhase].map(p => `${p.name}:(${p.x},${p.y})`));
            
            // Re-render everything with detailed logging
            console.log('Re-rendering formation players...');
            renderFormationPlayers();
            console.log('Re-rendering player selection...');
            renderCombinedPlayerList();
            
            console.log(`ROLE-ONLY SWAP: ${temp.name} (${player1.position}) ↔ ${player1.name} (${player2.position})`);
            console.log('Central DB after role swap:', centralFormationDB.players.map(p => `${p.name}(${p.position}) at (${p.tacticalPos.x},${p.tacticalPos.y})`));
        }
        
        // Update formationData from central database
        function updateFormationFromCentralDB() {
            formationData[currentFormationPhase] = centralFormationDB.players.map(player => ({
                id: player.id,
                x: player.tacticalPos.x,
                y: player.tacticalPos.y,
                position: player.position,
                number: player.number,
                name: player.name,
                role: player.role
            }));
        }
        
        // Update globalSquadSlots from central database
        function updateGlobalSquadSlotsFromCentralDB() {
            centralFormationDB.players.forEach((player, index) => {
                if (index < 11 && globalSquadSlots[index]) {
                    globalSquadSlots[index].position = player.position;
                    globalSquadSlots[index].role = player.role;
                    globalSquadSlots[index].assignedPlayer = squadRoster.find(p => p.id === player.id);
                }
            });
        }
        
        // Add drag and drop functionality for squad list reordering only
        function addPlayerDragDropHandlers(playerDiv, player) {
            let draggedElement = null;
            let draggedPlayerId = null;
            
            playerDiv.addEventListener('dragstart', (e) => {
                draggedElement = playerDiv;
                draggedPlayerId = player.id;
                
                // Clear visual feedback
                playerDiv.style.opacity = '0.6';
                playerDiv.style.transform = 'scale(0.95)';
                playerDiv.style.boxShadow = '0 4px 12px rgba(0, 148, 204, 0.4)';
                
                e.dataTransfer.effectAllowed = 'move';
                e.dataTransfer.setData('text/plain', player.id);
                
                // Add drag indicator to body
                document.body.style.cursor = 'grabbing';
            });
            
            playerDiv.addEventListener('dragend', (e) => {
                // Reset visual state
                playerDiv.style.opacity = '1';
                playerDiv.style.transform = 'scale(1)';
                playerDiv.style.boxShadow = '';
                
                // Clear drag state
                draggedElement = null;
                draggedPlayerId = null;
                document.body.style.cursor = '';
                
                // Remove all drop indicators
                document.querySelectorAll('.fm-player-item').forEach(item => {
                    item.style.borderTop = '';
                    item.style.borderBottom = '';
                });
            });
            
            playerDiv.addEventListener('dragover', (e) => {
                e.preventDefault();
                e.dataTransfer.dropEffect = 'move';
                
                if (draggedElement && draggedElement !== playerDiv) {
                    // Show drop indicator
                    const rect = playerDiv.getBoundingClientRect();
                    const mouseY = e.clientY;
                    const middleY = rect.top + rect.height / 2;
                    
                    // Clear previous indicators
                    document.querySelectorAll('.fm-player-item').forEach(item => {
                        item.style.borderTop = '';
                        item.style.borderBottom = '';
                    });
                    
                    // Show appropriate drop indicator
                    if (mouseY < middleY) {
                        playerDiv.style.borderTop = '2px solid var(--accent-200)';
                    } else {
                        playerDiv.style.borderBottom = '2px solid var(--accent-200)';
                    }
                }
            });
            
            playerDiv.addEventListener('dragleave', (e) => {
                // Only clear if we're actually leaving the element
                if (!playerDiv.contains(e.relatedTarget)) {
                    playerDiv.style.borderTop = '';
                    playerDiv.style.borderBottom = '';
                }
            });
            
            playerDiv.addEventListener('drop', (e) => {
                e.preventDefault();
                
                // Clear drop indicators
                document.querySelectorAll('.fm-player-item').forEach(item => {
                    item.style.borderTop = '';
                    item.style.borderBottom = '';
                });
                
                if (draggedElement && draggedElement !== playerDiv) {
                    // Determine drop position
                    const rect = playerDiv.getBoundingClientRect();
                    const mouseY = e.clientY;
                    const middleY = rect.top + rect.height / 2;
                    const insertAfter = mouseY >= middleY;
                    
                    // Reorder players in squadRoster array
                    const draggedIndex = squadRoster.findIndex(p => p.id === draggedPlayerId);
                    const targetIndex = squadRoster.findIndex(p => p.id === player.id);
                    
                    if (draggedIndex !== -1 && targetIndex !== -1 && draggedIndex !== targetIndex) {
                        // Remove dragged player from original position
                        const draggedPlayer = squadRoster.splice(draggedIndex, 1)[0];
                        
                        // Calculate new insert position
                        let newIndex = targetIndex;
                        if (draggedIndex < targetIndex) {
                            newIndex = targetIndex - 1;
                        }
                        if (insertAfter) {
                            newIndex++;
                        }
                        
                        // Insert at new position
                        squadRoster.splice(newIndex, 0, draggedPlayer);
                        
                        // Re-render the list
                        renderCombinedPlayerList();
                        console.log(`Reordered squad: moved ${draggedPlayer.name} to position ${newIndex + 1}`);
                    }
                }
            });
        }
        
        // Remove player from formation
        function removePlayerFromFormation(playerId) {
            const currentPlayers = formationData[currentFormationPhase];
            const playerIndex = currentPlayers.findIndex(p => p.id === playerId);
            
            if (playerIndex !== -1) {
                currentPlayers.splice(playerIndex, 1);
                renderFormationPlayers(); // Re-render everything
                console.log(`Removed player ${playerId} from formation`);
            }
        }
        
        // Set formation phase and update display (now uses dropdown)
        function setFormationPhase(phase) {
            currentFormationPhase = phase;
            
            // Update dropdown selection
            const dropdown = document.getElementById('phase-dropdown');
            if (dropdown) {
                dropdown.value = phase;
            }
            
            // Re-render players for new phase
            renderFormationPlayers();
            
            console.log(`Formation phase changed to: ${phase}`);
        }
        
        // Start player dragging
        function startPlayerDrag(playerId, e) {
            e.preventDefault();
            e.stopPropagation();
            
            isDraggingPlayer = true;
            draggedPlayerId = playerId;
            
            const playerCircle = document.querySelector(`circle[data-player-id="${playerId}"]`);
            const nameText = document.querySelector(`.player-name-svg[data-player-id="${playerId}"]`);
            
            if (playerCircle) {
                playerCircle.style.filter = 'drop-shadow(0 4px 12px rgba(0,148,204,0.8))';
                playerCircle.style.cursor = 'grabbing';
            }
            
            // Hide name during dragging
            if (nameText) {
                nameText.style.opacity = '0';
            }
            
            // Show grid overlay during movement
            showPitchGrid();
            
            console.log(`Started dragging player ${playerId}`);
            
            // Add global mouse event listeners with consistent capture
            document.addEventListener('mousemove', updatePlayerPosition, { capture: true });
            document.addEventListener('mouseup', stopPlayerDrag, { capture: true });
            
            // Set body cursor to maintain lock
            document.body.style.cursor = 'grabbing';
        }
        
        // Show tactical grid overlay on pitch (4m x 4m squares)
        function showPitchGrid() {
            const field = document.getElementById('formation-field');
            if (!field) return;
            
            // Remove existing grid if any
            const existingGrid = field.querySelector('.pitch-grid');
            if (existingGrid) existingGrid.remove();
            
            // Create grid overlay
            const gridOverlay = document.createElementNS('http://www.w3.org/2000/svg', 'g');
            gridOverlay.classList.add('pitch-grid');
            
            // 4m x 4m tactical squares: 68m÷4m=17 columns, 108m÷4m=27 rows
            const squareSize = 4; // 4 meters per square
            const numCols = Math.floor(68 / squareSize); // 17 columns
            const numRows = Math.floor(108 / squareSize); // 27 rows
            
            // Draw vertical grid lines (17+1 = 18 lines)
            for (let i = 0; i <= numCols; i++) {
                const line = document.createElementNS('http://www.w3.org/2000/svg', 'line');
                line.setAttribute('x1', i * squareSize);
                line.setAttribute('y1', 0);
                line.setAttribute('x2', i * squareSize);
                line.setAttribute('y2', 108);
                line.setAttribute('stroke', 'rgba(255,255,255,0.4)');
                line.setAttribute('stroke-width', '0.3');
                line.setAttribute('stroke-dasharray', '1.5,1.5');
                gridOverlay.appendChild(line);
            }
            
            // Draw horizontal grid lines (27+1 = 28 lines)
            for (let i = 0; i <= numRows; i++) {
                const line = document.createElementNS('http://www.w3.org/2000/svg', 'line');
                line.setAttribute('x1', 0);
                line.setAttribute('y1', i * squareSize);
                line.setAttribute('x2', 68);
                line.setAttribute('y2', i * squareSize);
                line.setAttribute('stroke', 'rgba(255,255,255,0.4)');
                line.setAttribute('stroke-width', '0.3');
                line.setAttribute('stroke-dasharray', '1.5,1.5');
                gridOverlay.appendChild(line);
            }
            
            field.appendChild(gridOverlay);
        }
        
        // Hide grid overlay
        function hidePitchGrid() {
            const field = document.getElementById('formation-field');
            if (!field) return;
            
            const grid = field.querySelector('.pitch-grid');
            if (grid) grid.remove();
        }
        
        // Show ghost preview at snap target location
        function showGhostPreview(x, y) {
            const field = document.getElementById('formation-field');
            if (!field) return;
            
            // Remove existing ghost
            const existingGhost = field.querySelector('.ghost-preview');
            if (existingGhost) existingGhost.remove();
            
            // Create ghost preview circle
            const ghost = document.createElementNS('http://www.w3.org/2000/svg', 'circle');
            ghost.setAttribute('cx', x);
            ghost.setAttribute('cy', y);
            ghost.setAttribute('r', '2.25'); // Same size as player
            ghost.setAttribute('fill', 'rgba(0, 255, 136, 0.4)'); // Semi-transparent green
            ghost.setAttribute('stroke', 'rgba(0, 255, 136, 0.8)');
            ghost.setAttribute('stroke-width', '0.3');
            ghost.setAttribute('stroke-dasharray', '1,1');
            ghost.setAttribute('class', 'ghost-preview');
            ghost.style.pointerEvents = 'none';
            
            field.appendChild(ghost);
        }
        
        // Hide ghost preview
        function hideGhostPreview() {
            const field = document.getElementById('formation-field');
            if (!field) return;
            
            const ghost = field.querySelector('.ghost-preview');
            if (ghost) ghost.remove();
        }
        
        // Show swap indicator when hovering over occupied position
        function showSwapIndicator(x, y, occupyingPlayer) {
            const field = document.getElementById('formation-field');
            if (!field) return;
            
            // Remove existing indicators
            const existingGhost = field.querySelector('.ghost-preview');
            const existingSwap = field.querySelector('.swap-indicator');
            if (existingGhost) existingGhost.remove();
            if (existingSwap) existingSwap.remove();
            
            // Create swap indicator circle (pulsing orange)
            const swapIndicator = document.createElementNS('http://www.w3.org/2000/svg', 'circle');
            swapIndicator.setAttribute('cx', x);
            swapIndicator.setAttribute('cy', y);
            swapIndicator.setAttribute('r', '3'); // Slightly larger than player
            swapIndicator.setAttribute('fill', 'rgba(255, 165, 0, 0.3)'); // Orange
            swapIndicator.setAttribute('stroke', 'rgba(255, 165, 0, 0.8)');
            swapIndicator.setAttribute('stroke-width', '0.4');
            swapIndicator.setAttribute('stroke-dasharray', '2,2');
            swapIndicator.setAttribute('class', 'swap-indicator');
            swapIndicator.style.pointerEvents = 'none';
            
            // Add pulsing animation
            swapIndicator.style.animation = 'pulse 1s ease-in-out infinite alternate';
            
            field.appendChild(swapIndicator);
        }
        
        // Hide swap indicator
        function hideSwapIndicator() {
            const field = document.getElementById('formation-field');
            if (!field) return;
            
            const swapIndicator = field.querySelector('.swap-indicator');
            if (swapIndicator) swapIndicator.remove();
        }
        
        // Update player position during drag - FOLLOWS MOUSE WITH GHOST PREVIEW
        function updatePlayerPosition(e) {
            if (!isDraggingPlayer || !draggedPlayerId) return;
            
            const field = document.getElementById('formation-field');
            if (!field) return;
            
            const rect = field.getBoundingClientRect();
            
            // Calculate position relative to actual pitch boundaries
            // SVG viewBox: "0 -1 68 109" but pitch rect: "0 0 68 108"
            const viewBoxWidth = 68;
            const viewBoxHeight = 109; // Total viewBox height (-1 to 108)
            const pitchHeight = 108; // Actual pitch height (0 to 108)
            const viewBoxOffsetY = -1; // ViewBox starts at Y=-1
            
            // Transform mouse to viewBox coordinates first
            const viewBoxX = ((e.clientX - rect.left) / rect.width) * viewBoxWidth;
            const viewBoxY = ((e.clientY - rect.top) / rect.height) * viewBoxHeight + viewBoxOffsetY;
            
            // Convert to pitch coordinates (pitch starts at Y=0 within viewBox)
            const rawX = viewBoxX; // X is the same
            const rawY = Math.max(0, Math.min(108, viewBoxY)); // Constrain to pitch Y boundaries
            
            // Constrain to field boundaries - NO GRID SNAPPING during drag
            const constrainedX = Math.max(2, Math.min(66, rawX));
            const constrainedY = Math.max(2, Math.min(106, rawY));
            
            // Calculate nearest grid BOX CENTER (not intersection!)
            const squareSize = 4;
            
            // CORRECT: Snap to grid box centers (2, 6, 10, 14, 18, 22...)
            const nearestGridX = Math.round((constrainedX - 2) / squareSize) * squareSize + 2;
            const nearestGridY = Math.round((constrainedY - 2) / squareSize) * squareSize + 2;
            
            // Check if target position is occupied by another player
            const occupyingPlayer = getPlayerAtPosition(nearestGridX, nearestGridY);
            const isSwapTarget = occupyingPlayer && occupyingPlayer.id !== draggedPlayerId;
            
            // Show ghost preview or swap indicator
            if (isSwapTarget) {
                showSwapIndicator(nearestGridX, nearestGridY, occupyingPlayer);
                document.body.style.cursor = 'copy'; // Swap cursor
            } else {
                showGhostPreview(nearestGridX, nearestGridY);
                document.body.style.cursor = 'grabbing'; // Normal drag cursor
            }
            
            // Update player position to follow mouse exactly
            const currentPlayers = formationData[currentFormationPhase];
            const player = currentPlayers.find(p => p.id === draggedPlayerId);
            if (player) {
                // Store exact mouse position and nearest snap target
                player.tempX = constrainedX;
                player.tempY = constrainedY;
                player.snapTargetX = nearestGridX;
                player.snapTargetY = nearestGridY;
                
                // Update SVG elements to follow mouse exactly - IMMEDIATE response
                const circle = document.querySelector(`circle[data-player-id="${draggedPlayerId}"]`);
                const numberText = document.querySelector(`.player-number-svg[data-player-id="${draggedPlayerId}"]`);
                const nameText = document.querySelector(`.player-name-svg[data-player-id="${draggedPlayerId}"]`);
                
                if (circle) {
                    circle.setAttribute('cx', constrainedX);
                    circle.setAttribute('cy', constrainedY);
                    circle.style.cursor = 'grabbing'; // Change to grabbing during drag
                }
                if (numberText) {
                    numberText.setAttribute('x', constrainedX);
                    numberText.setAttribute('y', constrainedY + 0.8);
                }
                if (nameText) {
                    nameText.setAttribute('x', constrainedX);
                    nameText.setAttribute('y', constrainedY + 4.5);
                    // Hide name during dragging
                    nameText.style.opacity = '0';
                }
            }
        }
        
        // Stop player dragging and apply grid snapping
        function stopPlayerDrag() {
            if (isDraggingPlayer && draggedPlayerId) {
                const currentPlayers = formationData[currentFormationPhase];
                const player = currentPlayers.find(p => p.id === draggedPlayerId);
                
                if (player && player.snapTargetX !== undefined && player.snapTargetY !== undefined) {
                    // Use the snap target calculated from mouse position
                    const finalX = Math.max(2, Math.min(66, player.snapTargetX));
                    const finalY = Math.max(2, Math.min(106, player.snapTargetY));
                    
                    // Check if target position is occupied for swapping
                    const occupyingPlayer = getPlayerAtPosition(finalX, finalY);
                    
                    if (occupyingPlayer && occupyingPlayer.id !== draggedPlayerId) {
                        // SWAP: Exchange positions
                        const originalX = player.x;
                        const originalY = player.y;
                        
                        // Move dragged player to target position
                        player.x = finalX;
                        player.y = finalY;
                        
                        // Move occupying player to dragged player's original position  
                        occupyingPlayer.x = originalX;
                        occupyingPlayer.y = originalY;
                        
                        console.log(`Player swap: ${draggedPlayerId} ↔ ${occupyingPlayer.id} at (${finalX}m, ${finalY}m)`);
                        
                        // Find player indices in central database for swapping
                        const draggedIndex = centralFormationDB.players.findIndex(p => p.id === draggedPlayerId);
                        const occupyingIndex = centralFormationDB.players.findIndex(p => p.id === occupyingPlayer.id);
                        
                        if (draggedIndex !== -1 && occupyingIndex !== -1) {
                            unifiedPlayerSwap(draggedIndex, occupyingIndex);
                        }
                        
                        // Update both players' visual positions
                        updatePlayerVisualPosition(draggedPlayerId, finalX, finalY);
                        updatePlayerVisualPosition(occupyingPlayer.id, originalX, originalY);
                        
                        // Refresh the player selection panel to show swapped roles
                        renderCombinedPlayerList();
                        
                    } else {
                        // MOVE: Simple position update
                        player.x = finalX;
                        player.y = finalY;
                        updatePlayerVisualPosition(draggedPlayerId, finalX, finalY);
                    }
                    delete player.tempX; // Clean up temporary properties
                    delete player.tempY;
                    delete player.snapTargetX;
                    delete player.snapTargetY;
                    
                    console.log(`Player ${draggedPlayerId} positioned at: (${finalX}m, ${finalY}m)`);
                }
            }
            
            // Hide all drag indicators and update occupancy
            hidePitchGrid();
            hideGhostPreview();
            hideSwapIndicator();
            updateGridOccupancy(); // Refresh occupancy after position changes
            
            isDraggingPlayer = false;
            draggedPlayerId = null;
            
            // Remove global mouse event listeners
            document.removeEventListener('mousemove', updatePlayerPosition, { capture: true });
            document.removeEventListener('mouseup', stopPlayerDrag, { capture: true });
            
            // Restore cursor
            document.body.style.cursor = 'default';
        }
        
        // Update grid occupancy tracker
        function updateGridOccupancy() {
            gridOccupancy.clear();
            const currentPlayers = formationData[currentFormationPhase];
            currentPlayers.forEach(player => {
                const gridKey = `${player.x},${player.y}`;
                gridOccupancy.set(gridKey, player);
            });
        }
        
        // Check if a grid position is occupied by another player
        function getPlayerAtPosition(x, y) {
            const gridKey = `${x},${y}`;
            return gridOccupancy.get(gridKey) || null;
        }
        
        // Unified player position swap function - handles both pitch and player-selection
        function swapPlayerPositions(playerId1, playerId2) {
            const currentPlayers = formationData[currentFormationPhase];
            
            // Find players in formation data by their ID
            const player1Index = currentPlayers.findIndex(p => p.id == playerId1);
            const player2Index = currentPlayers.findIndex(p => p.id == playerId2);
            
            if (player1Index !== -1 && player2Index !== -1 && player1Index < 11 && player2Index < 11) {
                // Get the corresponding slots (array index matches)
                const slot1 = globalSquadSlots[player1Index];
                const slot2 = globalSquadSlots[player2Index];
                
                // Swap assigned players between slots
                const tempPlayer = slot1.assignedPlayer;
                slot1.assignedPlayer = slot2.assignedPlayer;
                slot2.assignedPlayer = tempPlayer;
                
                console.log(`Unified swap: ${slot1.assignedPlayer?.name} (${slot1.position}) ↔ ${slot2.assignedPlayer?.name} (${slot2.position})`);
                
                // Refresh player-selection panel to show swapped assignments
                renderCombinedPlayerList();
            } else {
                console.error(`Swap failed: Invalid player indices ${player1Index}, ${player2Index} for players ${playerId1}, ${playerId2}`);
            }
        }
        
        // Update player visual position on SVG
        function updatePlayerVisualPosition(playerId, x, y) {
            const circle = document.querySelector(`circle[data-player-id="${playerId}"]`);
            const numberText = document.querySelector(`.player-number-svg[data-player-id="${playerId}"]`);
            const nameText = document.querySelector(`.player-name-svg[data-player-id="${playerId}"]`);
            
            if (circle) {
                circle.setAttribute('cx', x);
                circle.setAttribute('cy', y);
                circle.style.cursor = 'grab';
                
                // Restore gradient shadow
                const currentPlayers = formationData[currentFormationPhase];
                const playerData = currentPlayers.find(p => p.id == playerId);
                const positionClass = getPositionClass(playerData?.position || 'midfielder');
                let shadowColor;
                switch(positionClass) {
                    case 'goalkeeper': shadowColor = 'rgba(255,204,0,0.4)'; break;
                    case 'defender': shadowColor = 'rgba(0,150,204,0.4)'; break; 
                    case 'midfielder': shadowColor = 'rgba(0,224,120,0.4)'; break;
                    case 'forward': shadowColor = 'rgba(255,0,50,0.4)'; break;
                    default: shadowColor = 'rgba(0,224,120,0.4)'; break;
                }
                circle.style.filter = `drop-shadow(0 2px 4px ${shadowColor})`;
            }
            if (numberText) {
                numberText.setAttribute('x', x);
                numberText.setAttribute('y', y + 0.8);
            }
            if (nameText) {
                nameText.setAttribute('x', x);
                nameText.setAttribute('y', y + 4.5);
                nameText.style.opacity = '1';
            }
        }
        
        // Show squad analysis dialog
        function showSquadAnalysis() {
            alert('Squad Analysis: Formation shows good balance with 95% familiarity. Strong defensive presence with Varane and Martinez. Creative midfield led by Bruno Fernandes. Clinical forward line with Hojlund as focal point. Overall team rating: 8.2/10');
        }
        
        // Reset formation to default positions
        function resetFormation() {
            const defaultPositions = {
                attacking: [
                    { id: 1, x: 50, y: 88, position: 'GK', number: 1, name: 'Onana' },
                    { id: 2, x: 15, y: 72, position: 'LB', number: 23, name: 'Shaw' },
                    { id: 3, x: 35, y: 77, position: 'CB', number: 19, name: 'Varane' },
                    { id: 4, x: 65, y: 77, position: 'CB', number: 6, name: 'Martinez' },
                    { id: 5, x: 85, y: 72, position: 'RB', number: 20, name: 'Dalot' },
                    { id: 6, x: 40, y: 58, position: 'DM', number: 18, name: 'Casemiro' },
                    { id: 7, x: 60, y: 58, position: 'CM', number: 37, name: 'Mainoo' },
                    { id: 8, x: 20, y: 35, position: 'LW', number: 10, name: 'Rashford' },
                    { id: 9, x: 50, y: 45, position: 'AM', number: 8, name: 'Bruno' },
                    { id: 10, x: 80, y: 35, position: 'RW', number: 17, name: 'Garnacho' },
                    { id: 11, x: 50, y: 20, position: 'ST', number: 11, name: 'Hojlund' }
                ]
            };
            
            formationData[currentFormationPhase] = [...defaultPositions.attacking];
            renderFormationPlayers();
            console.log('Formation reset to default 4-2-3-1');
        }
        
        // Save formation 
        function saveFormation() {
            localStorage.setItem('fm_formation_data', JSON.stringify(formationData));
            console.log('Formation saved to localStorage');
            // Could trigger visual feedback here
        }
        
        // Export formation as JSON
        function exportFormation() {
            const dataStr = JSON.stringify(formationData, null, 2);
            const dataUri = 'data:application/json;charset=utf-8,'+ encodeURIComponent(dataStr);
            
            const link = document.createElement('a');
            link.setAttribute('href', dataUri);
            link.setAttribute('download', 'fm-formation-tactics.json');
            link.click();
            
            console.log('Formation exported as JSON');
        }
        
        // Clear formation selection
        function clearFormation() {
            // Clear all formation positions
            formationData[currentFormationPhase] = [];
            
            // Reset all squad roles to substitutes/reserves
            squadRoster.forEach((player, index) => {
                if (index < 11) {
                    player.squadRole = `Sub${(index + 1).toString().padStart(2, '0')}`;
                } else {
                    player.squadRole = 'Reserves';
                }
            });
            
            // Re-render everything
            renderFormationPlayers();
            renderCombinedPlayerList();
            
            console.log('Formation cleared - all players available for selection');
        }
        
        // Load formation from localStorage
        function loadFormation() {
            const savedFormation = localStorage.getItem('fm_formation_data');
            if (savedFormation) {
                formationData = JSON.parse(savedFormation);
                renderFormationPlayers();
                renderCombinedPlayerList();
                console.log('Formation loaded from localStorage');
            } else {
                console.log('No saved formation found');
            }
        }
        
        // Filter squad based on multiple criteria
        function filterSquad() {
            const squadFilter = document.getElementById('squad-filter').value;
            const statusFilter = document.getElementById('status-filter').value;
            const nationalityFilter = document.getElementById('nationality-filter').value;
            const positionFilter = document.getElementById('position-filter').value;
            const ageMin = parseInt(document.getElementById('age-min').value);
            const ageMax = parseInt(document.getElementById('age-max').value);
            
            // Update age displays
            document.getElementById('age-min-display').textContent = ageMin;
            document.getElementById('age-max-display').textContent = ageMax;
            
            // Apply filters and re-render
            renderCombinedPlayerList();
            
            console.log(`Filters applied: Squad=${squadFilter}, Status=${statusFilter}, Nation=${nationalityFilter}, Position=${positionFilter}, Age=${ageMin}-${ageMax}`);
        }
        
        // Auto-pick best XI based on ratings and positions with coach preference
        function autoPickFormation(coach = 'head') {
            // Group players by position preference
            const playersByPosition = {
                'GK': squadRoster.filter(p => p.position === 'GK').sort((a, b) => b.rating - a.rating),
                'CB': squadRoster.filter(p => p.position === 'CB').sort((a, b) => b.rating - a.rating),
                'LB': squadRoster.filter(p => p.position === 'LB').sort((a, b) => b.rating - a.rating),
                'RB': squadRoster.filter(p => p.position === 'RB').sort((a, b) => b.rating - a.rating),
                'DM': squadRoster.filter(p => p.position === 'DM').sort((a, b) => b.rating - a.rating),
                'CM': squadRoster.filter(p => p.position === 'CM').sort((a, b) => b.rating - a.rating),
                'AM': squadRoster.filter(p => p.position === 'AM').sort((a, b) => b.rating - a.rating),
                'LW': squadRoster.filter(p => p.position === 'LW').sort((a, b) => b.rating - a.rating),
                'RW': squadRoster.filter(p => p.position === 'RW').sort((a, b) => b.rating - a.rating),
                'ST': squadRoster.filter(p => p.position === 'ST').sort((a, b) => b.rating - a.rating)
            };
            
            // Auto-assign best players to formation positions
            const bestFormation = [
                { ...playersByPosition['GK'][0], x: 34, y: 97, role: 'Sweeper Keeper' },
                { ...playersByPosition['LB'][0], x: 8, y: 83, role: 'Inverted Wing Back' },
                { ...playersByPosition['CB'][0], x: 22, y: 87, role: 'Ball Playing Defender' },
                { ...playersByPosition['CB'][1] || playersByPosition['CB'][0], x: 46, y: 87, role: 'Ball Playing Defender' },
                { ...playersByPosition['RB'][0], x: 60, y: 83, role: 'Complete Wing Back' },
                { ...playersByPosition['DM'][0], x: 26, y: 70, role: 'Deep Lying Playmaker' },
                { ...playersByPosition['CM'][0], x: 42, y: 70, role: 'Box to Box Midfielder' },
                { ...playersByPosition['LW'][0], x: 10, y: 37, role: 'Inside Forward' },
                { ...playersByPosition['AM'][0], x: 34, y: 50, role: 'Advanced Playmaker' },
                { ...playersByPosition['RW'][0], x: 58, y: 37, role: 'Inside Forward' },
                { ...playersByPosition['ST'][0], x: 34, y: 17, role: 'Complete Forward' }
            ].filter(player => player.id); // Remove undefined players
            
            // Update formation data
            formationData[currentFormationPhase] = bestFormation;
            
            // Update squad roles
            squadRoster.forEach(player => {
                const isInFormation = bestFormation.some(fp => fp.id === player.id);
                if (isInFormation) {
                    const formationPlayer = bestFormation.find(fp => fp.id === player.id);
                    const positionIndex = bestFormation.indexOf(formationPlayer);
                    const positions = ['GK', 'LB', 'LCB', 'RCB', 'RB', 'DM', 'CM', 'LW', 'AM', 'RW', 'ST'];
                    player.squadRole = positions[positionIndex] || player.position;
                } else {
                    // Set as substitute if not in formation
                    const subIndex = squadRoster.filter(p => !bestFormation.some(fp => fp.id === p.id)).indexOf(player) + 1;
                    player.squadRole = `Sub${subIndex.toString().padStart(2, '0')}`;
                }
            });
            
            // Re-render everything
            renderFormationPlayers();
            renderCombinedPlayerList();
            
            console.log('Auto-picked best XI formation');
        }
        
        // Change formation type
        function changeFormation(formationType) {
            console.log(`Formation changed to: ${formationType}`);
            // Could implement different formation layouts here
        }
        
        // Open filter dialog
        function openFilterDialog() {
            // Create modal overlay
            const overlay = document.createElement('div');
            overlay.id = 'filter-modal-overlay';
            overlay.style.cssText = `
                position: fixed; top: 0; left: 0; right: 0; bottom: 0;
                background: rgba(0, 0, 0, 0.7); z-index: 2000;
                display: flex; align-items: center; justify-content: center;
            `;
            
            // Create modal dialog
            const dialog = document.createElement('div');
            dialog.style.cssText = `
                background: var(--neutral-300); border-radius: 8px; padding: 20px;
                width: 400px; max-width: 90vw; box-shadow: 0 8px 32px rgba(0,0,0,0.5);
                border: 1px solid var(--neutral-500);
            `;
            
            dialog.innerHTML = `
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
                    <h3 style="margin: 0; color: var(--primary-400); font-size: 16px;">Squad Filters</h3>
                    <button onclick="closeFilterDialog()" 
                            style="background: none; border: none; color: rgba(255,255,255,0.8); 
                                   font-size: 18px; cursor: pointer; padding: 4px;">×</button>
                </div>
                
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 12px;">
                    <div>
                        <label style="display: block; color: rgba(255,255,255,0.8); font-size: 10px; margin-bottom: 4px;">Squad Level</label>
                        <select id="modal-squad-filter" 
                                style="width: 100%; background: var(--neutral-400); color: white; border: 1px solid var(--neutral-500); 
                                       border-radius: 3px; padding: 6px; font-size: 10px; cursor: pointer;">
                            <option value="all">All Squad</option>
                            <option value="first-team">First Team</option>
                            <option value="reserves">Reserves</option>
                            <option value="u21">U21</option>
                            <option value="u18">U18</option>
                        </select>
                    </div>
                    
                    <div>
                        <label style="display: block; color: rgba(255,255,255,0.8); font-size: 10px; margin-bottom: 4px;">Player Status</label>
                        <select id="modal-status-filter" 
                                style="width: 100%; background: var(--neutral-400); color: white; border: 1px solid var(--neutral-500); 
                                       border-radius: 3px; padding: 6px; font-size: 10px; cursor: pointer;">
                            <option value="all">All Status</option>
                            <option value="available">Available</option>
                            <option value="loan">On Loan</option>
                            <option value="transfer">Transfer Listed</option>
                        </select>
                    </div>
                </div>
                
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 12px;">
                    <div>
                        <label style="display: block; color: rgba(255,255,255,0.8); font-size: 10px; margin-bottom: 4px;">Nationality</label>
                        <select id="modal-nationality-filter" 
                                style="width: 100%; background: var(--neutral-400); color: white; border: 1px solid var(--neutral-500); 
                                       border-radius: 3px; padding: 6px; font-size: 10px; cursor: pointer;">
                            <option value="all">All Nations</option>
                            <option value="home-grown">Home Grown</option>
                            <option value="foreign">Foreign</option>
                            <option value="eu">EU Players</option>
                            <option value="non-eu">Non-EU</option>
                        </select>
                    </div>
                    
                    <div>
                        <label style="display: block; color: rgba(255,255,255,0.8); font-size: 10px; margin-bottom: 4px;">Position</label>
                        <select id="modal-position-filter" 
                                style="width: 100%; background: var(--neutral-400); color: white; border: 1px solid var(--neutral-500); 
                                       border-radius: 3px; padding: 6px; font-size: 10px; cursor: pointer;">
                            <option value="all">All Positions</option>
                            <option value="GK">Goalkeepers</option>
                            <option value="DEF">Defenders</option>
                            <option value="MID">Midfielders</option>
                            <option value="ATT">Attackers</option>
                        </select>
                    </div>
                </div>
                
                <div style="margin-bottom: 16px;">
                    <label style="display: block; color: rgba(255,255,255,0.8); font-size: 10px; margin-bottom: 8px;">Age Range</label>
                    <div style="display: flex; align-items: center; gap: 8px;">
                        <input type="range" id="modal-age-min" min="16" max="40" value="16" 
                               style="flex: 1; height: 6px; background: var(--neutral-500); border-radius: 3px;">
                        <span style="font-size: 10px; color: rgba(255,255,255,0.8); min-width: 20px;" id="modal-age-min-display">16</span>
                        <span style="font-size: 10px; color: rgba(255,255,255,0.6);">to</span>
                        <input type="range" id="modal-age-max" min="16" max="40" value="40" 
                               style="flex: 1; height: 6px; background: var(--neutral-500); border-radius: 3px;">
                        <span style="font-size: 10px; color: rgba(255,255,255,0.8); min-width: 20px;" id="modal-age-max-display">40</span>
                    </div>
                </div>
                
                <div style="display: flex; gap: 8px; justify-content: flex-end;">
                    <button onclick="resetFilters()" 
                            style="background: var(--neutral-500); color: white; border: none; 
                                   padding: 8px 16px; border-radius: 4px; font-size: 10px; cursor: pointer;">
                        Reset
                    </button>
                    <button onclick="applyFilters()" 
                            style="background: var(--primary-400); color: white; border: none; 
                                   padding: 8px 16px; border-radius: 4px; font-size: 10px; cursor: pointer;">
                        Apply Filters
                    </button>
                </div>
            `;
            
            overlay.appendChild(dialog);
            document.body.appendChild(overlay);
            
            // Update age displays
            document.getElementById('modal-age-min').oninput = function() {
                document.getElementById('modal-age-min-display').textContent = this.value;
            };
            document.getElementById('modal-age-max').oninput = function() {
                document.getElementById('modal-age-max-display').textContent = this.value;
            };
            
            // Close on overlay click
            overlay.addEventListener('click', (e) => {
                if (e.target === overlay) closeFilterDialog();
            });
        }
        
        // Close filter dialog
        function closeFilterDialog() {
            const overlay = document.getElementById('filter-modal-overlay');
            if (overlay) overlay.remove();
        }
        
        // Apply filters from modal
        function applyFilters() {
            const squadFilter = document.getElementById('modal-squad-filter').value;
            const statusFilter = document.getElementById('modal-status-filter').value;
            const nationalityFilter = document.getElementById('modal-nationality-filter').value;
            const positionFilter = document.getElementById('modal-position-filter').value;
            const ageMin = parseInt(document.getElementById('modal-age-min').value);
            const ageMax = parseInt(document.getElementById('modal-age-max').value);
            
            // Apply filters and re-render
            renderCombinedPlayerList();
            closeFilterDialog();
            
            console.log(`Filters applied: Squad=${squadFilter}, Status=${statusFilter}, Nation=${nationalityFilter}, Position=${positionFilter}, Age=${ageMin}-${ageMax}`);
        }
        
        // Reset all filters
        function resetFilters() {
            document.getElementById('modal-squad-filter').value = 'all';
            document.getElementById('modal-status-filter').value = 'all';
            document.getElementById('modal-nationality-filter').value = 'all';
            document.getElementById('modal-position-filter').value = 'all';
            document.getElementById('modal-age-min').value = 16;
            document.getElementById('modal-age-max').value = 40;
            document.getElementById('modal-age-min-display').textContent = '16';
            document.getElementById('modal-age-max-display').textContent = '40';
        }
        
        // Create player selection dropdown for each slot
        // PLAYER SELECTION DROPDOWN - Enhanced with swap functionality
        // PLAYER SELECTION DROPDOWN - Enhanced visibility for Empty option
        function createPlayerSelectionDropdown(slot, currentPlayer) {
            const isEmptySelected = !currentPlayer;
            const emptyColor = isEmptySelected ? 'var(--neutral-400)' : 'white';
            let options = `<option value="" style="color: #C3C3C3;">Empty</option>`;
            
            squadRoster.forEach(player => {
                const selected = currentPlayer && player.id == currentPlayer.id ? 'selected' : '';
                const isAssignedElsewhere = globalSquadSlots.some(s => s.id !== slot.id && s.assignedPlayer && s.assignedPlayer.id == player.id);
                const playerName = isAssignedElsewhere ? `${player.name} (Swap)` : player.name;
                options += `<option value="${player.id}" ${selected} style="color: white;">${playerName}</option>`;
            });
            
            return `<select onchange="assignOrSwapPlayer(${slot.id}, this.value)" 
                            class="aethelred-player-dropdown"
                            style="width: 100%; height: 100%; 
                                   background: var(--neutral-300); color: ${isEmptySelected ? 'var(--neutral-400)' : 'white'};
                                   border: none; border-radius: 0;
                                   padding: 8px 12px; font-size: var(--font-size-sm);
                                   font-weight: 400; cursor: pointer; outline: none;">
                        ${options}
                    </select>`;
        }
        
        // Update main render function to use new modular system
        function createSquadSlot(container, slot, index) {
            return createAethelredSquadSlot(container, slot, index);
        }
        
        // Get empty icon for unassigned slots
        function getEmptyIcon() {
            return `<div style="width: 18px; height: 18px; background: rgba(255,255,255,0.1); 
                               border-radius: 50%; border: 1px dashed rgba(255,255,255,0.3);"></div>`;
        }
        
        // Global drag state for proper drag-drop functionality
        let currentDraggedSlot = null;
        
        // Enhanced drag-and-drop swapping functionality
        function addSlotDragDropHandlers(slotDiv, slot) {
            slotDiv.addEventListener('dragstart', (e) => {
                currentDraggedSlot = slot;
                slotDiv.style.opacity = '0.6';
                e.dataTransfer.effectAllowed = 'move';
                e.dataTransfer.setData('text/plain', slot.id);
                console.log(`Drag started for slot ${slot.id} (${slot.position})`);
            });
            
            slotDiv.addEventListener('dragend', (e) => {
                slotDiv.style.opacity = '1';
                currentDraggedSlot = null;
                console.log('Drag ended');
            });
            
            slotDiv.addEventListener('dragover', (e) => {
                e.preventDefault();
                e.dataTransfer.dropEffect = 'move';
                if (currentDraggedSlot && currentDraggedSlot.id !== slot.id) {
                    slotDiv.style.background = 'rgba(0, 148, 204, 0.2)';
                }
            });
            
            slotDiv.addEventListener('dragleave', (e) => {
                // Only reset if we're actually leaving this element
                if (!slotDiv.contains(e.relatedTarget)) {
                    slotDiv.style.background = '';
                }
            });
            
            slotDiv.addEventListener('drop', (e) => {
                e.preventDefault();
                slotDiv.style.background = '';
                
                if (currentDraggedSlot && currentDraggedSlot.id !== slot.id) {
                    console.log(`Dropping slot ${currentDraggedSlot.id} onto slot ${slot.id}`);
                    swapPlayersInSlots(currentDraggedSlot.id, slot.id);
                }
            });
        }
        
        // Assign player to specific slot
        // Enhanced player assignment with swap functionality
        function assignOrSwapPlayer(slotId, playerId) {
            console.log(`Assigning/swapping player ${playerId} to slot ${slotId}`);
            
            const targetIndex = slotId - 1; // Convert slot ID to array index
            
            // If clearing the slot
            if (!playerId || playerId === '') {
                if (targetIndex >= 0 && targetIndex < 11) {
                    const targetSlot = globalSquadSlots[targetIndex];
                    centralFormationDB.players[targetIndex] = { 
                        index: targetIndex, 
                        id: null, 
                        name: '', 
                        position: targetSlot.position, 
                        role: targetSlot.role, 
                        number: 0, 
                        tacticalPos: centralFormationDB.players[targetIndex]?.tacticalPos || { x: 34, y: 50 } 
                    };
                    
                    updateFormationFromCentralDB();
                    updateGlobalSquadSlotsFromCentralDB();
                    renderFormationPlayers();
                    renderCombinedPlayerList();
                }
                return;
            }
            
            // Find source player index in central database
            const sourceIndex = centralFormationDB.players.findIndex(p => p.id == playerId);
            
            if (sourceIndex !== -1 && sourceIndex !== targetIndex) {
                // SWAP: Use unified swap function
                unifiedPlayerSwap(targetIndex, sourceIndex);
            } else if (sourceIndex === -1) {
                // NEW ASSIGNMENT: Player not currently in formation
                const player = squadRoster.find(p => p.id == playerId);
                if (player && targetIndex >= 0 && targetIndex < 11) {
                    const targetSlot = globalSquadSlots[targetIndex];
                    centralFormationDB.players[targetIndex] = {
                        index: targetIndex,
                        id: player.id,
                        name: player.name,
                        position: targetSlot.position,
                        role: targetSlot.role,
                        number: player.number,
                        tacticalPos: centralFormationDB.players[targetIndex]?.tacticalPos || { x: 34, y: 50 }
                    };
                    
                    updateFormationFromCentralDB();
                    updateGlobalSquadSlotsFromCentralDB();
                    renderFormationPlayers();
                    renderCombinedPlayerList();
                }
            }
        }
        
        // Legacy function for compatibility
        function assignPlayerToSlot(slotId, playerId) {
            return assignOrSwapPlayer(slotId, playerId);
        }
        
        // FIXED: Swap players between two slots using unified system
        function swapPlayersInSlots(slotId1, slotId2) {
            console.log(`PLAYER-SELECTION DRAG: Swapping slots ${slotId1} and ${slotId2}`);
            
            // Convert slot IDs to indices for unified system
            const index1 = slotId1 - 1;
            const index2 = slotId2 - 1;
            
            // Use unified swap function that updates both pitch and player-selection
            if (index1 >= 0 && index1 < 11 && index2 >= 0 && index2 < 11) {
                unifiedPlayerSwap(index1, index2);
                console.log(`Used unified swap for slots ${slotId1} ↔ ${slotId2}`);
            } else {
                console.log(`Slot-only swap for substitutes ${slotId1} ↔ ${slotId2}`);
                // For substitutes, use old logic (they don't appear on pitch)
                const slot1 = globalSquadSlots.find(s => s.id == slotId1);
                const slot2 = globalSquadSlots.find(s => s.id == slotId2);
                
                if (slot1 && slot2) {
                    const tempPlayer = slot1.assignedPlayer;
                    slot1.assignedPlayer = slot2.assignedPlayer;
                    slot2.assignedPlayer = tempPlayer;
                    renderCombinedPlayerList();
                }
            }
        }
        
        // Change slot role
        function changeSlotRole(slotId, newRole) {
            console.log(`Changing slot ${slotId} role to ${newRole}`);
            
            const slot = globalSquadSlots.find(s => s.id === slotId);
            if (slot) {
                slot.role = newRole;
            }
            
            // Re-render to update display
            renderCombinedPlayerList();
        }
        
        // Duty functionality removed for simplified interface
        
        // Back to Grid functionality (from formation interface)
        function closeFormationEditor() {
            console.log('=== SWITCHING TO TACTICS CARDS VIEW ===');
            
            // Hide formation interface
            const formationView = document.getElementById('tactics-formation-view');
            if (formationView) {
                formationView.style.display = 'none';
                formationView.classList.remove('active');
            }
            
            // Show cards view for other tactics content
            const cardsView = document.getElementById('tactics-cards-view');
            if (cardsView) {
                cardsView.style.display = 'flex';
                cardsView.classList.add('active');
                
                // Load instructions content as default for cards view
                loadPageCards('tactics', 'instructions');
            }
            
            // Switch to Instructions submenu
            const instructionsItem = document.querySelector('#tactics-submenu .submenu-item:nth-child(2)');
            if (instructionsItem) {
                setActiveSubmenuItem(instructionsItem);
            }
            
            console.log('=== SWITCHED TO TACTICS CARDS VIEW ===');
        }
        
        // Set active submenu item helper function
        function setActiveSubmenuItem(element) {
            const submenuContainer = element.parentElement;
            submenuContainer.querySelectorAll('.submenu-item').forEach(item => {
                item.classList.remove('active');
            });
            element.classList.add('active');
        }
        
        // REMOVED: openFormationEditor - Formation is now the default view for Tactics
        
        // Initialize formation interface when page loads
        window.addEventListener('load', () => {
            setTimeout(() => {
                renderFormationPlayers();
            }, 1000);
        });
        
        // REMOVED: Old simple generators that were overriding Aethelred implementations
        // All submenu content now uses proper Aethelred Design System components per newPlan.md
        
    </script>
</body>
</html>